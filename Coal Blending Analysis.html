<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blended Coal Analysis Calculator</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome - Primary CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Font Awesome - Fallback CDN -->
    <link href="https://use.fontawesome.com/releases/v6.5.0/css/all.css" rel="stylesheet" crossorigin="anonymous">
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 0.5s ease, color 0.3s ease;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .calculator-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calculator-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .calculator-title {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .calculator-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            margin-bottom: 0;
        }

        .section-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
            margin: 15px 0 20px 0;
            padding: 10px 0;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .input-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .input-label {
            color: white;
            font-weight: 500;
            width: 220px;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .input-group {
            display: flex;
            flex: 1;
            gap: 10px;
            max-width: 400px;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            padding: 12px 15px;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
            color: white;
            outline: none;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .unit-label {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            min-width: 80px;
            text-align: center;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .results-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .results-table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .results-table th {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            padding: 15px 10px;
            text-align: center;
            border: none;
            font-size: 14px;
        }

        .results-table td {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
        }

        .results-table tbody tr:nth-child(even) td {
            background: rgba(255, 255, 255, 0.05);
        }

        .results-table tbody tr:hover td {
            background: rgba(255, 255, 255, 0.15);
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid #dc3545;
            color: #721c24;
            padding: 15px 0 5px 0;
            border-radius: 10px;
            margin: 10px 0 10px 0;
            font-weight: 500;
            display: none;
        }

        .instruction-message {
            background: rgba(0, 123, 255, 0.1);
            border: 1px solid #007bff;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .floating-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .floating-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .storage-counter {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            border: 2px solid white;
            min-width: 20px;
        }

        .storage-counter:empty {
            display: none;
        }

        .export-dropdown {
            position: fixed;
            bottom: 110px;
            right: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            min-width: 180px;
        }

        .export-dropdown.active {
            display: flex;
        }

        .export-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .export-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .formula-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-left: 4px solid rgba(255, 255, 255, 0.3);
            padding: 20px;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .formula-sidebar.active {
            right: 0;
        }

        .formula-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .formula-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .formula-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .formula-expression {
            color: white;
            font-size: 14px;
            line-height: 1.6;
        }

        .formula-fallback {
            display: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            margin-top: 8px;
            font-style: italic;
        }

        .stored-calculations {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .stored-calc-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .calc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .calc-summary {
            margin-bottom: 10px;
        }

        .calc-actions {
            display: flex;
            gap: 8px;
        }

        .stored-calculation-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stored-calculation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stored-calculation-summary {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            line-height: 1.4;
        }

        .delete-btn {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .store-btn, .clear-btn {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }

        .clear-btn {
            background: rgba(220, 53, 69, 0.2);
            border-color: #dc3545;
        }

        .store-btn:hover, .clear-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .calculator-container {
                padding: 20px;
                margin: 10px;
            }
            
            .input-section {
                padding: 15px;
            }

            .input-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                margin-bottom: 10px;
            }

            .input-label {
                min-width: auto;
                text-align: left;
                padding: 8px 0;
                font-size: 14px;
                font-weight: 500;
            }
            
            .input-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .header-section {
                margin-top: 80px; /* Add top margin to clear night-mode toggle */
                margin-bottom: 30px;
            }
            
            .calculator-title {
                font-size: 24px;
            }
            
            .calculator-subtitle {
                font-size: 14px;
            }

            .night-mode-toggle {
                top: 15px;
                right: 15px;
                padding: 6px 12px;
            }
        }
            
        /* For dual inputs (coal properties), display in a row */
        .input-group.dual-inputs {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 8px;
        }
            
            .input-group.dual-inputs .form-control {
                width: calc(50% - 4px);
                font-size: 14px;
                padding: 12px;
                border-radius: 10px;
                border: 1px solid #ddd;
                box-sizing: border-box;
                margin-bottom: 0;
            }
            
            /* For single inputs (plant parameters), keep column layout */
            .input-group .form-control {
                width: 100%;
                font-size: 14px;
                padding: 12px;
                border-radius: 10px;
                border: 1px solid #ddd;
                box-sizing: border-box;
                margin-bottom: 8px;
            }
            
            .input-group .form-control:last-of-type {
                margin-bottom: 0;
            }
            
            .unit-label {
                display: none; /* Hidden since units are now in labels */
            }

            .floating-actions {
                bottom: 20px;
                right: 20px;
            }

            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 18px;
            }

            .formula-sidebar {
                width: 100%;
                right: -100%;
            }

            .results-table {
                font-size: 12px;
            }

            .results-table th,
            .results-table td {
                padding: 8px 5px;
                word-wrap: break-word;
                max-width: 120px;
            }

            .back-button {
                width: 40px;
                height: 40px;
                top: 15px;
                left: 15px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .calculator-title {
                font-size: 24px;
            }
            
            .calculator-subtitle {
                font-size: 14px;
            }
        

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .calculator-container {
                padding: 15px;
                margin: 10px 0;
            }
            
            .header-section {
                margin-top: 70px; /* Add top margin to clear night-mode toggle */
                margin-bottom: 25px;
            }
            
            .calculator-title {
                font-size: 20px;
            }
            
            .calculator-subtitle {
                font-size: 13px;
            }

            .night-mode-toggle {
                top: 10px;
                right: 10px;
                padding: 5px 10px;
                font-size: 14px;
            }

            .input-section {
                padding: 12px;
                margin-bottom: 15px;
            }

            .input-group {
                display: flex;
                flex-direction: column;
                gap: 6px;
                width: 100%;
            }
            
            /* For dual inputs in small mobile, keep them in a row */
            .input-group.dual-inputs {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .input-group.dual-inputs .form-control {
                width: calc(50% - 3px);
                padding: 14px 12px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 10px;
                border: 1px solid #ddd;
                box-sizing: border-box;
                margin-bottom: 0;
            }

            .input-group .form-control {
                width: 100%;
                padding: 14px 12px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 10px;
                border: 1px solid #ddd;
                box-sizing: border-box;
                margin-bottom: 6px;
            }
            
            .input-group .form-control:last-of-type {
                margin-bottom: 0;
            }
            
            .input-row {
                flex-direction: column;
                gap: 8px;
                margin-bottom: 18px;
            }
            
            .input-label {
                min-width: auto;
                font-size: 13px;
                text-align: left;
                margin-bottom: 6px;
                font-weight: 500;
                color: #333;
                padding: 6px 0;
            }
            
            .unit-label {
                display: none; /* Hidden since units are now in labels */
            }
            
            .section-title {
                font-size: 18px;
                text-align: center;
                margin: 20px 0 15px 0;
            }
            
            .results-table {
                font-size: 10px;
            }
            
            .results-table th,
            .results-table td {
                padding: 4px 2px;
                word-wrap: break-word;
                max-width: 80px;
            }
            
            .blended-analysis-table td {
                padding: 0.2rem 0.1rem;
            }
            
            .back-button {
                width: 40px;
                height: 40px;
                top: 10px;
                left: 10px;
                font-size: 16px;
            }
            
            .floating-actions {
                bottom: 15px;
                right: 10px;
                gap: 8px;
            }
            
            .floating-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
            
            .storage-counter {
                width: 18px;
                height: 18px;
                font-size: 9px;
            }
            
            .export-dropdown {
                right: 10px;
                bottom: 70px;
                min-width: 150px;
            }
            
            .export-btn {
                padding: 10px 12px;
                font-size: 13px;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-width: 360px) {
            .calculator-container {
                padding: 10px;
                margin: 5px 0;
            }
            
            .input-section {
                padding: 8px;
            }
            
            .header-section {
                margin-top: 65px; /* Add top margin to clear night-mode toggle */
                margin-bottom: 20px;
            }
            
            .calculator-title {
                font-size: 18px;
            }
            
            .calculator-subtitle {
                font-size: 12px;
            }

            .night-mode-toggle {
                top: 8px;
                right: 8px;
                padding: 4px 8px;
                font-size: 13px;
            }
            
            .input-group.dual-inputs .form-control {
                width: calc(50% - 2px);
                padding: 12px 8px;
                font-size: 14px;
                border-radius: 10px;
            }
            
            .input-group .form-control {
                padding: 12px 10px;
                font-size: 16px;
                border-radius: 10px;
            }
            
            .input-label {
                font-size: 12px;
                padding: 4px 0;
            }
            
            .unit-label {
                display: none; /* Hidden since units are now in labels */
            }
            
            .calculator-title {
                font-size: 18px;
            }
            
            .calculator-subtitle {
                font-size: 12px;
            }
        }
        
        /* Night Mode Toggle Styles */
        .night-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .toggle-label {
            font-size: 16px;
            user-select: none;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: #4dabf7;
            border-color: #4dabf7;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Night Mode Styles */
        body.night-mode {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f0f23) !important;
            color: #e0e0e0 !important;
        }

        body.night-mode .calculator-container {
            background: rgba(26, 26, 46, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .calculator-header {
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            margin-bottom: 30px !important;
            padding: 0 !important;
        }

        body.night-mode .calculator-title {
            color: #ffffff !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5) !important;
        }

        body.night-mode .calculator-subtitle {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        body.night-mode .section-title {
            color: #ffffff !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5) !important;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3) !important;
        }

        body.night-mode .input-section {
            background: rgba(40, 40, 60, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .input-label {
            color: #b0b0b0 !important;
        }

        body.night-mode .form-control {
            background: rgba(40, 40, 60, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #e0e0e0 !important;
        }

        body.night-mode .form-control:focus {
            background: rgba(50, 50, 70, 0.9) !important;
            border-color: #4dabf7 !important;
            box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25) !important;
        }

        body.night-mode .btn-primary {
            background: linear-gradient(135deg, #4263eb, #364fc7) !important;
            border-color: #364fc7 !important;
        }

        body.night-mode .btn-primary:hover {
            background: linear-gradient(135deg, #364fc7, #3b82f6) !important;
            border-color: #3b82f6 !important;
        }

        body.night-mode .results-section {
            background: rgba(26, 26, 46, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .results-grid .col-md-4 {
            background: rgba(40, 40, 60, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .result-item h6 {
            color: #b0b0b0 !important;
        }

        body.night-mode .result-value {
            color: #ffffff !important;
        }

        body.night-mode .back-button {
            background: rgba(26, 26, 46, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #e0e0e0 !important;
        }

        body.night-mode .back-button:hover {
            background: rgba(40, 40, 60, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.4) !important;
        }

        body.night-mode .export-btn {
            background: rgba(26, 26, 46, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #e0e0e0 !important;
        }

        body.night-mode .export-btn:hover {
            background: rgba(40, 40, 60, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
        }

        body.night-mode .error-message {
            background: rgba(220, 53, 69, 0.2) !important;
            border: 1px solid rgba(220, 53, 69, 0.4) !important;
            color: #f8d7da !important;
        }

        body.night-mode .instruction-message {
            background: rgba(13, 202, 240, 0.2) !important;
            border: 1px solid rgba(13, 202, 240, 0.4) !important;
            color: #b6effb !important;
        }

        body.night-mode .night-mode-toggle {
            background: rgba(26, 26, 46, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        /* Fallback icons in case Font Awesome doesn't load */
        .fa-file-pdf::before { content: "📄"; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important; }
        .fa-image::before { content: "🖼️"; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important; }
        .fa-fire::before { content: "🔥"; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important; }
        .fa-industry::before { content: "🏭"; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important; }
        .fa-chart-bar::before { content: "📊"; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important; }
        .fa-arrow-left::before { content: "←"; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important; }
        .fa-info-circle::before { content: "ℹ️"; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important; }
        .fa-tag::before { content: "🏷️"; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important; }
        
        /* Enhanced export button styling */
        .export-btn {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            transition: all 0.3s ease !important;
            min-height: 40px !important;
        }

        .export-btn .fas,
        .export-btn .fa {
            font-size: 16px !important;
            flex-shrink: 0 !important;
        }

        /* Enhanced Entrance Animations */
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes zoomInRotate {
            from { opacity: 0; transform: scale(0.8) rotate(-5deg); }
            to { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes flipInX {
            from { opacity: 0; transform: perspective(400px) rotateX(90deg); }
            40% { transform: perspective(400px) rotateX(-20deg); }
            60% { opacity: 1; transform: perspective(400px) rotateX(10deg); }
            80% { transform: perspective(400px) rotateX(-5deg); }
            to { opacity: 1; transform: perspective(400px) rotateX(0deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Animation Classes */
        .animate-slide-in-left {
            animation: slideInLeft 0.6s ease-out;
        }

        .animate-slide-in-right {
            animation: slideInRight 0.6s ease-out;
        }

        .animate-slide-in-up {
            animation: slideInUp 0.6s ease-out;
        }

        .animate-slide-in-down {
            animation: slideInDown 0.6s ease-out;
        }

        .animate-zoom-in {
            animation: zoomIn 0.6s ease-out;
        }

        .animate-zoom-in-rotate {
            animation: zoomInRotate 0.7s ease-out;
        }

        .animate-bounce-in {
            animation: bounceIn 0.8s ease-out;
        }

        .animate-flip-in-x {
            animation: flipInX 0.8s ease-out;
        }

        .animate-pulse {
            animation: pulse 0.6s ease-out;
        }

        /* Staggered animation delays */
        .animate-delay-1 { animation-delay: 0.1s; animation-fill-mode: both; opacity: 0; }
        .animate-delay-2 { animation-delay: 0.2s; animation-fill-mode: both; opacity: 0; }
        .animate-delay-3 { animation-delay: 0.3s; animation-fill-mode: both; opacity: 0; }
        .animate-delay-4 { animation-delay: 0.4s; animation-fill-mode: both; opacity: 0; }
        .animate-delay-5 { animation-delay: 0.5s; animation-fill-mode: both; opacity: 0; }
        .animate-delay-6 { animation-delay: 0.6s; animation-fill-mode: both; opacity: 0; }
        
    </style>
</head>
<body>
    <!-- Night Mode Toggle -->
    <div class="night-mode-toggle">
        <span class="toggle-label">🌙</span>
        <label class="toggle-switch">
            <input type="checkbox" id="nightModeToggle">
            <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">☀️</span>
    </div>

    <!-- Back Button -->
    <button class="back-button" onclick="goBack()" title="Back to Calculators">
        <i class="fas fa-arrow-left"></i>
    </button>

    <!-- Main Calculator Container -->
    <div class="calculator-container">
        <!-- Header -->
        <div class="calculator-header">
            <h1 class="calculator-title">Blended Coal Analysis</h1>
        </div>

        <!-- Error/Instruction Messages -->
        <div class="error-message" id="errorMessage"></div>
        <div class="instruction-message" id="instructionMessage">
            <i class="fas fa-info-circle me-2"></i>
            Please fill in all the fields.
        </div>

        <!-- Coal Properties Section -->
        <div id="coalPropertiesSection">
            <h3 class="section-title">
                <i class="fas fa-fire me-2"></i>Coal Properties
            </h3>

            <div class="input-section">
            <div class="input-row">
                <label class="input-label">
                    <i class="fas fa-tag me-2"></i>Coal Source Names
                </label>
                <div class="input-group dual-inputs">
                    <input type="text" class="form-control" id="coalA-blending-name" placeholder="Indigenous Coal" data-allow-text="true">
                    <input type="text" class="form-control" id="coalB-blending-name" placeholder="Imported Coal" data-allow-text="true">
                </div>
            </div>

            <div class="input-row">
                <label class="input-label">
                    <i class="fas fa-gem me-2"></i>Coal Cost (Rs/MT)
                </label>
                <div class="input-group dual-inputs">
                    <input type="number" class="form-control" id="coal-cost-indian" placeholder="0" step="0.01" min="0">
                    <input type="number" class="form-control" id="coal-cost-imported" placeholder="0" step="0.01" min="0">
                </div>
            </div>

            <div class="input-row">
                <label class="input-label">
                    <i class="fas fa-train me-2"></i>Railway Freight (Rs/MT)
                </label>
                <div class="input-group dual-inputs">
                    <input type="number" class="form-control" id="railway-freight-indian" placeholder="0" step="0.01" min="0">
                    <input type="number" class="form-control" id="railway-freight-imported" placeholder="0" step="0.01" min="0">
                </div>
            </div>

            <div class="input-row">
                <label class="input-label">
                    <i class="fas fa-thermometer-half me-2"></i>GCV - ARB (kcal/kg)
                </label>
                <div class="input-group dual-inputs">
                    <input type="number" class="form-control" id="gcv-arb-Indian" placeholder="0" step="0.01" min="0">
                    <input type="number" class="form-control" id="gcv-arb-Imported" placeholder="0" step="0.01" min="0">
                </div>
            </div>
        </div>
        </div> <!-- End coalPropertiesSection -->

        <!-- Plant Parameters Section -->
        <div id="plantParametersSection">
            <h3 class="section-title">
                <i class="fas fa-industry me-2"></i>Plant Parameters
            </h3>

        <div class="input-section">
            <div class="input-row">
                <label class="input-label">
                    <i class="fas fa-bolt me-2"></i>Generation Capacity (MW)
                </label>
                <div class="input-group">
                    <input type="number" class="form-control" id="generationcapacity-blended" placeholder="0" step="0.01" min="0">
                </div>
            </div>

            <div class="input-row">
                <label class="input-label">
                    <i class="fas fa-chart-line me-2"></i>Plant Load Factor (%)
                </label>
                <div class="input-group">
                    <input type="number" class="form-control" id="plf-blended" placeholder="0" step="0.01" min="0" max="100">
                </div>
            </div>

            <div class="input-row">
                <label class="input-label">
                    <i class="fas fa-calendar me-2"></i>Number of Days (Days)
                </label>
                <div class="input-group">
                    <input type="number" class="form-control" id="days-blended" placeholder="0" step="1" min="0" max="365">
                </div>
            </div>

            <div class="input-row">
                <label class="input-label">
                    <i class="fas fa-thermometer-three-quarters me-2"></i>Station Heat Rate (kcal/kWh)
                </label>
                <div class="input-group">
                    <input type="number" class="form-control" id="shr-blended" placeholder="0" step="0.01" min="0">
                </div>
            </div>

            <div class="input-row">
                <label class="input-label">
                    <i class="fas fa-percentage me-2"></i>Blending Ratio (%)
                </label>
                <div class="input-group">
                    <input type="number" class="form-control" id="blending-ratio" placeholder="0" step="0.01" min="0" max="100">
                </div>
            </div>
        </div>

        <!-- Store Calculation Button -->
        <div class="text-center">
            <button class="store-btn" onclick="storeCalculation()" id="storeButton" disabled>
                <i class="fas fa-save me-2"></i>Store Calculation
            </button>
            <button class="clear-btn" onclick="clearForm()">
                <i class="fas fa-refresh me-2"></i>Clear Form
            </button>
        </div>
        </div> <!-- End plantParametersSection -->

        <!-- Results Section -->
        <div class="results-container" id="resultsContainer" style="display: none;">
            <h3 class="section-title">
                <i class="fas fa-chart-bar me-2"></i>Analysis Results
            </h3>

            <div class="table-responsive">
                <table class="results-table table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th id="coalA-header">Indigenous Coal</th>
                            <th id="coalB-header">Imported Coal</th>
                            <th>Blended Coal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Quantity Required (Lakh MT)</strong></td>
                            <td><span id="indian-coal-quantity"></span></td>
                            <td>—</td>
                            <td>—</td>
                        </tr>
                        <tr>
                            <td><strong>Blending Ratio (%)</strong></td>
                            <td><span id="indian-coal-quantity-ratio-after-blending"></span></td>
                            <td><span id="imported-coal-quantity-ratio-after-blending"></span></td>
                            <td>—</td>
                        </tr>
                        <tr>
                            <td><strong>Quantity Required for Blending (Lakh MT)</strong></td>
                            <td><span id="indian-coal-quantity-after-blending"></span></td>
                            <td><span id="imported-coal-quantity-after-blending"></span></td>
                            <td><span id="blendedcoal"></span></td>
                        </tr>
                        <tr>
                            <td><strong>GCV ARB (kcal/kg)</strong></td>
                            <td><span id="gcv-arb-Indian-table"></span></td>
                            <td><span id="gcv-arb-Imported-tabel"></span></td>
                            <td><span id="gcv-blended"></span></td>
                        </tr>
                        <tr>
                            <td><strong>Landed Cost (Rs/MT)</strong></td>
                            <td><span id="indian-coal-landed-charges-MT"></span></td>
                            <td><span id="Imported-coal-landed-charges-MT"></span></td>
                            <td><span id="landed-cost-blended-MT"></span></td>
                        </tr>
                        <tr>
                            <td><strong>Landed Cost (Rs/MCal)</strong></td>
                            <td><span id="indian-coal-landed-charges-MC"></span></td>
                            <td><span id="Imported-coal-landed-charges-MC"></span></td>
                            <td><span id="landed-cost-blended-MC"></span></td>
                        </tr>
                        <tr>
                            <td><strong>Per Unit Cost (Rs/kWh)</strong></td>
                            <td><span id="indian-coal-energy-charges"></span></td>
                            <td><span id="Imported-coal-energy-charges"></span></td>
                            <td><span id="blended-coal-energy-charges"></span></td>
                        </tr>
                        <tr>
                            <td><strong>Specific Coal Consumption (kg/kWh)</strong></td>
                            <td><span id="indian-coal-SCC"></span></td>
                            <td><span id="Imported-coal-SCC"></span></td>
                            <td><span id="blended-coal-SCC"></span></td>
                        </tr>
                        <tr>
                            <td><strong>Increase in Per Unit Cost (Rs/kWh)</strong></td>
                            <td>—</td>
                            <td>—</td>
                            <td><span id="comparison-result"></span></td>
                        </tr>
                        <tr>
                            <td><strong>Additional Financial Liability (Rs.)</strong></td>
                            <td>—</td>
                            <td>—</td>
                            <td><span id="additionalFinancialLiabilityImported-result"></span></td>
                        </tr>
                        <tr>
                            <td><strong>Units Generated (LUs)</strong></td>
                            <td>—</td>
                            <td>—</td>
                            <td><span id="unitsGeneratedBlended-result"></span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Stored Calculations -->
        <div class="stored-calculations" id="storedCalculationsContainer" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 style="color: white; margin: 0;">
                    <i class="fas fa-database me-2"></i>Stored Calculations
                </h4>
                <button type="button" class="btn btn-outline-light btn-sm" onclick="clearAllStoredData()" title="Clear All Stored Data">
                    <i class="fas fa-trash-alt me-1"></i>Clear All
                </button>
            </div>
            <div id="storedCalculationsList"></div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-actions">
        <button class="floating-btn" onclick="toggleStoredCalculations()" title="Stored Calculations">
            <i class="fas fa-database"></i>
            <span class="storage-counter" id="storageCounter">0</span>
        </button>
        <button class="floating-btn" onclick="toggleFormulas()" title="View Formulas">
            <i class="fas fa-calculator"></i>
        </button>
        <button class="floating-btn" onclick="toggleExportOptions()" title="Export Options">
            <i class="fas fa-download"></i>
        </button>
    </div>

    <!-- Export Dropdown -->
    <div class="export-dropdown" id="exportDropdown">
        <button class="export-btn" onclick="exportToPDF()">
            <i class="fas fa-file-pdf text-danger"></i>
            Export as PDF
        </button>
        <button class="export-btn" onclick="exportToJPG()">
            <i class="fas fa-image text-primary"></i>
            Export as JPG
        </button>
    </div>

    <!-- Formula Sidebar -->
    <div class="formula-sidebar" id="formulaSidebar">
        <div class="formula-header">
            <h2 class="formula-title">Formulas</h2>
            <button class="close-btn" onclick="toggleFormulas()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Landed Cost (Blended)} = \text{Landed Cost Indian} \times (1 - \frac{\text{Blending Ratio}}{100}) + \text{Landed Cost Imported} \times \frac{\text{Blending Ratio}}{100}$$
                <div class="formula-fallback">Landed Cost (Blended) = Landed Cost Indian × (1 - Blending Ratio/100) + Landed Cost Imported × (Blending Ratio/100)</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{GCV (Blended)} = \text{GCV Indian} \times (1 - \frac{\text{Blending Ratio}}{100}) + \text{GCV Imported} \times \frac{\text{Blending Ratio}}{100}$$
                <div class="formula-fallback">GCV (Blended) = GCV Indian × (1 - Blending Ratio/100) + GCV Imported × (Blending Ratio/100)</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Energy Charges (Blended)} = \frac{\text{Landed Cost (Blended)} \times \text{SHR}}{\text{GCV (Blended)} \times 1000}$$
                <div class="formula-fallback">Energy Charges (Blended) = (Landed Cost (Blended) × SHR) ÷ (GCV (Blended) × 1000)</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Generation} = \text{Capacity} \times \frac{\text{PLF}}{100} \times 24 \times \text{Days}$$
                <div class="formula-fallback">Generation = Capacity × (PLF ÷ 100) × 24 × Days</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{SCC} = \frac{\text{SHR}}{\text{GCV}}$$
                <div class="formula-fallback">SCC = SHR ÷ GCV</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Additional Financial Liability} = (\text{Energy Charges Blended} - \text{Energy Charges Indian}) \times \text{Generation}$$
                <div class="formula-fallback">Additional Financial Liability = (Energy Charges Blended - Energy Charges Indian) × Generation</div>
            </div>
        </div>
    </div>

    <!-- Include necessary libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<!-- JavaScript for Professional Coal Blending Analysis -->
<script>
// Professional JavaScript with advanced features
window.MathJax = {
    tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
    },
    svg: {
        fontCache: 'global'
    },
    startup: {
        ready() {
            MathJax.startup.defaultReady();
            console.log('MathJax is loaded and ready!');
        }
    }
};

// Global variables for professional features
let storedCalculations = JSON.parse(localStorage.getItem('blendingCalculations')) || [];
let calculationCounter = parseInt(localStorage.getItem('blendingCalculationCounter')) || 1;

// Professional input validation
document.addEventListener('DOMContentLoaded', function () {
    function restrictNumericInput(input) {
        input.addEventListener('keydown', function (event) {
            const allowedKeys = [
                "Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab", "Home", "End"
            ];
            if (allowedKeys.includes(event.key)) return;

            if (event.key === "." && this.value.includes(".")) {
                event.preventDefault();
                return;
            }
            if (
                event.key === '-' || event.key === '+' || event.key === 'e' ||
                (!/^\d$/.test(event.key) && event.key !== ".")
            ) {
                event.preventDefault();
            }
        });

        input.addEventListener('paste', function (event) {
            const paste = (event.clipboardData || window.clipboardData).getData('text');
            if (!/^\d*\.?\d*$/.test(paste)) {
                event.preventDefault();
            }
        });

        input.addEventListener('blur', function () {
            const value = parseFloat(this.value.trim());
            if (isNaN(value) || value < 0) {
                this.value = "";
            }
        });
    }

    function applyUniversalNumericRestriction() {
        document.querySelectorAll('input:not([data-allow-text="true"])').forEach(input => {
            restrictNumericInput(input);
        });
    }

    applyUniversalNumericRestriction();
    
    // Setup event listeners
    setupEventListeners();
    
    // Prevent form submission on Enter
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        });
    });

    // Professional event listeners setup
    function setupEventListeners() {
        const blendedInputs = [
            "gcv-arb-Indian", "coal-cost-indian", "railway-freight-indian",
            "gcv-arb-Imported", "coal-cost-imported", "railway-freight-imported",
            "generationcapacity-blended", "plf-blended", "days-blended", 
            "shr-blended", "blending-ratio"
        ];

    blendedInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', calculateBlendedCoalEnergyCharges);
            input.addEventListener('input', showBlendingBadges);
        }
    });

    // Coal name updates
    const coalAInput = document.getElementById('coalA-blending-name');
    const coalAHeader = document.getElementById('coalA-header');
    if (coalAInput && coalAHeader) {
        coalAInput.addEventListener('input', function () {
            coalAHeader.textContent = coalAInput.value || 'Indigenous Coal';
        });
    }

    const coalBInput = document.getElementById('coalB-blending-name');
    const coalBHeader = document.getElementById('coalB-header');
    if (coalBInput && coalBHeader) {
        coalBInput.addEventListener('input', function () {
            coalBHeader.textContent = coalBInput.value || 'Imported Coal';
        });
    }

    // Enhanced input validation
    blendedInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('keydown', function(e) {
                if (
                    [46, 8, 9, 27, 13, 110, 190].indexOf(e.keyCode) !== -1 ||
                    ((e.ctrlKey || e.metaKey) && [65, 67, 86, 88, 90].indexOf(e.keyCode) !== -1) ||
                    (e.keyCode >= 35 && e.keyCode <= 39)
                ) {
                    return;
                }
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) &&
                    (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
                if (e.key === '-' || e.key === '+' || e.key === 'e') {
                    e.preventDefault();
                }
            });
            
            input.addEventListener('input', function() {
                if (parseFloat(input.value) < 0) input.value = '';
                
                // Auto-correct PLF if over 100
                if (id === 'plf-blended' && parseFloat(input.value) > 100) {
                    input.value = 100;
                }
            });
        }
    }); // End forEach for blendedInputs
    } // End setupEventListeners function
    
    // Night Mode Functionality
    function initializeNightMode() {
        const nightModeToggle = document.getElementById('nightModeToggle');
        const body = document.body;
        
        // Check saved preference
        const isNightMode = localStorage.getItem('nightMode') === 'true';
        if (isNightMode) {
            body.classList.add('night-mode');
            nightModeToggle.checked = true;
        }
        
        // Toggle functionality
        nightModeToggle.addEventListener('change', function() {
            if (this.checked) {
                body.classList.add('night-mode');
                localStorage.setItem('nightMode', 'true');
            } else {
                body.classList.remove('night-mode');
                localStorage.setItem('nightMode', 'false');
            }
        });
    }

    // Animation System
    function initializeAnimations() {
        const elements = [
            { selector: '.calculator-header', animation: 'animate-slide-in-down', delay: 0 },
            { selector: '.night-mode-toggle', animation: 'animate-slide-in-right', delay: 1 },
            { selector: '.back-button', animation: 'animate-slide-in-left', delay: 1 },
            { selector: '#coalPropertiesSection', animation: 'animate-slide-in-left', delay: 2 },
            { selector: '#plantParametersSection', animation: 'animate-slide-in-right', delay: 3 },
            { selector: '#resultsContainer', animation: 'animate-zoom-in-rotate', delay: 4 },
            { selector: '.error-message', animation: 'animate-bounce-in', delay: 2 },
            { selector: '.instruction-message', animation: 'animate-flip-in-x', delay: 3 }
        ];

        elements.forEach(({ selector, animation, delay }) => {
            const element = document.querySelector(selector);
            if (element) {
                element.classList.add(animation, `animate-delay-${delay}`);
            }
        });

        // Animate input sections when they come into view
        const inputSections = document.querySelectorAll('.input-section');
        inputSections.forEach((section, index) => {
            const animationClass = index % 2 === 0 ? 'animate-slide-in-left' : 'animate-slide-in-right';
            section.classList.add(animationClass, `animate-delay-${Math.min(index + 2, 6)}`);
        });

        // Animate buttons when results are shown
        const exportButtons = document.querySelectorAll('.export-btn');
        exportButtons.forEach((btn, index) => {
            btn.classList.add('animate-pulse', `animate-delay-${index + 1}`);
        });
    }

    // Enhanced results animation
    function animateResults() {
        const resultItems = document.querySelectorAll('.result-item');
        resultItems.forEach((item, index) => {
            setTimeout(() => {
                item.classList.add('animate-slide-in-up');
            }, index * 100);
        });
    }

    // Initialize all systems
    setupEventListeners();
    initializeNightMode();
    initializeAnimations();
    
    // Initialize stored calculations display and counter
    updateStoredCalculationsDisplay();
}); // End DOMContentLoaded

// Professional calculation function with enhanced features
function calculateBlendedCoalEnergyCharges() {
    try {
        // Get input values with error handling
        const inputs = {
            gcvArbindian: parseFloat(document.getElementById("gcv-arb-Indian").value) || 0,
            coalCostIndian: parseFloat(document.getElementById("coal-cost-indian").value) || 0,
            railwayFreightIndian: parseFloat(document.getElementById("railway-freight-indian").value) || 0,
            gcvArbimported: parseFloat(document.getElementById("gcv-arb-Imported").value) || 0,
            coalCostImported: parseFloat(document.getElementById("coal-cost-imported").value) || 0,
            railwayFreightImported: parseFloat(document.getElementById("railway-freight-imported").value) || 0,
            generationcapacityblended: parseFloat(document.getElementById("generationcapacity-blended").value) || 0,
            plfblended: Math.min(parseFloat(document.getElementById("plf-blended").value) || 0, 100),
            daysblended: parseFloat(document.getElementById("days-blended").value) || 0,
            shrblended: parseFloat(document.getElementById("shr-blended").value) || 0,
            blendingRatio: parseFloat(document.getElementById("blending-ratio").value) || 0
        };

        // Enhanced validation - allow zero for PLF (partial load)
        if (inputs.gcvArbindian <= 0 || inputs.coalCostIndian < 0 || inputs.railwayFreightIndian < 0 ||
            inputs.gcvArbimported <= 0 || inputs.coalCostImported < 0 || inputs.railwayFreightImported < 0 ||
            inputs.generationcapacityblended <= 0 || inputs.plfblended < 0 || inputs.plfblended > 100 ||
            inputs.daysblended <= 0 || inputs.shrblended <= 0 || 
            inputs.blendingRatio < 0 || inputs.blendingRatio > 100) {
            showErrorState();
            return;
        }

        // Calculations with enhanced precision
        const calculations = performBlendingCalculations(inputs);
        
        // Display results with professional formatting
        displayResults(calculations, inputs);
        
        // Show success state
        showSuccessState(calculations);
        
    } catch (error) {
        console.error('Calculation error:', error);
        showErrorState();
    }
}

// Enhanced calculation engine
function performBlendingCalculations(inputs) {
    const {
        gcvArbindian, coalCostIndian, railwayFreightIndian,
        gcvArbimported, coalCostImported, railwayFreightImported,
        generationcapacityblended, plfblended, daysblended,
        shrblended, blendingRatio
    } = inputs;

    // Basic calculations
    const landedCostIndian = coalCostIndian + railwayFreightIndian;
    const landedCostImported = coalCostImported + railwayFreightImported;
    const landedCostIndianMC = landedCostIndian / gcvArbindian;
    const landedCostImportedMC = landedCostImported / gcvArbimported;

    // Energy calculations
    const energyChargesIndian = (landedCostIndian * shrblended) / (gcvArbindian * 1000);
    const energyChargesImported = (landedCostImported * shrblended) / (gcvArbimported * 1000);
    const sccIndian = shrblended / gcvArbindian;
    const sccImported = shrblended / gcvArbimported;

    // Blending calculations
    const blendFactor = blendingRatio / 100;
    const gcvBlended = (gcvArbindian * (1 - blendFactor)) + (gcvArbimported * blendFactor);
    const landedCostBlended = (landedCostIndian * (1 - blendFactor)) + (landedCostImported * blendFactor);
    const landedCostBlendedMC = landedCostBlended / gcvBlended;
    const sccBlended = shrblended / gcvBlended;

    // Advanced energy calculations
    const energyChargesBlended = (energyChargesIndian * (1 - blendFactor)) + (energyChargesImported * blendFactor);
    const comparisonResult = (energyChargesBlended - energyChargesIndian) * (sccIndian / sccImported);
    const energyChargesAfterBlending = energyChargesIndian + comparisonResult;

    // Quantity calculations
    const quantityIndianCoal = (generationcapacityblended * daysblended * 24 * plfblended * 10 * shrblended) / (gcvArbindian * 100000000);
    const quantityImportedCoal = quantityIndianCoal * blendingRatio / 100;
    const quantityIndianCoalAfterBlending = quantityIndianCoal - (quantityImportedCoal * gcvArbimported / gcvArbindian);
    const quantityblendedCoal = quantityIndianCoalAfterBlending + quantityImportedCoal;

    // Financial impact
    const expenditureIndianCoal = quantityImportedCoal * landedCostIndian * gcvArbimported / gcvArbindian;
    const expenditureImportedCoal = quantityImportedCoal * landedCostImported;
    const additionalFinancialLiability = (expenditureImportedCoal - expenditureIndianCoal) * 100000;
    const unitsgeneratedBlended = generationcapacityblended * plfblended * daysblended * 24 * 10 / 100000;

    return {
        landedCostIndian, landedCostImported, landedCostIndianMC, landedCostImportedMC,
        energyChargesIndian, energyChargesImported, sccIndian, sccImported,
        gcvBlended, landedCostBlended, landedCostBlendedMC, sccBlended,
        energyChargesBlended, energyChargesAfterBlending, comparisonResult,
        quantityIndianCoal, quantityImportedCoal, quantityIndianCoalAfterBlending,
        quantityblendedCoal, additionalFinancialLiability, unitsgeneratedBlended
    };
}
// Professional results display
function displayResults(calculations, inputs) {
    const {
        landedCostIndian, landedCostImported, landedCostIndianMC, landedCostImportedMC,
        energyChargesIndian, energyChargesImported, sccIndian, sccImported,
        gcvBlended, landedCostBlended, landedCostBlendedMC, sccBlended,
        energyChargesAfterBlending, comparisonResult,
        quantityIndianCoal, quantityImportedCoal, quantityIndianCoalAfterBlending,
        quantityblendedCoal, additionalFinancialLiability, unitsgeneratedBlended
    } = calculations;

    const { blendingRatio } = inputs;

    // Quantity ratios
    const IndianCoalQuantityRatioAfterBlending = 100 - blendingRatio;
    const ImportedCoalQuantityRatioAfterBlending = blendingRatio;

    // Update all display elements with professional formatting
    updateElement("indian-coal-quantity", quantityIndianCoal.toFixed(5));
    updateElement("indian-coal-quantity-ratio-after-blending", IndianCoalQuantityRatioAfterBlending.toFixed(2));
    updateElement("imported-coal-quantity-ratio-after-blending", ImportedCoalQuantityRatioAfterBlending.toFixed(2));
    
    updateElement("indian-coal-quantity-after-blending", quantityIndianCoalAfterBlending.toFixed(2));
    updateElement("imported-coal-quantity-after-blending", quantityImportedCoal.toFixed(2));
    updateElement("blendedcoal", quantityblendedCoal.toFixed(2));

    updateElement("gcv-arb-Indian-table", inputs.gcvArbindian.toFixed(2));
    updateElement("gcv-arb-Imported-tabel", inputs.gcvArbimported.toFixed(2));
    updateElement("gcv-blended", gcvBlended.toFixed(2));

    updateElement("indian-coal-landed-charges-MT", landedCostIndian.toFixed(2));
    updateElement("Imported-coal-landed-charges-MT", landedCostImported.toFixed(2));
    updateElement("landed-cost-blended-MT", landedCostBlended.toFixed(2));
    
    updateElement("indian-coal-landed-charges-MC", landedCostIndianMC.toFixed(4));
    updateElement("Imported-coal-landed-charges-MC", landedCostImportedMC.toFixed(4));
    updateElement("landed-cost-blended-MC", landedCostBlendedMC.toFixed(4));

    updateElement("indian-coal-energy-charges", energyChargesIndian.toFixed(4));
    updateElement("Imported-coal-energy-charges", energyChargesImported.toFixed(4));
    updateElement("blended-coal-energy-charges", energyChargesAfterBlending.toFixed(4));

    updateElement("indian-coal-SCC", sccIndian.toFixed(4));
    updateElement("Imported-coal-SCC", sccImported.toFixed(4));
    updateElement("blended-coal-SCC", sccBlended.toFixed(4));

    updateElement("comparison-result", comparisonResult.toFixed(4));
    updateElement("additionalFinancialLiabilityImported-result", formatIndianStyleNumber(additionalFinancialLiability));
    updateElement("unitsGeneratedBlended-result", formatIndianStyleNumber(unitsgeneratedBlended));
}

// Utility functions
function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.innerText = value;
    }
}

function formatIndianStyleNumber(num) {
    if (isNaN(num)) return "0";
    return new Intl.NumberFormat('en-IN', {
        maximumFractionDigits: 2,
        minimumFractionDigits: 0
    }).format(num);
}

// Professional state management
function showErrorState() {
    // Hide the main results container
    const resultsContainer = document.getElementById('resultsContainer');
    if (resultsContainer) {
        resultsContainer.style.display = 'none';
    }
    
    // Show instruction message and hide error message
    const instructionMessage = document.getElementById('instructionMessage');
    const errorMessage = document.getElementById('errorMessage');
    if (instructionMessage) instructionMessage.style.display = 'block';
    if (errorMessage) errorMessage.style.display = 'none';
    
    // Disable store button
    const storeButton = document.getElementById('storeButton');
    if (storeButton) {
        storeButton.disabled = true;
    }
    
    updateElementDisplay('resultshow70', 'block');
    updateElementDisplay('resultshowblending', 'none');
    updateElementDisplay('resultshow71', 'none');
}

function showSuccessState(calculations) {
    // Show the main results container
    const resultsContainer = document.getElementById('resultsContainer');
    if (resultsContainer) {
        resultsContainer.style.display = 'block';
        // Trigger results animation
        setTimeout(() => {
            const resultItems = document.querySelectorAll('.result-item');
            resultItems.forEach((item, index) => {
                setTimeout(() => {
                    item.classList.add('animate-slide-in-up');
                }, index * 50);
            });
        }, 100);
    }
    
    // Hide instruction message and error message
    const instructionMessage = document.getElementById('instructionMessage');
    const errorMessage = document.getElementById('errorMessage');
    if (instructionMessage) instructionMessage.style.display = 'none';
    if (errorMessage) errorMessage.style.display = 'none';
    
    // Enable store button
    const storeButton = document.getElementById('storeButton');
    if (storeButton) {
        storeButton.disabled = false;
    }
    
    updateElementDisplay('resultshow70', 'none');
    updateElementDisplay('resultshow71', 'block');
    updateElementDisplay('resultshowblending', 'block');
    
    // Update badges with professional formatting
    updateElement('blended-coal-perunitcost', `Per Unit Cost: Rs. ${calculations.comparisonResult.toFixed(4)}`);
    updateElement('blended-coal-addlfinancialliability', 
        `Addl. Financial Liability: Rs. ${formatIndianStyleNumber(calculations.additionalFinancialLiability)}`);
}

function updateElementDisplay(id, display) {
    const element = document.getElementById(id);
    if (element) {
        element.style.display = display;
    }
}

function showBlendingBadges() {
    // This function can be used for additional badge functionality
    calculateBlendedCoalEnergyCharges();
}

// Professional stored calculations management
function initializeStoredCalculations() {
    updateStoredCalculationsDisplay();
}

function autoSaveCalculation(inputs, calculations) {
    const calculation = {
        id: calculationCounter++,
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleDateString('en-IN'),
        time: new Date().toLocaleTimeString('en-IN'),
        inputs: { ...inputs },
        results: {
            comparisonResult: calculations.comparisonResult,
            additionalFinancialLiability: calculations.additionalFinancialLiability,
            energyChargesAfterBlending: calculations.energyChargesAfterBlending
        },
        coalNames: {
            coalA: document.getElementById('coalA-blending-name').value || 'Indigenous Coal',
            coalB: document.getElementById('coalB-blending-name').value || 'Imported Coal'
        }
    };
    
    storedCalculations.unshift(calculation);
    if (storedCalculations.length > 10) {
        storedCalculations = storedCalculations.slice(0, 10);
    }
    
    localStorage.setItem('blendingCalculations', JSON.stringify(storedCalculations));
    localStorage.setItem('blendingCalculationCounter', calculationCounter.toString());
    updateStoredCalculationsDisplay();
}

// Manual store calculation function
function storeCalculation() {
    try {
        console.log('storeCalculation() called');
        
        // Get current input values and validate
        const inputs = {
            gcvArbindian: parseFloat(document.getElementById("gcv-arb-Indian").value) || 0,
            coalCostIndian: parseFloat(document.getElementById("coal-cost-indian").value) || 0,
            railwayFreightIndian: parseFloat(document.getElementById("railway-freight-indian").value) || 0,
            gcvArbimported: parseFloat(document.getElementById("gcv-arb-Imported").value) || 0,
            coalCostImported: parseFloat(document.getElementById("coal-cost-imported").value) || 0,
            railwayFreightImported: parseFloat(document.getElementById("railway-freight-imported").value) || 0,
            generationcapacityblended: parseFloat(document.getElementById("generationcapacity-blended").value) || 0,
            plfblended: Math.min(parseFloat(document.getElementById("plf-blended").value) || 0, 100),
            daysblended: parseFloat(document.getElementById("days-blended").value) || 0,
            shrblended: parseFloat(document.getElementById("shr-blended").value) || 0,
            blendingRatio: parseFloat(document.getElementById("blending-ratio").value) || 0
        };

        // Validation
        if (inputs.gcvArbindian <= 0 || inputs.coalCostIndian < 0 || inputs.railwayFreightIndian < 0 ||
            inputs.gcvArbimported <= 0 || inputs.coalCostImported < 0 || inputs.railwayFreightImported < 0 ||
            inputs.generationcapacityblended <= 0 || inputs.plfblended < 0 || inputs.plfblended > 100 ||
            inputs.daysblended <= 0 || inputs.shrblended <= 0 || 
            inputs.blendingRatio < 0 || inputs.blendingRatio > 100) {
            showNotification('Please fill all required fields with valid values before storing', 'warning');
            return;
        }

        // Create calculation name
        const coalAName = document.getElementById('coalA-blending-name').value || 'Indigenous Coal';
        const coalBName = document.getElementById('coalB-blending-name').value || 'Imported Coal';
        const calculationName = prompt(`Enter a name for this calculation:`) || `${coalAName} vs ${coalBName} - ${new Date().toLocaleDateString('en-IN')}`;
        
        if (!calculationName.trim()) {
            showNotification('Calculation name is required', 'warning');
            return;
        }

        // Perform calculations
        const calculations = performBlendingCalculations(inputs);

        // Create calculation object with name
        const calculation = {
            id: calculationCounter++,
            name: calculationName.trim(),
            timestamp: new Date().toISOString(),
            date: new Date().toLocaleDateString('en-IN'),
            time: new Date().toLocaleTimeString('en-IN'),
            inputs: { ...inputs },
            results: {
                comparisonResult: calculations.comparisonResult,
                additionalFinancialLiability: calculations.additionalFinancialLiability,
                energyChargesAfterBlending: calculations.energyChargesAfterBlending,
                gcvBlended: calculations.gcvBlended,
                landedCostBlended: calculations.landedCostBlended
            },
            coalNames: {
                coalA: coalAName,
                coalB: coalBName
            }
        };
        
        // Store the calculation
        storedCalculations.unshift(calculation);
        if (storedCalculations.length > 15) {
            storedCalculations = storedCalculations.slice(0, 15);
        }
        
        localStorage.setItem('blendingCalculations', JSON.stringify(storedCalculations));
        localStorage.setItem('blendingCalculationCounter', calculationCounter.toString());
        updateStoredCalculationsDisplay();

        showNotification(`Calculation "${calculation.name}" stored successfully!`, 'success');
        
    } catch (error) {
        console.error('Store calculation error:', error);
        showNotification('Failed to store calculation. Please try again.', 'error');
    }
}

function updateStoredCalculationsDisplay() {
    const container = document.getElementById('storedCalculationsList');
    const counter = document.getElementById('storageCounter');
    
    // Update counter
    if (counter) {
        counter.textContent = storedCalculations.length;
        if (storedCalculations.length === 0) {
            counter.style.display = 'none';
        } else {
            counter.style.display = 'flex';
        }
    }
    
    if (!container) return;
    
    if (storedCalculations.length === 0) {
        container.innerHTML = '<p class="text-muted">No stored calculations yet.</p>';
        return;
    }
    
    container.innerHTML = storedCalculations.map(calc => `
        <div class="stored-calc-item" data-calc-id="${calc.id}">
            <div class="calc-header">
                <strong>${calc.name || calc.coalNames.coalA + ' vs ' + calc.coalNames.coalB}</strong>
                <small class="text-muted">${calc.date} ${calc.time}</small>
            </div>
            <div class="calc-summary">
                <span class="badge bg-primary">Blending: ${calc.inputs.blendingRatio}%</span>
                <span class="badge bg-success">Cost: Rs.${calc.results.comparisonResult.toFixed(4)}</span>
            </div>
            <div class="calc-actions">
                <button class="btn btn-sm btn-outline-primary" onclick="loadCalculation(${calc.id})">
                    <i class="fas fa-upload"></i> Load
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCalculation(${calc.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function loadCalculation(calcId) {
    const calc = storedCalculations.find(c => c.id === calcId);
    if (!calc) return;
    
    // Load all input values with proper mapping
    const fieldMapping = {
        'gcvArbindian': 'gcv-arb-Indian',
        'coalCostIndian': 'coal-cost-indian',
        'railwayFreightIndian': 'railway-freight-indian',
        'gcvArbimported': 'gcv-arb-Imported',
        'coalCostImported': 'coal-cost-imported',
        'railwayFreightImported': 'railway-freight-imported',
        'generationcapacityblended': 'generationcapacity-blended',
        'plfblended': 'plf-blended',
        'daysblended': 'days-blended',
        'shrblended': 'shr-blended',
        'blendingRatio': 'blending-ratio'
    };
    
    Object.entries(calc.inputs).forEach(([key, value]) => {
        const elementId = fieldMapping[key];
        if (elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value;
            }
        }
    });
    
    // Load coal names
    document.getElementById('coalA-blending-name').value = calc.coalNames.coalA;
    document.getElementById('coalB-blending-name').value = calc.coalNames.coalB;
    
    // Recalculate
    calculateBlendedCoalEnergyCharges();
    
    // Hide stored calculations
    toggleStoredCalculations();
    
    // Show success notification
    showNotification('Calculation loaded successfully!', 'success');
}

function deleteCalculation(calcId) {
    storedCalculations = storedCalculations.filter(c => c.id !== calcId);
    localStorage.setItem('blendingCalculations', JSON.stringify(storedCalculations));
    updateStoredCalculationsDisplay();
    showNotification('Calculation deleted', 'warning');
}


// Professional UI functions
function toggleFormulas() {
    const sidebar = document.getElementById('formulaSidebar');
    if (sidebar) {
        sidebar.classList.toggle('active');
    }
}

function toggleExportOptions() {
    const dropdown = document.getElementById('exportDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}

function toggleStoredCalculations() {
    const container = document.getElementById('storedCalculationsContainer');
    if (container) {
        const isVisible = container.style.display !== 'none';
        container.style.display = isVisible ? 'none' : 'block';
    }
}

// Clear form function for the clear button
function clearForm() {
    clearAllInputs();
}

function clearAllInputs() {
    if (confirm('Are you sure you want to clear all inputs?')) {
        const inputs = document.querySelectorAll('input[type="number"], input[type="text"]');
        inputs.forEach(input => {
            if (!input.hasAttribute('data-keep-value')) {
                input.value = '';
            }
        });
        
        // Reset coal names
        document.getElementById('coalA-blending-name').value = '';
        document.getElementById('coalB-blending-name').value = '';
        document.getElementById('coalA-header').textContent = 'Indigenous Coal';
        document.getElementById('coalB-header').textContent = 'Imported Coal';
        
        // Hide results
        showErrorState();
        
        showNotification('All inputs cleared', 'info');
    }
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification-toast`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        animation: slideInRight 0.3s ease;
    `;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Professional PDF Export
function exportToPDF() {
    try {
        // Check if results are available
        const resultsContainer = document.getElementById('resultsContainer');
        if (!resultsContainer || resultsContainer.style.display === 'none') {
            showNotification('Please calculate results before exporting PDF.', 'warning');
            return;
        }

        showNotification('Generating PDF...', 'info');

        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
            showNotification('PDF library not loaded. Please refresh and try again.', 'error');
            return;
        }
        
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Header
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('Coal Blending Analysis Report', 20, 25);
        
        // Timestamp
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Generated on: ${new Date().toLocaleString('en-IN')}`, 20, 35);
        
        // Get coal names
        const coalAName = document.getElementById('coalA-blending-name').value || 'Indigenous Coal';
        const coalBName = document.getElementById('coalB-blending-name').value || 'Imported Coal';
        
        // Coal Properties table
        const coalPropertiesData = getCoalPropertiesDataForPDF();
        if (coalPropertiesData.length > 0) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Coal Properties', 20, 50);
            
            doc.autoTable({
                startY: 55,
                head: [['Parameter', coalAName, coalBName, 'Unit']],
                body: coalPropertiesData,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [52, 58, 64] }
            });
        }
        
        // Plant Parameters table
        const plantParametersData = getPlantParametersDataForPDF();
        if (plantParametersData.length > 0) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Plant Parameters', 20, doc.lastAutoTable.finalY + 15);
            
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 20,
                head: [['Parameter', 'Value', 'Unit']],
                body: plantParametersData,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [52, 58, 64] }
            });
        }
        
        // Analysis Results table
        const resultsData = getResultsDataForPDF();
        if (resultsData.length > 0) {
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Analysis Results', 20, doc.lastAutoTable.finalY + 15);
            
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 20,
                head: [['Parameter', coalAName, coalBName, 'Blended Coal', 'Unit']],
                body: resultsData,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [52, 58, 64] }
            });
        }
        
        // Key findings
        const comparisonResult = parseFloat(document.getElementById('comparison-result').innerText || '0');
        const additionalLiability = document.getElementById('additionalFinancialLiabilityImported-result').innerText || '0';
        
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('Key Findings', 20, doc.lastAutoTable.finalY + 15);
        
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 20,
            body: [
                ['Increase in Per Unit Cost', `Rs. ${comparisonResult.toFixed(4)}/kWh`],
                ['Additional Financial Liability', `Rs. ${additionalLiability}`]
            ],
            theme: 'grid',
            styles: { fontSize: 10 },
            columnStyles: {
                0: { fontStyle: 'bold', fillColor: [248, 249, 250] }
            }
        });
        
        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.text(`Page ${i} of ${pageCount}`, 20, 285);
            doc.text('Generated by Professional Coal Blending Analysis Tool', 120, 285);
        }
        
        // Save the PDF
        const fileName = `Coal_Blending_Analysis_${coalAName}_vs_${coalBName}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        showNotification('PDF exported successfully!', 'success');
        
    } catch (error) {
        console.error('PDF export error:', error);
        showNotification('Error exporting PDF. Please try again.', 'warning');
    }
}

// Professional JPG Export with structured data like PDF
function exportToJPG() {
    try {
        // Check if results are available first
        const resultsContainer = document.getElementById('resultsContainer');
        if (!resultsContainer || resultsContainer.style.display === 'none') {
            showNotification('Please calculate results before exporting JPG.', 'warning');
            return;
        }

        showNotification('Generating high-quality image...', 'info');
        
        // Get coal names
        const coalAName = document.getElementById('coalA-blending-name').value || 'Indigenous Coal';
        const coalBName = document.getElementById('coalB-blending-name').value || 'Imported Coal';
        
        // Create A4 portrait container with professional layout
        const exportContainer = document.createElement('div');
        exportContainer.style.cssText = `
            background: #ffffff !important;
            width: 794px !important;
            min-height: 1123px !important;
            padding: 25px !important;
            margin: 0 auto !important;
            font-family: 'Arial', 'Helvetica', sans-serif !important;
            color: #2c3e50 !important;
            box-sizing: border-box !important;
            position: relative !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: 0 0 20px rgba(0,0,0,0.1) !important;
        `;
        
        // Professional header section
        const headerSection = document.createElement('div');
        headerSection.style.cssText = `
            text-align: center !important;
            padding-bottom: 20px !important;
            border-bottom: 3px solid #3498db !important;
            margin-bottom: 25px !important;
        `;
        
        const title = document.createElement('h1');
        title.textContent = 'Coal Blending Analysis Report';
        title.style.cssText = `
            color: #2c5aa0 !important;
            margin: 0 0 10px 0 !important;
            font-size: 26px !important;
            font-weight: bold !important;
            letter-spacing: 1px !important;
        `;
        
        const timestamp = document.createElement('p');
        timestamp.textContent = `Generated on: ${new Date().toLocaleString('en-IN')}`;
        timestamp.style.cssText = `
            color: #7f8c8d !important;
            margin: 5px 0 !important;
            font-size: 13px !important;
            font-weight: 500 !important;
        `;
        
        headerSection.appendChild(title);
        headerSection.appendChild(timestamp);
        exportContainer.appendChild(headerSection);
        
        // Optimized table styling function with full width utilization
        const getTableStyle = () => `
            width: 100% !important;
            border-collapse: collapse !important;
            margin-bottom: 22px !important;
            font-size: 11px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            table-layout: fixed !important;
        `;
        
        const getHeaderStyle = () => `
            background: linear-gradient(135deg, #34495e, #2c3e50) !important;
            color: white !important;
            padding: 10px 6px !important;
            text-align: center !important;
            font-weight: bold !important;
            font-size: 10px !important;
            word-wrap: break-word !important;
        `;
        
        const getCellStyle = (isEven = false) => `
            border: 1px solid #ecf0f1 !important;
            padding: 8px 6px !important;
            text-align: center !important;
            font-size: 10px !important;
            background: ${isEven ? '#f8f9fa' : 'white'} !important;
            color: #2c3e50 !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        `;
        
        const getSectionTitleStyle = () => `
            color: #2c5aa0 !important;
            margin: 18px 0 10px 0 !important;
            font-size: 16px !important;
            font-weight: bold !important;
            padding: 6px 0 !important;
            border-left: 4px solid #3498db !important;
            padding-left: 10px !important;
        `;

        // Coal Properties Table with improved layout
        const coalPropertiesSection = document.createElement('div');
        const coalPropsTitle = document.createElement('h2');
        coalPropsTitle.textContent = 'Coal Properties';
        coalPropsTitle.style.cssText = getSectionTitleStyle();
        
        const coalPropsTable = document.createElement('table');
        coalPropsTable.style.cssText = getTableStyle();
        
        // Use same data as PDF
        const coalPropertiesData = getCoalPropertiesDataForPDF();
        const coalPropsRows = coalPropertiesData.map((row, index) => {
            const isEven = index % 2 === 0;
            return `
                <tr>
                    <td style="${getCellStyle(isEven)} width: 40% !important; font-weight: 600 !important; text-align: left !important; padding-left: 12px !important;">${row[0]}</td>
                    <td style="${getCellStyle(isEven)} width: 25% !important;">${row[1]}</td>
                    <td style="${getCellStyle(isEven)} width: 25% !important;">${row[2]}</td>
                    <td style="${getCellStyle(isEven)} width: 10% !important; font-style: italic !important; color: #7f8c8d !important; font-size: 9px !important;">${row[3]}</td>
                </tr>
            `;
        }).join('');
        
        coalPropsTable.innerHTML = `
            <thead>
                <tr>
                    <th style="${getHeaderStyle()} width: 40% !important;">Parameter</th>
                    <th style="${getHeaderStyle()} width: 25% !important;">${coalAName}</th>
                    <th style="${getHeaderStyle()} width: 25% !important;">${coalBName}</th>
                    <th style="${getHeaderStyle()} width: 10% !important;">Unit</th>
                </tr>
            </thead>
            <tbody>
                ${coalPropsRows}
            </tbody>
        `;
        
        coalPropertiesSection.appendChild(coalPropsTitle);
        coalPropertiesSection.appendChild(coalPropsTable);
        exportContainer.appendChild(coalPropertiesSection);

        // Plant Parameters Table
        const plantParamsSection = document.createElement('div');
        const plantParamsTitle = document.createElement('h2');
        plantParamsTitle.textContent = 'Plant Parameters';
        plantParamsTitle.style.cssText = getSectionTitleStyle();
        
        const plantParamsTable = document.createElement('table');
        plantParamsTable.style.cssText = getTableStyle();
        
        // Use same data as PDF
        const plantParametersData = getPlantParametersDataForPDF();
        const plantParamsRows = plantParametersData.map((row, index) => {
            const isEven = index % 2 === 0;
            return `
                <tr>
                    <td style="${getCellStyle(isEven)} width: 60% !important; font-weight: 600 !important; text-align: left !important; padding-left: 12px !important;">${row[0]}</td>
                    <td style="${getCellStyle(isEven)} width: 25% !important;">${row[1]}</td>
                    <td style="${getCellStyle(isEven)} width: 15% !important; font-style: italic !important; color: #7f8c8d !important; font-size: 9px !important;">${row[2]}</td>
                </tr>
            `;
        }).join('');
        
        plantParamsTable.innerHTML = `
            <thead>
                <tr>
                    <th style="${getHeaderStyle()} width: 60% !important;">Parameter</th>
                    <th style="${getHeaderStyle()} width: 25% !important;">Value</th>
                    <th style="${getHeaderStyle()} width: 15% !important;">Unit</th>
                </tr>
            </thead>
            <tbody>
                ${plantParamsRows}
            </tbody>
        `;
        
        plantParamsSection.appendChild(plantParamsTitle);
        plantParamsSection.appendChild(plantParamsTable);
        exportContainer.appendChild(plantParamsSection);
        
        // Analysis Results Table with compact design
        const resultsSection = document.createElement('div');
        const resultsTitle = document.createElement('h2');
        resultsTitle.textContent = 'Analysis Results';
        resultsTitle.style.cssText = getSectionTitleStyle();
        
        const resultsTable = document.createElement('table');
        resultsTable.style.cssText = getTableStyle();
        
        // Use same data as PDF
        const resultsData = getResultsDataForPDF();
        const resultsRows = resultsData.map((row, index) => {
            const isEven = index % 2 === 0;
            return `
                <tr>
                    <td style="${getCellStyle(isEven)} width: 32% !important; font-weight: 600 !important; text-align: left !important; font-size: 9px !important; padding-left: 8px !important;">${row[0]}</td>
                    <td style="${getCellStyle(isEven)} width: 17% !important; font-size: 9px !important;">${row[1]}</td>
                    <td style="${getCellStyle(isEven)} width: 17% !important; font-size: 9px !important;">${row[2]}</td>
                    <td style="${getCellStyle(isEven)} width: 17% !important; font-weight: bold !important; background: ${isEven ? '#e8f4fd' : '#f0f8ff'} !important; color: #2c5aa0 !important; font-size: 9px !important;">${row[3]}</td>
                    <td style="${getCellStyle(isEven)} width: 17% !important; font-style: italic !important; color: #7f8c8d !important; font-size: 8px !important;">${row[4]}</td>
                </tr>
            `;
        }).join('');
        
        resultsTable.innerHTML = `
            <thead>
                <tr>
                    <th style="${getHeaderStyle()} width: 32% !important;">Parameter</th>
                    <th style="${getHeaderStyle()} width: 17% !important;">${coalAName}</th>
                    <th style="${getHeaderStyle()} width: 17% !important;">${coalBName}</th>
                    <th style="${getHeaderStyle()} width: 17% !important;">Blended</th>
                    <th style="${getHeaderStyle()} width: 17% !important;">Unit</th>
                </tr>
            </thead>
            <tbody>
                ${resultsRows}
            </tbody>
        `;
        
        resultsSection.appendChild(resultsTitle);
        resultsSection.appendChild(resultsTable);
        exportContainer.appendChild(resultsSection);
        
        // Key Findings - Enhanced presentation
        const findingsSection = document.createElement('div');
        const findingsTitle = document.createElement('h2');
        findingsTitle.textContent = 'Key Findings';
        findingsTitle.style.cssText = getSectionTitleStyle();
        
        const comparisonResult = parseFloat(document.getElementById('comparison-result')?.innerText || '0');
        const additionalLiability = document.getElementById('additionalFinancialLiabilityImported-result')?.innerText || '0';
        
        const findingsTable = document.createElement('table');
        findingsTable.style.cssText = getTableStyle();
        findingsTable.innerHTML = `
            <tbody>
                <tr>
                    <td style="${getCellStyle()} width: 50% !important; font-weight: bold !important; text-align: left !important; background: #e8f4fd !important; color: #2c5aa0 !important;">Increase in Per Unit Cost</td>
                    <td style="${getCellStyle()} width: 50% !important; font-weight: bold !important; color: #e74c3c !important;">Rs. ${comparisonResult.toFixed(4)}/kWh</td>
                </tr>
                <tr>
                    <td style="${getCellStyle(true)} width: 50% !important; font-weight: bold !important; text-align: left !important; background: #e8f4fd !important; color: #2c5aa0 !important;">Additional Financial Liability</td>
                    <td style="${getCellStyle(true)} width: 50% !important; font-weight: bold !important; color: #e74c3c !important;">Rs. ${additionalLiability}</td>
                </tr>
            </tbody>
        `;
        
        findingsSection.appendChild(findingsTitle);
        findingsSection.appendChild(findingsTable);
        exportContainer.appendChild(findingsSection);
        
        // Professional footer
        const footer = document.createElement('div');
        footer.style.cssText = `
            position: absolute !important;
            bottom: 20px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            text-align: center !important;
            color: #95a5a6 !important;
            font-size: 12px !important;
            border-top: 1px solid #ecf0f1 !important;
            padding-top: 10px !important;
            width: calc(100% - 60px) !important;
        `;
        footer.innerHTML = `
            <strong>Professional Coal Blending Analysis Tool</strong><br>
            <small>Advanced Energy Economics & Environmental Analysis</small>
        `;
        exportContainer.appendChild(footer);
        
        // Add to DOM temporarily
        document.body.appendChild(exportContainer);
        
        // High-quality rendering
        html2canvas(exportContainer, {
            scale: 2.5,
            useCORS: true,
            backgroundColor: '#ffffff',
            logging: false,
            allowTaint: false,
            imageTimeout: 15000,
            width: 794,
            height: 1123,
        }).then(canvas => {
            // Clean up DOM
            document.body.removeChild(exportContainer);
            
            // Create download
            const link = document.createElement('a');
            link.download = `Coal_Blending_Analysis_${coalAName.replace(/[^a-zA-Z0-9]/g, '_')}_vs_${coalBName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
            
            showNotification('High-quality JPG exported successfully!', 'success');
        }).catch(error => {
            console.error('Canvas rendering error:', error);
            // Clean up on error
            if (document.body.contains(exportContainer)) {
                document.body.removeChild(exportContainer);
            }
            showNotification('Error generating image. Please try again.', 'error');
        });
    } catch (error) {
        console.error('JPG export error:', error);
        showNotification('Error exporting JPG. Please try again.', 'error');
    }
}

// Helper functions for optimized table creation
// Helper functions for PDF export with separate table structures
function getCoalPropertiesDataForPDF() {
    const coalProperties = [
        ['GCV (ARB)', 'gcv-arb-Indian', 'gcv-arb-Imported', 'kcal/kg'],
        ['Coal Cost', 'coal-cost-indian', 'coal-cost-imported', 'Rs./MT'],
        ['Railway Freight', 'railway-freight-indian', 'railway-freight-imported', 'Rs./MT']
    ];
    
    return coalProperties.map(([param, id1, id2, unit]) => {
        const val1 = document.getElementById(id1)?.value || '-';
        const val2 = document.getElementById(id2)?.value || '-';
        return [param, val1, val2, unit];
    });
}

function getPlantParametersDataForPDF() {
    const plantParameters = [
        ['Generation Capacity', 'generationcapacity-blended', 'MW'],
        ['Plant Load Factor (PLF)', 'plf-blended', '%'],
        ['Operating Days', 'days-blended', 'days'],
        ['Station Heat Rate (SHR)', 'shr-blended', 'kcal/kWh'],
        ['Blending Ratio', 'blending-ratio', '%']
    ];
    
    return plantParameters.map(([param, id, unit]) => {
        const val = document.getElementById(id)?.value || '-';
        return [param, val, unit];
    });
}

function getResultsDataForPDF() {
    const results = [
        ['GCV (ARB)', 'gcv-arb-Indian-table', 'gcv-arb-Imported-tabel', 'gcv-blended', 'kcal/kg'],
        ['Landed Cost', 'indian-coal-landed-charges-MT', 'Imported-coal-landed-charges-MT', 'landed-cost-blended-MT', 'Rs./MT'],
        ['Landed Cost', 'indian-coal-landed-charges-MC', 'Imported-coal-landed-charges-MC', 'landed-cost-blended-MC', 'Rs./MCal'],
        ['Energy Charges', 'indian-coal-energy-charges', 'Imported-coal-energy-charges', 'blended-coal-energy-charges', 'Rs./kWh'],
        ['SCC', 'indian-coal-SCC', 'Imported-coal-SCC', 'blended-coal-SCC', 'kg/kWh']
    ];
    
    return results.map(([param, id1, id2, id3, unit]) => {
        const val1 = document.getElementById(id1)?.innerText || '-';
        const val2 = document.getElementById(id2)?.innerText || '-';
        const val3 = document.getElementById(id3)?.innerText || '-';
        return [param, val1, val2, val3, unit];
    });
}

// Helper functions for JPG export - A4 optimized with full width and separate tables
function createCoalPropertiesTableRows() {
    const coalData = [
        ['GCV (ARB)', 'gcv-arb-Indian', 'gcv-arb-Imported', 'kcal/kg'],
        ['Coal Cost', 'coal-cost-indian', 'coal-cost-imported', 'Rs./MT'],
        ['Railway Freight', 'railway-freight-indian', 'railway-freight-imported', 'Rs./MT']
    ];
    
    return coalData.map(([param, id1, id2, unit]) => {
        const val1 = document.getElementById(id1)?.value || '-';
        const val2 = document.getElementById(id2)?.value || '-';
        const style = 'border: 1px solid #ddd !important; padding: 6px !important; text-align: center !important; font-size: 10px !important; word-wrap: break-word !important;';
        const paramStyle = 'border: 1px solid #ddd !important; padding: 6px !important; text-align: left !important; font-weight: 500 !important; font-size: 10px !important; word-wrap: break-word !important;';
        return `
            <tr>
                <td style="${paramStyle}">${param}</td>
                <td style="${style}">${val1}</td>
                <td style="${style}">${val2}</td>
                <td style="${style}">${unit}</td>
            </tr>
        `;
    }).join('');
}

function createPlantParametersTableRows() {
    const plantData = [
        ['Generation Capacity', 'generationcapacity-blended', 'MW'],
        ['Plant Load Factor (PLF)', 'plf-blended', '%'],
        ['Operating Days', 'days-blended', 'days'],
        ['Station Heat Rate (SHR)', 'shr-blended', 'kcal/kWh'],
        ['Blending Ratio', 'blending-ratio', '%']
    ];
    
    return plantData.map(([param, id, unit]) => {
        const val = document.getElementById(id)?.value || '-';
        const style = 'border: 1px solid #ddd !important; padding: 6px !important; text-align: center !important; font-size: 10px !important; word-wrap: break-word !important;';
        const paramStyle = 'border: 1px solid #ddd !important; padding: 6px !important; text-align: left !important; font-weight: 500 !important; font-size: 10px !important; word-wrap: break-word !important;';
        return `
            <tr>
                <td style="${paramStyle}">${param}</td>
                <td style="${style}">${val}</td>
                <td style="${style}">${unit}</td>
            </tr>
        `;
    }).join('');
}

function createAnalysisResultsTableRows() {
    const results = [
        ['GCV (ARB)', 'gcv-arb-Indian-table', 'gcv-arb-Imported-tabel', 'gcv-blended', 'kcal/kg'],
        ['Landed Cost', 'indian-coal-landed-charges-MT', 'Imported-coal-landed-charges-MT', 'landed-cost-blended-MT', 'Rs./MT'],
        ['Landed Cost', 'indian-coal-landed-charges-MC', 'Imported-coal-landed-charges-MC', 'landed-cost-blended-MC', 'Rs./MCal'],
        ['Energy Charges', 'indian-coal-energy-charges', 'Imported-coal-energy-charges', 'blended-coal-energy-charges', 'Rs./kWh'],
        ['SCC', 'indian-coal-SCC', 'Imported-coal-SCC', 'blended-coal-SCC', 'kg/kWh']
    ];
    
    return results.map(([param, id1, id2, id3, unit]) => {
        const val1 = document.getElementById(id1)?.innerText || '-';
        const val2 = document.getElementById(id2)?.innerText || '-';
        const val3 = document.getElementById(id3)?.innerText || '-';
        const style = 'border: 1px solid #ddd !important; padding: 6px !important; text-align: center !important; font-size: 10px !important; word-wrap: break-word !important;';
        const paramStyle = 'border: 1px solid #ddd !important; padding: 6px !important; text-align: left !important; font-weight: 500 !important; font-size: 10px !important; word-wrap: break-word !important;';
        return `
            <tr>
                <td style="${paramStyle}">${param}</td>
                <td style="${style}">${val1}</td>
                <td style="${style}">${val2}</td>
                <td style="${style}">${val3}</td>
                <td style="${style}">${unit}</td>
            </tr>
        `;
    }).join('');
}

// Back Button Functionality
function goBack() {
    // Try to go back to parent window if opened from main app
    if (window.opener && !window.opener.closed) {
        try {
            // If opened from main app, switch focus back and close this tab
            window.opener.focus();
            // Call function to show calculators page in parent window
            if (typeof window.opener.showCalculatorsPage === 'function') {
                window.opener.showCalculatorsPage();
            }
            window.close();
        } catch (e) {
            // If cross-origin or other security issues, fallback to alert
            alert('Please use the browser back button or close this tab to return to the main application.');
        }
    } else {
        // If no parent window, try to navigate to main app
        try {
            window.location.href = 'index.html#calculators';
        } catch (e) {
            alert('Please use the browser back button to return to the main application.');
        }
    }
}

// Close export dropdown, stored calculations, and formula sidebar when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('exportDropdown');
    const storedCalcsContainer = document.getElementById('storedCalculationsContainer');
    const formulaSidebar = document.getElementById('formulaSidebar');
    const button = event.target.closest('.floating-btn');
    const closeBtn = event.target.closest('.close-btn');
    
    // Close export dropdown if clicking outside
    if (dropdown && !dropdown.contains(event.target) && !button) {
        dropdown.classList.remove('active');
    }
    
    // Close stored calculations if clicking outside
    if (storedCalcsContainer && storedCalcsContainer.style.display !== 'none' && 
        !storedCalcsContainer.contains(event.target) && !button) {
        storedCalcsContainer.style.display = 'none';
    }
    
    // Close formula sidebar if clicking outside
    if (formulaSidebar && formulaSidebar.classList.contains('active') && 
        !formulaSidebar.contains(event.target) && !button && !closeBtn) {
        formulaSidebar.classList.remove('active');
    }
});

// Add keyboard shortcuts
document.addEventListener('keydown', function(event) {
    if (event.ctrlKey || event.metaKey) {
        switch(event.key) {
            case 'p':
                event.preventDefault();
                exportToPDF();
                break;
            case 's':
                event.preventDefault();
                exportToJPG();
                break;
            case 'f':
                event.preventDefault();
                toggleFormulas();
                break;
        }
    }
});

// Clear All Stored Data Function
function clearAllStoredData() {
    if (confirm('Are you sure you want to clear all stored calculation data? This action cannot be undone.')) {
        try {
            // Clear localStorage
            localStorage.removeItem('coalBlendingCalculations');
            
            // Update display
            updateStoredCalculationsDisplay();
            updateStoredCalculationsCounter();
            
            // Show success message
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 500;
                animation: slideInRight 0.3s ease-out;
            `;
            toast.innerHTML = '<i class="fas fa-check-circle me-2"></i>All stored data cleared successfully!';
            document.body.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
            
        } catch (error) {
            console.error('Error clearing stored data:', error);
            alert('Error clearing stored data. Please try again.');
        }
    }
}

console.log('Professional Coal Blending Analysis loaded successfully!');
</script>
</body>
</html>
