<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alternate Fuel Cost Economics Calculator</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            },
            startup: {
                ready() {
                    MathJax.startup.defaultReady();
                    console.log('MathJax is loaded and ready!');
                }
            }
        };
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #a9f3f3 100%);
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.8s ease-in;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 1000;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .calculator-container {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            padding: 30px;
            width: 100%;
            max-width: 900px;
            margin: 60px auto 20px auto;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator-header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Animated Alternate Fuel Icon */
        .fuel-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            position: relative;
        }

        .fuel-container {
            position: relative;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-fuel-icon {
            font-size: 32px;
            color: #4CAF50;
            animation: fuelPulse 2s ease-in-out infinite;
            z-index: 2;
            position: relative;
        }

        .fuel-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .fuel-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #81C784, #4CAF50);
            border-radius: 50%;
            animation: particleFloat 3s ease-in-out infinite;
        }

        .fuel-particle:nth-child(1) {
            top: 10%;
            left: 20%;
            animation-delay: 0s;
            background: radial-gradient(circle, #FFB74D, #FF9800);
        }

        .fuel-particle:nth-child(2) {
            top: 20%;
            right: 15%;
            animation-delay: 0.5s;
            background: radial-gradient(circle, #81C784, #4CAF50);
        }

        .fuel-particle:nth-child(3) {
            bottom: 20%;
            left: 15%;
            animation-delay: 1s;
            background: radial-gradient(circle, #64B5F6, #2196F3);
        }

        .fuel-particle:nth-child(4) {
            bottom: 15%;
            right: 20%;
            animation-delay: 1.5s;
            background: radial-gradient(circle, #A1887F, #795548);
        }

        .rotating-ring {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 2px solid transparent;
            border-top: 2px solid rgba(76, 175, 80, 0.6);
            border-right: 2px solid rgba(255, 152, 0, 0.6);
            border-radius: 50%;
            animation: ringRotate 4s linear infinite;
        }

        @keyframes fuelPulse {
            0%, 100% {
                transform: scale(1);
                filter: brightness(1);
            }
            50% {
                transform: scale(1.1);
                filter: brightness(1.2);
            }
        }

        @keyframes particleFloat {
            0%, 100% {
                transform: translateY(0px) scale(1);
                opacity: 0.7;
            }
            33% {
                transform: translateY(-8px) scale(1.2);
                opacity: 1;
            }
            66% {
                transform: translateY(4px) scale(0.9);
                opacity: 0.8;
            }
        }

        @keyframes ringRotate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .calculator-title {
            color: white;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        

        .section-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
            margin: 5px 0 15px 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            border-left: 4px solid rgba(255, 255, 255, 0.6);
            padding-left: 15px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .input-row {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .input-label {
            color: white;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .input-group {
            display: flex;
            align-items: stretch;
            position: relative;
        }

        .input-group-prepend {
            display: flex;
            flex-shrink: 0;
        }

        .input-group-text1 {
            background: linear-gradient(135deg, #495057, #343a40);
            color: white;
            border: 1px solid #dee2e6;
            border-right: none;
            border-radius: 12px 0 0 12px;
            padding: 6px 12px;
            font-weight: 500;
            min-width: 240px;
            width: 240px;
            max-width: 240px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            line-height: 1.3;
            height: 45px;
            box-sizing: border-box;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .input-group-text1:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
        }

        .input-group-text2 {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-left: none;
            border-right: none;
            padding: 6px 10px;
            font-weight: bold;
            min-width: 80px;
            width: 80px;
            max-width: 80px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            line-height: 1.3;
            height: 45px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        .input-group-text2:hover {
            background: #f8f9fa;
        }

        .form-control {
            flex: 1;
            flex-shrink: 1;
            flex-grow: 1;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #dee2e6;
            border-left: none;
            border-radius: 0 12px 12px 0;
            min-width: 0;
            font-size: 15px;
            font-weight: 500;
            color: #333;
            outline: none;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            height: 45px;
            box-sizing: border-box;
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 1);
            border-color: #4a90e2;
            box-shadow: 0 4px 20px rgba(74, 144, 226, 0.4);
        }

        .form-control::placeholder {
            color: #6c757d;
            font-weight: 400;
        }

        .results-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-table {
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .results-table th {
            background: linear-gradient(135deg, #495057, #343a40);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            border: none;
        }

        .results-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-weight: 500;
            color: #333;
        }

        .results-table tbody tr:nth-child(even) td {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .results-table tbody tr:hover td {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .error-message {
            background: rgba(220, 53, 69, 0.15);
            color: #dc3545;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(220, 53, 69, 0.3);
            display: none;
        }

        .instruction-message {
            background: rgba(52, 73, 94, 0.9);
            color: #ffffff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(52, 73, 94, 0.8);
        }

        .result-badge {
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: 600;
            margin: 5px;
            display: inline-block;
        }

        .result-badge.success {
            background: rgba(39, 174, 96, 0.8);
            color: #ffffff;
            border: 1px solid #27ae60;
        }

        .result-badge.info {
            background: rgba(52, 73, 94, 0.8);
            color: #ffffff;
            border: 1px solid #34495e;
        }

        .floating-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(52, 73, 94, 0.9);
            border: 1px solid #34495e;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .floating-btn:hover {
            background: rgba(52, 73, 94, 1);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .calculation-counter {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .export-dropdown {
            position: fixed;
            bottom: 110px;
            right: 30px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
            min-width: 200px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
        }

        .export-dropdown.active {
            display: flex;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Night Mode Toggle Styles */
        .night-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #2196F3;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }

        /* Night Mode Styles */
        body.night-mode {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f0f23) !important;
            color: #e0e0e0 !important;
        }

        body.night-mode .calculator-container {
            background: rgba(26, 26, 46, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .calculator-header {
            background: linear-gradient(135deg, #2c2c54, #40407a) !important;
            border-radius: 15px !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            margin-bottom: 10px !important;
            padding: 5px !important;
        }

        body.night-mode .calculator-title {
            color: #ffffff !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5) !important;
        }

        body.night-mode .section-title {
            color: #ffffff !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5) !important;
            border-left: 4px solid rgba(255, 255, 255, 0.8) !important;
        }

        body.night-mode .input-section {
            background: rgba(40, 40, 60, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .form-group label {
            color: #b0b0b0 !important;
        }

        body.night-mode .form-control {
            background: rgba(40, 40, 60, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #e0e0e0 !important;
        }

        body.night-mode .form-control:focus {
            background: rgba(50, 50, 70, 0.9) !important;
            border-color: #4dabf7 !important;
            box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25) !important;
        }

        body.night-mode .input-group-text1 {
            background: linear-gradient(135deg, #2c2c54, #40407a) !important;
            color: #ffffff !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        body.night-mode .input-group-text1:hover {
            background: linear-gradient(135deg, #40407a, #4263eb) !important;
        }

        body.night-mode .input-group-text2 {
            background: rgba(40, 40, 60, 0.9) !important;
            color: #ffffff !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
            font-weight: bold !important;
        }

        body.night-mode .input-group-text2:hover {
            background: rgba(50, 50, 70, 0.9) !important;
            color: #ffffff !important;
        }

        body.night-mode .btn-primary {
            background: linear-gradient(135deg, #4263eb, #364fc7) !important;
            border-color: #364fc7 !important;
        }

        body.night-mode .btn-primary:hover {
            background: linear-gradient(135deg, #364fc7, #3b82f6) !important;
            border-color: #3b82f6 !important;
        }

        body.night-mode .results-section {
            background: rgba(26, 26, 46, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .results-header {
            background: linear-gradient(135deg, #2c2c54, #40407a) !important;
            color: #ffffff !important;
        }

        body.night-mode .results-grid .col-md-6 {
            background: rgba(40, 40, 60, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .result-item h6 {
            color: #b0b0b0 !important;
        }

        body.night-mode .result-value {
            color: #ffffff !important;
        }

        body.night-mode .back-button {
            background: rgba(26, 26, 46, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #e0e0e0 !important;
        }

        body.night-mode .back-button:hover {
            background: rgba(40, 40, 60, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.4) !important;
        }

        body.night-mode .export-btn {
            background: rgba(26, 26, 46, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #e0e0e0 !important;
        }

        body.night-mode .export-btn:hover {
            background: rgba(40, 40, 60, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
        }

        body.night-mode .analysis-table {
            background: rgba(26, 26, 46, 0.9) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        body.night-mode .analysis-table th {
            background: linear-gradient(135deg, #2c2c54, #40407a) !important;
            color: #ffffff !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        body.night-mode .analysis-table td {
            background: rgba(40, 40, 60, 0.6) !important;
            color: #e0e0e0 !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .plant-data {
            background: rgba(40, 40, 60, 0.6) !important;
            color: #e0e0e0 !important;
        }

        body.night-mode .error-message {
            background: rgba(220, 53, 69, 0.2) !important;
            border: 1px solid rgba(220, 53, 69, 0.4) !important;
            color: #f8d7da !important;
        }

        body.night-mode .instruction-message {
            background: rgba(13, 202, 240, 0.2) !important;
            border: 1px solid rgba(13, 202, 240, 0.4) !important;
            color: #b6effb !important;
        }

        /* Formula Sidebar Night Mode Styles */
        body.night-mode .formula-sidebar {
            background: rgba(26, 26, 46, 0.95) !important;
            border-left: 4px solid rgba(77, 171, 247, 0.6) !important;
            backdrop-filter: blur(20px) !important;
        }

        body.night-mode .formula-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
        }

        body.night-mode .formula-title {
            color: #ffffff !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5) !important;
        }

        body.night-mode .close-btn {
            background: rgba(40, 40, 60, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.4) !important;
            color: #ffffff !important;
        }

        body.night-mode .close-btn:hover {
            background: rgba(77, 171, 247, 0.3) !important;
            border-color: #4dabf7 !important;
        }

        body.night-mode .formula-item {
            background: rgba(40, 40, 60, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        body.night-mode .formula-expression {
            color: #e0e0e0 !important;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8) !important;
            font-weight: 600 !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            white-space: pre-wrap !important;
            word-break: break-after !important;
        }

        body.night-mode .formula-fallback {
            color: #b0b0b0 !important;
            font-weight: 500 !important;
        }

        body.night-mode .stored-calculations {
            background: rgba(40, 40, 60, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .stored-calc-item {
            background: rgba(26, 26, 46, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
        }

        body.night-mode .stored-calc-item:hover {
            background: rgba(77, 171, 247, 0.2) !important;
            border-color: #4dabf7 !important;
            transform: translateY(-2px) !important;
        }

        body.night-mode .calc-header {
            color: #ffffff !important;
        }

        body.night-mode .calc-details {
            color: #b0b0b0 !important;
        }

        body.night-mode .calc-actions button {
            background: rgba(40, 40, 60, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #e0e0e0 !important;
        }

        body.night-mode .calc-actions button:hover {
            background: rgba(77, 171, 247, 0.3) !important;
            border-color: #4dabf7 !important;
        }

        /* Night Mode Mobile Responsiveness */
        @media (max-width: 768px) {
            .night-mode-toggle {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
            }
            
            .toggle-label {
                font-size: 12px;
            }
            
            .toggle-switch {
                width: 40px;
                height: 20px;
            }
            
            .toggle-slider:before {
                height: 14px;
                width: 14px;
                left: 3px;
                bottom: 3px;
            }
            
            input:checked + .toggle-slider:before {
                transform: translateX(20px);
            }
        }

        /* Animation Styles */
        @keyframes slideInFromLeft {
            0% {
                transform: translateX(-100px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInFromRight {
            0% {
                transform: translateX(100px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInFromTop {
            0% {
                transform: translateY(-50px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInFromBottom {
            0% {
                transform: translateY(50px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes zoomIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes rotateIn {
            0% {
                transform: rotate(-10deg) scale(0.9);
                opacity: 0;
            }
            100% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }
        }

        @keyframes flipIn {
            0% {
                transform: rotateY(-90deg);
                opacity: 0;
            }
            100% {
                transform: rotateY(0deg);
                opacity: 1;
            }
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            70% {
                transform: scale(0.9);
                opacity: 0.9;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes pulseGrow {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }
            50% {
                transform: scale(1.02);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Animation Classes */
        .animate-slide-left {
            animation: slideInFromLeft 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }

        .animate-slide-right {
            animation: slideInFromRight 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }

        .animate-slide-top {
            animation: slideInFromTop 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }

        .animate-slide-bottom {
            animation: slideInFromBottom 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }

        .animate-zoom-in {
            animation: zoomIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }

        .animate-rotate-in {
            animation: rotateIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }

        .animate-flip-in {
            animation: flipIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }

        .animate-bounce-in {
            animation: bounceIn 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }

        .animate-pulse-grow {
            animation: pulseGrow 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
        }

        /* Staggered Animation Delays */
        .delay-0 { animation-delay: 0ms; }
        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }
        .delay-400 { animation-delay: 400ms; }
        .delay-500 { animation-delay: 500ms; }
        .delay-600 { animation-delay: 600ms; }
        .delay-700 { animation-delay: 700ms; }
        .delay-800 { animation-delay: 800ms; }
        .delay-900 { animation-delay: 900ms; }
        .delay-1000 { animation-delay: 1000ms; }
        .delay-1100 { animation-delay: 1100ms; }
        .delay-1200 { animation-delay: 1200ms; }

        /* Notification Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100px);
                opacity: 0;
            }
        }
        
        .export-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .export-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .formula-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-left: 4px solid rgba(255, 255, 255, 0.3);
            padding: 20px;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .formula-sidebar.active {
            right: 0;
        }

        .formula-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .formula-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .formula-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .formula-expression {
            color: #2c3e50;
            font-size: 14px;
            line-height: 1.6;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            word-break: break-after;
        }

        /* Formula wrapping specifically after equals sign */
        .formula-expression::after {
            content: '';
        }
        
        .formula-expression {
            /* Allow breaking after = sign */
            word-break: normal;
        }
        
        /* Custom formula display for better wrapping */
        .formula-expression .equals-break {
            display: inline-block;
            width: 100%;
        }

        /* MathJax formula styling and wrapping */
        .formula-expression .MathJax {
            max-width: 100% !important;
            overflow-wrap: break-word !important;
        }

        .formula-expression .MathJax_Display {
            text-align: left !important;
            margin: 0.5em 0 !important;
        }

        /* Responsive formula display */
        @media (max-width: 400px) {
            .formula-sidebar {
                width: 350px !important;
            }
            
            .formula-expression {
                font-size: 12px !important;
                line-height: 1.5 !important;
            }
            
            .formula-fallback {
                font-size: 11px !important;
                line-height: 1.4 !important;
            }
        }

        .formula-fallback {
            display: none;
            color: #34495e;
            font-size: 12px;
            margin-top: 8px;
            font-style: italic;
            font-weight: 500;
        }

        .stored-calculations {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .stored-calc-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stored-calc-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .calc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .calc-summary .badge {
            font-size: 10px;
            padding: 4px 8px;
        }

        .calc-actions {
            margin-top: 10px;
        }
        
        .stored-calculation-summary {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            line-height: 1.4;
        }

        .delete-btn {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .store-btn, .clear-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: 1px solid #20c997;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .store-btn-small, .clear-btn-small {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: 1px solid #20c997;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px 3px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            font-size: 13px;
        }

        .btn-small {
            padding: 6px 12px !important;
            margin: 5px 3px !important;
            border-radius: 6px !important;
            font-size: 13px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        }

        .clear-btn {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            border: 1px solid #fd7e14;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
        }

        .clear-btn-small {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
            border: 1px solid #fd7e14;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .store-btn:hover, .clear-btn:hover, .store-btn-small:hover, .clear-btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            * {
                box-sizing: border-box;
            }
            
            body {
                padding: 10px;
                overflow-x: hidden;
            }
            
            .calculator-container {
                padding: 20px 15px;
                margin: 60px 5px 20px 5px;
                width: calc(100vw - 10px);
                max-width: 100%;
                box-sizing: border-box;
            }

            .input-group {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }

            .input-group-text1 {
                min-width: 140px;
                width: 140px;
                max-width: 140px;
                font-size: 0.75rem;
                padding: 6px 8px;
                line-height: 1.2;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .input-group-text2 {
                min-width: 60px;
                width: 60px;
                max-width: 60px;
                font-size: 0.65rem;
                padding: 6px 4px;
            }
            
            .form-control {
                flex: 1;
                min-width: 0;
                width: auto;
                box-sizing: border-box;
            }

            .floating-actions {
                bottom: 20px;
                right: 20px;
            }

            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 18px;
            }

            .formula-sidebar {
                width: 100%;
                right: -100%;
                padding: 15px 10px;
            }

            .results-table {
                font-size: 12px;
                width: 100%;
                table-layout: auto;
            }

            .results-table th,
            .results-table td {
                padding: 8px 4px;
                font-size: 11px;
                white-space: nowrap;
            }

            .back-button {
                width: 40px;
                height: 40px;
                top: 10px;
                left: 10px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .calculator-container {
                padding: 15px 10px;
                margin: 60px 2px 20px 2px;
                width: calc(100vw - 4px);
            }
            
            .calculator-title {
                font-size: 20px;
                line-height: 1.3;
            }

            .input-group {
                flex-direction: row;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }

            .input-group-prepend {
                flex-shrink: 0;
                display: flex;
                max-width: 65%;
            }

            .input-group-text1 {
                border-radius: 8px 0 0 8px;
                width: 160px;
                min-width: 120px;
                max-width: 180px;
                flex: none;
                font-size: 0.7rem;
                padding: 6px 4px;
                line-height: 1.1;
                word-wrap: break-word;
                white-space: normal;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .input-group-text2 {
                border-radius: 0;
                width: 50px;
                min-width: 50px;
                max-width: 50px;
                font-size: 0.6rem;
                padding: 6px 2px;
                flex-shrink: 0;
            }

            .form-control {
                border-radius: 0 8px 8px 0;
                border: 1px solid #dee2e6;
                border-left: none;
                flex: 1;
                min-width: 0;
                width: auto;
                font-size: 14px;
                padding: 8px 10px;
            }
            
            .input-row {
                margin-bottom: 15px;
                width: 100%;
                box-sizing: border-box;
            }
            
            .input-section {
                width: 100%;
                padding: 15px 8px;
                box-sizing: border-box;
            }
            
            .results-table {
                font-size: 10px;
                width: 100%;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <!-- Night Mode Toggle -->
    <div class="night-mode-toggle animate-slide-top delay-0">
        <label class="toggle-switch">
            <input type="checkbox" id="nightModeToggle" onchange="toggleNightMode()">
            <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Night Mode</span>
    </div>
    
    <!-- Back Button -->
    <button class="back-button animate-zoom-in delay-100" onclick="goBack()" title="Back to Calculators">
        <i class="fas fa-arrow-left"></i>
    </button>
    <!-- Main Calculator Container -->
    <div class="calculator-container animate-slide-bottom delay-200">
        <!-- Header -->
        <div class="calculator-header animate-flip-in delay-300">
            <h1 class="calculator-title">
                <div class="fuel-icon">
                    <div class="fuel-container">
                        <div class="fuel-particles">
                            <div class="fuel-particle"></div>
                            <div class="fuel-particle"></div>
                            <div class="fuel-particle"></div>
                            <div class="fuel-particle"></div>
                        </div>
                        <div class="rotating-ring"></div>
                        <i class="fas fa-seedling main-fuel-icon"></i>
                    </div>
                </div>
                Alternate Fuel Cost Economics
            </h1>
        </div>

        <!-- Error/Instruction Messages -->
        <div class="error-message animate-slide-left delay-400" id="errorMessage"></div>
        <div class="instruction-message animate-slide-right delay-400" id="instructionMessage">
            <i class="fas fa-info-circle me-2"></i>
            Please fill in all the required fields to see the alternate fuel cost analysis results
        </div>

        <!-- Linked Coal Properties Section -->
        <h3 class="section-title animate-rotate-in delay-500">
            <i class="fas fa-fire me-2"></i>Linked Coal Properties
        </h3>

        <div class="input-section animate-slide-left delay-600">
            <div class="input-row">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text1">Annual Coal Requirement</span>
                        <span class="input-group-text2">MT</span>
                    </div>
                    <input type="number" class="form-control" id="acq-linked-coal" placeholder="1000000" step="0.01" min="0">
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text1">Landed Coal Cost</span>
                        <span class="input-group-text2">Rs/MCal</span>
                    </div>
                    <input type="number" class="form-control" id="landed-cost-linked" placeholder="1.25" step="0.01" min="0">
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text1">GCV Linked Coal</span>
                        <span class="input-group-text2">kcal/kg</span>
                    </div>
                    <input type="number" class="form-control" id="gcv-linked-coal" placeholder="4300" step="0.01" min="0">
                </div>
            </div>
        </div>

        <!-- Alternate Fuel Properties Section -->
        <h3 class="section-title animate-rotate-in delay-700">
            <i class="fas fa-leaf me-2"></i>Alternate Fuel Properties
        </h3>

        <div class="input-section animate-slide-right delay-800">
            <div class="input-row">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text1">Alternate Fuel %</span>
                        <span class="input-group-text2">%</span>
                    </div>
                    <input type="number" class="form-control" id="alternate-fuel-percentage" placeholder="5" step="0.01" min="0" max="100">
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text1">Landed Fuel Cost</span>
                        <span class="input-group-text2">Rs/MCal</span>
                    </div>
                    <input type="number" class="form-control" id="landed-cost-alternate" placeholder="2.25" step="0.01" min="0">
                </div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text1">GCV Alternate Fuel</span>
                        <span class="input-group-text2">kcal/kg</span>
                    </div>
                    <input type="number" class="form-control" id="gcv-alternate-fuel" placeholder="2800" step="0.01" min="0">
                </div>
            </div>
        </div>

        <!-- Plant Name Section -->
        <div class="input-section animate-zoom-in delay-850">
            <div class="input-row">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text1">Plant Name</span>
                    </div>
                    <input type="text" class="form-control" id="plant-name" placeholder="Enter plant name" maxlength="50" data-allow-text="true">
                </div>
            </div>
        </div>

        <!-- Add Plant Data Button -->
        <div class="text-center animate-pulse-grow delay-900">
            <button class="store-btn-small" onclick="addPlantToAnalysis()" id="addPlantButton">
                <i class="fas fa-plus me-1"></i>Add Plant
            </button>
            <button class="clear-btn-small" onclick="clearAllInputs()">
                <i class="fas fa-refresh me-1"></i>Clear Form
            </button>
            <button class="btn btn-warning btn-small" onclick="clearCurrentAnalysis()">
                <i class="fas fa-trash me-1"></i>Clear Table
            </button>
            <button class="btn btn-info btn-small" onclick="toggleAnalysisTable()" id="toggleTableButton">
                <i class="fas fa-eye me-1"></i>Hide Table
            </button>
        </div>

        <!-- Store Calculation Button -->
        <div class="text-center animate-bounce-in delay-900" style="margin-top: 15px;">
            <button class="store-btn-small" onclick="storeCalculation()" id="storeButton" disabled>
                <i class="fas fa-save me-1"></i>Store Analysis
            </button>
        </div>

        <!-- Results Section -->
        <div class="results-container" id="resultsContainer" style="display: none;">
            <h3 class="section-title">
                <i class="fas fa-chart-bar me-2"></i>Analysis Results
            </h3>

            <!-- Result Badges -->
            <div id="badgeContainer" class="mb-3"></div>

            <!-- Multi-Plant Analysis Table -->
            <div class="table-responsive" style="max-height: 600px; overflow-x: auto;">
                <table class="results-table table" id="multiPlantTable">
                    <thead>
                        <tr id="tableHeader">
                            <th class="sticky-column" style="position: sticky; left: 0; background-color: #2c3e50; color: white; z-index: 10;">Parameter</th>
                            <th style="min-width: 120px; background-color: #34495e; color: white;">Unit</th>
                            <!-- Plant columns will be added dynamically -->
                            <th class="total-column" style="background-color: #e74c3c; color: white;">Total/Average</th>
                        </tr>
                    </thead>
                    <tbody id="multiPlantTableBody">
                        <tr>
                            <td class="sticky-column" style="position: sticky; left: 0; background-color: #ecf0f1; font-weight: bold;">Annual Coal Requirement</td>
                            <td style="background-color: #ecf0f1;">MT</td>
                            <td class="total-column total-acq" style="background-color: #fadbd8; font-weight: bold;">-</td>
                        </tr>
                        <tr>
                            <td class="sticky-column" style="position: sticky; left: 0; background-color: #ecf0f1; font-weight: bold;">Landed Linked Coal Cost</td>
                            <td style="background-color: #ecf0f1;">Rs/MCal</td>
                            <td class="total-column avg-landed-cost" style="background-color: #fadbd8; font-weight: bold;">-</td>
                        </tr>
                        <tr>
                            <td class="sticky-column" style="position: sticky; left: 0; background-color: #ecf0f1; font-weight: bold;">GCV Linked Coal</td>
                            <td style="background-color: #ecf0f1;">kcal/kg</td>
                            <td class="total-column avg-gcv-linked" style="background-color: #fadbd8; font-weight: bold;">-</td>
                        </tr>
                        <tr>
                            <td class="sticky-column" style="position: sticky; left: 0; background-color: #ecf0f1; font-weight: bold;">Alternate Fuel %</td>
                            <td style="background-color: #ecf0f1;">%</td>
                            <td class="total-column avg-alt-fuel-pct" style="background-color: #fadbd8; font-weight: bold;">-</td>
                        </tr>
                        <tr>
                            <td class="sticky-column" style="position: sticky; left: 0; background-color: #ecf0f1; font-weight: bold;">Quantity of Linked Coal</td>
                            <td style="background-color: #ecf0f1;">MT</td>
                            <td class="total-column total-linked-coal-qty" style="background-color: #fadbd8; font-weight: bold;">-</td>
                        </tr>
                        <tr>
                            <td class="sticky-column" style="position: sticky; left: 0; background-color: #ecf0f1; font-weight: bold;">Quantity of Alternate Fuel</td>
                            <td style="background-color: #ecf0f1;">MT</td>
                            <td class="total-column total-alt-fuel-qty" style="background-color: #fadbd8; font-weight: bold;">-</td>
                        </tr>
                        <tr>
                            <td class="sticky-column" style="position: sticky; left: 0; background-color: #ecf0f1; font-weight: bold;">Landed Alternate Fuel Cost</td>
                            <td style="background-color: #ecf0f1;">Rs/MCal</td>
                            <td class="total-column avg-alt-fuel-cost" style="background-color: #fadbd8; font-weight: bold;">-</td>
                        </tr>
                        <tr>
                            <td class="sticky-column" style="position: sticky; left: 0; background-color: #ecf0f1; font-weight: bold;">GCV Alternate Fuel</td>
                            <td style="background-color: #ecf0f1;">kcal/kg</td>
                            <td class="total-column avg-gcv-alternate" style="background-color: #fadbd8; font-weight: bold;">-</td>
                        </tr>
                        <tr style="background-color: rgba(231, 76, 60, 0.1);">
                            <td class="sticky-column" style="position: sticky; left: 0; background-color: #e74c3c; color: white; font-weight: bold;">Weighted Average Cost</td>
                            <td style="background-color: #e74c3c; color: white; font-weight: bold;">Rs/MCal</td>
                            <td class="total-column weighted-avg-cost-total" style="background-color: #c0392b; color: white; font-weight: bold;">-</td>
                        </tr>
                        <tr style="background-color: rgba(231, 76, 60, 0.1);">
                            <td class="sticky-column" style="position: sticky; left: 0; background-color: #e74c3c; color: white; font-weight: bold;">Additional Financial Liability</td>
                            <td style="background-color: #e74c3c; color: white; font-weight: bold;">Rs Crore</td>
                            <td class="total-column total-liability" style="background-color: #c0392b; color: white; font-weight: bold;">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Stored Calculations -->
        <div class="stored-calculations" id="storedCalculationsContainer" style="display: none;">
            <h4 style="color: white; margin-bottom: 15px;">
                <i class="fas fa-database me-2"></i>Stored Calculations
            </h4>
            <div id="storedCalculationsList"></div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-actions">
        <button class="floating-btn" onclick="toggleStoredCalculations()" title="Stored Calculations">
            <i class="fas fa-database"></i>
            <span class="calculation-counter" id="calculationCounter">0</span>
        </button>
        <button class="floating-btn" onclick="toggleFormulas()" title="View Formulas">
            <span style="font-weight: bold; font-style: italic; font-size: 14px;">fx</span>
        </button>
        <button class="floating-btn" onclick="toggleExportOptions()" title="Export Options">
            <i class="fas fa-download"></i>
        </button>
    </div>

    <!-- Export Dropdown -->
    <div class="export-dropdown animate-slide-right delay-1100" id="exportDropdown">
        <button class="export-btn" onclick="exportToPDF()">
            <i class="fas fa-file-pdf text-danger"></i>
            Export as PDF
        </button>
        <button class="export-btn" onclick="exportToJPG()">
            <i class="fas fa-image text-primary"></i>
            Export as JPG
        </button>
    </div>

    <!-- Formula Sidebar -->
    <div class="formula-sidebar" id="formulaSidebar">
        <div class="formula-header">
            <h2 class="formula-title">Formulas</h2>
            <button class="close-btn" onclick="toggleFormulas()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Quantity of Alternate Fuel} = \text{ACQ} \times \frac{\text{AF Percentage}}{100}$$
                <div class="formula-fallback">Quantity of Alternate Fuel =<br>ACQ  (AF Percentage  100)</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Quantity of Linked Coal} = \text{ACQ} - \text{Quantity of Alternate Fuel}$$
                <div class="formula-fallback">Quantity of Linked Coal =<br>ACQ - Quantity of Alternate Fuel</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Energy Content} = \text{Quantity} \times \frac{\text{GCV}}{1000}$$
                <div class="formula-fallback">Energy Content =<br>Quantity  (GCV  1000)</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Total Cost} = \text{Energy Content} \times \text{Cost per MCal}$$
                <div class="formula-fallback">Total Cost =<br>Energy Content  Cost per MCal</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Additional Financial Liability} = \text{Total Cost (Mixed)} - \text{Total Cost (Linked Only)}$$
                <div class="formula-fallback">Additional Financial Liability =<br>Total Cost (Mixed) - Total Cost (Linked Only)</div>
            </div>
        </div>
    </div>

    <!-- Include necessary libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
                    
                    <div class="collapse" id="aflFormula">
                        <div class="card card-body mt-2 mb-1" style="width: fit-content;">
                            <em style="font-size: smaller;"> <b>Additional Financial Liability :</b> (Annual Coal Requriement x Percentage of Alternate Fuel) x [(Landed Cost of Alternate Fuel x GCV of Alternate Fuel) - (Landed cost of Linked Coal x GCV of Linked Coal)] / 10^9</em>
                        </div>
                    </div>
                    
         
<div class="table-responsive mt-2" id="aflTableContainer" style="display:none;">
  <table class="table table-bordered table-sm text-center align-middle CoalLinkageAdvance-table" id="aflTable">
    <thead class="table-dark">
      <tr id="aflTableHeaderRow">
        <th>Parameter</th>
        <!-- Plant columns will be added by JS -->
      </tr>
    </thead>
    <tbody id="aflTableBody">
      <!-- Parameter rows will be added by JS -->
    </tbody>
    <tfoot id="aflTableFooter">
      <!-- Totals will be added by JS -->
    </tfoot>
  </table>
</div>




                </div>
          
             


<!--- HTML for inputs ends here-->        

 
<!-- Include Bootstrap JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<!-- JavaScript for Professional Alternate Fuel Cost Economics -->
<script>
// Professional JavaScript with advanced features
window.MathJax = {
    tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
    },
    svg: {
        fontCache: 'global'
    },
    startup: {
        ready() {
            MathJax.startup.defaultReady();
            console.log('MathJax is loaded and ready!');
        }
    }
};

// Global variables for simple plant storage with browser compatibility
let plantStorageCounter = 1;

// Initialize simple plant storage with enhanced browser compatibility
function initializePlantStorage() {
    try {
        // Check if localStorage is available (for browser security restrictions)
        if (typeof(Storage) === "undefined" || !window.localStorage) {
            console.warn('localStorage not available - using session storage');
            return false;
        }
        
        const counter = localStorage.getItem('alternateFuelPlantCounter');
        if (counter && !isNaN(parseInt(counter))) {
            plantStorageCounter = parseInt(counter);
            console.log('Loaded plant storage counter:', plantStorageCounter);
        } else {
            // Initialize counter if not found
            plantStorageCounter = 1;
            localStorage.setItem('alternateFuelPlantCounter', '1');
        }
        return true;
    } catch (error) {
        console.error('Error accessing localStorage:', error);
        plantStorageCounter = 1;
        return false;
    }
}

// Get all stored plants with enhanced browser compatibility
function getAllStoredPlants() {
    const plants = [];
    try {
        if (typeof(Storage) === "undefined" || !window.localStorage) {
            console.warn('localStorage not available');
            return plants;
        }
        
        for (let i = 1; i < plantStorageCounter; i++) {
            const plantData = localStorage.getItem(`alternateFuelPlant_${i}`);
            if (plantData) {
                try {
                    const plant = JSON.parse(plantData);
                    plants.push({ srNo: i, ...plant });
                } catch (error) {
                    console.error(`Error parsing plant ${i}:`, error);
                }
            }
        }
    } catch (error) {
        console.error('Error accessing stored plants:', error);
    }
    return plants;
}

// Clear all stored plant data with enhanced browser compatibility
function clearAllStoredData() {
    if (confirm('Are you sure you want to clear all stored plant data? This cannot be undone.')) {
        try {
            if (typeof(Storage) === "undefined" || !window.localStorage) {
                console.warn('localStorage not available');
                showNotification('Storage not available in this browser', 'warning');
                return;
            }
            
            // Clear all plant entries
            for (let i = 1; i < plantStorageCounter; i++) {
                localStorage.removeItem(`alternateFuelPlant_${i}`);
            }
            // Reset counter to 1
            plantStorageCounter = 1;
            localStorage.setItem('alternateFuelPlantCounter', '1');
            
            updateStoredCalculationsDisplay();
            showNotification('All stored plant data cleared', 'success');
            console.log('All stored plant data cleared, counter reset to 1');
        } catch (error) {
            console.error('Error clearing stored data:', error);
            showNotification('Error clearing stored data', 'warning');
        }
    }
}

// Professional input validation
document.addEventListener('DOMContentLoaded', function () {
    function restrictNumericInput(input) {
        input.addEventListener('keydown', function (event) {
            const allowedKeys = [
                "Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab", "Home", "End"
            ];
            if (allowedKeys.includes(event.key)) return;

            if (event.key === "." && this.value.includes(".")) {
                event.preventDefault();
                return;
            }
            if (
                event.key === '-' || event.key === '+' || event.key === 'e' ||
                (!/^\d$/.test(event.key) && event.key !== ".")
            ) {
                event.preventDefault();
            }
        });

        input.addEventListener('paste', function (event) {
            const paste = (event.clipboardData || window.clipboardData).getData('text');
            if (!/^\d*\.?\d*$/.test(paste)) {
                event.preventDefault();
            }
        });

        input.addEventListener('blur', function () {
            const value = parseFloat(this.value.trim());
            if (isNaN(value) || value < 0) {
                this.value = "";
            }
        });
    }

    function applyUniversalNumericRestriction() {
        document.querySelectorAll('input:not([data-allow-text="true"])').forEach(input => {
            restrictNumericInput(input);
        });
    }

    applyUniversalNumericRestriction();
    
    // Initialize professional features
    initializePlantStorage(); // Initialize storage before other features
    initializeStoredCalculations();
    setupEventListeners();
    
    // Prevent form submission on Enter
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        });
    });
});

// Professional event listeners setup
function setupEventListeners() {
    const alternateFuelInputs = [
        "acq-linked-coal", "landed-cost-linked", "gcv-linked-coal",
        "alternate-fuel-percentage", "landed-cost-alternate", "gcv-alternate-fuel"
    ];

    alternateFuelInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', calculateAlternateFuelCostEconomics);
            input.addEventListener('input', showAlternateFuelBadges);
        }
    });

    // Enhanced input validation
    alternateFuelInputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('keydown', function(e) {
                if (
                    [46, 8, 9, 27, 13, 110, 190].indexOf(e.keyCode) !== -1 ||
                    ((e.ctrlKey || e.metaKey) && [65, 67, 86, 88, 90].indexOf(e.keyCode) !== -1) ||
                    (e.keyCode >= 35 && e.keyCode <= 39)
                ) {
                    return;
                }
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) &&
                    (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
                if (e.key === '-' || e.key === '+' || e.key === 'e') {
                    e.preventDefault();
                }
            });
            
            input.addEventListener('input', function() {
                if (parseFloat(input.value) < 0) input.value = '';
                
                // Auto-correct percentage if over 100
                if (id === 'alternate-fuel-percentage' && parseFloat(input.value) > 100) {
                    input.value = 100;
                }
            });
        }
    });
}

// Professional calculation function with enhanced features
function calculateAlternateFuelCostEconomics() {
    console.log('calculateAlternateFuelCostEconomics called');
    try {
        // Get input values with error handling
        const inputs = {
            acqLinkedCoal: parseFloat(document.getElementById("acq-linked-coal").value) || 0,
            landedCostLinked: parseFloat(document.getElementById("landed-cost-linked").value) || 0,
            gcvLinkedCoal: parseFloat(document.getElementById("gcv-linked-coal").value) || 0,
            alternateFuelPercentage: parseFloat(document.getElementById("alternate-fuel-percentage").value) || 0,
            landedCostAlternate: parseFloat(document.getElementById("landed-cost-alternate").value) || 0,
            gcvAlternateFuel: parseFloat(document.getElementById("gcv-alternate-fuel").value) || 0
        };

        console.log('Input values:', inputs);

        // Validation
        const requiredInputs = Object.values(inputs);
        if (requiredInputs.some(val => isNaN(val) || val <= 0)) {
            console.log('Validation failed - some inputs are invalid');
            showErrorState();
            return;
        }

        // Calculations with enhanced precision
        const calculations = performAlternateFuelCalculations(inputs);
        console.log('Calculations complete:', calculations);
        
        // Display results with professional formatting
        displayResults(calculations, inputs);
        
        // Show success state
        showSuccessState(calculations);
        
    } catch (error) {
        console.error('Calculation error:', error);
        showErrorState();
    }
}

// Enhanced calculation engine
function performAlternateFuelCalculations(inputs) {
    const {
        acqLinkedCoal, landedCostLinked, gcvLinkedCoal,
        alternateFuelPercentage, landedCostAlternate, gcvAlternateFuel
    } = inputs;

    // Basic calculations
    const afPercentage = alternateFuelPercentage / 100;
    const quantityAlternateFuel = acqLinkedCoal * afPercentage;
    const quantityLinkedCoal = acqLinkedCoal - quantityAlternateFuel;
    const totalQuantityMixed = acqLinkedCoal;

    // Energy content calculations (in Million Calories)
    const energyContentLinked = (quantityLinkedCoal * gcvLinkedCoal) / 1000;
    const energyContentAlternate = (quantityAlternateFuel * gcvAlternateFuel) / 1000;
    const totalEnergyContent = energyContentLinked + energyContentAlternate;

    // Cost calculations (in Crores)
    const totalCostLinked = (energyContentLinked * landedCostLinked) / 10000000; // Convert to crores
    const totalCostAlternate = (energyContentAlternate * landedCostAlternate) / 10000000; // Convert to crores
    const totalCostMixed = totalCostLinked + totalCostAlternate;

    // Cost calculation if only linked coal was used
    const totalEnergyIfOnlyLinked = (acqLinkedCoal * gcvLinkedCoal) / 1000;
    const totalCostIfOnlyLinked = (totalEnergyIfOnlyLinked * landedCostLinked) / 10000000;

    // Additional financial liability (multiplied by 1000)
    const additionalFinancialLiability = (totalCostMixed - totalCostIfOnlyLinked) * 1000;

    // Weighted average cost per MCal
    const weightedAvgCost = totalEnergyContent > 0 ? (totalCostMixed * 10000000) / totalEnergyContent : 0;

    return {
        quantityLinkedCoal, quantityAlternateFuel, totalQuantityMixed,
        energyContentLinked, energyContentAlternate, totalEnergyContent,
        totalCostLinked, totalCostAlternate, totalCostMixed,
        additionalFinancialLiability, weightedAvgCost,
        landedCostLinked, landedCostAlternate
    };
}

// Professional results display
function displayResults(calculations, inputs) {
    const {
        quantityLinkedCoal, quantityAlternateFuel, totalQuantityMixed,
        energyContentLinked, energyContentAlternate, totalEnergyContent,
        totalCostLinked, totalCostAlternate, totalCostMixed,
        additionalFinancialLiability, weightedAvgCost,
        landedCostLinked, landedCostAlternate
    } = calculations;

    // Update all display elements with professional formatting
    updateElement("quantity-linked-coal", quantityLinkedCoal.toFixed(2));
    updateElement("quantity-alternate-fuel", quantityAlternateFuel.toFixed(2));
    updateElement("total-quantity-mixed", totalQuantityMixed.toFixed(2));

    updateElement("cost-per-mcal-linked", landedCostLinked.toFixed(2));
    updateElement("cost-per-mcal-alternate", landedCostAlternate.toFixed(2));
    updateElement("weighted-avg-cost", weightedAvgCost.toFixed(2));

    updateElement("energy-content-linked", energyContentLinked.toFixed(2));
    updateElement("energy-content-alternate", energyContentAlternate.toFixed(2));
    updateElement("total-energy-content", totalEnergyContent.toFixed(2));

    updateElement("total-cost-linked", totalCostLinked.toFixed(2));
    updateElement("total-cost-alternate", totalCostAlternate.toFixed(2));
    updateElement("total-cost-mixed", totalCostMixed.toFixed(2));

    updateElement("additional-financial-liability", additionalFinancialLiability.toFixed(2));
}

// Utility functions
function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.innerText = value;
    }
}

function formatIndianStyleNumber(num) {
    if (isNaN(num)) return "0";
    return new Intl.NumberFormat('en-IN', {
        maximumFractionDigits: 2,
        minimumFractionDigits: 0
    }).format(num);
}

// Professional state management
function showErrorState() {
    updateElementDisplay('resultsContainer', 'none');
    updateElementDisplay('instructionMessage', 'block');
    // Remove the empty error message display
    updateElementDisplay('errorMessage', 'none');
    
    // Disable the Store Calculation button when there are errors
    const storeButton = document.getElementById('storeButton');
    if (storeButton) {
        storeButton.disabled = true;
        console.log('Store button disabled due to errors');
    }
}

function showSuccessState(calculations) {
    updateElementDisplay('instructionMessage', 'none');
    updateElementDisplay('errorMessage', 'none');
    updateElementDisplay('resultsContainer', 'block');
    
    // Enable the Store Calculation button when calculations are successful
    const storeButton = document.getElementById('storeButton');
    if (storeButton) {
        storeButton.disabled = false;
        console.log('Store button enabled');
    }
    
    // Update badges with professional formatting
    const badgeContainer = document.getElementById('badgeContainer');
    if (badgeContainer) {
        badgeContainer.innerHTML = `
            <div class="result-badge success">
                Weighted Avg Cost: Rs. ${calculations.weightedAvgCost.toFixed(2)}/MCal
            </div>
            <div class="result-badge info">
                Additional Liability: Rs. ${calculations.additionalFinancialLiability.toFixed(2)} Crore
            </div>
        `;
    }
}

function updateElementDisplay(id, display) {
    const element = document.getElementById(id);
    if (element) {
        element.style.display = display;
    }
}

function showAlternateFuelBadges() {
    // This function can be used for additional badge functionality
    calculateAlternateFuelCostEconomics();
}

// Professional stored calculations management
function initializeStoredCalculations() {
    updateStoredCalculationsDisplay();
}

// Simple store calculation function - stores current plant from form inputs
function storeCalculation() {
    // Prevent multiple rapid clicks
    const storeButton = document.getElementById('storeButton');
    if (storeButton && storeButton.disabled) {
        console.log('Store button is disabled, preventing duplicate storage');
        return;
    }
    
    try {
        console.log('=== SIMPLE STORE DEBUG ===');
        console.log('Storing current plant with Sr. No. approach');
        
        // Temporarily disable button to prevent double-clicks
        if (storeButton) {
            storeButton.disabled = true;
            storeButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Storing...';
        }
        
        // Get current plant name from form
        const plantName = document.getElementById('plant-name').value.trim();
        if (!plantName) {
            showNotification('Please enter a plant name before storing', 'warning');
            return;
        }

        // Check if plant with same name already exists
        const existingPlants = getAllStoredPlants();
        const duplicatePlant = existingPlants.find(plant => 
            plant.plantName.toLowerCase() === plantName.toLowerCase()
        );
        
        if (duplicatePlant) {
            const confirmOverwrite = confirm(`A plant named "${plantName}" already exists as Sr. No. ${duplicatePlant.srNo}. Do you want to store this as a new entry anyway?`);
            if (!confirmOverwrite) {
                console.log('User cancelled storage due to duplicate name');
                return;
            }
        }

        // Get all current form inputs with correct IDs
        const currentInputs = {
            acqLinkedCoal: parseFloat(document.getElementById('acq-linked-coal').value) || 0,
            landedCostLinked: parseFloat(document.getElementById('landed-cost-linked').value) || 0,
            gcvLinkedCoal: parseFloat(document.getElementById('gcv-linked-coal').value) || 0,
            alternateFuelPercentage: parseFloat(document.getElementById('alternate-fuel-percentage').value) || 0,
            landedCostAlternate: parseFloat(document.getElementById('landed-cost-alternate').value) || 0,
            gcvAlternateFuel: parseFloat(document.getElementById('gcv-alternate-fuel').value) || 0
        };

        // Validate essential inputs
        if (currentInputs.acqLinkedCoal <= 0) {
            showNotification('Please enter a valid ACQ for Linked Coal', 'warning');
            return;
        }
        
        if (currentInputs.alternateFuelPercentage <= 0 || currentInputs.alternateFuelPercentage >= 100) {
            showNotification('Please enter a valid Alternate Fuel Percentage (0-100)', 'warning');
            return;
        }

        // Calculate current results to store using the same function as display
        const calculations = performAlternateFuelCalculations(currentInputs);
        
        console.log('=== CALCULATION DEBUG ===');
        console.log('Input values:', currentInputs);
        console.log('Calculated values:', calculations);
        console.log('Additional Financial Liability:', calculations.additionalFinancialLiability);
        console.log('=== END CALCULATION DEBUG ===');
        
        // Use current counter as Sr. No.
        const srNo = plantStorageCounter;
        
        // Create simple plant storage object
        const plantStorage = {
            srNo: srNo,
            plantName: plantName,
            date: new Date().toLocaleDateString('en-IN'),
            time: new Date().toLocaleTimeString('en-IN'),
            timestamp: new Date().toISOString(),
            inputs: currentInputs,
            calculations: calculations
        };

        // Store in localStorage with Sr. No. as key
        try {
            if (typeof(Storage) === "undefined" || !window.localStorage) {
                showNotification('Storage not available in this browser', 'warning');
                return;
            }
            
            const storageKey = `alternateFuelPlant_${srNo}`;
            localStorage.setItem(storageKey, JSON.stringify(plantStorage));
            
            console.log(`Stored: Sr.${srNo} - ${plantName} in key: ${storageKey}`);
            
            // Increment counter
            plantStorageCounter++;
            localStorage.setItem('alternateFuelPlantCounter', plantStorageCounter.toString());
            
            console.log('Next Sr. No. will be:', plantStorageCounter);
            console.log('=== END SIMPLE STORE DEBUG ===');
            
            updateStoredCalculationsDisplay();
            showNotification(`Plant "${plantName}" stored successfully as Sr. No. ${srNo}`, 'success');
        } catch (error) {
            console.error('Error storing plant:', error);
            showNotification(`Error storing plant: ${error.message}`, 'warning');
        }
        
    } catch (error) {
        console.error('Error storing plant:', error);
        showNotification(`Error storing plant: ${error.message}`, 'warning');
    } finally {
        // Re-enable button after processing
        setTimeout(() => {
            if (storeButton) {
                storeButton.disabled = false;
                storeButton.innerHTML = '<i class="fas fa-save me-2"></i>Store Complete Analysis';
            }
        }, 1000); // 1 second delay to prevent rapid clicks
    }
}

function updateStoredCalculationsDisplay() {
    const container = document.getElementById('storedCalculationsList');
    const counter = document.getElementById('calculationCounter');
    
    if (!container) return;
    
    // Get all stored plants
    const storedPlants = getAllStoredPlants();
    
    // Update counter
    if (counter) {
        counter.textContent = storedPlants.length;
        counter.style.display = storedPlants.length > 0 ? 'flex' : 'none';
    }
    
    if (storedPlants.length === 0) {
        container.innerHTML = '<p class="text-muted" style="color: rgba(255,255,255,0.7);">No stored plants yet.</p>';
        return;
    }

    // Add clear all button at the top
    let html = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; border: 1px solid rgba(220, 53, 69, 0.3);">
            <span style="color: rgba(255,255,255,0.8); font-size: 13px;">
                <i class="fas fa-database me-1"></i>
                ${storedPlants.length} stored plant${storedPlants.length !== 1 ? 's' : ''}
            </span>
            <button class="btn btn-sm btn-outline-danger" onclick="clearAllStoredData()" style="font-size: 11px; padding: 4px 8px;">
                <i class="fas fa-trash-alt me-1"></i>Clear All
            </button>
        </div>
    `;

    html += storedPlants.map(plant => {
        const altFuelPct = (plant.inputs?.alternateFuelPercentage || 0).toFixed(1);
        const liability = (plant.calculations?.additionalFinancialLiability || 0).toFixed(2);
        const acq = (plant.inputs?.acqLinkedCoal || 0).toFixed(0);
        
        return `
            <div class="stored-calc-item" data-sr-no="${plant.srNo}">
                <div class="calc-header">
                    <strong style="color: white;">Sr.${plant.srNo} - ${plant.plantName}</strong>
                    <small class="text-muted" style="color: rgba(255,255,255,0.7);">${plant.date} ${plant.time}</small>
                </div>
                <div class="calc-summary" style="margin: 8px 0;">
                    <span class="badge bg-info" style="margin-right: 5px;">ACQ: ${acq}MT</span>
                    <span class="badge bg-primary" style="margin-right: 5px;">AF: ${altFuelPct}%</span>
                    <span class="badge bg-success">Liability: Rs.${liability}Cr</span>
                </div>
                <div class="calc-actions" style="display: flex; gap: 10px;">
                    <button class="btn btn-sm btn-outline-light" onclick="loadPlantBySrNo(${plant.srNo})" style="font-size: 12px;">
                        <i class="fas fa-upload"></i> Load
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePlantBySrNo(${plant.srNo})" style="font-size: 12px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}function loadCalculation(calcId) {
    const calc = storedCalculations.find(c => c.id === calcId);
    if (!calc) return;
    
    // Load all input values with proper mapping
    const inputMapping = {
        'acqLinkedCoal': 'acq-linked-coal',
        'landedCostLinked': 'landed-cost-linked',
        'gcvLinkedCoal': 'gcv-linked-coal',
        'alternateFuelPercentage': 'alternate-fuel-percentage',
        'landedCostAlternate': 'landed-cost-alternate',
        'gcvAlternateFuel': 'gcv-alternate-fuel'
    };
    
    Object.entries(calc.inputs).forEach(([key, value]) => {
        const elementId = inputMapping[key];
        if (elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value;
            }
        }
    });
    
    // Recalculate
    calculateAlternateFuelCostEconomics();
    
    // Hide stored calculations
    toggleStoredCalculations();
    
    // Show success notification
    showNotification('Calculation loaded successfully!', 'success');
}

// Load individual plant data
function loadSinglePlant(calcId) {
    console.log('=== LOAD SINGLE PLANT DEBUG ===');
    console.log('Loading plant ID:', calcId);
    
    const plant = storedCalculations.find(c => c.id == calcId && c.type === 'singlePlant');
    if (!plant) {
        console.log('Plant not found or wrong type');
        showNotification('Plant data not found', 'warning');
        return;
    }
    
    console.log('Found plant:', plant.plantName);
    
    // Set plant name
    document.getElementById('plant-name').value = plant.plantName || '';
    
    // Set input values
    const inputMapping = {
        'acqLinkedCoal': 'acq-linked-coal',
        'landedCostLinked': 'landed-cost-linked',
        'gcvLinkedCoal': 'gcv-linked-coal',
        'alternateFuelPercentage': 'alternate-fuel-percentage',
        'landedCostAlternate': 'landed-cost-alternate',
        'gcvAlternateFuel': 'gcv-alternate-fuel'
    };
    
    Object.entries(plant.inputs || {}).forEach(([key, value]) => {
        const elementId = inputMapping[key];
        if (elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value;
                console.log(`Loaded ${key}: ${value}`);
            }
        }
    });
    
    // Recalculate
    calculateAlternateFuelCostEconomics();
    
    // Hide stored calculations
    toggleStoredCalculations();
    
    // Show success notification
    showNotification(`Plant "${plant.plantName}" loaded successfully!`, 'success');
    
    console.log('=== END LOAD SINGLE PLANT DEBUG ===');
}

// Load multi-plant analysis
function loadMultiPlantAnalysis(analysisId) {
    console.log('=== LOAD ANALYSIS DEBUG ===');
    console.log('Attempting to load analysis ID:', analysisId);
    console.log('Available analyses:', storedCalculations.map(c => ({ id: c.id, name: c.data?.analysisName, type: c.type })));
    
    const analysis = storedCalculations.find(c => c.id == analysisId); // Use == for flexible comparison
    if (!analysis || analysis.type !== 'multiPlantAnalysis') {
        console.log('Analysis not found or wrong type. Analysis:', analysis);
        showNotification('Analysis not found', 'warning');
        return;
    }
    
    // Check if analysis has plants
    if (!analysis.data.plants || analysis.data.plants.length === 0) {
        console.log('No plants found in analysis');
        showNotification('No plant data found in this analysis', 'warning');
        return;
    }
    
    // Debug: Log the complete analysis structure
    console.log('Found analysis:', {
        id: analysis.id,
        name: analysis.data.analysisName,
        plantCount: analysis.data.plants.length,
        plants: analysis.data.plants.map(p => ({ name: p.name, inputs: Object.keys(p.inputs || {}) }))
    });
    
    // Show available plants to user and let them choose
    const plantOptions = analysis.data.plants.map((plant, index) => {
        const acq = plant.inputs?.acqLinkedCoal || 'N/A';
        const altFuel = plant.inputs?.alternateFuelPercentage || 'N/A';
        return `${index + 1}. ${plant.name} (ACQ: ${acq}, AF%: ${altFuel})`;
    }).join('\n');
    
    let choice;
    if (analysis.data.plants.length === 1) {
        // If only one plant, load it automatically
        choice = "1";
        console.log('Auto-loading single plant:', analysis.data.plants[0].name);
    } else {
        // If multiple plants, let user choose
        console.log('Multiple plants found, showing selection dialog');
        choice = prompt(`Analysis: ${analysis.data.analysisName}\n\nAvailable plants:\n${plantOptions}\n\nEnter plant number to load (1-${analysis.data.plants.length}):`);
        
        if (choice === null) {
            console.log('User cancelled plant selection');
            return; // User cancelled
        }
    }
    
    const plantIndex = parseInt(choice) - 1;
    if (isNaN(plantIndex) || plantIndex < 0 || plantIndex >= analysis.data.plants.length) {
        console.log('Invalid plant selection:', choice, 'Index:', plantIndex);
        showNotification('Invalid plant number selected', 'warning');
        return;
    }
    
    const selectedPlant = analysis.data.plants[plantIndex];
    console.log('Loading plant:', selectedPlant.name, 'with data:', selectedPlant);
    console.log('=== END LOAD DEBUG ===');
    
    // Set input values for the selected plant
    const inputMapping = {
        'acqLinkedCoal': 'acq-linked-coal',
        'landedCostLinked': 'landed-cost-linked',
        'gcvLinkedCoal': 'gcv-linked-coal',
        'alternateFuelPercentage': 'alternate-fuel-percentage',
        'landedCostAlternate': 'landed-cost-alternate',
        'gcvAlternateFuel': 'gcv-alternate-fuel'
    };
    
    // Load plant name
    document.getElementById('plant-name').value = selectedPlant.name || '';
    console.log('Loaded plant name:', selectedPlant.name);
    
    // Load plant inputs
    Object.entries(selectedPlant.inputs || {}).forEach(([key, value]) => {
        const elementId = inputMapping[key];
        if (elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value;
                console.log(`Loaded ${key}: ${value} into ${elementId}`);
            }
        }
    });
    
    // Recalculate to update results and badges
    calculateAlternateFuelCostEconomics();
    
    // Hide stored calculations
    toggleStoredCalculations();
    
    // Show success notification
    showNotification(`Plant "${selectedPlant.name}" data loaded. Current analysis table is preserved.`, 'success');
}

function deleteCalculation(calcId) {
    storedCalculations = storedCalculations.filter(c => c.id !== calcId);
    localStorage.setItem('alternateFuelCalculations', JSON.stringify(storedCalculations));
    updateStoredCalculationsDisplay();
    showNotification('Calculation deleted', 'warning');
}

// New Simple Loading Functions for Sr. No. System

// Simple function to load plant by Sr. No.
function loadPlantBySrNo(srNo) {
    try {
        const plantData = localStorage.getItem(`alternateFuelPlant_${srNo}`);
        if (!plantData) {
            alert(`Plant with Sr. No. ${srNo} not found!`);
            return;
        }
        
        const plant = JSON.parse(plantData);
        
        // Load all the plant data into the form using correct IDs
        document.getElementById('plant-name').value = plant.plantName || '';
        document.getElementById('acq-linked-coal').value = plant.inputs?.acqLinkedCoal || '';
        document.getElementById('landed-cost-linked').value = plant.inputs?.landedCostLinked || '';
        document.getElementById('gcv-linked-coal').value = plant.inputs?.gcvLinkedCoal || '';
        document.getElementById('alternate-fuel-percentage').value = plant.inputs?.alternateFuelPercentage || '';
        document.getElementById('landed-cost-alternate').value = plant.inputs?.landedCostAlternate || '';
        document.getElementById('gcv-alternate-fuel').value = plant.inputs?.gcvAlternateFuel || '';
        
        alert(`Successfully loaded plant: ${plant.plantName} (Sr. No. ${srNo})`);
        
        // Close the stored calculations view
        toggleStoredCalculations();
        
    } catch (error) {
        alert(`Error loading plant: ${error.message}`);
        console.error('Error loading plant:', error);
    }
}

// Simple function to delete plant by Sr. No.
function deletePlantBySrNo(srNo) {
    if (confirm(`Are you sure you want to delete plant Sr. No. ${srNo}?`)) {
        try {
            const plantData = localStorage.getItem(`alternateFuelPlant_${srNo}`);
            if (plantData) {
                const plant = JSON.parse(plantData);
                localStorage.removeItem(`alternateFuelPlant_${srNo}`);
                updateStoredCalculationsDisplay();
                alert(`Plant "${plant.plantName}" (Sr. No. ${srNo}) deleted successfully!`);
            } else {
                alert(`Plant Sr. No. ${srNo} not found!`);
            }
        } catch (error) {
            alert(`Error deleting plant: ${error.message}`);
        }
    }
}

// Delete multi-plant analysis
function deleteStoredAnalysis(analysisId) {
    const analysis = storedCalculations.find(c => c.id === analysisId);
    if (analysis && confirm(`Are you sure you want to delete "${analysis.data.analysisName}"?`)) {
        storedCalculations = storedCalculations.filter(c => c.id !== analysisId);
        localStorage.setItem('alternateFuelCalculations', JSON.stringify(storedCalculations));
        updateStoredCalculationsDisplay();
        showNotification('Multi-plant analysis deleted', 'warning');
    }
}

// Professional UI functions
function toggleFormulas() {
    const sidebar = document.getElementById('formulaSidebar');
    if (sidebar) {
        sidebar.classList.toggle('active');
    }
}

function toggleExportOptions() {
    const dropdown = document.getElementById('exportDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}

function toggleStoredCalculations() {
    const container = document.getElementById('storedCalculationsContainer');
    if (container) {
        const isVisible = container.style.display !== 'none';
        container.style.display = isVisible ? 'none' : 'block';
    }
}

// Store for plant data
let plantAnalysisData = [];

// Add plant to multi-plant analysis
function addPlantToAnalysis() {
    // Get plant name
    const plantName = document.getElementById("plant-name").value.trim();
    if (!plantName) {
        showNotification('Please enter a plant name', 'warning');
        return;
    }
    
    // Check if plant already exists
    if (plantAnalysisData.some(plant => plant.name === plantName)) {
        showNotification('Plant name already exists. Please use a different name.', 'warning');
        return;
    }
    
    // Get input values
    const inputs = {
        acqLinkedCoal: parseFloat(document.getElementById("acq-linked-coal").value) || 0,
        landedCostLinked: parseFloat(document.getElementById("landed-cost-linked").value) || 0,
        gcvLinkedCoal: parseFloat(document.getElementById("gcv-linked-coal").value) || 0,
        alternateFuelPercentage: parseFloat(document.getElementById("alternate-fuel-percentage").value) || 0,
        landedCostAlternate: parseFloat(document.getElementById("landed-cost-alternate").value) || 0,
        gcvAlternateFuel: parseFloat(document.getElementById("gcv-alternate-fuel").value) || 0
    };
    
    // Validate inputs
    const requiredInputs = Object.values(inputs);
    if (requiredInputs.some(val => val <= 0)) {
        showNotification('Please fill all fields with valid values', 'warning');
        return;
    }
    
    // Calculate results for this plant
    const calculations = performAlternateFuelCalculations(inputs);
    
    // Store plant data
    const plantData = {
        name: plantName,
        inputs: inputs,
        calculations: calculations
    };
    
    plantAnalysisData.push(plantData);
    
    // Update the table
    updateMultiPlantTable();
    
    // Keep all inputs including plant name for potential storage
    // Users can manually clear if they want to enter new data
    
    // Enable store button if we have plants
    document.getElementById('storeButton').disabled = false;
    
    showNotification(`Plant "${plantName}" added to analysis! All input values preserved for storage.`, 'success');
}

// Update the multi-plant analysis table
function updateMultiPlantTable() {
    const headerRow = document.getElementById('tableHeader');
    const tableBody = document.getElementById('multiPlantTableBody');
    
    // Clear existing plant columns (keep parameter and unit columns, and total column)
    const existingPlantHeaders = headerRow.querySelectorAll('.plant-column');
    existingPlantHeaders.forEach(header => header.remove());
    
    // Add plant columns to header
    const totalColumn = headerRow.querySelector('.total-column');
    plantAnalysisData.forEach((plant, index) => {
        const th = document.createElement('th');
        th.className = 'plant-column';
        th.style.minWidth = '120px';
        th.style.backgroundColor = '#3498db';
        th.style.color = 'white';
        th.textContent = plant.name;
        headerRow.insertBefore(th, totalColumn);
    });
    
    // Update data rows
    const rows = tableBody.querySelectorAll('tr');
    
    // ACQ row
    updateDataRow(rows[0], 'acqLinkedCoal', 'MT');
    
    // Landed Cost row
    updateDataRow(rows[1], 'landedCostLinked', 'Rs/MCal');
    
    // GCV Linked row
    updateDataRow(rows[2], 'gcvLinkedCoal', 'kcal/kg');
    
    // Alternate Fuel % row
    updateDataRow(rows[3], 'alternateFuelPercentage', '%');
    
    // Quantity of Linked Coal row (calculated)
    updateDataRow(rows[4], 'quantityLinkedCoal', 'MT', true);
    
    // Quantity of Alternate Fuel row (calculated)
    updateDataRow(rows[5], 'quantityAlternateFuel', 'MT', true);
    
    // Landed Fuel Cost row
    updateDataRow(rows[6], 'landedCostAlternate', 'Rs/MCal');
    
    // GCV Alternate row
    updateDataRow(rows[7], 'gcvAlternateFuel', 'kcal/kg');
    
    // Weighted Average Cost row (calculated)
    updateDataRow(rows[8], 'weightedAvgCost', 'Rs/MCal', true);
    
    // Additional Financial Liability row
    updateDataRow(rows[9], 'additionalFinancialLiability', 'Rs Crore', true);
    
    // Show results container
    updateElementDisplay('resultsContainer', 'block');
    updateElementDisplay('instructionMessage', 'none');
}

// Helper function to update data rows
function updateDataRow(row, dataKey, unit, isCalculation = false) {
    // Clear existing plant data cells
    const existingCells = row.querySelectorAll('.plant-data');
    existingCells.forEach(cell => cell.remove());
    
    const totalCell = row.querySelector('.total-column');
    let total = 0;
    let count = plantAnalysisData.length;
    
    // Determine if this is the liability row or weighted average cost row (special styling)
    const isLiabilityRow = dataKey === 'additionalFinancialLiability';
    const isWeightedAvgRow = dataKey === 'weightedAvgCost';
    
    // Add plant data cells
    plantAnalysisData.forEach(plant => {
        const td = document.createElement('td');
        td.className = 'plant-data';
        td.style.textAlign = 'center';
        
        // Apply appropriate background color based on row type
        if (isLiabilityRow || isWeightedAvgRow) {
            td.style.backgroundColor = '#e74c3c';
            td.style.color = 'white';
            td.style.fontWeight = 'bold';
        } else {
            td.style.backgroundColor = '#ecf0f1';
            td.style.color = '#333';
        }
        
        let value;
        if (isCalculation) {
            value = plant.calculations[dataKey];
        } else {
            value = plant.inputs[dataKey];
        }
        
        td.textContent = value.toFixed(2);
        total += value;
        
        row.insertBefore(td, totalCell);
    });
    
    // Update total/average
    if (count > 0) {
        if (dataKey === 'additionalFinancialLiability' || 
            dataKey === 'acqLinkedCoal' || 
            dataKey === 'quantityLinkedCoal' || 
            dataKey === 'quantityAlternateFuel') {
            totalCell.textContent = total.toFixed(2); // Sum for liability, ACQ, and quantities
        } else if (dataKey === 'weightedAvgCost') {
            // Calculate overall weighted average cost based on total energy content
            let totalCostMixed = 0;
            let totalEnergyContent = 0;
            plantAnalysisData.forEach(plant => {
                totalCostMixed += plant.calculations.totalCostMixed;
                totalEnergyContent += plant.calculations.totalEnergyContent;
            });
            const overallWeightedAvgCost = totalEnergyContent > 0 ? (totalCostMixed * 10000000) / totalEnergyContent : 0;
            totalCell.textContent = overallWeightedAvgCost.toFixed(2);
        } else if (dataKey === 'landedCostLinked' || dataKey === 'gcvLinkedCoal') {
            // Weighted average w.r.t. quantity of linked coal
            let weightedSum = 0;
            let totalWeight = 0;
            plantAnalysisData.forEach(plant => {
                const weight = plant.calculations.quantityLinkedCoal;
                const value = plant.inputs[dataKey];
                weightedSum += value * weight;
                totalWeight += weight;
            });
            const weightedAverage = totalWeight > 0 ? weightedSum / totalWeight : 0;
            totalCell.textContent = weightedAverage.toFixed(2);
        } else if (dataKey === 'landedCostAlternate' || dataKey === 'gcvAlternateFuel') {
            // Weighted average w.r.t. quantity of alternate fuel
            let weightedSum = 0;
            let totalWeight = 0;
            plantAnalysisData.forEach(plant => {
                const weight = plant.calculations.quantityAlternateFuel;
                const value = plant.inputs[dataKey];
                weightedSum += value * weight;
                totalWeight += weight;
            });
            const weightedAverage = totalWeight > 0 ? weightedSum / totalWeight : 0;
            totalCell.textContent = weightedAverage.toFixed(2);
        } else {
            totalCell.textContent = (total / count).toFixed(2); // Simple average for others
        }
    }
}

function clearAllInputs() {
    if (confirm('Are you sure you want to clear all input fields?')) {
        const inputs = document.querySelectorAll('input[type="number"], input[type="text"]');
        inputs.forEach(input => {
            if (!input.hasAttribute('data-keep-value')) {
                input.value = '';
            }
        });
        
        // Don't hide the analysis table - only hide results if no analysis exists
        if (plantAnalysisData.length === 0) {
            showErrorState();
        }
        
        showNotification('All input fields cleared', 'info');
    }
}

// Toggle analysis table visibility
function toggleAnalysisTable() {
    const resultsContainer = document.getElementById('resultsContainer');
    const toggleButton = document.getElementById('toggleTableButton');
    
    if (!resultsContainer || !toggleButton) return;
    
    const isVisible = resultsContainer.style.display !== 'none';
    
    if (isVisible) {
        resultsContainer.style.display = 'none';
        toggleButton.innerHTML = '<i class="fas fa-eye me-1"></i>Show Table';
        toggleButton.className = 'btn btn-success btn-small';
    } else {
        resultsContainer.style.display = 'block';
        toggleButton.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Table';
        toggleButton.className = 'btn btn-info btn-small';
    }
}

// Clear only the analysis table (keep input form)
function clearCurrentAnalysis() {
    if (confirm('Are you sure you want to clear the current analysis table? Input form will be preserved.')) {
        // Clear plant analysis data
        plantAnalysisData = [];
        
        // Reset table to initial state
        const headerRow = document.getElementById('tableHeader');
        const existingPlantHeaders = headerRow.querySelectorAll('.plant-column');
        existingPlantHeaders.forEach(header => header.remove());
        
        // Clear all plant data cells
        const tableBody = document.getElementById('multiPlantTableBody');
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const plantCells = row.querySelectorAll('.plant-data');
            plantCells.forEach(cell => cell.remove());
            
            // Reset total cells
            const totalCell = row.querySelector('.total-column');
            if (totalCell) {
                totalCell.textContent = '-';
            }
        });
        
        // Hide results and disable store button
        showErrorState();
        document.getElementById('storeButton').disabled = true;
        
        showNotification('Analysis table cleared. Input form preserved.', 'info');
    }
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} notification-toast`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        animation: slideInRight 0.3s ease;
    `;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Professional PDF Export
function exportToPDF() {
    try {
        // Check if multi-plant analysis exists
        if (plantAnalysisData.length === 0) {
            showNotification('Please add plants to analysis before exporting PDF', 'warning');
            return;
        }

        console.log('Starting PDF export for multi-plant analysis...');
        
        // Create a new jsPDF instance in A4 Portrait mode
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF("p", "mm", "a4"); // Portrait for A4 format
        
        // Header
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('Multi-Plant Alternate Fuel Cost Economics Analysis', 20, 20);
        
        // Timestamp and analysis info
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Generated on: ${new Date().toLocaleString('en-IN')}`, 20, 30);
        doc.text(`Total Plants: ${plantAnalysisData.length}`, 20, 36);
        
        // Prepare multi-plant table data
        const tableData = [];
        const plantNames = plantAnalysisData.map(plant => plant.name);
        
        // Table headers
        const headers = ['Parameter', 'Unit', ...plantNames, 'Total/Avg'];
        
        // Table rows data
        const rows = [
            ['Annual Coal Requirement', 'MT'],
            ['Landed Linked Coal Cost', 'Rs/MCal'],
            ['GCV Linked Coal', 'kcal/kg'],
            ['Alternate Fuel %', '%'],
            ['Quantity of Linked Coal', 'MT'],
            ['Quantity of Alternate Fuel', 'MT'],
            ['Landed Alternate Fuel Cost', 'Rs/MCal'],
            ['GCV Alternate Fuel', 'kcal/kg'],
            ['Weighted Average Cost', 'Rs/MCal'],
            ['Additional Financial Liability', 'Rs Crore']
        ];
        
        // Add plant data to each row
        rows.forEach((row, rowIndex) => {
            const paramNames = [
                'acqLinkedCoal', 'landedCostLinked', 'gcvLinkedCoal', 'alternateFuelPercentage',
                'quantityLinkedCoal', 'quantityAlternateFuel', 'landedCostAlternate', 
                'gcvAlternateFuel', 'weightedAvgCost', 'additionalFinancialLiability'
            ];
            
            const paramName = paramNames[rowIndex];
            const isCalculation = ['quantityLinkedCoal', 'quantityAlternateFuel', 'weightedAvgCost', 'additionalFinancialLiability'].includes(paramName);
            
            let total = 0;
            let count = plantAnalysisData.length;
            
            // Add each plant's data
            plantAnalysisData.forEach(plant => {
                const value = isCalculation ? plant.calculations[paramName] : plant.inputs[paramName];
                row.push(value.toFixed(2));
                total += value;
            });
            
            // Add total/average column
            if (['additionalFinancialLiability', 'acqLinkedCoal', 'quantityLinkedCoal', 'quantityAlternateFuel'].includes(paramName)) {
                row.push(total.toFixed(2)); // Sum
            } else if (paramName === 'weightedAvgCost') {
                // Calculate overall weighted average cost
                let totalCostMixed = 0;
                let totalEnergyContent = 0;
                plantAnalysisData.forEach(plant => {
                    totalCostMixed += plant.calculations.totalCostMixed;
                    totalEnergyContent += plant.calculations.totalEnergyContent;
                });
                const overallWeightedAvgCost = totalEnergyContent > 0 ? (totalCostMixed * 10000000) / totalEnergyContent : 0;
                row.push(overallWeightedAvgCost.toFixed(2));
            } else if (paramName === 'landedCostLinked' || paramName === 'gcvLinkedCoal') {
                // Weighted average by linked coal quantity
                let weightedSum = 0;
                let totalWeight = 0;
                plantAnalysisData.forEach(plant => {
                    const weight = plant.calculations.quantityLinkedCoal;
                    const value = plant.inputs[paramName];
                    weightedSum += value * weight;
                    totalWeight += weight;
                });
                const weightedAvg = totalWeight > 0 ? weightedSum / totalWeight : 0;
                row.push(weightedAvg.toFixed(2));
            } else if (paramName === 'landedCostAlternate' || paramName === 'gcvAlternateFuel') {
                // Weighted average by alternate fuel quantity
                let weightedSum = 0;
                let totalWeight = 0;
                plantAnalysisData.forEach(plant => {
                    const weight = plant.calculations.quantityAlternateFuel;
                    const value = plant.inputs[paramName];
                    weightedSum += value * weight;
                    totalWeight += weight;
                });
                const weightedAvg = totalWeight > 0 ? weightedSum / totalWeight : 0;
                row.push(weightedAvg.toFixed(2));
            } else {
                row.push((total / count).toFixed(2)); // Simple average
            }
        });
        
        // Create the table
        doc.autoTable({
            startY: 45,
            head: [headers],
            body: rows,
            theme: 'grid',
            styles: { 
                fontSize: 7,
                cellPadding: 1.5,
                overflow: 'linebreak'
            },
            headStyles: { 
                fillColor: [52, 152, 219],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            columnStyles: {
                0: { fontStyle: 'bold', fillColor: [241, 245, 249] }, // Parameter column
                1: { fillColor: [241, 245, 249] }, // Unit column
                [headers.length - 1]: { fontStyle: 'bold', fillColor: [255, 243, 224] } // Total/Avg column
            },
            alternateRowStyles: {
                fillColor: [249, 250, 251]
            }
        });

        // Footer
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.text(`Page ${i} of ${pageCount}`, 20, 280);
            doc.text('Multi-Plant Analysis - Professional Alternate Fuel Cost Economics Tool', 60, 280);
        }
        
        doc.save(`Multi_Plant_Alternate_Fuel_Analysis_${new Date().toISOString().split('T')[0]}.pdf`);
        showNotification('Multi-plant PDF exported successfully!', 'success');
        
    } catch (error) {
        console.error('PDF export error:', error);
        showNotification('Error exporting PDF: ' + error.message, 'warning');
    }
}

// Professional Multi-Plant JPG Export
function exportToJPG() {
    console.log('exportToJPG function called - Multi-plant version');
    
    try {
        // Check if multi-plant analysis exists
        if (plantAnalysisData.length === 0) {
            showNotification('Please add plants to analysis before exporting JPG', 'warning');
            return;
        }

        console.log('Starting JPG export process for multi-plant analysis...');
        showNotification('Generating multi-plant JPG report...', 'info');

        // Create a temporary container for the multi-plant table (A4 Portrait dimensions)
        const reportContainer = document.createElement('div');
        reportContainer.id = 'tempReportContainer';
        reportContainer.style.cssText = `
            position: fixed;
            top: 50px;
            left: 50px;
            width: 794px;
            min-height: 1123px;
            background: #ffffff !important;
            background-color: #ffffff !important;
            padding: 30px;
            font-family: Arial, sans-serif;
            color: #333;
            box-sizing: border-box;
            z-index: 10000;
            border: 1px solid #ccc;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: visible;
        `;
        
        // Create multi-plant table HTML
        let tableHTML = `
            <div style="margin-bottom: 30px;">
                <h1 style="color: #2c3e50; font-size: 24px; margin-bottom: 10px; font-weight: bold; text-align: center;">
                    Multi-Plant Alternate Fuel Cost Economics Analysis
                </h1>
                <p style="text-align: center; color: #666; font-size: 12px; margin-bottom: 20px;">
                    Generated on: ${new Date().toLocaleString('en-IN')} | Total Plants: ${plantAnalysisData.length}
                </p>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 9px;">
                    <thead>
                        <tr style="background: #3498db; color: white;">
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: left; font-weight: bold; font-size: 8px;">Parameter</th>
                            <th style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold; font-size: 8px;">Unit</th>`;
        
        // Add plant name headers
        plantAnalysisData.forEach(plant => {
            tableHTML += `<th style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold; font-size: 8px; min-width: 60px;">${plant.name}</th>`;
        });
        
        tableHTML += `<th style="border: 1px solid #ddd; padding: 6px; text-align: center; font-weight: bold; background: #f39c12; font-size: 8px;">Total/Avg</th></tr></thead><tbody>`;
        
        // Table rows
        const rows = [
            ['Annual Coal Requirement', 'MT', 'acqLinkedCoal', false],
            ['Landed Linked Coal Cost', 'Rs/MCal', 'landedCostLinked', false],
            ['GCV Linked Coal', 'kcal/kg', 'gcvLinkedCoal', false],
            ['Alternate Fuel %', '%', 'alternateFuelPercentage', false],
            ['Quantity of Linked Coal', 'MT', 'quantityLinkedCoal', true],
            ['Quantity of Alternate Fuel', 'MT', 'quantityAlternateFuel', true],
            ['Landed Alternate Fuel Cost', 'Rs/MCal', 'landedCostAlternate', false],
            ['GCV Alternate Fuel', 'kcal/kg', 'gcvAlternateFuel', false],
            ['Weighted Average Cost', 'Rs/MCal', 'weightedAvgCost', true],
            ['Additional Financial Liability', 'Rs Crore', 'additionalFinancialLiability', true]
        ];
        
        rows.forEach(([paramName, unit, dataKey, isCalculation], rowIndex) => {
            const isEvenRow = rowIndex % 2 === 0;
            const bgColor = isEvenRow ? '#f8f9fa' : '#ffffff';
            
            tableHTML += `<tr style="background: ${bgColor};">`;
            tableHTML += `<td style="border: 1px solid #ddd; padding: 5px; font-weight: bold; background: #ecf0f1; font-size: 8px;">${paramName}</td>`;
            tableHTML += `<td style="border: 1px solid #ddd; padding: 5px; text-align: center; background: #ecf0f1; font-size: 8px;">${unit}</td>`;
            
            let total = 0;
            let count = plantAnalysisData.length;
            
            // Add plant data
            plantAnalysisData.forEach(plant => {
                const value = isCalculation ? plant.calculations[dataKey] : plant.inputs[dataKey];
                tableHTML += `<td style="border: 1px solid #ddd; padding: 5px; text-align: center; font-size: 8px;">${value.toFixed(2)}</td>`;
                total += value;
            });
            
            // Add total/average
            let totalValue;
            if (['additionalFinancialLiability', 'acqLinkedCoal', 'quantityLinkedCoal', 'quantityAlternateFuel'].includes(dataKey)) {
                totalValue = total.toFixed(2); // Sum
            } else if (dataKey === 'weightedAvgCost') {
                // Calculate overall weighted average cost
                let totalCostMixed = 0;
                let totalEnergyContent = 0;
                plantAnalysisData.forEach(plant => {
                    totalCostMixed += plant.calculations.totalCostMixed;
                    totalEnergyContent += plant.calculations.totalEnergyContent;
                });
                const overallWeightedAvgCost = totalEnergyContent > 0 ? (totalCostMixed * 10000000) / totalEnergyContent : 0;
                totalValue = overallWeightedAvgCost.toFixed(2);
            } else if (dataKey === 'landedCostLinked' || dataKey === 'gcvLinkedCoal') {
                // Weighted average by linked coal quantity
                let weightedSum = 0;
                let totalWeight = 0;
                plantAnalysisData.forEach(plant => {
                    const weight = plant.calculations.quantityLinkedCoal;
                    const value = plant.inputs[dataKey];
                    weightedSum += value * weight;
                    totalWeight += weight;
                });
                totalValue = totalWeight > 0 ? (weightedSum / totalWeight).toFixed(2) : '0.00';
            } else if (dataKey === 'landedCostAlternate' || dataKey === 'gcvAlternateFuel') {
                // Weighted average by alternate fuel quantity
                let weightedSum = 0;
                let totalWeight = 0;
                plantAnalysisData.forEach(plant => {
                    const weight = plant.calculations.quantityAlternateFuel;
                    const value = plant.inputs[dataKey];
                    weightedSum += value * weight;
                    totalWeight += weight;
                });
                totalValue = totalWeight > 0 ? (weightedSum / totalWeight).toFixed(2) : '0.00';
            } else {
                totalValue = (total / count).toFixed(2); // Simple average
            }
            
            tableHTML += `<td style="border: 1px solid #ddd; padding: 5px; text-align: center; font-weight: bold; background: #fff3cd; font-size: 8px;">${totalValue}</td>`;
            tableHTML += `</tr>`;
        });
        
        tableHTML += `</tbody></table>
            </div>`;
        
        reportContainer.innerHTML = tableHTML;
        document.body.appendChild(reportContainer);
        
        // Use html2canvas to capture the content in A4 portrait format
        setTimeout(() => {
            html2canvas(reportContainer, {
                backgroundColor: '#ffffff',
                scale: 1.5,
                useCORS: true,
                allowTaint: true,
                width: 794, // A4 width in pixels at 96 DPI
                height: 1123, // A4 height in pixels at 96 DPI
                scrollX: 0,
                scrollY: 0
            }).then(canvas => {
                // Create download link
                const link = document.createElement('a');
                link.download = `Multi_Plant_Alternate_Fuel_Analysis_${new Date().toISOString().split('T')[0]}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                
                // Remove temporary container
                document.body.removeChild(reportContainer);
                
                showNotification('Multi-plant JPG exported successfully!', 'success');
            }).catch(error => {
                console.error('html2canvas error:', error);
                document.body.removeChild(reportContainer);
                showNotification('Error generating JPG: ' + error.message, 'warning');
            });
            
        }, 200);
        
    } catch (error) {
        console.error('JPG export error:', error);
        showNotification('Error in JPG export function: ' + error.message, 'warning');
    }
}

// Helper functions for PDF export
function getInputDataForPDF() {
    const inputs = [
        ['Annual Coal Requirement', 'acq-linked-coal', '', 'MT'],
        ['Landed Linked Coal Cost', 'landed-cost-linked', 'landed-cost-alternate', 'Rs/MCal'],
        ['GCV', 'gcv-linked-coal', 'gcv-alternate-fuel', 'kcal/kg'],
        ['Alternate Fuel %', '', 'alternate-fuel-percentage', '%']
    ];
    
    return inputs.map(([param, id1, id2, unit]) => {
        const val1 = id1 ? (document.getElementById(id1)?.value || '-') : '-';
        const val2 = id2 ? (document.getElementById(id2)?.value || '-') : '-';
        return [param, val1, val2, unit];
    });
}

function getResultsDataForPDF() {
    const results = [
        ['Quantity Required', 'quantity-linked-coal', 'quantity-alternate-fuel', 'total-quantity-mixed', 'MT'],
        ['Cost per MCal', 'cost-per-mcal-linked', 'cost-per-mcal-alternate', 'weighted-avg-cost', 'Rs/MCal'],
        ['Total Energy Content', 'energy-content-linked', 'energy-content-alternate', 'total-energy-content', 'MCal'],
        ['Total Cost', 'total-cost-linked', 'total-cost-alternate', 'total-cost-mixed', 'Rs Crore']
    ];
    
    return results.map(([param, id1, id2, id3, unit]) => {
        const val1 = document.getElementById(id1)?.innerText || '-';
        const val2 = document.getElementById(id2)?.innerText || '-';
        const val3 = document.getElementById(id3)?.innerText || '-';
        return [param, val1, val2, val3, unit];
    });
}

// Back Button Functionality
function goBack() {
    // Try to go back to parent window if opened from main app
    if (window.opener && !window.opener.closed) {
        try {
            // If opened from main app, switch focus back and close this tab
            window.opener.focus();
            // Call function to show calculators page in parent window
            if (typeof window.opener.showCalculatorsPage === 'function') {
                window.opener.showCalculatorsPage();
            }
            window.close();
        } catch (e) {
            // If cross-origin or other security issues, fallback to alert
            alert('Please use the browser back button or close this tab to return to the main application.');
        }
    } else {
        // If no parent window, try to navigate to main app
        try {
            window.location.href = 'index.html#calculators';
        } catch (e) {
            alert('Please use the browser back button to return to the main application.');
        }
    }
}

// Night Mode Functionality
function toggleNightMode() {
    const body = document.body;
    const toggle = document.getElementById('nightModeToggle');
    const isNightMode = toggle.checked;
    
    if (isNightMode) {
        body.classList.add('night-mode');
        localStorage.setItem('alternateFuelNightMode', 'enabled');
    } else {
        body.classList.remove('night-mode');
        localStorage.setItem('alternateFuelNightMode', 'disabled');
    }
}

// Initialize Night Mode on page load
function initializeNightMode() {
    const savedMode = localStorage.getItem('alternateFuelNightMode');
    const toggle = document.getElementById('nightModeToggle');
    
    if (savedMode === 'enabled') {
        document.body.classList.add('night-mode');
        toggle.checked = true;
    } else {
        document.body.classList.remove('night-mode');
        toggle.checked = false;
    }
}

// Initialize night mode when page loads
function initializeNightMode() {
    try {
        if (typeof(Storage) !== "undefined" && window.localStorage) {
            const nightMode = localStorage.getItem('alternateFuelNightMode');
            if (nightMode === 'enabled') {
                document.body.classList.add('night-mode');
                const toggle = document.getElementById('nightModeToggle');
                if (toggle) toggle.checked = true;
            }
        }
    } catch (error) {
        console.error('Error initializing night mode:', error);
    }
}

// Professional notification system for browser compatibility
function showNotification(message, type = 'info', duration = 4000) {
    console.log(`Notification (${type}): ${message}`);
    
    // Try to create visual notification if possible
    try {
        // Remove existing notification
        const existing = document.querySelector('.temp-notification');
        if (existing) existing.remove();
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'temp-notification';
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: ${type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#17a2b8'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 9999;
            font-size: 14px;
            max-width: 300px;
            word-wrap: break-word;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        `;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Auto remove after duration
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }, duration);
        
    } catch (error) {
        console.error('Error showing notification:', error);
        // Fallback to alert for critical messages
        if (type === 'warning') {
            alert(message);
        }
    }
}

// Load plant by Sr. No. with enhanced browser compatibility
function loadPlantBySrNo(srNo) {
    try {
        if (typeof(Storage) === "undefined" || !window.localStorage) {
            showNotification('Storage not available in this browser', 'warning');
            return;
        }
        
        const plantData = localStorage.getItem(`alternateFuelPlant_${srNo}`);
        if (!plantData) {
            showNotification(`Plant Sr.${srNo} not found`, 'warning');
            return;
        }
        
        const plant = JSON.parse(plantData);
        console.log(`Loading plant Sr.${srNo}:`, plant.plantName);
        
        // Set plant name
        const plantNameInput = document.getElementById('plant-name');
        if (plantNameInput) plantNameInput.value = plant.plantName || '';
        
        // Set input values
        const inputMapping = {
            'acqLinkedCoal': 'acq-linked-coal',
            'landedCostLinked': 'landed-cost-linked', 
            'gcvLinkedCoal': 'gcv-linked-coal',
            'alternateFuelPercentage': 'alternate-fuel-percentage',
            'landedCostAlternate': 'landed-cost-alternate',
            'gcvAlternateFuel': 'gcv-alternate-fuel'
        };
        
        Object.entries(plant.inputs || {}).forEach(([key, value]) => {
            const elementId = inputMapping[key];
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value;
                }
            }
        });
        
        // Recalculate
        calculateAlternateFuelCostEconomics();
        
        showNotification(`Plant "${plant.plantName}" loaded successfully!`, 'success');
        
    } catch (error) {
        console.error('Error loading plant:', error);
        showNotification(`Error loading plant: ${error.message}`, 'warning');
    }
}

// Delete plant by Sr. No. with enhanced browser compatibility
function deletePlantBySrNo(srNo) {
    if (!confirm(`Are you sure you want to delete Sr.${srNo}? This cannot be undone.`)) {
        return;
    }
    
    try {
        if (typeof(Storage) === "undefined" || !window.localStorage) {
            showNotification('Storage not available in this browser', 'warning');
            return;
        }
        
        const plantData = localStorage.getItem(`alternateFuelPlant_${srNo}`);
        if (!plantData) {
            showNotification(`Plant Sr.${srNo} not found`, 'warning');
            return;
        }
        
        const plant = JSON.parse(plantData);
        localStorage.removeItem(`alternateFuelPlant_${srNo}`);
        
        updateStoredCalculationsDisplay();
        showNotification(`Plant "${plant.plantName}" (Sr.${srNo}) deleted successfully!`, 'success');
        
    } catch (error) {
        console.error('Error deleting plant:', error);
        showNotification(`Error deleting plant: ${error.message}`, 'warning');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    initializeNightMode();
});

// Close export dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('exportDropdown');
    const formulaSidebar = document.getElementById('formulaSidebar');
    const button = event.target.closest('.floating-btn');
    
    // Close export dropdown if clicking outside
    if (dropdown && !dropdown.contains(event.target) && !button) {
        dropdown.classList.remove('active');
    }
    
    // Close formula sidebar if clicking outside
    if (formulaSidebar && !formulaSidebar.contains(event.target) && !button) {
        const isFormulaButton = button && button.querySelector('.fa-calculator');
        if (!isFormulaButton) {
            formulaSidebar.classList.remove('active');
        }
    }
});

// Add keyboard shortcuts
document.addEventListener('keydown', function(event) {
    if (event.ctrlKey || event.metaKey) {
        switch(event.key) {
            case 'p':
                event.preventDefault();
                exportToPDF();
                break;
            case 's':
                event.preventDefault();
                exportToJPG();
                break;
            case 'f':
                event.preventDefault();
                toggleFormulas();
                break;
        }
    }
});

console.log('Professional Alternate Fuel Cost Economics loaded successfully!');
</script>
</body>
</html>
