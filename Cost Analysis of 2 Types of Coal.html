<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Analysis of 2 Types of Coal Calculator</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .calculator-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            width: 100%;
            max-width: 800px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calculator-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .calculator-title {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 255, 255, 0.1);
            }
            50% {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 255, 255, 0.2), 0 0 40px rgba(79, 172, 254, 0.1);
            }
        }

        /* Animated Comparison Icon */
        .comparison-icon {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coal-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2c3e50;
            font-size: 14px;
            font-weight: bold;
            animation: coalPulse 2.5s ease-in-out infinite;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .coal-icon:nth-child(1) {
            animation-delay: 0s;
        }

        .coal-icon:nth-child(3) {
            animation-delay: 1.2s;
        }

        .comparison-arrow {
            color: #ffd700;
            font-size: 20px;
            animation: arrowFloat 2s ease-in-out infinite;
            text-shadow: 0 2px 8px rgba(255, 215, 0, 0.5);
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.4));
        }

        @keyframes coalPulse {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                background: linear-gradient(135deg, #ffd700, #ff8c00);
                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3), 0 0 0 0 rgba(255, 215, 0, 0.4);
            }
            25% {
                transform: scale(1.1) rotate(5deg);
                background: linear-gradient(135deg, #ffed4e, #ffa500);
            }
            50% {
                transform: scale(1.15) rotate(0deg);
                background: linear-gradient(135deg, #fff200, #ff6600);
                box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5), 0 0 0 10px rgba(255, 215, 0, 0);
            }
            75% {
                transform: scale(1.1) rotate(-5deg);
                background: linear-gradient(135deg, #ffed4e, #ffa500);
            }
        }

        @keyframes arrowFloat {
            0%, 100% {
                transform: translateX(0) scale(1);
                opacity: 0.8;
                color: #ffd700;
            }
            25% {
                transform: translateX(2px) scale(1.1);
                opacity: 1;
                color: #fff200;
            }
            50% {
                transform: translateX(4px) scale(1.2);
                opacity: 1;
                color: #ffed4e;
            }
            75% {
                transform: translateX(2px) scale(1.1);
                opacity: 1;
                color: #fff200;
            }
        }

        .calculator-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
            font-weight: 300;
        }

        .instruction-message {
            background: rgba(74, 144, 226, 0.2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(74, 144, 226, 0.3);
            text-align: center;
            font-weight: 500;
            margin-bottom: 25px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
        }

        .input-group {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            flex-wrap: nowrap;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease;
        }

        .input-group:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .input-group-prepend {
            display: flex;
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .input-group-text1 {
            background: linear-gradient(135deg, #495057, #343a40);
            color: white;
            border: 1px solid #dee2e6;
            border-right: none;
            border-radius: 8px 0 0 8px;
            padding: 8px 12px;
            font-weight: 500;
            min-width: 180px;
            width: 180px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            line-height: 1.5;
            height: 42px;
            box-sizing: border-box;
            white-space: nowrap;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .input-group-text1:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            transform: scale(1.02);
        }

        .input-group-text2 {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-left: none;
            border-right: none;
            padding: 8px 12px;
            font-weight: bold;
            min-width: 80px;
            width: 120px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            line-height: 1.5;
            height: 42px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            color: #495057;
            flex-shrink: 0;
        }

        .input-group-text2:hover {
            background: #f8f9fa;
            transform: scale(1.02);
        }

        .dual-input-container {
            display: flex;
            flex: 1;
            gap: 1px;
        }

        .dynamic-input-container {
            display: flex;
            gap: 0;
            flex: 1;
            flex-wrap: wrap;
            position: relative;
        }

        .dynamic-input-container .input-field {
            flex: 1;
            min-width: 120px;
            border-left: none;
            position: relative;
        }

        .dynamic-input-container .input-field:first-child {
            border-radius: 0;
        }

        .dynamic-input-container .input-field:last-child {
            border-radius: 0 8px 8px 0;
        }

        /* Remove button for coal inputs */
        .remove-coal-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .remove-coal-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        /* Coal Cards Grid */
        .coal-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        /* Add Coal Button Section */
        .add-coal-section {
            text-align: center;
            margin: 20px 0;
        }

        .add-coal-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .add-coal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            background: linear-gradient(135deg, #20c997, #28a745);
        }

        /* Individual Coal Card */
        .coal-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid;
            position: relative;
            transition: all 0.3s ease;
        }

        .coal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Card Border Colors */
        .coal-card:nth-child(1) { border-color: #007bff; }
        .coal-card:nth-child(2) { border-color: #28a745; }
        .coal-card:nth-child(3) { border-color: #ffc107; }
        .coal-card:nth-child(4) { border-color: #dc3545; }
        .coal-card:nth-child(5) { border-color: #6f42c1; }
        .coal-card:nth-child(6) { border-color: #fd7e14; }

        /* Card Header */
        .coal-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .coal-card-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .coal-card-remove {
            background: rgba(220, 53, 69, 0.8);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .coal-card-remove:hover {
            background: #dc3545;
            transform: scale(1.1);
        }

        /* Coal Card Inputs */
        .coal-card-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .coal-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .coal-input-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: 500;
        }

        .coal-input-field {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 15px;
            color: white;
            font-size: 14px;
            width: 100%;
            min-width: 200px;
            transition: all 0.3s ease;
        }

        .coal-input-field:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .coal-input-field::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Plant Parameters Card */
        .plant-parameters-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #17a2b8;
            margin: 20px 0;
        }

        .plant-params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .coal-cards-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .coal-card {
                padding: 15px;
            }
            
            .plant-params-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .coal-card-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .coal-card-remove {
                align-self: flex-end;
            }
        }

        /* Coal input wrapper */
        .coal-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 120px;
        }

        .coal-input-wrapper .input-field {
            width: 100%;
            border-left: none;
        }

        .coal-input-wrapper:first-child .input-field {
            border-radius: 0;
        }

        .coal-input-wrapper:last-child .input-field {
            border-radius: 0 8px 8px 0;
        }

        .input-field {
            border: 1px solid #dee2e6;
            border-left: none;
            padding: 10px 15px;
            font-size: 0.95rem;
            font-weight: 500;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            flex: 1;
            transition: all 0.3s ease;
            outline: none;
            height: 42px;
            box-sizing: border-box;
        }

        .input-field:first-child {
            border-radius: 0;
        }

        .input-field:last-child {
            border-radius: 0 8px 8px 0;
        }

        .input-field.single {
            border-radius: 0 8px 8px 0;
        }

        .input-field:focus {
            background: rgba(255, 255, 255, 0.95);
            border-color: #4facfe;
            box-shadow: 0 0 0 0.25rem rgba(79, 172, 254, 0.25);
            transform: scale(1.02);
        }

        .results-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 25px;
            margin: 25px 0;
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .results-title {
            color: white;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .comparison-table {
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .comparison-table th {
            background: linear-gradient(135deg, #495057, #343a40);
            color: white;
            padding: 12px 8px;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
        }

        .comparison-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
        }

        .comparison-table tr:nth-child(even) {
            background: rgba(248, 249, 250, 0.5);
        }

        .comparison-table .parameter-cell {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            padding-left: 12px;
        }

        .economical-header {
            background: rgba(40, 167, 69, 0.2) !important;
            color: #28a745 !important;
            font-weight: bold !important;
        }

        .economical-cell {
            background: rgba(40, 167, 69, 0.1) !important;
            color: #28a745 !important;
            font-weight: bold !important;
        }

        .summary-section {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .summary-item {
            margin-bottom: 8px;
            font-weight: 500;
            align-content: center;
            justify-content: center;
        }

        /* Override font-weight for strong tags within summary items */
        .summary-item strong {
            font-weight: bold !important;
        }

        /* Specific override for strong tags in section headers within summary */
        .summary-item.section-header {
            font-weight: 900 !important;
            color:#1a1a1a;
        }

        /* Multi-column table responsive design */
        .comparison-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .comparison-table th,
            .comparison-table td {
                padding: 8px 4px;
                font-size: 12px;
                min-width: 80px;
            }
        }

        @media (max-width: 768px) {
            .comparison-table th,
            .comparison-table td {
                min-width: 100px;
                font-size: 11px;
            }
            
            .comparison-table {
                min-width: 600px;
            }
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 107, 0.3);
            text-align: center;
            font-weight: 500;
            display: none;
            animation: shake 0.5s ease-out;
            margin-bottom: 20px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            position: relative;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #b02a37);
            color: white;
        }

        .storage-counter {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        .floating-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .floating-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            font-size: 24px;
        }

        .floating-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .export-dropdown {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        .export-btn {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #333;
        }

        .export-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }

        .formula-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-left: 4px solid;
            border-left-color: #4facfe;
            border-image: linear-gradient(135deg, #4facfe, #00f2fe) 1;
            box-shadow: -5px 0 20px rgba(79, 172, 254, 0.3);
            transition: right 0.3s ease;
            overflow-y: auto;
            z-index: 1000;
            padding: 20px;
        }

        .formula-sidebar.active {
            right: 0;
        }

        .formula-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }

        .formula-title {
            color: #333;
            font-size: 22px;
            font-weight: 700;
            margin: 0;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .formula-item {
            margin-bottom: 15px;
            padding: 5px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .formula-name {
            color: #495057;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .formula-expression {
            color: #333;
            font-size: 12px;
            line-height: 1.6;
        }

        .formula-fallback {
            color: #666;
            font-size: 14px;
            font-style: italic;
            margin-top: 5px;
            display: none;
        }

        .no-mathjax .formula-expression {
            display: none;
        }

        .no-mathjax .formula-fallback {
            display: block;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                align-items: flex-start;
                padding: 10px;
                min-height: 100vh;
            }

            .calculator-container {
                margin-top: 40px;
                padding: 15px;
                width: calc(100vw - 20px);
                max-width: calc(100vw - 20px);
                box-sizing: border-box;
                overflow-x: hidden;
                min-height: calc(100vh - 80px);
            }

            .calculator-title {
                font-size: 22px;
                line-height: 1.3;
            }

            .calculator-subtitle {
                font-size: 14px;
                margin-bottom: 20px;
            }

            .input-group {
                
                margin-bottom: 12px;
                display: flex;
                flex-direction: row;
                align-items: stretch;
                flex-wrap: nowrap;
            }

            .input-group-prepend {
                display: flex;
            }

            .input-group-text1 {
                min-width: 0px;
                width: 250px;
                font-size: 0.8rem;
                padding: 8px 6px;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
            }

            .input-group-text2 {
                min-width: 100px;
                width: 100px;
                font-size: 0.75rem;
                padding: 8px 6px;
            }

            .dual-input-container {
                display: flex;
                flex: 1;
                gap: 1px;
            }

            .dual-input-container .input-field {
                font-size: 14px;
                padding: 12px 8px;
                flex: 1 1 50%;
                width: 50%;
                min-width: 0;
                max-width: none;
            }

            .input-field.single {
                font-size: 14px;
                padding: 12px 8px;
                flex: 1;
                width: 100%;
            }

            .input-field:first-child {
                border-radius: 0;
            }

            .input-field:last-child {
                border-radius: 0 8px 8px 0;
            }

            .input-field.single {
                border-radius: 0 8px 8px 0;
            }

            .results-container {
                padding: 15px;
                margin: 20px 0;
                overflow-x: auto;
            }

            .comparison-table {
                font-size: 12px;
                min-width: 100%;
            }

            .comparison-table th,
            .comparison-table td {
                padding: 8px 6px;
                font-size: 11px;
            }

            .comparison-table .parameter-cell {
                min-width: 120px;
                font-size: 10px;
                padding-left: 8px;
            }

            .action-buttons {
                flex-direction: row;
                gap: 10px;
                margin-top: 20px;
                justify-content: center;
            }

            .action-buttons .btn {
                flex: 1;
                max-width: 48%;
                padding: 10px 8px;
                font-size: 13px;
                text-align: center;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .formula-sidebar {
                width: 100%;
                right: -100%;
            }

            .back-button {
                top: 15px;
                left: 15px;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }

            .floating-actions {
                bottom: 20px;
                right: 20px;
            }

            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 18px;
                margin-bottom: 10px;
                background: rgba(52, 73, 94, 0.9) !important;
                border: 1px solid rgba(52, 73, 94, 0.8) !important;
                color: white !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .floating-btn:hover {
                background: rgba(44, 62, 80, 0.95) !important;
                transform: scale(1.05);
            }

            .export-dropdown {
                position: fixed;
                bottom: 140px;
                left: 50%;
                transform: translateX(-50%);
                right: auto;
                display: flex;
                flex-direction: row;
                gap: 10px;
                background: rgba(255, 255, 255, 0.95);
                padding: 10px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            }

            .export-btn {
                padding: 8px 12px;
                font-size: 12px;
                white-space: nowrap;
            }

            .error-message,
            .instruction-message {
                font-size: 14px;
                padding: 12px;
                margin: 15px 0;
            }

            .summary-section {
                padding: 12px;
                margin-top: 15px;
            }

            .summary-item {
                font-size: 13px;
                margin-bottom: 6px;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 5px;
            }

            .calculator-container {
                margin-top: 30px;
                padding: 10px;
                width: calc(100vw - 10px);
                max-width: calc(100vw - 10px);
                min-height: calc(100vh - 60px);
            }

            .calculator-title {
                font-size: 18px;
                line-height: 1.2;
            }

            .calculator-subtitle {
                font-size: 12px;
                margin-bottom: 15px;
            }

            .input-group {
                display: flex;
                flex-direction: row;
                align-items: stretch;
                flex-wrap: nowrap;
                margin-bottom: 10px;
            }

            .input-group-text1 {
                min-width: 120px;
                width: 120px;
                font-size: 0.75rem;
                padding: 6px 4px;
                white-space: nowrap;
                text-overflow: ellipsis;
                overflow: hidden;
            }

            .input-group-text2 {
                min-width: 55px;
                width: 55px;
                font-size: 0.7rem;
                padding: 6px 4px;
            }

            .dual-input-container {
                display: flex;
                flex: 1;
                gap: 1px;
            }

            .dual-input-container .input-field {
                font-size: 13px;
                padding: 10px 6px;
                flex: 1 1 50%;
                width: 50%;
                min-width: 0;
                max-width: none;
            }

            .input-field.single {
                font-size: 13px;
                padding: 10px 6px;
                flex: 1;
                width: 100%;
            }

            .comparison-table {
                font-size: 10px;
            }

            .comparison-table th,
            .comparison-table td {
                padding: 6px 4px;
                font-size: 9px;
            }

            .comparison-table .parameter-cell {
                min-width: 100px;
                font-size: 9px;
                padding-left: 6px;
            }

            .back-button {
                top: 10px;
                left: 10px;
                width: 35px;
                height: 35px;
                font-size: 16px;
            }

            .floating-actions {
                bottom: 15px;
                right: 15px;
            }

            .floating-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
                background: rgba(52, 73, 94, 0.9) !important;
                border: 1px solid rgba(52, 73, 94, 0.8) !important;
                color: white !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            .floating-btn:hover {
                background: rgba(44, 62, 80, 0.95) !important;
                transform: scale(1.05);
            }

            .export-dropdown {
                bottom: 120px;
                padding: 8px;
            }

            .export-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
        }
        
        /* Night Mode Toggle Styles */
        .night-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 15px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .toggle-label {
            font-size: 16px;
            user-select: none;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 19px;
            height: 19px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active {
            background: #4a69bd;
        }

        .toggle-switch.active::before {
            transform: translateX(25px);
        }

        /* Night Mode Styles */
        body.night-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%) !important;
            color: #ecf0f1 !important;
        }

        body.night-mode .calculator-container {
            background: rgba(26, 26, 46, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
        }

        body.night-mode .calculator-header {
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            margin-bottom: 20px !important;
            padding: 0 !important;
        }

        body.night-mode .calculator-title {
            color: #ffffff !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5) !important;
        }

        body.night-mode .coal-icon {
            background: rgba(255, 255, 255, 0.9) !important;
            color: #1a1a1a !important;
        }

        body.night-mode .comparison-arrow {
            color: #ffd700 !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5) !important;
        }

        body.night-mode .calculator-subtitle {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        body.night-mode .input-section {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .section-title {
            color: #74b9ff !important;
        }

        body.night-mode .form-control {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #ecf0f1 !important;
        }

        body.night-mode .form-control:focus {
            background: rgba(255, 255, 255, 0.15) !important;
            border-color: #74b9ff !important;
            box-shadow: 0 0 0 0.25rem rgba(116, 185, 255, 0.25) !important;
        }

        body.night-mode .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        body.night-mode .input-label {
            color: #ddd !important;
        }

        body.night-mode .unit-label {
            color: #bbb !important;
        }

        body.night-mode .calculate-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3) !important;
        }

        body.night-mode .calculate-btn:hover {
            background: linear-gradient(135deg, #0984e3, #74b9ff) !important;
        }

        body.night-mode .results-container {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .results-title {
            color: #74b9ff !important;
        }

        body.night-mode .comparison-table {
            color: #ecf0f1 !important;
            background: rgba(255, 255, 255, 0.05) !important;
        }

        body.night-mode .comparison-table th {
            background: rgba(116, 185, 255, 0.3) !important;
            color: #fff !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        body.night-mode .comparison-table td {
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: #ecf0f1 !important;
        }

        body.night-mode .comparison-table tr:nth-child(even) td {
            background: rgba(255, 255, 255, 0.12) !important;
        }

        body.night-mode .comparison-table .best-value {
            background: rgba(39, 174, 96, 0.4) !important;
            color: #2ecc71 !important;
            font-weight: bold !important;
        }

        body.night-mode .floating-btn {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: #ecf0f1 !important;
        }

        body.night-mode .floating-btn:hover {
            background: rgba(255, 255, 255, 0.2) !important;
        }

        /* Mobile night mode floating buttons - enhanced visibility */
        @media (max-width: 768px) {
            body.night-mode .floating-btn {
                background: rgba(30, 30, 30, 0.95) !important;
                border: 1px solid rgba(255, 255, 255, 0.3) !important;
                color: #ffffff !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            }

            body.night-mode .floating-btn:hover {
                background: rgba(45, 45, 45, 0.98) !important;
                transform: scale(1.05);
            }
        }

        body.night-mode .export-dropdown {
            background: rgba(26, 26, 46, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        body.night-mode .export-btn {
            color: #ecf0f1 !important;
        }

        body.night-mode .export-btn:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .instruction-message {
            background: rgba(116, 185, 255, 0.2) !important;
            border: 1px solid rgba(116, 185, 255, 0.3) !important;
            color: #74b9ff !important;
        }

        body.night-mode .error-message {
            background: rgba(231, 76, 60, 0.2) !important;
            border: 1px solid rgba(231, 76, 60, 0.3) !important;
            color: #e74c3c !important;
        }

        body.night-mode .night-mode-toggle {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        body.night-mode .toggle-label {
            color: #ecf0f1 !important;
        }

        body.night-mode .back-button {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        /* Storage Counter */
        .storage-counter {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
        }

        /* Stored Calculations Styles */
        .stored-calculations {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            max-width: 90vw;
            max-height: 70vh;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .stored-calculation-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .stored-calculation-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stored-calculation-title {
            color: #74b9ff;
            font-size: 16px;
            font-weight: bold;
            margin: 0;
        }

        .stored-calculation-date {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        .stored-calculation-data {
            color: white;
            font-size: 14px;
            line-height: 1.4;
        }

        .stored-calculation-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .calc-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .calc-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        body.night-mode .stored-calculations {
            background: rgba(26, 26, 46, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.night-mode .stored-calculation-item {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Mobile responsive adjustments for night mode toggle */
        @media (max-width: 768px) {
            .calculator-container {
                margin-top: 40px !important;
            }
            
            .night-mode-toggle {
                top: 15px;
                right: 15px;
                padding: 6px 12px;
            }

            .stored-calculations {
                width: 350px;
                top: 80px;
            }
        }

        @media (max-width: 480px) {
            .calculator-container {
                margin-top: 70px !important;
            }
            
            .night-mode-toggle {
                top: 10px;
                right: 10px;
                padding: 5px 10px;
                font-size: 14px;
            }

            .stored-calculations {
                width: 320px;
                top: 70px;
            }
        }

        @media (max-width: 360px) {
            .calculator-container {
                margin-top: 65px !important;
            }
            
            .night-mode-toggle {
                top: 8px;
                right: 8px;
                padding: 4px 8px;
                font-size: 13px;
            }

            .stored-calculations {
                width: 280px;
                top: 65px;
            }
        }

        /* Animation System */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(100px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-100px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes rotateIn {
            from {
                opacity: 0;
                transform: rotate(-200deg);
            }
            to {
                opacity: 1;
                transform: rotate(0);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes flipIn {
            from {
                opacity: 0;
                transform: perspective(400px) rotateX(-90deg);
            }
            to {
                opacity: 1;
                transform: perspective(400px) rotateX(0deg);
            }
        }

        /* Animation Classes */
        .animate-slide-in-left {
            animation: slideInLeft 0.6s ease-out forwards;
        }

        .animate-slide-in-right {
            animation: slideInRight 0.6s ease-out forwards;
        }

        .animate-slide-in-up {
            animation: slideInUp 0.6s ease-out forwards;
        }

        .animate-slide-in-down {
            animation: slideInDown 0.6s ease-out forwards;
        }

        .animate-zoom-in {
            animation: zoomIn 0.5s ease-out forwards;
        }

        .animate-rotate-in {
            animation: rotateIn 0.8s ease-out forwards;
        }

        .animate-bounce-in {
            animation: bounceIn 0.8s ease-out forwards;
        }

        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .animate-flip-in {
            animation: flipIn 0.6s ease-out forwards;
        }

        /* Initial state for animated elements */
        .animate-slide-in-left,
        .animate-slide-in-right,
        .animate-slide-in-up,
        .animate-slide-in-down,
        .animate-zoom-in,
        .animate-rotate-in,
        .animate-bounce-in,
        .animate-flip-in {
            opacity: 0;
        }
    </style>
</head>
<body>
    <!-- Back Button -->
    <button class="back-button" onclick="goBack()" title="Back to Calculators">
        <i class="fas fa-arrow-left"></i>
    </button>

    <!-- Night Mode Toggle -->
    <div class="night-mode-toggle">
        <span class="toggle-label">🌙</span>
        <div class="toggle-switch" onclick="toggleNightMode()"></div>
        <span class="toggle-label">☀️</span>
    </div>

    <!-- Main Calculator Container -->
    <div class="calculator-container">
        <div class="calculator-header">
            <h1 class="calculator-title">
                <div class="comparison-icon">
                    <div class="coal-icon">A</div>
                    <i class="fas fa-exchange-alt comparison-arrow"></i>
                    <div class="coal-icon">B</div>
                </div>
                Coal Cost Analysis
            </h1>
            <p class="calculator-subtitle">Compare costs between various types of coal</p>
        </div>

        <!-- Instruction Message -->
        <div class="instruction-message" id="instruction-message">
            <i class="fas fa-info-circle me-2"></i>
            Fill all parameters to compare coal costs
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Results Container -->
        <div class="results-container" id="resultsContainer">
            <h3 class="results-title" id="resultsTitle">Cost Analysis Results</h3>
            <table class="comparison-table" id="comparisonTable">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th id="coal1Header">Coal Type 1</th>
                        <th id="coal2Header">Coal Type 2</th>
                    </tr>
                </thead>
                <tbody id="comparisonTableBody">
                    <!-- Dynamic content will be inserted here -->
                </tbody>
            </table>
            <div class="summary-section" id="summarySection">
                <!-- Summary results will be displayed here -->
            </div>
        </div>

        <!-- Coal Cards Container -->
        <div id="coalCardsContainer" class="coal-cards-grid">
            <!-- Coal cards will be dynamically generated here -->
        </div>

        <!-- Add Coal Button -->
        <div class="add-coal-section">
            <button class="btn btn-success add-coal-btn" onclick="addCoalType()" title="Add Coal Type">
                <i class="fas fa-plus me-2"></i> Add Coal Type
            </button>
        </div>

        <!-- Plant Parameters Section -->
        <div class="plant-parameters-card">
            <div class="coal-card-header">
                <h6 class="coal-card-title">
                    <i class="fas fa-industry me-2"></i>
                    Plant Parameters
                </h6>
            </div>
            
            <div class="plant-params-grid">
                <div class="coal-input-group">
                    <label class="coal-input-label">Generation Capacity (MW)</label>
                    <input type="number" class="coal-input-field" id="capacity" step="1" min="0" placeholder="2300">
                </div>

                <div class="coal-input-group">
                    <label class="coal-input-label">PLF (%)</label>
                    <input type="number" class="coal-input-field" id="plf" step="0.01" min="0" max="100" placeholder="85">
                </div>

                <div class="coal-input-group">
                    <label class="coal-input-label">Number of Days</label>
                    <input type="number" class="coal-input-field" id="days" step="1" min="0" max="365" placeholder="365">
                </div>

                <div class="coal-input-group">
                    <label class="coal-input-label">Station Heat Rate (kcal/kWh)</label>
                    <input type="number" class="coal-input-field" id="shr" step="0.01" min="0" placeholder="2700">
                </div>

                <div class="coal-input-group">
                    <label class="coal-input-label">Coal Quantity (MT) - Optional</label>
                    <input type="number" class="coal-input-field" id="coalQuantity" step="1" min="0" placeholder="100000">
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-success" onclick="calculate()">
                <i class="fas fa-calculator"></i>
                Calculate
            </button>
            <button class="btn btn-primary" onclick="storeCalculation()">
                <i class="fas fa-save"></i>
                Store Data
                <span class="storage-counter" id="storageCounter">0</span>
            </button>
            <button class="btn btn-danger" onclick="clearInputs()">
                <i class="fas fa-eraser"></i>
                Clear
            </button>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-actions">
        <button class="floating-btn" onclick="toggleStoredCalculations()" title="Stored Calculations">
            <i class="fas fa-database"></i>
            <span class="storage-counter" id="floatingStorageCounter">0</span>
        </button>
        <button class="floating-btn" onclick="toggleFormulas()" title="View Formulas">
            <i class="fas fa-calculator"></i>
        </button>
        <button class="floating-btn" onclick="toggleExportOptions()" title="Export Options">
            <i class="fas fa-download"></i>
        </button>
    </div>

    <!-- Export Dropdown -->
    <div class="export-dropdown" id="exportDropdown">
        <button class="export-btn" onclick="exportToPDF()">
            <i class="fas fa-file-pdf text-danger"></i>
            Export as PDF
        </button>
        <button class="export-btn" onclick="exportToJPG()">
            <i class="fas fa-image text-primary"></i>
            Export as JPG
        </button>
    </div>

    <!-- Stored Calculations -->
    <div class="stored-calculations" id="storedCalculationsContainer" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 style="color: white; margin: 0;">
                <i class="fas fa-database me-2"></i>Stored Calculations
            </h4>
            <button type="button" class="btn btn-outline-light btn-sm" onclick="clearAllStoredData()" title="Clear All Stored Data">
                <i class="fas fa-trash-alt me-1"></i>Clear All
            </button>
        </div>
        <div id="storedCalculationsList"></div>
    </div>

    <!-- Formula Sidebar -->
    <div class="formula-sidebar" id="formulaSidebar">
        <div class="formula-header">
            <h2 class="formula-title">Formulas</h2>
            <button class="close-btn" onclick="toggleFormulas()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Generation} = \text{Capacity} \times \frac{\text{PLF}}{100} \times 24 \times \text{Days}$$
                <div class="formula-fallback">Generation = Capacity × (PLF ÷ 100) × 24 × Days</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Coal Required} = \frac{\text{Generation} \times \text{SHR}}{\text{GCV} \times 1000}$$
                <div class="formula-fallback">Coal Required = (Generation × SHR) ÷ (GCV × 1000)</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Landed Cost} = \text{Coal Cost} + \text{Railway Freight}$$
                <div class="formula-fallback">Landed Cost = Coal Cost + Railway Freight</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Landed Cost (MCal)} = \frac{\text{Landed Cost (MT)}}{\text{GCV}}$$
                <div class="formula-fallback">Landed Cost (MCal) = Landed Cost (MT) ÷ GCV</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Energy Charges} = \frac{\text{Landed Cost (MT)} \times \text{SHR}}{\text{GCV} \times 1000}$$
                <div class="formula-fallback">Energy Charges = (Landed Cost × SHR) ÷ (GCV × 1000)</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{SCC} = \frac{\text{SHR}}{\text{GCV}}$$
                <div class="formula-fallback">SCC = SHR ÷ GCV</div>
            </div>
        </div>

        <div class="formula-item">
            <div class="formula-expression">
                $$\text{Total Cost} = \text{Coal Required} \times \text{Landed Cost}$$
            </div>
        </div>
    </div>

    <!-- Include necessary libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>

    <script>
        // Global variables
        let storedCalculations = JSON.parse(localStorage.getItem('coalAnalysisCalculations') || '[]');
        let isExportDropdownOpen = false;
        let inputs, results, errorMessage, storageCounter, instructionMessage;
        let coalCount = 2; // Track number of coal types
        let maxCoalTypes = 6; // Maximum allowed coal types

        // Initialize DOM elements after page loads
        function initializeElements() {
            // Initialize only the basic elements first
            inputs = {
                capacity: document.getElementById('capacity'),
                plf: document.getElementById('plf'),
                days: document.getElementById('days'),
                shr: document.getElementById('shr'),
                coalQuantity: document.getElementById('coalQuantity')
            };

            results = {
                container: document.getElementById('resultsContainer'),
                title: document.getElementById('resultsTitle'),
                table: document.getElementById('comparisonTable'),
                tableBody: document.getElementById('comparisonTableBody'),
                summarySection: document.getElementById('summarySection')
            };

            errorMessage = document.getElementById('errorMessage');
            storageCounter = document.getElementById('storageCounter');
            instructionMessage = document.getElementById('instruction-message');
        }

        // Dynamic coal management functions
        function updateInputsObject() {
            inputs = {
                capacity: document.getElementById('capacity'),
                plf: document.getElementById('plf'),
                days: document.getElementById('days'),
                shr: document.getElementById('shr'),
                coalQuantity: document.getElementById('coalQuantity')
            };

            // Add dynamic coal inputs
            for (let i = 1; i <= coalCount; i++) {
                inputs[`coal${i}Name`] = document.getElementById(`coal${i}Name`);
                inputs[`coal${i}Cost`] = document.getElementById(`coal${i}Cost`);
                inputs[`coal${i}Freight`] = document.getElementById(`coal${i}Freight`);
                inputs[`coal${i}GCV`] = document.getElementById(`coal${i}GCV`);
            }
        }

        function addCoalType() {
            if (coalCount >= maxCoalTypes) {
                showError(`Maximum ${maxCoalTypes} coal types allowed.`);
                return;
            }

            coalCount++;
            
            const coalCardsContainer = document.getElementById('coalCardsContainer');
            const coalCard = createCoalCard(coalCount);
            coalCardsContainer.appendChild(coalCard);
            
            updateInputsObject();
            updateInstructionMessage();
            
            // Add event listeners to new inputs
            setupInputEventListeners(coalCard);
            
            // Show success message
            showError(`Coal Type ${coalCount} added successfully!`, 'success');
        }

        function createCoalCard(index) {
            const coalCard = document.createElement('div');
            coalCard.className = 'coal-card';
            coalCard.setAttribute('data-coal-index', index);
            
            coalCard.innerHTML = `
                <div class="coal-card-header">
                    <h6 class="coal-card-title">Coal ${index}</h6>
                    ${index > 2 ? `
                        <button type="button" class="coal-card-remove" onclick="removeCoalType(${index})" title="Remove Coal">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                </div>
                
                <div class="coal-card-inputs">
                    <div class="coal-input-group">
                        <label class="coal-input-label">Coal Name</label>
                        <input type="text" 
                               class="coal-input-field coal-name" 
                               id="coal${index}Name" 
                               placeholder="Enter coal name"
                               data-allow-text="true">
                    </div>
                    
                    <div class="coal-input-group">
                        <label class="coal-input-label">Coal Cost (Rs/MT)</label>
                        <input type="number" 
                               class="coal-input-field coal-cost" 
                               id="coal${index}Cost" 
                               step="0.01" 
                               min="0" 
                               placeholder="${2400 + (index - 1) * 200}">
                    </div>
                    
                    <div class="coal-input-group">
                        <label class="coal-input-label">Railway Freight (Rs/MT)</label>
                        <input type="number" 
                               class="coal-input-field coal-freight" 
                               id="coal${index}Freight" 
                               step="0.01" 
                               min="0" 
                               placeholder="${2500 + (index - 1) * 200}">
                    </div>
                    
                    <div class="coal-input-group">
                        <label class="coal-input-label">GCV (kcal/kg)</label>
                        <input type="number" 
                               class="coal-input-field coal-gcv" 
                               id="coal${index}GCV" 
                               step="0.01" 
                               min="0" 
                               placeholder="${4300 + (index - 1) * 200}">
                    </div>
                </div>
            `;
            
            return coalCard;
        }

        function createCoalInput(type, id, placeholder, allowText = false) {
            const wrapper = document.createElement('div');
            wrapper.className = 'coal-input-wrapper';
            
            const input = document.createElement('input');
            input.type = type;
            input.className = 'input-field';
            input.id = id;
            input.placeholder = placeholder;
            
            if (type === 'number') {
                input.step = '0.01';
                input.min = '0';
            }
            
            if (allowText) {
                input.setAttribute('data-allow-text', 'true');
            }

            // Add remove button (only if more than 2 coal types)
            if (coalCount > 2) {
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-coal-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.title = 'Remove this coal type';
                removeBtn.onclick = () => removeCoalType(coalCount);
                wrapper.appendChild(removeBtn);
            }

            wrapper.appendChild(input);
            return wrapper;
        }

        function getPlaceholderValue(type) {
            const placeholders = {
                cost: (2400 + (coalCount - 1) * 200).toString(),
                freight: (2500 + (coalCount - 1) * 200).toString(),
                gcv: (4300 + (coalCount - 1) * 200).toString()
            };
            return placeholders[type] || '';
        }

        function removeCoalType(coalIndex) {
            if (coalCount <= 2) {
                showError('Minimum 2 coal types required.');
                return;
            }

            // Remove the coal card from DOM
            const coalCard = document.querySelector(`.coal-card[data-coal-index="${coalIndex}"]`);
            if (coalCard) {
                coalCard.remove();
            }

            // Reindex remaining coal cards
            reindexCoalCards();
            
            coalCount--;
            
            // Update inputs object
            updateInputsObject();
            
            // Update instruction message
            updateInstructionMessage();
            
            // Show success message
            showError(`Coal type removed successfully!`, 'success');
        }

        function reindexCoalCards() {
            const coalCards = document.querySelectorAll('.coal-card');
            coalCards.forEach((card, index) => {
                const newIndex = index + 1;
                card.setAttribute('data-coal-index', newIndex);
                
                // Update card title
                const title = card.querySelector('.coal-card-title');
                if (title) {
                    title.textContent = `Coal ${newIndex}`;
                }
                
                // Update input IDs
                const nameInput = card.querySelector('.coal-name');
                const costInput = card.querySelector('.coal-cost');
                const freightInput = card.querySelector('.coal-freight');
                const gcvInput = card.querySelector('.coal-gcv');
                
                if (nameInput) nameInput.id = `coal${newIndex}Name`;
                if (costInput) costInput.id = `coal${newIndex}Cost`;
                if (freightInput) freightInput.id = `coal${newIndex}Freight`;
                if (gcvInput) gcvInput.id = `coal${newIndex}GCV`;
                
                // Update remove button (only show for index > 2)
                const removeBtn = card.querySelector('.coal-card-remove');
                if (removeBtn) {
                    if (newIndex <= 2) {
                        removeBtn.remove();
                    } else {
                        removeBtn.onclick = () => removeCoalType(newIndex);
                    }
                } else if (newIndex > 2) {
                    // Add remove button if it doesn't exist but should
                    const header = card.querySelector('.coal-card-header');
                    const newRemoveBtn = document.createElement('button');
                    newRemoveBtn.type = 'button';
                    newRemoveBtn.className = 'coal-card-remove';
                    newRemoveBtn.onclick = () => removeCoalType(newIndex);
                    newRemoveBtn.title = 'Remove Coal';
                    newRemoveBtn.innerHTML = '<i class="fas fa-times"></i>';
                    header.appendChild(newRemoveBtn);
                }
            });
        }

        // Utility functions
        function setupInputEventListeners(container = document) {
            const inputs = container.querySelectorAll('.coal-input-field');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    updateInstructionMessage();
                    // Auto-calculate silently when all required fields are filled
                    autoCalculate();
                });
                input.addEventListener('change', () => {
                    updateInstructionMessage();
                    // Auto-calculate silently when all required fields are filled
                    autoCalculate();
                });
            });
        }

        function formatNumber(num, decimals = 2) {
            if (isNaN(num) || num === null || num === undefined) return '-';
            return new Intl.NumberFormat('en-IN', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num);
        }

        function showError(message, type = 'error', hideResults = true) {
            errorMessage.textContent = message;
            
            // Style based on message type
            if (type === 'success') {
                errorMessage.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                errorMessage.style.borderColor = '#28a745';
                errorMessage.style.color = '#155724';
            } else {
                errorMessage.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                errorMessage.style.borderColor = '#dc3545';
                errorMessage.style.color = '#721c24';
            }
            
            errorMessage.style.display = 'block';
            if (type !== 'success' && hideResults) {
                results.container.style.display = 'none';
            }
            instructionMessage.style.display = 'none';
            
            setTimeout(() => {
                errorMessage.style.display = 'none';
                instructionMessage.style.display = 'block';
                // Reset to default error styling
                errorMessage.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                errorMessage.style.borderColor = '#dc3545';
                errorMessage.style.color = '#721c24';
            }, type === 'success' ? 4000 : 3000); // Show success messages a bit longer
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function updateInstructionMessage() {
            const values = getInputValues();
            
            // Check if all coal names are filled
            const namesComplete = values.coalTypes && values.coalTypes.every(coal => coal.name && coal.name.trim() !== '');
            
            // Check if all coal properties are filled
            const coalPropertiesComplete = values.coalTypes && values.coalTypes.every(coal => 
                !isNaN(coal.cost) && !isNaN(coal.freight) && !isNaN(coal.gcv)
            );
            
            // Check if all plant parameters are filled
            const plantParamsComplete = !isNaN(values.capacity) && !isNaN(values.plf) && 
                                      !isNaN(values.days) && !isNaN(values.shr) && !isNaN(values.coalQuantity);
            
            if (!namesComplete || !coalPropertiesComplete || !plantParamsComplete) {
                instructionMessage.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    Fill all parameters to compare ${coalCount} coal types
                `;
                instructionMessage.style.display = 'block';
                instructionMessage.style.color = 'white';
            } else {
                instructionMessage.style.display = 'none';
            }
        }

        function getInputValues() {
            if (!inputs || !inputs.capacity) {
                console.log('Inputs not initialized yet');
                return {};
            }
            
            const values = {
                capacity: parseFloat(inputs.capacity.value),
                plf: parseFloat(inputs.plf.value),
                days: parseFloat(inputs.days.value),
                shr: parseFloat(inputs.shr.value),
                coalQuantity: parseFloat(inputs.coalQuantity.value),
                coalTypes: []
            };

            // Get values for all coal types
            for (let i = 1; i <= coalCount; i++) {
                const nameInput = inputs[`coal${i}Name`];
                const costInput = inputs[`coal${i}Cost`];
                const freightInput = inputs[`coal${i}Freight`];
                const gcvInput = inputs[`coal${i}GCV`];
                
                if (nameInput && costInput && freightInput && gcvInput) {
                    const coalData = {
                        name: nameInput.value.trim() || '',
                        cost: parseFloat(costInput.value),
                        freight: parseFloat(freightInput.value),
                        gcv: parseFloat(gcvInput.value)
                    };
                    values.coalTypes.push(coalData);
                } else {
                    // Fallback to direct DOM access
                    const nameEl = document.getElementById(`coal${i}Name`);
                    const costEl = document.getElementById(`coal${i}Cost`);
                    const freightEl = document.getElementById(`coal${i}Freight`);
                    const gcvEl = document.getElementById(`coal${i}GCV`);
                    
                    if (nameEl && costEl && freightEl && gcvEl) {
                        const coalData = {
                            name: nameEl.value.trim() || '',
                            cost: parseFloat(costEl.value),
                            freight: parseFloat(freightEl.value),
                            gcv: parseFloat(gcvEl.value)
                        };
                        values.coalTypes.push(coalData);
                    } else {
                        console.log(`Warning: Coal ${i} inputs not found`);
                    }
                }
            }
            
            return values;
        }

        function validateInputs(values) {
            console.log('Validating inputs with values:', values);
            
            // Check if we have coal types data
            if (!values.coalTypes || values.coalTypes.length === 0) {
                console.log('No coal types found in values');
                showError('No coal types found. Please ensure coal cards are loaded properly.');
                return false;
            }
            
            // Check for missing coal names
            for (let i = 0; i < values.coalTypes.length; i++) {
                console.log(`Checking coal ${i + 1} name:`, values.coalTypes[i].name);
                if (!values.coalTypes[i].name || values.coalTypes[i].name.trim() === '') {
                    const error = `Please enter name for Coal Type ${i + 1}.`;
                    console.log('Validation error:', error);
                    showError(error);
                    return false;
                }
            }

            // Check if any plant parameter is empty
            const plantInputs = [
                inputs.capacity.value, inputs.plf.value, inputs.days.value, 
                inputs.shr.value, inputs.coalQuantity.value
            ];

            console.log('Plant inputs:', plantInputs);
            if (plantInputs.some(v => v.trim() === '')) {
                const error = 'Please fill in all plant parameter fields.';
                console.log('Validation error:', error);
                showError(error);
                return false;
            }

            // Check coal properties for all coal types
            for (let i = 0; i < values.coalTypes.length; i++) {
                const coal = values.coalTypes[i];
                const coalValues = [coal.cost, coal.freight, coal.gcv];
                
                if (coalValues.some(v => isNaN(v))) {
                    const error = `Please enter valid numeric values for ${coal.name || `Coal Type ${i + 1}`}.`;
                    console.log('Validation error:', error);
                    showError(error);
                    return false;
                }

                if (coalValues.some(v => v < 0)) {
                    const error = `Please enter valid non-negative values for ${coal.name || `Coal Type ${i + 1}`}.`;
                    console.log('Validation error:', error);
                    showError(error);
                    return false;
                }
            }

            // Check for negative or invalid numeric values for plant parameters
            const plantValues = [values.capacity, values.plf, values.days, values.shr, values.coalQuantity];

            if (plantValues.some(v => isNaN(v))) {
                const error = 'Please enter valid numeric values for plant parameters.';
                console.log('Validation error:', error);
                showError(error);
                return false;
            }

            if (plantValues.some(v => v < 0)) {
                const error = 'Please enter valid non-negative values for plant parameters.';
                console.log('Validation error:', error);
                showError(error);
                return false;
            }

            if (values.plf > 100) {
                const error = 'PLF cannot exceed 100%.';
                console.log('Validation error:', error);
                showError(error);
                return false;
            }

            if (values.days > 365) {
                const error = 'Days cannot exceed 365.';
                console.log('Validation error:', error);
                showError(error);
                return false;
            }

            console.log('Validation passed!');
            return true;
        }

        function calculateComparison() {
            const values = getInputValues();
            
            if (!validateInputs(values)) return null;

            hideError();
            updateInstructionMessage();

            // Common calculations
            const generation = values.capacity * (values.plf / 100) * 24 * values.days; // MWh
            
            // Initialize results array
            const coalResults = [];
            
            // Calculate for each coal type
            values.coalTypes.forEach((coal, index) => {
                const landedCost = coal.cost + coal.freight;
                const required = (generation * values.shr) / (coal.gcv * 1000); // MT
                const landedCostMC = landedCost / coal.gcv;
                const energyCharges = (landedCost * values.shr) / (coal.gcv * 1000);
                const scc = values.shr / coal.gcv;
                const totalCost = (required * 1000 * landedCost) / 10000000; // Crores (using displayed quantity)
                const fuelCost = required * landedCost; // Total fuel cost in Rs
                
                coalResults.push({
                    index: index,
                    name: coal.name,
                    cost: coal.cost,
                    freight: coal.freight,
                    gcv: coal.gcv,
                    landedCost: landedCost,
                    required: required,
                    landedCostMC: landedCostMC,
                    energyCharges: energyCharges,
                    scc: scc,
                    totalCost: totalCost,
                    fuelCost: fuelCost
                });
            });
            
            // Sort by energy charges (most economical first)
            coalResults.sort((a, b) => a.energyCharges - b.energyCharges);
            
            // Calculate savings relative to most expensive coal
            const mostExpensive = coalResults[coalResults.length - 1];
            const mostEconomical = coalResults[0];
            
            coalResults.forEach(coal => {
                coal.savingsVsMostExpensive = mostExpensive.fuelCost - coal.fuelCost;
                coal.isEconomical = coal.index === mostEconomical.index;
            });

            return {
                values,
                generation,
                coalResults,
                mostEconomical: mostEconomical.name,
                mostExpensive: mostExpensive.name,
                maxSavings: mostExpensive.fuelCost - mostEconomical.fuelCost
            };
        }

        function displayResults(calculation) {
            if (!calculation) return;

            const { values, generation, coalResults, mostEconomical, mostExpensive, maxSavings } = calculation;

            // Update title with multiple coal names
            const coalNames = coalResults.map(coal => coal.name).join(' vs ');
            results.title.textContent = `${coalNames} Analysis`;

            // Create dynamic table headers
            const headerRow = results.table.querySelector('thead tr');
            headerRow.innerHTML = `
                <th class="parameter-cell">Parameters</th>
                ${coalResults.map(coal => `
                    <th class="text-center ${coal.isEconomical ? 'economical-header' : ''}">${coal.name}</th>
                `).join('')}
            `;

            // Create table rows with dynamic columns
            const parameters = [
                { label: 'Cost (Rs/MT)', key: 'cost', decimals: 2 },
                { label: 'Freight (Rs/MT)', key: 'freight', decimals: 2 },
                { label: 'GCV (kcal/kg)', key: 'gcv', decimals: 0 },
                { label: 'Quantity Required (MT)', key: 'required', decimals: 0, transform: val => val * 1000 },
                { label: 'Landed Cost (Rs/MT)', key: 'landedCost', decimals: 2 },
                { label: 'Landed Cost (Rs/MCal)', key: 'landedCostMC', decimals: 3 },
                { label: 'Energy Charges (Rs/kWh)', key: 'energyCharges', decimals: 4 },
                { label: 'SCC (kg/kWh)', key: 'scc', decimals: 3 },
                { label: 'Total Expenditure (Rs. Crore)', key: 'totalCost', decimals: 2 }
            ];

            results.tableBody.innerHTML = parameters.map(param => `
                <tr>
                    <td class="parameter-cell">${param.label}</td>
                    ${coalResults.map(coal => {
                        const value = param.transform ? param.transform(coal[param.key]) : coal[param.key];
                        const cellClass = coal.isEconomical && param.key === 'energyCharges' ? 'economical-cell' : '';
                        return `<td class="${cellClass}">${formatNumber(value, param.decimals)}</td>`;
                    }).join('')}
                </tr>
            `).join('');

            // Update summary section for multiple coals
            const totalSavingAmount = (maxSavings * 100) / 10000000; // Convert to crores
            
            results.summarySection.innerHTML = `
                <div class="summary-item section-header">
                    <i class="fas fa-trophy text-warning me-2"></i>
                    <strong>${mostEconomical}</strong> is the most economical coal
                </div>
                <div class="summary-item">
                    <i class="fas fa-coins text-success me-2"></i>
                    Maximum saving vs <strong>${mostExpensive}</strong>: <strong>Rs. ${formatNumber(totalSavingAmount, 2)} Crore</strong>
                </div>
                <div class="summary-item">
                    <i class="fas fa-bolt text-primary me-2"></i>
                    Generation: <strong>${formatNumber(generation, 2)} Lakh Units</strong>
                </div>
                <div class="summary-item">
                    <i class="fas fa-chart-line text-info me-2"></i>
                    Comparing <strong>${coalResults.length}</strong> coal types
                </div>
            `;

            results.container.style.display = 'block';
        }

        function calculate() {
            const calculation = calculateComparison();
            displayResults(calculation);
            return calculation;
        }

        function autoCalculate() {
            const values = getInputValues();
            
            // Check if we have minimum required data for auto-calculation
            const hasMinimumData = values.coalTypes && values.coalTypes.length >= 2;
            const allNamesProvided = hasMinimumData && values.coalTypes.every(coal => coal.name && coal.name.trim() !== '');
            const allCoalPropsProvided = hasMinimumData && values.coalTypes.every(coal => 
                !isNaN(coal.cost) && !isNaN(coal.freight) && !isNaN(coal.gcv) &&
                coal.cost >= 0 && coal.freight >= 0 && coal.gcv > 0
            );
            const allPlantParamsProvided = values.capacity > 0 && values.plf > 0 && values.days > 0 && 
                                         values.shr > 0 && values.coalQuantity > 0;

            if (hasMinimumData && allNamesProvided && allCoalPropsProvided && allPlantParamsProvided) {
                const calculation = calculateComparisonSilent(values);
                if (calculation) {
                    displayResults(calculation);
                }
            }
        }

        function calculateComparisonSilent(values) {
            // Silent calculation without validation errors
            hideError();
            updateInstructionMessage();

            // Common calculations
            const generation = values.capacity * (values.plf / 100) * 24 * values.days; // MWh
            
            // Initialize results array
            const coalResults = [];
            
            // Calculate for each coal type
            values.coalTypes.forEach((coal, index) => {
                const landedCost = coal.cost + coal.freight;
                const required = (generation * values.shr) / (coal.gcv * 1000); // MT
                const landedCostMC = landedCost / coal.gcv;
                const energyCharges = (landedCost * values.shr) / (coal.gcv * 1000);
                const scc = values.shr / coal.gcv;
                const totalCost = (required * 1000 * landedCost) / 10000000; // Crores (using displayed quantity)
                const fuelCost = required * landedCost; // Total fuel cost in Rs
                
                coalResults.push({
                    index: index,
                    name: coal.name,
                    cost: coal.cost,
                    freight: coal.freight,
                    gcv: coal.gcv,
                    landedCost: landedCost,
                    required: required,
                    landedCostMC: landedCostMC,
                    energyCharges: energyCharges,
                    scc: scc,
                    totalCost: totalCost,
                    fuelCost: fuelCost
                });
            });
            
            // Sort by energy charges (most economical first)
            coalResults.sort((a, b) => a.energyCharges - b.energyCharges);
            
            // Calculate savings relative to most expensive coal
            const mostExpensive = coalResults[coalResults.length - 1];
            const mostEconomical = coalResults[0];
            
            coalResults.forEach(coal => {
                coal.savingsVsMostExpensive = mostExpensive.fuelCost - coal.fuelCost;
                coal.isEconomical = coal.index === mostEconomical.index;
            });

            return {
                values,
                generation,
                coalResults,
                mostEconomical: mostEconomical.name,
                mostExpensive: mostExpensive.name,
                maxSavings: mostExpensive.fuelCost - mostEconomical.fuelCost
            };
        }

        function storeCalculation() {
            const calculation = calculate();
            if (!calculation) return;

            const timestamp = new Date().toISOString();
            
            // Get input values directly
            const inputValues = getInputValues();
            
            // Use the most economical coal from the calculation
            const bestOption = calculation.mostEconomical || 'N/A';
            
            const storedData = {
                timestamp,
                coalTypes: inputValues.coalTypes || [],
                capacity: inputValues.capacity || 0,
                plf: inputValues.plf || 0,
                days: inputValues.days || 0,
                shr: inputValues.shr || 0,
                coalQuantity: inputValues.coalQuantity || 0,
                bestOption: bestOption,
                mostExpensive: calculation.mostExpensive || 'N/A',
                maxSavings: calculation.maxSavings || 0,
                coalCount: inputValues.coalTypes ? inputValues.coalTypes.length : 0,
                results: calculation
            };

            // Get current stored calculations
            let storedCalculations = JSON.parse(localStorage.getItem('coalAnalysisCalculations') || '[]');
            storedCalculations.push(storedData);
            localStorage.setItem('coalAnalysisCalculations', JSON.stringify(storedCalculations));
            updateStoredCalculationsCounter();
            showMessage('Calculation stored successfully!', 'success');
        }

        // Dedicated function for showing messages without hiding results
        function showMessage(message, type = 'info') {
            if (!errorMessage) return;
            
            errorMessage.textContent = message;
            
            if (type === 'success') {
                errorMessage.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                errorMessage.style.borderColor = '#28a745';
                errorMessage.style.color = '#155724';
            } else {
                errorMessage.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                errorMessage.style.borderColor = '#dc3545';
                errorMessage.style.color = '#721c24';
            }
            
            errorMessage.style.display = 'block';
            // Don't hide results for messages
            
            setTimeout(() => {
                errorMessage.style.display = 'none';
                // Reset to default error styling
                errorMessage.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                errorMessage.style.borderColor = '#dc3545';
                errorMessage.style.color = '#721c24';
            }, type === 'success' ? 3000 : 2500);
        }

        function clearInputs() {
            // Clear coal name inputs
            document.getElementById('coal1Name').value = '';
            document.getElementById('coal2Name').value = '';
            
            // Clear coal properties
            document.getElementById('coal1Cost').value = '';
            document.getElementById('coal2Cost').value = '';
            document.getElementById('coal1Freight').value = '';
            document.getElementById('coal2Freight').value = '';
            document.getElementById('coal1GCV').value = '';
            document.getElementById('coal2GCV').value = '';
            
            // Clear plant parameters
            document.getElementById('capacity').value = '';
            document.getElementById('plf').value = '';
            document.getElementById('days').value = '';
            document.getElementById('shr').value = '';
            document.getElementById('coalQuantity').value = '';
            
            // Clear results section
            document.getElementById('results').innerHTML = '';
            
            console.log('All input fields cleared successfully!');
        }

        function clearData() {
            let storedCalculations = JSON.parse(localStorage.getItem('coalAnalysisCalculations') || '[]');
            if (storedCalculations.length === 0) {
                showError('No data to clear.');
                return;
            }

            if (confirm('Are you sure you want to clear all stored calculations?')) {
                localStorage.removeItem('coalAnalysisCalculations');
                updateStoredCalculationsCounter();
                showMessage('All stored data cleared successfully!', 'success');
            }
        }

        function updateStorageCounter() {
            const storedCalculations = JSON.parse(localStorage.getItem('coalAnalysisCalculations') || '[]');
            if (storageCounter) {
                storageCounter.textContent = storedCalculations.length;
            }
        }

        // Back Button Functionality
        function goBack() {
            // Try to go back to parent window if opened from main app
            if (window.opener && !window.opener.closed) {
                try {
                    // If opened from main app, switch focus back and close this tab
                    window.opener.focus();
                    // Call function to show calculators page in parent window
                    if (typeof window.opener.showCalculatorsPage === 'function') {
                        window.opener.showCalculatorsPage();
                    }
                    window.close();
                } catch (e) {
                    // If cross-origin or other security issues, fallback to alert
                    alert('Please use the browser back button or close this tab to return to the main application.');
                }
            } else {
                // If no parent window, try to navigate to main app
                try {
                    window.location.href = 'index.html#calculators';
                } catch (e) {
                    alert('Please use the browser back button to return to the main application.');
                }
            }
        }

        function toggleFormulas() {
            const sidebar = document.getElementById('formulaSidebar');
            sidebar.classList.toggle('active');
            
            if (sidebar.classList.contains('active')) {
                setTimeout(() => {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        MathJax.typesetPromise([sidebar]).then(() => {
                            console.log('MathJax formulas rendered successfully');
                        }).catch((err) => {
                            console.log('MathJax rendering error:', err);
                        });
                    }
                }, 100);
            }
        }

        function toggleExportOptions() {
            const dropdown = document.getElementById('exportDropdown');
            isExportDropdownOpen = !isExportDropdownOpen;
            dropdown.style.display = isExportDropdownOpen ? 'flex' : 'none';
        }

        function exportToPDF() {
            console.log('ExportToPDF function called');
            
            // Try to get current calculation first
            const currentCalculation = calculateComparison();
            if (currentCalculation) {
                // Export current calculation
                exportCurrentCalculationToPDF(currentCalculation);
                return;
            }
            
            // Fallback to stored calculations
            const storedCalculations = JSON.parse(localStorage.getItem('coalAnalysisCalculations') || '[]');
            console.log('Stored calculations:', storedCalculations);
            
            if (storedCalculations.length === 0) {
                showError('No data to export. Please enter coal data or store some calculations first.', 'error', false);
                return;
            }

            try {
                if (!window.jspdf) {
                    showError('PDF library not loaded. Please refresh the page and try again.', 'error', false);
                    return;
                }
                
                exportStoredCalculationsToPDF(storedCalculations);
                
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                showError('Error occurred while exporting to PDF. Please try again.', 'error', false);
                toggleExportOptions();
            }
        }

        function exportCurrentCalculationToPDF(calculation) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                let yPosition = 20;
                const pageWidth = 210;
                const margin = 20;
                
                // Header
                doc.setFillColor(79, 172, 254);
                doc.rect(0, 0, pageWidth, 20, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('Coal Cost Analysis Report', pageWidth/2, 12, { align: 'center' });
                
                yPosition = 35;
                doc.setTextColor(0, 0, 0);
                
                // Coal comparison title
                const coalNames = calculation.coalResults.map(coal => coal.name).join(' vs ');
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`Analysis: ${coalNames}`, margin, yPosition);
                yPosition += 12;
                
                // Input values
                const values = getInputValues();
                
                // Plant parameters table
                const plantParams = [
                    ['Generation Capacity', `${values.capacity} MW`],
                    ['Plant Load Factor (PLF)', `${values.plf}%`],
                    ['Number of Days', `${values.days} Days`],
                    ['Station Heat Rate (SHR)', `${values.shr} kcal/kWh`],
                    ['Coal Quantity (if specified)', values.coalQuantity ? `${(values.coalQuantity/100000).toFixed(2)} Lakh MT` : 'Not specified']
                ];
                
                doc.autoTable({
                    head: [['Plant Parameters', 'Value']],
                    body: plantParams,
                    startY: yPosition,
                    margin: { left: margin, right: margin },
                    styles: { fontSize: 9, cellPadding: 2, font: 'helvetica' },
                    headStyles: { fillColor: [52, 144, 220], textColor: [255, 255, 255], fontStyle: 'bold' },
                    theme: 'grid'
                });
                
                yPosition = doc.lastAutoTable.finalY + 8;
                
                // Coal input parameters
                const coalInputData = calculation.coalResults.map(coal => [
                    coal.name,
                    `${coal.cost}`,
                    `${coal.freight}`,
                    `${coal.gcv}`
                ]);
                
                doc.autoTable({
                    head: [['Coal Type', 'Cost (Rs/MT)', 'Freight (Rs/MT)', 'GCV (kcal/kg)']],
                    body: coalInputData,
                    startY: yPosition,
                    margin: { left: margin, right: margin },
                    styles: { fontSize: 9, cellPadding: 2, font: 'helvetica' },
                    headStyles: { fillColor: [52, 144, 220], textColor: [255, 255, 255], fontStyle: 'bold' },
                    theme: 'grid'
                });
                
                yPosition = doc.lastAutoTable.finalY + 8;
                
                // Results table
                const resultsData = [
                    ['Quantity Required (MT)', ...calculation.coalResults.map(coal => `${(coal.required * 1000).toFixed(0)}`)],
                    ['Landed Cost (Rs/MT)', ...calculation.coalResults.map(coal => `${coal.landedCost.toFixed(2)}`)],
                    ['Landed Cost (Rs/MCal)', ...calculation.coalResults.map(coal => `${coal.landedCostMC.toFixed(3)}`)],
                    ['Energy Charges (Rs/kWh)', ...calculation.coalResults.map(coal => `${coal.energyCharges.toFixed(4)}`)],
                    ['SCC (kg/kWh)', ...calculation.coalResults.map(coal => `${coal.scc.toFixed(3)}`)],
                    ['Total Expenditure (Rs. Crore)', ...calculation.coalResults.map(coal => `${coal.totalCost.toFixed(2)}`)]
                ];
                
                const headers = ['Parameters', ...calculation.coalResults.map(coal => coal.name)];
                
                doc.autoTable({
                    head: [headers],
                    body: resultsData,
                    startY: yPosition,
                    margin: { left: margin, right: margin },
                    styles: { fontSize: 8, cellPadding: 2, font: 'helvetica' },
                    headStyles: { fillColor: [220, 53, 69], textColor: [255, 255, 255], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [248, 249, 250] },
                    theme: 'grid'
                });
                
                yPosition = doc.lastAutoTable.finalY + 10;
                
                // Summary
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Summary:', margin, yPosition);
                yPosition += 6;
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`Most Economical: ${calculation.mostEconomical}`, margin, yPosition);
                yPosition += 5;
                doc.text(`Most Expensive: ${calculation.mostExpensive}`, margin, yPosition);
                yPosition += 5;
                doc.text(`Maximum Savings: Rs. ${(calculation.maxSavings / 10000000).toFixed(2)} Crore`, margin, yPosition);
                yPosition += 5;
                doc.text(`Generation: ${calculation.generation.toFixed(2)} Lakh Units`, margin, yPosition);
                yPosition += 5;
                doc.text(`Comparing: ${calculation.coalResults.length} coal types`, margin, yPosition);
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Report Generated: ${new Date().toLocaleString()}`, pageWidth/2, 285, { align: 'center' });
                
                doc.save('Coal_Analysis_Report.pdf');
                toggleExportOptions();
                showMessage('PDF exported successfully!', 'success');
                
            } catch (error) {
                console.error('Error exporting current calculation to PDF:', error);
                showError('Error occurred while exporting to PDF. Please try again.', 'error', false);
                toggleExportOptions();
            }
        }

        function exportStoredCalculationsToPDF(storedCalculations) {
            // Keep the existing stored calculations export logic for backward compatibility
            // This function will handle the legacy stored data format
            const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4'); // A4 portrait format
            
            let yPosition = 20;
            const pageWidth = 210; // A4 width in mm
            const margin = 20;
            const contentWidth = pageWidth - (2 * margin);
            
            // Compact Header
            doc.setFillColor(79, 172, 254); // Theme blue color
            doc.rect(0, 0, pageWidth, 20, 'F');
            
            // Title only
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Coal Analysis of Two Types of Coal', pageWidth/2, 12, { align: 'center' });
            
            yPosition = 30;
            
            // Total records info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text(`Total Analysis Records: ${storedCalculations.length}`, pageWidth/2, yPosition, { align: 'center' });
            
            yPosition += 10;
            
            // Process each stored calculation
            storedCalculations.forEach((calc, index) => {
                // Start each analysis on a new page (except the first one)
                if (index > 0) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Analysis header
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPosition - 3, contentWidth, 10, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(13);
                doc.setFont('helvetica', 'bold');
                doc.text(`Analysis ${index + 1}: ${calc.coal1Name} vs ${calc.coal2Name}`, margin + 3, yPosition + 3);
                
                yPosition += 12;
                
                // Input Parameters Section
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('INPUT PARAMETERS', margin, yPosition);
                yPosition += 6;
                
                // Plant Parameters Table
                const plantParams = [
                    ['Generation Capacity', `${calc.capacity} MW`],
                    ['Plant Load Factor (PLF)', `${calc.plf}%`],
                    ['Number of Days', `${calc.days} Days`],
                    ['Station Heat Rate (SHR)', `${calc.shr} kcal/kWh`],
                    ['Coal Quantity (if specified)', calc.coalQuantity ? `${(calc.coalQuantity/100000).toFixed(2)} Lakh MT` : 'Not specified']
                ];
                
                doc.autoTable({
                    head: [['Parameter', 'Value']],
                    body: plantParams,
                    startY: yPosition,
                    margin: { left: margin, right: margin },
                    tableWidth: contentWidth,
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [79, 172, 254], textColor: [255, 255, 255], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [248, 249, 250] },
                    theme: 'grid'
                });
                
                yPosition = doc.lastAutoTable.finalY + 6;
                
                // Coal Properties Comparison
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('COAL PROPERTIES COMPARISON', margin, yPosition);
                yPosition += 6;
                
                const coalProps = [
                    ['Coal Cost (Rs/MT)', `${calc.coal1Cost}`, `${calc.coal2Cost}`],
                    ['Railway Freight (Rs/MT)', `${calc.coal1Freight}`, `${calc.coal2Freight}`],
                    ['GCV (kcal/kg)', `${calc.coal1GCV}`, `${calc.coal2GCV}`],
                    ['Landed Cost (Rs/MT)', 
                        `${(calc.coal1Cost + calc.coal1Freight).toFixed(2)}`, 
                        `${(calc.coal2Cost + calc.coal2Freight).toFixed(2)}`],
                    ['Landed Cost (Rs/MCal)', 
                        `${((calc.coal1Cost + calc.coal1Freight) / calc.coal1GCV).toFixed(3)}`, 
                        `${((calc.coal2Cost + calc.coal2Freight) / calc.coal2GCV).toFixed(3)}`]
                ];
                
                doc.autoTable({
                    head: [['Parameter', calc.coal1Name, calc.coal2Name]],
                    body: coalProps,
                    startY: yPosition,
                    margin: { left: margin, right: margin },
                    tableWidth: contentWidth,
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [40, 167, 69], textColor: [255, 255, 255], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [248, 249, 250] },
                    theme: 'grid'
                });
                
                yPosition = doc.lastAutoTable.finalY + 6;
                
                // Results Section
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('ANALYSIS RESULTS', margin, yPosition);
                yPosition += 6;
                
                // Calculate generation
                const generation = calc.capacity * (calc.plf / 10000) * 24 * calc.days;
                
                const results = [
                    ['Generation (Lakh Units)', `${(generation).toFixed(2)}`],
                    ['Coal Required (Lakh MT)', 
                        `${(calc.results.coal1.required / 100000).toFixed(2)}`, 
                        `${(calc.results.coal2.required / 100000).toFixed(2)}`],
                    ['Energy Charges (Rs/kWh)', 
                        `${calc.results.coal1.energyCharges.toFixed(4)}`, 
                        `${calc.results.coal2.energyCharges.toFixed(4)}`],
                    ['SCC (kg/kWh)', 
                        `${calc.results.coal1.scc.toFixed(3)}`, 
                        `${calc.results.coal2.scc.toFixed(3)}`],
                    ['Total Expenditure (Rs. Crore)', 
                        `${calc.results.coal1.totalCost.toFixed(2)}`, 
                        `${calc.results.coal2.totalCost.toFixed(2)}`]
                ];
                
                doc.autoTable({
                    head: [['Parameter', calc.coal1Name, calc.coal2Name]],
                    body: results,
                    startY: yPosition,
                    margin: { left: margin, right: margin },
                    tableWidth: contentWidth,
                    styles: { fontSize: 8, cellPadding: 2 },
                    headStyles: { fillColor: [220, 53, 69], textColor: [255, 255, 255], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [248, 249, 250] },
                    theme: 'grid'
                });
                
                yPosition = doc.lastAutoTable.finalY + 6;
                
                // Economic Analysis
                const economicalCoal = calc.results.coal1.totalCost < calc.results.coal2.totalCost ? calc.coal1Name : calc.coal2Name;
                const savings = Math.abs(calc.results.coal1.totalCost - calc.results.coal2.totalCost);
                const perUnitSaving = Math.abs(calc.results.coal1.energyCharges - calc.results.coal2.energyCharges);
                
                // Calculate coal quantity savings if specified
                let coalQuantitySavings = 0;
                let coalQuantityText = '';
                if (calc.coalQuantity && calc.coalQuantity > 0) {
                    const coal1LandedCost = calc.coal1Cost + calc.coal1Freight;
                    const coal2LandedCost = calc.coal2Cost + calc.coal2Freight;
                    const economicalLandedCost = economicalCoal === calc.coal1Name ? coal1LandedCost : coal2LandedCost;
                    const otherLandedCost = economicalCoal === calc.coal1Name ? coal2LandedCost : coal1LandedCost;
                    const economicalGCV = economicalCoal === calc.coal1Name ? calc.coal1GCV : calc.coal2GCV;
                    const otherGCV = economicalCoal === calc.coal1Name ? calc.coal2GCV : calc.coal1GCV;
                    
                    // Calculate savings per MT based on equivalent energy
                    coalQuantitySavings = ((otherLandedCost * (economicalGCV / otherGCV)) - economicalLandedCost) * calc.coalQuantity / 10000000; // in Crores
                    coalQuantityText = `Rs. ${coalQuantitySavings.toFixed(2)} Crore for ${(calc.coalQuantity/100000).toFixed(2)} Lakh MT`;
                }
                
                // Conclusion box - compact height
                const boxHeight = calc.coalQuantity && calc.coalQuantity > 0 ? 28 : 22;
                doc.setFillColor(40, 167, 69);
                doc.rect(margin, yPosition - 2, contentWidth, boxHeight, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text('ECONOMIC CONCLUSION', margin + 3, yPosition + 4);
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text(`• ${economicalCoal} coal is more economical`, margin + 3, yPosition + 10);
                doc.text(`• Total Savings: Rs. ${savings.toFixed(2)} Crore`, margin + 3, yPosition + 15);
                doc.text(`• Per Unit Cost Reduction: Rs. ${perUnitSaving.toFixed(4)}`, margin + 85, yPosition + 10);
                doc.text(`• Generation: ${generation.toFixed(2)} Lakh Units`, margin + 85, yPosition + 15);
                
                // Add coal quantity savings if available
                if (calc.coalQuantity && calc.coalQuantity > 0) {
                    doc.text(`• Coal Quantity Savings: ${coalQuantityText}`, margin + 3, yPosition + 20);
                }
                
                yPosition += boxHeight + 8;
            });
            
            // Footer on last page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text(`Page ${i} of ${pageCount}`, pageWidth/2, 285, { align: 'center' });
                doc.text('Generated by Coal Cost Analysis Calculator', pageWidth/2, 290, { align: 'center' });
                
                // Add report generation info to the last page
                if (i === pageCount) {
                    doc.text(`Report Generated: ${new Date().toLocaleString()}`, pageWidth/2, 295, { align: 'center' });
                }
            }

            doc.save('Professional_Coal_Cost_Analysis_Report.pdf');
            toggleExportOptions();
            showMessage('PDF exported successfully!', 'success');
        }

        async function exportToJPG() {
            console.log('ExportToJPG function called');
            
            // Try to get current calculation first
            const currentCalculation = calculateComparison();
            if (currentCalculation) {
                // Export current calculation
                await exportCurrentCalculationToJPG(currentCalculation);
                return;
            }
            
            // Fallback to stored calculations
            const storedCalculations = JSON.parse(localStorage.getItem('coalAnalysisCalculations') || '[]');
            console.log('Stored calculations for JPG:', storedCalculations);
            
            if (storedCalculations.length === 0) {
                showError('No data to export. Please enter coal data or store some calculations first.', 'error', false);
                return;
            }

            try {
                if (!window.html2canvas) {
                    showError('Image export library not loaded. Please refresh the page and try again.', 'error', false);
                    return;
                }
                
                // Use simplified stored export for now
                await exportSimpleStoredToJPG(storedCalculations);
                
            } catch (error) {
                console.error('Error exporting to JPG:', error);
                showError('Error occurred while exporting to JPG. Please try again.', 'error', false);
            }
            
            toggleExportOptions();
        }

        async function exportCurrentCalculationToJPG(calculation) {
            try {
                if (!window.html2canvas) {
                    showError('Image export library not loaded. Please refresh the page and try again.', 'error', false);
                    return;
                }

                const pageWidth = 794;
                const pageHeight = 1123;
                const margin = 60;
                
                // Get input values
                const values = getInputValues();
                
                // Coal names for title
                const coalNames = calculation.coalResults.map(coal => coal.name).join(' vs ');
                
                // Create page content
                const pageContent = `
                    <div style="background: #f0f0f0; padding: 8px; margin: 0 0 15px 0; border-radius: 4px;">
                        <h2 style="margin: 0; font-size: 18px; font-weight: bold; color: #333;">Analysis: ${coalNames}</h2>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h3 style="color: #2c3e50; font-size: 16px; margin: 0 0 8px 0; border-bottom: 2px solid #3498db; padding-bottom: 5px;">Plant Parameters</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 10px;">
                            <tr style="background: #f8f9fa;"><td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">Generation Capacity</td><td style="padding: 5px; border: 0.5px solid #666; color: #000; font-weight: normal;">${values.capacity} MW</td></tr>
                            <tr><td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">Plant Load Factor (PLF)</td><td style="padding: 5px; border: 0.5px solid #666; color: #000; font-weight: normal;">${values.plf}%</td></tr>
                            <tr style="background: #f8f9fa;"><td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">Number of Days</td><td style="padding: 5px; border: 0.5px solid #666; color: #000; font-weight: normal;">${values.days} Days</td></tr>
                            <tr><td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">Station Heat Rate (SHR)</td><td style="padding: 5px; border: 0.5px solid #666; color: #000; font-weight: normal;">${values.shr} kcal/kWh</td></tr>
                            <tr style="background: #f8f9fa;"><td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">Coal Quantity</td><td style="padding: 5px; border: 0.5px solid #666; color: #000; font-weight: normal;">${values.coalQuantity ? (values.coalQuantity/100000).toFixed(2) + ' Lakh MT' : 'Not specified'}</td></tr>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h3 style="color: #2c3e50; font-size: 16px; margin: 0 0 8px 0; border-bottom: 2px solid #e74c3c; padding-bottom: 5px;">Coal Input Parameters</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #3498db; color: white;">
                                    <th style="padding: 6px; border: 0.5px solid #666; text-align: left; font-weight: bold;">Coal Type</th>
                                    <th style="padding: 6px; border: 0.5px solid #666; text-align: center; font-weight: bold;">Cost (Rs/MT)</th>
                                    <th style="padding: 6px; border: 0.5px solid #666; text-align: center; font-weight: bold;">Freight (Rs/MT)</th>
                                    <th style="padding: 6px; border: 0.5px solid #666; text-align: center; font-weight: bold;">GCV (kcal/kg)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${calculation.coalResults.map((coal, index) => `
                                    <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                                        <td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">${coal.name}</td>
                                        <td style="padding: 5px; border: 0.5px solid #666; text-align: center; color: #000; font-weight: normal;">${coal.cost}</td>
                                        <td style="padding: 5px; border: 0.5px solid #666; text-align: center; color: #000; font-weight: normal;">${coal.freight}</td>
                                        <td style="padding: 5px; border: 0.5px solid #666; text-align: center; color: #000; font-weight: normal;">${coal.gcv}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h3 style="color: #2c3e50; font-size: 16px; margin: 0 0 8px 0; border-bottom: 2px solid #e74c3c; padding-bottom: 5px;">Analysis Results</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                            <thead>
                                <tr style="background: #e74c3c; color: white;">
                                    <th style="padding: 6px; border: 0.5px solid #666; text-align: left; font-weight: bold;">Parameters</th>
                                    ${calculation.coalResults.map(coal => `<th style="padding: 6px; border: 0.5px solid #666; text-align: center; font-weight: bold;">${coal.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">Quantity Required (MT)</td>
                                    ${calculation.coalResults.map(coal => `<td style="padding: 5px; border: 0.5px solid #666; text-align: center; color: #000; font-weight: normal;">${(coal.required * 1000).toFixed(0)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">Landed Cost (Rs/MT)</td>
                                    ${calculation.coalResults.map(coal => `<td style="padding: 5px; border: 0.5px solid #666; text-align: center; color: #000; font-weight: normal;">${coal.landedCost.toFixed(2)}</td>`).join('')}
                                </tr>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">Landed Cost (Rs/MCal)</td>
                                    ${calculation.coalResults.map(coal => `<td style="padding: 5px; border: 0.5px solid #666; text-align: center; color: #000; font-weight: normal;">${coal.landedCostMC.toFixed(3)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">Energy Charges (Rs/kWh)</td>
                                    ${calculation.coalResults.map(coal => `<td style="padding: 5px; border: 0.5px solid #666; text-align: center; color: #000; font-weight: normal;">${coal.energyCharges.toFixed(4)}</td>`).join('')}
                                </tr>
                                <tr style="background: #f8f9fa;">
                                    <td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">SCC (kg/kWh)</td>
                                    ${calculation.coalResults.map(coal => `<td style="padding: 5px; border: 0.5px solid #666; text-align: center; color: #000; font-weight: normal;">${coal.scc.toFixed(3)}</td>`).join('')}
                                </tr>
                                <tr>
                                    <td style="padding: 5px; border: 0.5px solid #666; font-weight: normal; color: #000;">Total Expenditure (Rs. Crore)</td>
                                    ${calculation.coalResults.map(coal => `<td style="padding: 5px; border: 0.5px solid #666; text-align: center; color: #000; font-weight: normal;">${coal.totalCost.toFixed(2)}</td>`).join('')}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 8px; border-left: 5px solid #27ae60;">
                        <h3 style="color: #27ae60; font-size: 14px; margin: 0 0 5px 0; font-weight: bold;">Summary</h3>
                        <p style="margin: 3px 0; font-size: 12px; color: #000; font-weight: normal;"><strong style="color: #000;">Most Economical:</strong> ${calculation.mostEconomical}</p>
                        <p style="margin: 3px 0; font-size: 12px; color: #000; font-weight: normal;"><strong style="color: #000;">Most Expensive:</strong> ${calculation.mostExpensive}</p>
                        <p style="margin: 3px 0; font-size: 12px; color: #000; font-weight: normal;"><strong style="color: #000;">Maximum Savings:</strong> Rs. ${(calculation.maxSavings / 10000000).toFixed(2)} Crore</p>
                        <p style="margin: 3px 0; font-size: 12px; color: #000; font-weight: normal;"><strong style="color: #000;">Generation:</strong> ${calculation.generation.toFixed(2)} Lakh Units</p>
                        <p style="margin: 3px 0; font-size: 12px; color: #000; font-weight: normal;"><strong style="color: #000;">Comparing:</strong> ${calculation.coalResults.length} coal types</p>
                    </div>
                `;

                // Create the page element
                const pageDiv = document.createElement('div');
                pageDiv.style.cssText = `
                    width: ${pageWidth}px;
                    height: ${pageHeight}px;
                    background: white;
                    font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                    position: relative;
                    box-sizing: border-box;
                    padding: 0;
                    margin: 0;
                    overflow: hidden;
                `;
                
                // Header
                const header = document.createElement('div');
                header.style.cssText = `
                    width: 100%;
                    height: 60px;
                    background: linear-gradient(135deg, #4facfe, #00f2fe);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0;
                    padding: 0;
                `;
                
                const title = document.createElement('h1');
                title.textContent = 'Coal Cost Analysis Report';
                title.style.cssText = `
                    color: white;
                    font-size: 24px;
                    font-weight: bold;
                    margin: 0;
                    text-align: center;
                `;
                header.appendChild(title);
                
                // Content
                const content = document.createElement('div');
                content.style.cssText = `
                    padding: ${margin}px;
                    padding-top: 20px;
                    height: ${pageHeight - 60 - 40}px;
                    overflow: hidden;
                    box-sizing: border-box;
                `;
                content.innerHTML = pageContent;
                
                // Footer
                const footer = document.createElement('div');
                footer.style.cssText = `
                    position: absolute;
                    bottom: 10px;
                    width: 100%;
                    text-align: center;
                    font-size: 12px;
                    color: #666;
                    line-height: 1.4;
                `;
                footer.innerHTML = `
                    <div>Generated by Coal Cost Analysis Calculator</div>
                    <div>Report Generated: ${new Date().toLocaleString()}</div>
                `;
                
                pageDiv.appendChild(header);
                pageDiv.appendChild(content);
                pageDiv.appendChild(footer);
                
                // Add to DOM temporarily for rendering
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = 'position: absolute; top: -9999px; left: -9999px;';
                document.body.appendChild(tempContainer);
                tempContainer.appendChild(pageDiv);
                
                // Convert to image
                const canvas = await html2canvas(pageDiv, {
                    width: pageWidth,
                    height: pageHeight,
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true
                });
                
                // Download
                const link = document.createElement('a');
                link.download = 'Coal_Analysis_Report.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.92);
                link.click();
                
                // Cleanup
                document.body.removeChild(tempContainer);
                
                showMessage('JPG exported successfully!', 'success');
                toggleExportOptions();
                
            } catch (error) {
                console.error('Error exporting current calculation to JPG:', error);
                showError('Error occurred while exporting to JPG. Please try again.', 'error', false);
                toggleExportOptions();
            }
        }

        async function exportSimpleStoredToJPG(storedCalculations) {
            // Simplified stored calculations export
            showMessage('Stored calculations JPG export - Feature being updated for multi-coal support', 'success');
                const pageWidth = 794; // A4 width at 96 DPI (210mm)
                const pageHeight = 1123; // A4 height at 96 DPI (297mm)
                const margin = 60;
                const contentWidth = pageWidth - (2 * margin);
                
                // Create a temporary container for each page
                const createPageElement = (pageContent, pageNumber, totalPages) => {
                    const pageDiv = document.createElement('div');
                    pageDiv.style.cssText = `
                        width: ${pageWidth}px;
                        height: ${pageHeight}px;
                        background: white;
                        font-family: 'Segoe UI', sans-serif;
                        position: relative;
                        page-break-after: always;
                        box-sizing: border-box;
                        padding: 0;
                        margin: 0;
                        overflow: hidden;
                    `;
                    
                    // Header
                    const header = document.createElement('div');
                    header.style.cssText = `
                        width: 100%;
                        height: 60px;
                        background: linear-gradient(135deg, #4facfe, #00f2fe);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0;
                        padding: 0;
                    `;
                    
                    const title = document.createElement('h1');
                    title.textContent = 'Coal Analysis of Two Types of Coal';
                    title.style.cssText = `
                        color: white;
                        font-size: 24px;
                        font-weight: bold;
                        margin: 0;
                        text-align: center;
                    `;
                    header.appendChild(title);
                    
                    // Content container
                    const content = document.createElement('div');
                    content.style.cssText = `
                        padding: ${margin}px;
                        padding-top: 20px;
                        height: ${pageHeight - 60 - 40}px; // Subtract header and footer
                        overflow: hidden;
                        box-sizing: border-box;
                    `;
                    content.innerHTML = pageContent;
                    
                    // Footer
                    const footer = document.createElement('div');
                    footer.style.cssText = `
                        position: absolute;
                        bottom: 10px;
                        width: 100%;
                        text-align: center;
                        font-size: 12px;
                        color: #666;
                        line-height: 1.4;
                    `;
                    footer.innerHTML = `
                        <div>Page ${pageNumber} of ${totalPages}</div>
                        <div>Generated by Coal Cost Analysis Calculator</div>
                        ${pageNumber === totalPages ? `<div>Report Generated: ${new Date().toLocaleString()}</div>` : ''}
                    `;
                    
                    pageDiv.appendChild(header);
                    pageDiv.appendChild(content);
                    pageDiv.appendChild(footer);
                    
                    return pageDiv;
                };
                
                // Create content for each analysis
                const pages = [];
                
                // First page with overview
                let overviewContent = `
                    <div style="text-align: center; margin: 20px 0; font-size: 14px; color: #333;">
                        Total Analysis Records: ${storedCalculations.length}
                    </div>
                `;
                
                storedCalculations.forEach((calc, index) => {
                    // Calculate generation
                    const generation = calc.capacity * (calc.plf / 10000) * 24 * calc.days;
                    const economicalCoal = calc.results.coal1.totalCost < calc.results.coal2.totalCost ? calc.coal1Name : calc.coal2Name;
                    const savings = Math.abs(calc.results.coal1.totalCost - calc.results.coal2.totalCost);
                    const perUnitSaving = Math.abs(calc.results.coal1.energyCharges - calc.results.coal2.energyCharges);
                    
                    // Calculate coal quantity savings if specified
                    let coalQuantitySavings = 0;
                    let coalQuantityText = '';
                    if (calc.coalQuantity && calc.coalQuantity > 0) {
                        const coal1LandedCost = calc.coal1Cost + calc.coal1Freight;
                        const coal2LandedCost = calc.coal2Cost + calc.coal2Freight;
                        const economicalLandedCost = economicalCoal === calc.coal1Name ? coal1LandedCost : coal2LandedCost;
                        const otherLandedCost = economicalCoal === calc.coal1Name ? coal2LandedCost : coal1LandedCost;
                        const economicalGCV = economicalCoal === calc.coal1Name ? calc.coal1GCV : calc.coal2GCV;
                        const otherGCV = economicalCoal === calc.coal1Name ? calc.coal2GCV : calc.coal1GCV;
                        
                        coalQuantitySavings = ((otherLandedCost * (economicalGCV / otherGCV)) - economicalLandedCost) * calc.coalQuantity / 10000000;
                        coalQuantityText = `Rs. ${coalQuantitySavings.toFixed(2)} Crore for ${(calc.coalQuantity/100000).toFixed(2)} Lakh MT`;
                    }
                    
                    const pageContent = `
                        <div style="background: #f0f0f0; padding: 8px; margin: 0 0 15px 0; border-radius: 4px;">
                            <h2 style="margin: 0; font-size: 18px; font-weight: bold; color: #333;">Analysis ${index + 1}: ${calc.coal1Name} vs ${calc.coal2Name}</h2>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin: 0 0 8px 0; color: #333;">INPUT PARAMETERS</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 15px;">
                                <thead>
                                    <tr style="background: #4facfe; color: white;">
                                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Parameter</th>
                                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="background: #f8f9fa;"><td style="padding: 6px; border: 1px solid #ddd;">Generation Capacity</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.capacity} MW</td></tr>
                                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Plant Load Factor (PLF)</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.plf}%</td></tr>
                                    <tr style="background: #f8f9fa;"><td style="padding: 6px; border: 1px solid #ddd;">Number of Days</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.days} Days</td></tr>
                                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Station Heat Rate (SHR)</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.shr} kcal/kWh</td></tr>
                                    <tr style="background: #f8f9fa;"><td style="padding: 6px; border: 1px solid #ddd;">Coal Quantity (if specified)</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.coalQuantity ? `${(calc.coalQuantity/100000).toFixed(2)} Lakh MT` : 'Not specified'}</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin: 0 0 8px 0; color: #333;">COAL PROPERTIES COMPARISON</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 15px;">
                                <thead>
                                    <tr style="background: #28a745; color: white;">
                                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Parameter</th>
                                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">${calc.coal1Name}</th>
                                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">${calc.coal2Name}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="background: #f8f9fa;"><td style="padding: 6px; border: 1px solid #ddd;">Coal Cost (Rs/MT)</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.coal1Cost}</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.coal2Cost}</td></tr>
                                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Railway Freight (Rs/MT)</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.coal1Freight}</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.coal2Freight}</td></tr>
                                    <tr style="background: #f8f9fa;"><td style="padding: 6px; border: 1px solid #ddd;">GCV (kcal/kg)</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.coal1GCV}</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.coal2GCV}</td></tr>
                                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Landed Cost (Rs/MT)</td><td style="padding: 6px; border: 1px solid #ddd;">${(calc.coal1Cost + calc.coal1Freight).toFixed(2)}</td><td style="padding: 6px; border: 1px solid #ddd;">${(calc.coal2Cost + calc.coal2Freight).toFixed(2)}</td></tr>
                                    <tr style="background: #f8f9fa;"><td style="padding: 6px; border: 1px solid #ddd;">Landed Cost (Rs/MCal)</td><td style="padding: 6px; border: 1px solid #ddd;">${((calc.coal1Cost + calc.coal1Freight) / calc.coal1GCV).toFixed(3)}</td><td style="padding: 6px; border: 1px solid #ddd;">${((calc.coal2Cost + calc.coal2Freight) / calc.coal2GCV).toFixed(3)}</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin: 0 0 8px 0; color: #333;">ANALYSIS RESULTS</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px; margin-bottom: 15px;">
                                <thead>
                                    <tr style="background: #dc3545; color: white;">
                                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Parameter</th>
                                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">${calc.coal1Name}</th>
                                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">${calc.coal2Name}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="background: #f8f9fa;"><td style="padding: 6px; border: 1px solid #ddd;">Generation (Lakh Units)</td><td colspan="2" style="padding: 6px; border: 1px solid #ddd; text-align: center;">${generation.toFixed(2)}</td></tr>
                                    <tr><td style="padding: 6px; border: 1px solid #ddd;">Coal Required (Lakh MT)</td><td style="padding: 6px; border: 1px solid #ddd;">${(calc.results.coal1.required / 100000).toFixed(2)}</td><td style="padding: 6px; border: 1px solid #ddd;">${(calc.results.coal2.required / 100000).toFixed(2)}</td></tr>
                                    <tr style="background: #f8f9fa;"><td style="padding: 6px; border: 1px solid #ddd;">Energy Charges (Rs/kWh)</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.results.coal1.energyCharges.toFixed(4)}</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.results.coal2.energyCharges.toFixed(4)}</td></tr>
                                    <tr><td style="padding: 6px; border: 1px solid #ddd;">SCC (kg/kWh)</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.results.coal1.scc.toFixed(3)}</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.results.coal2.scc.toFixed(3)}</td></tr>
                                    <tr style="background: #f8f9fa;"><td style="padding: 6px; border: 1px solid #ddd;">Total Expenditure (Rs. Crore)</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.results.coal1.totalCost.toFixed(2)}</td><td style="padding: 6px; border: 1px solid #ddd;">${calc.results.coal2.totalCost.toFixed(2)}</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="background: #28a745; color: white; padding: 12px; border-radius: 4px; margin-top: 15px;">
                            <h3 style="font-size: 16px; font-weight: bold; margin: 0 0 8px 0;">ECONOMIC CONCLUSION</h3>
                            <div style="font-size: 13px; line-height: 1.4;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>• ${economicalCoal} coal is more economical</span>
                                    <span>• Per Unit Cost Reduction: Rs. ${perUnitSaving.toFixed(4)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>• Total Savings: Rs. ${savings.toFixed(2)} Crore</span>
                                    <span>• Generation: ${generation.toFixed(2)} Lakh Units</span>
                                </div>
                                ${calc.coalQuantity && calc.coalQuantity > 0 ? `<div>• Coal Quantity Savings: ${coalQuantityText}</div>` : ''}
                            </div>
                        </div>
                    `;
                    
                    pages.push(createPageElement(pageContent, index + 1, storedCalculations.length));
                });
                
                // Create a temporary container to hold all pages
                const tempContainer = document.createElement('div');
                tempContainer.style.cssText = 'position: absolute; top: -9999px; left: -9999px;';
                document.body.appendChild(tempContainer);
                
                // Process each page and create JPG files
                for (let i = 0; i < pages.length; i++) {
                    tempContainer.appendChild(pages[i]);
                    
                    // Use html2canvas to convert page to image
                    const canvas = await html2canvas(pages[i], {
                        width: pageWidth,
                        height: pageHeight,
                        scale: 2, // Higher resolution
                        backgroundColor: '#ffffff',
                        logging: false,
                        useCORS: true
                    });
                    
                    // Download the image
                    const link = document.createElement('a');
                    const filename = storedCalculations.length > 1 
                        ? `Professional_Coal_Analysis_Report_Page_${i + 1}.jpg`
                        : 'Professional_Coal_Analysis_Report.jpg';
                    link.download = filename;
                    link.href = canvas.toDataURL('image/jpeg', 0.92);
                    link.click();
                    
                    tempContainer.removeChild(pages[i]);
                    
                    // Add a small delay between downloads to prevent browser blocking
                    if (i < pages.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                // Clean up
                document.body.removeChild(tempContainer);
                
                // Show success message
        }

        function setupEventListeners() {
            // Event listeners
            Object.values(inputs).forEach(input => {
                if (!input) return;
                
                input.addEventListener('input', () => {
                    updateInstructionMessage();
                    autoCalculate(); // Use silent auto-calculation
                });
                
                // Restrict numeric inputs
                if (input.type === 'number') {
                    input.addEventListener('keydown', function(e) {
                        const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Home', 'End'];
                        if (allowedKeys.includes(e.key)) return;
                        
                        if (e.key === '.' && this.value.includes('.')) {
                            e.preventDefault();
                            return;
                        }
                        
                        if (e.key === '-' || e.key === '+' || e.key === 'e' || (!/^\d$/.test(e.key) && e.key !== '.')) {
                            e.preventDefault();
                        }
                    });
                }
            });

            // PLF limit enforcement
            if (inputs.plf) {
                inputs.plf.addEventListener('input', function() {
                    if (parseFloat(this.value) > 100) {
                        this.value = 100;
                    }
                });
            }

            // Days limit enforcement
            if (inputs.days) {
                inputs.days.addEventListener('input', function() {
                    if (parseFloat(this.value) > 365) {
                        this.value = 365;
                    }
                });
            }

            // Close export dropdown and formula sidebar when clicking outside
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('exportDropdown');
                const formulaSidebar = document.getElementById('formulaSidebar');
                const exportButton = e.target.closest('.floating-btn');
                const formulaButton = e.target.closest('[onclick*="toggleFormulas"]');
                
                // Close export dropdown when clicking outside
                if (!exportButton && dropdown && !dropdown.contains(e.target) && isExportDropdownOpen) {
                    toggleExportOptions();
                }
                
                // Close formula sidebar when clicking outside
                if (!formulaButton && formulaSidebar && !formulaSidebar.contains(e.target) && formulaSidebar.classList.contains('active')) {
                    toggleFormulas();
                }
            });
        }

        // Night Mode Functions
        function toggleNightMode() {
            const body = document.body;
            const toggleSwitch = document.querySelector('.toggle-switch');
            
            body.classList.toggle('night-mode');
            toggleSwitch.classList.toggle('active');
            
            // Save preference to localStorage
            const isNightMode = body.classList.contains('night-mode');
            localStorage.setItem('nightMode', isNightMode);
        }

        function initializeNightMode() {
            const savedNightMode = localStorage.getItem('nightMode');
            const body = document.body;
            const toggleSwitch = document.querySelector('.toggle-switch');
            
            if (savedNightMode === 'true') {
                body.classList.add('night-mode');
                if (toggleSwitch) {
                    toggleSwitch.classList.add('active');
                }
            }
        }

        // Stored Calculations Functions
        function toggleStoredCalculations() {
            const container = document.getElementById('storedCalculationsContainer');
            if (container.style.display === 'none') {
                updateStoredCalculationsDisplay();
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        function updateStoredCalculationsDisplay() {
            const container = document.getElementById('storedCalculationsList');
            const storedCalculations = JSON.parse(localStorage.getItem('coalAnalysisCalculations') || '[]');
            
            if (storedCalculations.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center;">No stored calculations yet.</p>';
                return;
            }
            
            container.innerHTML = storedCalculations.map((calc, index) => {
                // Get coal names for display
                const coalNames = calc.coalTypes && calc.coalTypes.length > 0 
                    ? calc.coalTypes.map(coal => coal.name).join(' vs ')
                    : `${calc.coal1Name || 'Coal A'} vs ${calc.coal2Name || 'Coal B'}`;
                
                // Get coal details for display
                let coalDetails = '';
                if (calc.coalTypes && calc.coalTypes.length > 0) {
                    coalDetails = calc.coalTypes.map(coal => 
                        `<strong>${coal.name}:</strong> ₹${((coal.cost + coal.freight) / coal.gcv).toFixed(3)}/MCal, ${coal.gcv} kcal/kg`
                    ).join('<br>');
                } else {
                    coalDetails = `
                        <strong>${calc.coal1Name || 'Coal A'}:</strong> ₹${((calc.coal1Cost + calc.coal1Freight) / calc.coal1GCV).toFixed(3)}/MCal, ${calc.coal1GCV || 0} kcal/kg<br>
                        <strong>${calc.coal2Name || 'Coal B'}:</strong> ₹${((calc.coal2Cost + calc.coal2Freight) / calc.coal2GCV).toFixed(3)}/MCal, ${calc.coal2GCV || 0} kcal/kg
                    `;
                }
                
                return `
                    <div class="stored-calculation-item">
                        <div class="stored-calculation-actions">
                            <button class="calc-action-btn" onclick="loadCalculation(${index})" title="Load">
                                <i class="fas fa-upload"></i>
                            </button>
                            <button class="calc-action-btn" onclick="deleteCalculation(${index})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="stored-calculation-header">
                            <h5 class="stored-calculation-title">${coalNames}</h5>
                        </div>
                        <div class="stored-calculation-date">${new Date(calc.timestamp).toLocaleString()}</div>
                        <div class="stored-calculation-data">
                            ${coalDetails}<br>
                            <strong>Coal Count:</strong> ${calc.coalCount || 2}<br>
                            <strong>Best Option:</strong> ${calc.bestOption || 'N/A'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadCalculation(index) {
            const storedCalculations = JSON.parse(localStorage.getItem('coalAnalysisCalculations') || '[]');
            const calc = storedCalculations[index];
            
            if (calc) {
                // Clear existing coal cards and reset count
                const coalCardsContainer = document.getElementById('coalCardsContainer');
                coalCardsContainer.innerHTML = '';
                coalCount = 0; // Reset global coal count
                
                // Load coal types data
                if (calc.coalTypes && calc.coalTypes.length > 0) {
                    // Handle new multi-coal format
                    calc.coalTypes.forEach((coal, coalIndex) => {
                        addCoalType();
                        document.getElementById(`coal${coalIndex + 1}Name`).value = coal.name || '';
                        document.getElementById(`coal${coalIndex + 1}Cost`).value = coal.cost || '';
                        document.getElementById(`coal${coalIndex + 1}Freight`).value = coal.freight || '';
                        document.getElementById(`coal${coalIndex + 1}GCV`).value = coal.gcv || '';
                    });
                } else {
                    // Handle legacy 2-coal format
                    addCoalType(); // Coal 1
                    addCoalType(); // Coal 2
                    
                    document.getElementById('coal1Name').value = calc.coal1Name || '';
                    document.getElementById('coal2Name').value = calc.coal2Name || '';
                    document.getElementById('coal1Cost').value = calc.coal1Cost || '';
                    document.getElementById('coal2Cost').value = calc.coal2Cost || '';
                    document.getElementById('coal1Freight').value = calc.coal1Freight || '';
                    document.getElementById('coal2Freight').value = calc.coal2Freight || '';
                    document.getElementById('coal1GCV').value = calc.coal1GCV || '';
                    document.getElementById('coal2GCV').value = calc.coal2GCV || '';
                }
                
                // Load plant parameters
                document.getElementById('capacity').value = calc.capacity || '';
                document.getElementById('plf').value = calc.plf || '';
                document.getElementById('days').value = calc.days || '';
                document.getElementById('shr').value = calc.shr || '';
                document.getElementById('coalQuantity').value = calc.coalQuantity || '';
                
                // Hide stored calculations
                toggleStoredCalculations();
                
                // Auto-trigger calculation if we have minimum required data
                setTimeout(() => {
                    autoCalculate();
                }, 100); // Small delay to ensure DOM is updated
                
                showMessage('Calculation loaded successfully!', 'success');
            }
        }

        function deleteCalculation(index) {
            if (confirm('Are you sure you want to delete this calculation?')) {
                const storedCalculations = JSON.parse(localStorage.getItem('coalAnalysisCalculations') || '[]');
                storedCalculations.splice(index, 1);
                localStorage.setItem('coalAnalysisCalculations', JSON.stringify(storedCalculations));
                updateStoredCalculationsDisplay();
                updateStoredCalculationsCounter();
                showMessage('Calculation deleted successfully!', 'success');
            }
        }

        function clearAllStoredData() {
            if (confirm('Are you sure you want to clear all stored calculation data? This action cannot be undone.')) {
                try {
                    localStorage.removeItem('coalAnalysisCalculations');
                    updateStoredCalculationsDisplay();
                    updateStoredCalculationsCounter();
                    showMessage('All stored data cleared successfully!', 'success');
                } catch (error) {
                    console.error('Error clearing stored data:', error);
                    alert('Error clearing stored data. Please try again.');
                }
            }
        }

        function updateStoredCalculationsCounter() {
            const storedCalculations = JSON.parse(localStorage.getItem('coalAnalysisCalculations') || '[]');
            
            // Update main storage counter
            const counter = document.getElementById('storageCounter');
            if (counter) {
                counter.textContent = storedCalculations.length;
                counter.style.display = storedCalculations.length > 0 ? 'flex' : 'none';
            }
            
            // Update floating storage counter
            const floatingCounter = document.getElementById('floatingStorageCounter');
            if (floatingCounter) {
                floatingCounter.textContent = storedCalculations.length;
                floatingCounter.style.display = storedCalculations.length > 0 ? 'flex' : 'none';
            }
        }

        function showMessage(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 500;
                animation: slideInRight 0.3s ease-out;
            `;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Animation System
        function initializeAnimations() {
            const animationElements = [
                { selector: '.calculator-header', animation: 'animate-slide-in-down', delay: 0 },
                { selector: '.instruction-message', animation: 'animate-slide-in-left', delay: 0.2 },
                { selector: '.calculator-container', animation: 'animate-zoom-in', delay: 0.4 },
                { selector: '.results-container', animation: 'animate-zoom-in', delay: 0.6 },
                { selector: '.floating-actions', animation: 'animate-slide-in-right', delay: 0.8 },
                { selector: '.night-mode-toggle', animation: 'animate-slide-in-right', delay: 1 },
                { selector: '.back-button', animation: 'animate-slide-in-left', delay: 1.2 }
            ];

            animationElements.forEach(({ selector, animation, delay }) => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    setTimeout(() => {
                        element.classList.add(animation);
                    }, delay * 1000);
                });
            });
        }

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            initializeElements();
            
            // Initialize with default two coal cards
            const coalCardsContainer = document.getElementById('coalCardsContainer');
            console.log('Coal cards container:', coalCardsContainer);
            
            // Clear any existing cards and create fresh ones
            coalCardsContainer.innerHTML = '';
            
            for (let i = 1; i <= 2; i++) {
                const coalCard = createCoalCard(i);
                coalCardsContainer.appendChild(coalCard);
                console.log(`Created coal card ${i}`);
            }
            coalCount = 2;
            
            // Update inputs object AFTER coal cards are created
            updateInputsObject();
            console.log('Updated inputs object:', inputs);
            
            updateStorageCounter();
            updateInstructionMessage();
            setupEventListeners();
            setupInputEventListeners(); // Setup event listeners for coal inputs
            initializeNightMode(); // Initialize night mode
            updateStoredCalculationsCounter(); // Initialize storage counter
            initializeAnimations(); // Initialize animations
            
            // Ensure export dropdown is hidden on page load
            const exportDropdown = document.getElementById('exportDropdown');
            if (exportDropdown) {
                exportDropdown.style.display = 'none';
            }
            
            // MathJax initialization
            setTimeout(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise().then(() => {
                        console.log('Initial MathJax rendering completed');
                    }).catch((err) => {
                        console.log('Initial MathJax rendering error:', err);
                        document.body.classList.add('no-mathjax');
                    });
                } else {
                    setTimeout(() => {
                        if (!window.MathJax) {
                            document.body.classList.add('no-mathjax');
                            console.log('MathJax not loaded, showing fallback formulas');
                        }
                    }, 3000);
                }
            }, 1000);
            
            // Add click outside handlers for stored calculations
            document.addEventListener('click', function(e) {
                const storedCalcsContainer = document.getElementById('storedCalculationsContainer');
                const storageButton = e.target.closest('.floating-btn[onclick*="toggleStoredCalculations"]');
                
                if (storedCalcsContainer && !storedCalcsContainer.contains(e.target) && !storageButton && storedCalcsContainer.style.display !== 'none') {
                    storedCalcsContainer.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
