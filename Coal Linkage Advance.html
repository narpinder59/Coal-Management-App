<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coal Linkage Distribution - Professional</title>

    <!-- CDN Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Google Fonts for modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
/* ========================================================================
   COAL LINKAGE ADVANCE CALCULATOR - CLEAN CSS STRUCTURE
   ======================================================================== */

/* ========================================================================
   1. CSS VARIABLES & THEME SUPPORT
   ======================================================================== */
:root {
    /* Light Theme Colors */
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --card-bg-light: rgba(255, 255, 255, 0.15);
    --card-border-light: rgba(255, 255, 255, 0.2);
    --text-light: #ffffff;
    --input-bg-light: rgba(255, 255, 255, 0.9);
    --input-border-light: rgba(255, 255, 255, 0.3);
    --input-text-light: #333333;
    --section-bg-light: rgba(255, 255, 255, 0.15);
    --section-border-light: rgba(255, 255, 255, 0.3);
    
    /* Table Colors */
    --table-bg: #ffffff;
    --table-header-bg: #f8f9fa;
    --table-border: #dee2e6;
    --table-hover: #e8f5e8;
    --sticky-bg: #f8f9fa;
    --sticky-shadow: 2px 0 5px rgba(0,0,0,0.15);
}

[data-theme="dark"] {
    /* Dark Theme Colors */
    --primary-gradient: linear-gradient(135deg, #1a1a2e, #16213e, #0f0f23);
    --card-bg-light: rgba(26, 26, 46, 0.95);
    --card-border-light: rgba(255, 255, 255, 0.1);
    --text-light: #ffffff;
    --input-bg-light: rgba(40, 40, 60, 0.8);
    --input-border-light: rgba(255, 255, 255, 0.2);
    --input-text-light: #e0e0e0;
    --section-bg-light: rgba(40, 40, 60, 0.6);
    --section-border-light: rgba(255, 255, 255, 0.1);
    
    /* Dark Table Colors */
    --table-bg: rgba(50, 50, 70, 0.8);
    --table-header-bg: linear-gradient(135deg, #2c2c54, #40407a);
    --table-border: rgba(255, 255, 255, 0.1);
    --table-hover: rgba(70, 70, 90, 0.9);
    --sticky-bg: rgba(50, 50, 70, 1);
    --sticky-shadow: 2px 0 5px rgba(255,255,255,0.1);
}

/* ========================================================================
   2. BASE LAYOUT & TYPOGRAPHY
   ======================================================================== */
body {
    background: var(--primary-gradient);
    min-height: 100vh;
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
}

.main-container {
    padding: 20px;
    margin-top: 20px;
    position: relative;
}

.calculator-container {
    background: var(--card-bg-light);
    backdrop-filter: blur(20px);
    border: 1px solid var(--card-border-light);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    padding: 30px;
    margin: 0 auto;
    max-width: 1400px;
    position: relative;
}

.calculator-title {
    color: var(--text-light);
    text-align: center;
    font-size: 2.2rem;
    font-weight: 700;
    margin-bottom: 30px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

/* Animated main heading icon */
.calculator-title .fa-chart-line {
    animation: chartPulse 2s ease-in-out infinite;
    color: #ffd700;
    filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
}

@keyframes chartPulse {
    0% {
        transform: scale(1) rotate(0deg);
        color: #ffd700;
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
    }
    25% {
        transform: scale(1.1) rotate(5deg);
        color: #ff6b6b;
        filter: drop-shadow(0 0 15px rgba(255, 107, 107, 0.7));
    }
    50% {
        transform: scale(1.2) rotate(0deg);
        color: #4ecdc4;
        filter: drop-shadow(0 0 20px rgba(78, 205, 196, 0.8));
    }
    75% {
        transform: scale(1.1) rotate(-5deg);
        color: #45b7d1;
        filter: drop-shadow(0 0 15px rgba(69, 183, 209, 0.7));
    }
    100% {
        transform: scale(1) rotate(0deg);
        color: #ffd700;
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
    }
}

/* Performance optimization for animations */
.table-title::after,
.calculator-title .fa-chart-line {
    will-change: transform, background-position, color, filter;
}

/* ========================================================================
   3. NAVIGATION BUTTONS
   ======================================================================== */
.btn-back, .theme-toggle {
    position: fixed;
    top: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    font-size: 18px;
    color: white;
    cursor: pointer;
    z-index: 1000;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.btn-back {
    left: 20px;
    background: linear-gradient(135deg, #6c757d, #495057);
}

.theme-toggle {
    right: 20px;
    background: linear-gradient(135deg, #ffc107, #e0a800);
}

.btn-back:hover, .theme-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

/* Dark theme specific styling for theme toggle button */
[data-theme="dark"] .theme-toggle {
    background: linear-gradient(135deg, #007bff, #0056b3);
}

[data-theme="dark"] .theme-toggle:hover {
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
}

/* Rainbow Animation Toggle Button */
.rainbow-toggle {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: none;
    font-size: 14px;
    color: white;
    cursor: pointer;
    z-index: 1000;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
    background-size: 400% 400%;
    animation: rainbowButtonAnimation 3s ease-in-out infinite;
}

@keyframes rainbowButtonAnimation {
    0% {
        background-position: 0% 50%;
        transform: scale(1) rotate(0deg);
    }
    25% {
        background-position: 50% 0%;
        transform: scale(1.05) rotate(90deg);
    }
    50% {
        background-position: 100% 50%;
        transform: scale(1.1) rotate(180deg);
    }
    75% {
        background-position: 50% 100%;
        transform: scale(1.05) rotate(270deg);
    }
    100% {
        background-position: 0% 50%;
        transform: scale(1) rotate(360deg);
    }
}

.rainbow-toggle:hover {
    transform: translateY(-2px) scale(1.1);
    box-shadow: 0 6px 20px rgba(255, 255, 255, 0.4);
}

.rainbow-toggle.disabled {
    background: linear-gradient(135deg, #6c757d, #495057);
    animation: none;
}

.rainbow-toggle.disabled:hover {
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

/* ========================================================================
   4. FORM CONTROLS & INPUTS
   ======================================================================== */
.form-control {
    background: var(--input-bg-light);
    border: 1px solid var(--input-border-light);
    border-left: 1px solid #007bff;
    border-radius: 8px;
    color: var(--input-text-light);
    padding: 10px 15px;
    font-size: 14px;
    transition: all 0.3s ease;
    height: 42px;
    line-height: 1.5;
    box-sizing: border-box;
}

/* Form control in input groups */
.input-group .form-control {
    border-radius: 0 8px 8px 0;
    border-left: none;
    flex: 1;
}

.input-group {
    display: flex;
    align-items: stretch;
    width: 100%;
}

.input-group-prepend {
    display: flex;
    align-items: stretch;
}

.form-control:focus {
    background: rgba(255, 255, 255, 0.95);
    border-color: #4dabf7;
    border-left: 1px solid #4dabf7;
    box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
    outline: none;
}

.form-label {
    color: var(--text-light);
    font-weight: 600;
    margin-bottom: 8px;
}

/* ========================================================================
   4.1. INPUT GROUP STYLES
   ======================================================================== */
.input-group-text1 {
    background: linear-gradient(135deg, #495057, #343a40);
    color: white;
    border: 1px solid #dee2e6;
    border-right: none;
    border-radius: 8px 0 0 8px;
    padding: 8px 12px;
    font-weight: 500;
    min-width: 200px;
    width: 200px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    line-height: 1.5;
    height: 42px;
    box-sizing: border-box;
    white-space: nowrap;
}

.input-group-text2 {
    background: #e9ecef;
    border: 1px solid #dee2e6;
    border-left: none;
    border-right: none;
    padding: 8px 12px;
    font-weight: bold;
    min-width: 50px;
    width: 50px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    line-height: 1.5;
    height: 42px;
    box-sizing: border-box;
}

.input-group-text3 {
    background: linear-gradient(135deg, #495057, #343a40);
    color: white;
    border: 1px solid #dee2e6;
    border-right: none;
    border-radius: 8px 0 0 8px;
    padding: 8px 12px;
    font-weight: 500;
    min-width: 120px;
    width: 120px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    line-height: 1.5;
    height: 42px;
    box-sizing: border-box;
    white-space: nowrap;
}

.input-group-text4 {
    background: #e9ecef;
    border: 1px solid #dee2e6;
    border-left: none;
    border-right: none;
    padding: 8px 12px;
    font-weight: bold;
    min-width: 50px;
    width: 50px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    line-height: 1.5;
    height: 42px;
    box-sizing: border-box;
}

/* Dark theme support for input groups */
[data-theme="dark"] .input-group-text1,
[data-theme="dark"] .input-group-text3 {
    background: linear-gradient(135deg, #2c2c54, #40407a);
    color: #ffffff;
    border-color: rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .input-group-text2,
[data-theme="dark"] .input-group-text4 {
    background: rgba(40, 40, 60, 0.8);
    border-color: rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

/* Dark theme for form controls */
[data-theme="dark"] .form-control {
    background: rgba(40, 40, 60, 0.8);
    border-color: rgba(255, 255, 255, 0.2);
    border-left: 2px solid #17a2b8;
    color: #e0e0e0;
}

[data-theme="dark"] .form-control:focus {
    background: rgba(50, 50, 70, 0.9);
    border-color: #4dabf7;
    border-left: 1px solid #4dabf7;
    box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
    color: #ffffff;
}

/* Dark theme toggle button colors */
[data-theme="dark"] .redistribution-toggle input[type="radio"]:checked + .toggle-option {
    background: rgba(75, 192, 192, 0.8);
    color: white;
    box-shadow: 0 2px 8px rgba(75, 192, 192, 0.3);
}

[data-theme="dark"] .distribution-method-toggle input[type="radio"]:checked + .toggle-option {
    background: rgba(255, 159, 64, 0.8);
    color: white;
    box-shadow: 0 2px 8px rgba(255, 159, 64, 0.3);
}

/* ========================================================================
   5. TOGGLE BUTTONS & CONTROLS
   ======================================================================== */
.redistribution-mode-container,
.distribution-method-container {
    background: var(--section-bg-light);
    border: 1px solid var(--section-border-light);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
}

.redistribution-toggle,
.distribution-method-toggle {
    display: flex;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 25px;
    padding: 4px;
    gap: 2px;
}

.redistribution-toggle input[type="radio"],
.distribution-method-toggle input[type="radio"] {
    display: none;
}

.redistribution-toggle .toggle-option,
.distribution-method-toggle .toggle-option {
    flex: 1;
    text-align: center;
    padding: 8px 16px;
    border-radius: 20px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 12px;
    font-weight: 600;
}

.redistribution-toggle input[type="radio"]:checked + .toggle-option {
    background: rgba(0, 123, 255, 0.8);
    color: white;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
}

.distribution-method-toggle input[type="radio"]:checked + .toggle-option {
    background: rgba(220, 53, 69, 0.8);
    color: white;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

/* ========================================================================
   6. PROFESSIONAL BUTTONS
   ======================================================================== */
.btn-professional {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    margin: 5px;
}

.btn-professional:hover {
    background: linear-gradient(135deg, #0056b3, #004494);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    color: white;
}

.btn-professional-green {
    background: linear-gradient(135deg, #28a745, #1e7e34);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    margin: 5px;
}

.btn-professional-green:hover {
    background: linear-gradient(135deg, #1e7e34, #155724);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    color: white;
}

/* ========================================================================
   7. TABLE STRUCTURE & CONTAINERS
   ======================================================================== */
.table-header-container {
    margin-bottom: 15px;
}

.table-title {
    color: var(--text-light);
    font-size: 1.4rem;
    font-weight: 700;
    margin-bottom: 15px;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
    text-align: center;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--text-light);
    position: relative;
}

.table-title::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
    background-size: 400% 100%;
    border-radius: 2px;
    animation: rainbowAnimation 3s ease-in-out infinite;
}

@keyframes rainbowAnimation {
    0% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
    100% {
        background-position: 0% 50%;
    }
}

/* Rainbow animation control classes */
.no-rainbow .table-title::after {
    animation: none !important;
    background: linear-gradient(90deg, #dee2e6, #adb5bd) !important;
}

[data-theme="dark"] .no-rainbow .table-title::after {
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1)) !important;
}

/* Icon colors for different table titles */
.table-title .fa-cogs {
    color: #28a745; /* Green for Input Parameters */
}

.table-title .fa-calendar-alt {
    color: #007bff; /* Blue for Monthly Values */
}

.table-title .fa-chart-pie {
    color: #ffc107; /* Yellow for Quarterly Values */
}

.table-title .fa-calendar-day {
    color: #fd7e14; /* Orange for Per Day Values */
}

.table-title .fa-chart-bar {
    color: #e40a0a; /* Purple for Summary */
}

/* Glowing green pencil-square icon in table header */
.bi-pencil-square {
    color: #28a745;
    filter: drop-shadow(0 0 8px rgba(40, 167, 69, 0.8));
    animation: pencilGlow 2s ease-in-out infinite alternate;
    transform-origin: center;
}

@keyframes pencilGlow {
    0% {
        color: #28a745;
        filter: drop-shadow(0 0 8px rgba(40, 167, 69, 0.8));
        transform: scale(1) rotate(0deg);
    }
    25% {
        color: #20c997;
        filter: drop-shadow(0 0 10px rgba(32, 201, 151, 0.9));
        transform: scale(1.1) rotate(-3deg);
    }
    50% {
        color: #17a2b8;
        filter: drop-shadow(0 0 12px rgba(23, 162, 184, 1));
        transform: scale(1.15) rotate(0deg);
    }
    75% {
        color: #20c997;
        filter: drop-shadow(0 0 10px rgba(32, 201, 151, 0.9));
        transform: scale(1.1) rotate(3deg);
    }
    100% {
        color: #28a745;
        filter: drop-shadow(0 0 8px rgba(40, 167, 69, 0.8));
        transform: scale(1) rotate(0deg);
    }
}

/* Dark theme support for glowing pencil icon */
[data-theme="dark"] .bi-pencil-square {
    color: #20c997;
    filter: drop-shadow(0 0 10px rgba(32, 201, 151, 0.9));
}

/* Table header container spacing */
.table-header-container {
    margin-bottom: 10px;
}

/* Consistent spacing between table sections */
.row.mt-5 {
    margin-top: 1.5rem !important;
}

.coal-table-wrapper {
    width: 100%;
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    position: relative;
    border-radius: 8px;
    background: var(--table-bg);
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* ========================================================================
   8. TABLE BASE STYLING
   ======================================================================== */
.CoalLinkageAdvance-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 0;
    font-size: 14px;
    table-layout: fixed;
}

.CoalLinkageAdvance-table th,
.CoalLinkageAdvance-table td {
    padding: 12px 8px;
    text-align: center;
    vertical-align: middle;
    border: 1px solid var(--table-border);
    background: var(--table-bg);
    white-space: nowrap;
    min-width: 120px;
}

.CoalLinkageAdvance-table th {
    background: linear-gradient(135deg, #343a40, #495057);
    color: #ffffff;
    font-weight: 700;
    font-size: 13px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

/* ========================================================================
   9. STICKY FIRST COLUMN - UNIFIED RULES
   ======================================================================== */
.CoalLinkageAdvance-table th:first-child,
.CoalLinkageAdvance-table td:first-child {
    position: sticky !important;
    left: 0 !important;
    background: var(--sticky-bg) !important;
    box-shadow: var(--sticky-shadow) !important;
    border-right: 2px solid var(--table-border) !important;
    font-weight: 600 !important;
    text-align: left !important;
    min-width: 200px !important;
    width: 200px !important;
    max-width: 200px !important;
    z-index: 999 !important;
}

/* Equal width for remaining columns on desktop */
.CoalLinkageAdvance-table th:not(:first-child),
.CoalLinkageAdvance-table td:not(:first-child) {
    width: calc((100% - 200px) / 5) !important;
    min-width: 140px !important;
    max-width: calc((100% - 200px) / 5) !important;
}

/* Header sticky columns get higher z-index */
.CoalLinkageAdvance-table thead th:first-child {
    z-index: 1001 !important;
    background: linear-gradient(135deg, #343a40, #495057) !important;
    color: #ffffff !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
}

/* Light theme first column specific rules */
.CoalLinkageAdvance-table:not([data-theme="dark"]) th:first-child {
    background: linear-gradient(135deg, #343a40, #495057) !important;
    color: #ffffff !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
}

.CoalLinkageAdvance-table:not([data-theme="dark"]) td:first-child {
    background: var(--sticky-bg) !important;
    color: #333333 !important;
}

/* ========================================================================
   10. TABLE INTERACTIONS
   ======================================================================== */
.CoalLinkageAdvance-table tr:hover td {
    background: var(--table-hover);
}

.CoalLinkageAdvance-table tr:hover td:first-child {
    background: var(--table-hover) !important;
    color: #333333 !important;
}

/* Light theme hover states */
.CoalLinkageAdvance-table:not([data-theme="dark"]) tr:hover td:first-child {
    background: var(--table-hover) !important;
    color: #333333 !important;
}

.CoalLinkageAdvance-table td[contenteditable="true"] {
    background: rgba(255, 193, 7, 0.1);
    cursor: text;
    border-color: #ffc107;
}

.CoalLinkageAdvance-table td[contenteditable="true"]:focus {
    background: rgba(77, 171, 247, 0.1);
    border-color: #4dabf7;
    outline: none;
    box-shadow: 0 0 5px rgba(77, 171, 247, 0.3);
}

/* ========================================================================
   11. FLOATING ICONS & SIDEBAR
   ======================================================================== */
.floating-icons {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 1000;
}

.floating-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border: none;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.floating-icon:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
}

/* Custom fx icon styling */
.fx-icon {
    font-family: 'Times New Roman', serif;
    font-style: italic;
    font-weight: 700;
    font-size: 18px;
    color: inherit;
    display: inline-block;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

/* fx icon in sidebar title */
.sidebar-title .fx-icon {
    font-size: 20px;
}

/* fx icon responsive sizing */
@media (max-width: 768px) {
    .fx-icon {
        font-size: 16px;
    }
    
    .sidebar-title .fx-icon {
        font-size: 18px;
    }
}

/* Export Dropdown */
.export-dropdown {
    position: absolute;
    bottom: 60px;
    right: 0;
    background: transparent;
    border-radius: 8px;
    padding: 8px;
    min-width: 60px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.2s ease;
}

.export-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.export-dropdown button {
    width: 50px;
    height: 50px;
    margin-bottom: 8px;
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.export-dropdown button:hover {
    transform: scale(1.1);
}

.export-dropdown button:first-child {
    background: linear-gradient(135deg, #28a745, #1e7e34);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.export-dropdown button:first-child:hover {
    background: linear-gradient(135deg, #1e7e34, #155724);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

.export-dropdown button:last-child {
    background: linear-gradient(135deg, #dc3545, #c82333);
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    margin-bottom: 0;
}

.export-dropdown button:last-child:hover {
    background: linear-gradient(135deg, #c82333, #a71e2a);
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
}

.formula-sidebar {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100%;
    background: rgba(26, 26, 46, 0.98);
    color: #ffffff;
    z-index: 10050;
    transition: right 0.3s ease;
    overflow-y: auto;
    backdrop-filter: blur(15px);
    border-left: 2px solid rgba(255, 255, 255, 0.3);
    box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
}

.formula-sidebar.active,
.formula-sidebar.show {
    right: 0;
}

/* Formula sidebar header styling */
.sidebar-header {
    background: linear-gradient(135deg, #2c2c54, #40407a);
    padding: 20px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    position: sticky;
    top: 0;
    z-index: 1;
}

.sidebar-title {
    color: #ffffff;
    font-size: 1.3rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.close-sidebar {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(220, 53, 69, 0.8);
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.close-sidebar:hover {
    background: rgba(220, 53, 69, 1);
    transform: scale(1.1);
}

/* Formula sidebar content styling */
.sidebar-content {
    padding: 20px;
    line-height: 1.6;
}

.sidebar-content .alert {
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 20px;
}

.sidebar-content .alert-info {
    background: rgba(23, 162, 184, 0.2);
    border-color: rgba(23, 162, 184, 0.5);
    color: #ffffff;
}

.sidebar-content .alert-success {
    background: rgba(40, 167, 69, 0.2);
    border-color: rgba(40, 167, 69, 0.5);
    color: #ffffff;
}

.sidebar-content .example-box {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
}

.sidebar-content h5, .sidebar-content h6 {
    color: #ffffff;
    margin-bottom: 15px;
}

.sidebar-content ul li {
    margin-bottom: 8px;
    color: rgba(255, 255, 255, 0.9);
}

.sidebar-content p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 12px;
}

.sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: none;
    transition: opacity 0.3s ease;
}

.sidebar-overlay.show {
    display: block;
}

/* Light theme for formula sidebar */
[data-theme="light"] .formula-sidebar {
    background: rgba(255, 255, 255, 0.98);
    color: #333333;
    border-left: 2px solid rgba(0, 0, 0, 0.2);
    box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
}

[data-theme="light"] .sidebar-header {
    background: linear-gradient(135deg, #495057, #343a40);
    color: #ffffff;
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .sidebar-title {
    color: #ffffff;
}

[data-theme="light"] .sidebar-content {
    color: #333333;
}

[data-theme="light"] .sidebar-content .alert-info {
    background: rgba(23, 162, 184, 0.1);
    border-color: rgba(23, 162, 184, 0.3);
    color: #333333;
}

[data-theme="light"] .sidebar-content .alert-success {
    background: rgba(40, 167, 69, 0.1);
    border-color: rgba(40, 167, 69, 0.3);
    color: #333333;
}

[data-theme="light"] .sidebar-content .example-box {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #333333;
}

[data-theme="light"] .sidebar-content h5, 
[data-theme="light"] .sidebar-content h6 {
    color: #333333;
}

[data-theme="light"] .sidebar-content ul li,
[data-theme="light"] .sidebar-content p {
    color: #555555;
}

/* ========================================================================
   12. MONTH SELECTION MODAL
   ======================================================================== */
.month-selection-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 10050;
    display: none;
    justify-content: center;
    align-items: center;
}

.month-selection-content {
    background: white;
    border-radius: 15px;
    padding: 25px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
}

.month-checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin: 15px 0;
}

/* ========================================================================
   13. MOBILE RESPONSIVE DESIGN
   ======================================================================== */
@media (max-width: 992px) {
    .main-container,
    .calculator-container {
        overflow-x: visible !important;
        padding: 15px;
    }
    
    .calculator-title {
        font-size: 1.6rem;
    }
    
    .CoalLinkageAdvance-table {
        font-size: 12px;
        table-layout: auto;
    }
    
    .CoalLinkageAdvance-table th,
    .CoalLinkageAdvance-table td {
        padding: 8px 4px;
        min-width: 100px;
    }
    
    /* Fix header font size to match first column in tablet mode */
    .CoalLinkageAdvance-table th {
        font-size: 11px;
    }
    
    .CoalLinkageAdvance-table th:first-child,
    .CoalLinkageAdvance-table td:first-child {
        min-width: 120px !important;
        width: 120px !important;
        max-width: 120px !important;
        font-size: 11px;
    }
    
    /* Reset equal width constraint for mobile */
    .CoalLinkageAdvance-table th:not(:first-child),
    .CoalLinkageAdvance-table td:not(:first-child) {
        width: auto !important;
        min-width: 100px !important;
        max-width: none !important;
    }
}

@media (max-width: 768px) {
    .btn-back, .theme-toggle {
        width: 45px;
        height: 45px;
        font-size: 16px;
        top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    .btn-back {
        left: 10px;
    }
    
    .theme-toggle {
        right: 10px;
    }
    
    .rainbow-toggle {
        width: 20px;
        height: 20px;
        font-size: 12px;
        top: 60px;
        right: 25px;
    }
    
    .calculator-title {
        font-size: 1.3rem;
        margin-bottom: 20px;
    }
    
    .redistribution-toggle,
    .distribution-method-toggle {
        flex-direction: column;
        gap: 4px;
    }
    
    .redistribution-toggle .toggle-option,
    .distribution-method-toggle .toggle-option {
        padding: 8px 12px;
        font-size: 11px;
    }
    
    .CoalLinkageAdvance-table {
        font-size: 9px; /* Reduced font size for better mobile readability */
    }
    
    .CoalLinkageAdvance-table th,
    .CoalLinkageAdvance-table td {
        padding: 6px 3px;
        min-width: 80px;
    }
    
    /* Fix header font size and enable text wrapping in mobile */
    .CoalLinkageAdvance-table th {
        font-size: 8px;
        white-space: normal !important; /* Allow text wrapping */
        word-wrap: break-word;
        line-height: 1.2;
        height: auto !important;
        vertical-align: top;
    }
    
    /* Data cells with reduced font size */
    .CoalLinkageAdvance-table td {
        font-size: 9px;
        line-height: 1.3;
    }
    
    .CoalLinkageAdvance-table th:first-child,
    .CoalLinkageAdvance-table td:first-child {
        min-width: 85px !important;
        width: 85px !important;
        max-width: 85px !important;
        font-size: 10px;
    }
    
    /* Reset equal width constraint for smallest mobile */
    .CoalLinkageAdvance-table th:not(:first-child),
    .CoalLinkageAdvance-table td:not(:first-child) {
        width: auto !important;
        min-width: 70px !important;
        max-width: none !important;
    }
    
    .floating-icons {
        bottom: 10px;
        right: 10px;
    }
    
    .floating-icon {
        width: 45px;
        height: 45px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    /* Mobile input group adjustments */
    .input-group-text1,
    .input-group-text3 {
        min-width: 140px;
        width: 140px;
        font-size: 0.8rem;
    }
    
    .input-group-text2,
    .input-group-text4 {
        min-width: 45px;
        width: 45px;
        font-size: 0.75rem;
    }
    
    /* Mobile table title adjustments */
    .table-title {
        font-size: 1.1rem;
        margin-bottom: 12px;
    }
    
    .table-title::after {
        width: 100%;
        height: 2px;
    }
    
    /* Reduce animation intensity on mobile */
    .calculator-title .fa-chart-line {
        animation: chartPulseMobile 3s ease-in-out infinite;
    }
    
    @keyframes chartPulseMobile {
        0%, 100% {
            transform: scale(1);
            color: #ffd700;
        }
        50% {
            transform: scale(1.05);
            color: #4ecdc4;
        }
    }
}

@media (max-width: 576px) {
    .main-container {
        padding: 10px;
        margin-top: 10px;
    }
    
    .calculator-container {
        padding: 15px;
        border-radius: 15px;
    }
    
    .calculator-title {
        font-size: 1.1rem;
    }
    
    .redistribution-toggle .toggle-option,
    .distribution-method-toggle .toggle-option {
        padding: 6px 8px;
        font-size: 10px;
    }
    
    .CoalLinkageAdvance-table {
        font-size: 8px; /* Even smaller for very small screens */
    }
    
    .CoalLinkageAdvance-table th,
    .CoalLinkageAdvance-table td {
        padding: 3px 2px;
        min-width: 65px;
        white-space: normal; /* Allow text wrapping */
        word-wrap: break-word; /* Break long words */
    }
    
    /* Optimized header styling for smallest mobile screens */
    .CoalLinkageAdvance-table th {
        font-size: 7px;
        line-height: 1.1;
        vertical-align: top;
        font-weight: 600;
    }
    
    /* Data cells optimized for very small screens */
    .CoalLinkageAdvance-table td {
        font-size: 8px;
        line-height: 1.2;
        vertical-align: top;
    }
    
    .CoalLinkageAdvance-table th:first-child,
    .CoalLinkageAdvance-table td:first-child {
        min-width: 70px;
        font-size: 8px;
        font-weight: 600;
    }
    
    .btn-professional,
    .btn-professional-green {
        font-size: 0.75rem;
        padding: 6px 10px;
        width: 100%;
    }
    
    /* Smaller mobile table title adjustments */
    .table-title {
        font-size: 1rem;
        margin-bottom: 10px;
    }
    
    .table-title .fa-cogs,
    .table-title .fa-calendar-alt,
    .table-title .fa-chart-pie,
    .table-title .fa-calendar-day,
    .table-title .fa-chart-bar {
        font-size: 0.9rem;
    }
}

/* ========================================================================
   14. DARK THEME SPECIFIC OVERRIDES
   ======================================================================== */
[data-theme="dark"] .CoalLinkageAdvance-table th {
    background: linear-gradient(135deg, #2c2c54, #40407a) !important;
    color: #ffffff !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
}

[data-theme="dark"] .CoalLinkageAdvance-table td {
    background: var(--table-bg) !important;
    color: #e0e0e0 !important;
    border-color: var(--table-border) !important;
}

[data-theme="dark"] .CoalLinkageAdvance-table th:first-child {
    background: linear-gradient(135deg, #2c2c54, #40407a) !important;
    color: #ffffff !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
    z-index: 1001 !important;
}

[data-theme="dark"] .CoalLinkageAdvance-table td:first-child {
    background: var(--sticky-bg) !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .CoalLinkageAdvance-table tr:hover td:first-child {
    background: var(--table-hover) !important;
    color: #e0e0e0 !important;
}

[data-theme="dark"] .CoalLinkageAdvance-table tr:hover td {
    background: var(--table-hover) !important;
}

[data-theme="dark"] .coal-table-wrapper {
    background: rgba(40, 40, 60, 0.9) !important;
}

[data-theme="dark"] .CoalLinkageAdvance-table td[contenteditable="true"] {
    background: rgba(255, 193, 7, 0.2) !important;
    border-color: #ffc107 !important;
    color: #ffffff !important;
}

[data-theme="dark"] .CoalLinkageAdvance-table td[contenteditable="true"]:focus {
    background: rgba(77, 171, 247, 0.2) !important;
    border-color: #4dabf7 !important;
    color: #ffffff !important;
}

/* Dark theme table title styling */
[data-theme="dark"] .table-title {
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

[data-theme="dark"] .table-title::after {
    background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
    background-size: 400% 100%;
    animation: rainbowAnimation 3s ease-in-out infinite;
}

/* Dark theme text color fixes */
[data-theme="dark"] .text-muted {
    color: rgba(255, 255, 255, 0.7) !important;
}

[data-theme="dark"] .text-muted strong {
    color: rgba(255, 255, 255, 0.9) !important;
}

/* ========================================================================
   15. EXPORT & PRINT SPECIFIC STYLING
   ======================================================================== */

/* Export/Print specific table styling for consistent column widths */
@media print, (min-resolution: 144dpi) {
    .CoalLinkageAdvance-table {
        table-layout: fixed !important;
        width: 100% !important;
    }
    
    .CoalLinkageAdvance-table th:first-child,
    .CoalLinkageAdvance-table td:first-child {
        width: 20% !important;
        min-width: 20% !important;
        max-width: 20% !important;
    }
    
    .CoalLinkageAdvance-table th:not(:first-child),
    .CoalLinkageAdvance-table td:not(:first-child) {
        width: 16% !important;
        min-width: 16% !important;
        max-width: 16% !important;
    }
}

/* Force table layout for export consistency */
.export-mode .CoalLinkageAdvance-table {
    table-layout: fixed !important;
    width: 100% !important;
}

.export-mode .CoalLinkageAdvance-table th:first-child,
.export-mode .CoalLinkageAdvance-table td:first-child {
    width: 20% !important;
    min-width: 20% !important;
    max-width: 20% !important;
    position: static !important;
    box-shadow: none !important;
}

.export-mode .CoalLinkageAdvance-table th:not(:first-child),
.export-mode .CoalLinkageAdvance-table td:not(:first-child) {
    width: 16% !important;
    min-width: 16% !important;
    max-width: 16% !important;
}

/* Export-specific styling for better PDF/JPG output */
.export-mode {
    background: white !important;
    color: black !important;
}

.export-mode .calculator-container {
    background: white !important;
    border: none !important;
    box-shadow: none !important;
}

.export-mode .table-title {
    color: #333333 !important;
    text-shadow: none !important;
}

.export-mode .CoalLinkageAdvance-table th {
    background: linear-gradient(135deg, #343a40, #495057) !important;
    color: #ffffff !important;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3) !important;
}

.export-mode .CoalLinkageAdvance-table td {
    background: #ffffff !important;
    color: #333333 !important;
}

</style>

</head>

<body>

<div class="main-container">
    <div class="calculator-container">
        <!-- Back Button -->
        <div class="btn-back" onclick="goBackToCalculators()" title="Back to Calculators">
            <i class="fas fa-arrow-left"></i>
        </div>

        <!-- Theme Toggle -->
        <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
            <i class="fas fa-moon theme-icon" id="theme-icon"></i>
        </div>

        <!-- Rainbow Animation Toggle -->
        <div class="rainbow-toggle" onclick="toggleRainbowAnimation()" title="Toggle Rainbow Animation">
            <i class="fas fa-palette" id="rainbow-icon"></i>
        </div>

        <!-- Header -->
        <h1 class="calculator-title">
            <i class="fas fa-chart-line me-3"></i>
            Coal Linkage Distribution
        </h1>      

        <!-- Main Content Grid -->
        <div class="row justify-content-center">
            <!-- Input Section -->
            <div class="col-lg-6 col-md-8 col-sm-10 mb-2">
                <div class="table-container mb-2">
                    <h3 class="table-title">
                        <i class="fas fa-cogs me-2"></i>
                        Input Parameters
                    </h3>

                    <div id="input-error-badge" style="display:none"></div>
                    
                    <!-- Annual Coal Quantity -->
                    <div class="input-group input-group-sm mb-2">
                        <div class="input-group-prepend">
                            <span class="input-group-text1">Annual Coal Quantity</span>
                            <span class="input-group-text2">MT</span>
                        </div>
                        <input type="number" class="form-control" step="0.01" min="0" id="acq-input" value="7000000" placeholder="7000000" required>
                    </div>

                    <!-- Quantity in a Rake -->
                    <div class="input-group input-group-sm mb-2">
                        <div class="input-group-prepend">
                            <span class="input-group-text1">Quantity in a Rake</span>
                            <span class="input-group-text2">MT</span>
                        </div>
                        <input type="number" class="form-control" step="0.01" min="0" id="rake-quantity-input" value="4000" placeholder="4000" required>
                    </div>

                    <!-- Quarterly Percentages -->
                    <div class="row" style="margin-bottom: 15px !important;">
                        <!-- Q1 (Apr-Jun) -->
                        <div class="col-md-6 mb-2">
                            <div class="input-group input-group-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text3">Q1 (Apr-Jun)</span>
                                    <span class="input-group-text4">%</span>
                                </div>
                                <input type="number" class="form-control quarter-input" step="0.01" min="0" max="100" id="quarter-1" value="25" required>
                            </div>
                        </div>

                        <!-- Q2 (Jul-Sep) -->
                        <div class="col-md-6 mb-2">
                            <div class="input-group input-group-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text3">Q2 (Jul-Sep)</span>
                                    <span class="input-group-text4">%</span>
                                </div>
                                <input type="number" class="form-control quarter-input" step="0.01" min="0" max="100" id="quarter-2" value="22" required>
                            </div>
                        </div>

                        <!-- Q3 (Oct-Dec) -->
                        <div class="col-md-6 mb-2">
                            <div class="input-group input-group-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text3">Q3 (Oct-Dec)</span>
                                    <span class="input-group-text4">%</span>
                                </div>
                                <input type="number" class="form-control quarter-input" step="0.01" min="0" max="100" id="quarter-3" value="25" required>
                            </div>
                        </div>

                        <!-- Q4 (Jan-Mar) -->
                        <div class="col-md-6 mb-2">
                            <div class="input-group input-group-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text3">Q4 (Jan-Mar)</span>
                                    <span class="input-group-text4">%</span>
                                </div>
                                <input type="number" class="form-control quarter-input" step="0.01" min="0" max="100" id="quarter-4" value="28" required>
                            </div>
                        </div>
                    </div>

                    <div id="error-message" class="alert alert-warning" style="display: none; margin-top: 15px; margin-bottom: 15px;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> The total percentage cannot exceed 100%.
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <button id="copy-cells-btn" class="btn btn-professional-green">
                            <i class="fas fa-copy me-2"></i>
                            Copy to Actual Quantity
                        </button>
                    </div>
                    
                    <!-- Redistribution Mode Toggle -->
                    <div class="redistribution-mode-container mt-3">
                        <div class="d-flex align-items-center gap-3">
                            <label class="form-label mb-0 fw-bold">
                                <span class="fx-icon me-2">fx</span>
                                Redistribution Mode:
                            </label>
                            <div class="redistribution-toggle">
                                <input type="radio" id="mode-proportionate" name="redistribution-mode" value="proportionate" checked>
                                <label for="mode-proportionate" class="toggle-option">
                                    <i class="fas fa-percentage me-1"></i>
                                    Proportionate
                                </label>
                                <input type="radio" id="mode-absolute" name="redistribution-mode" value="absolute">
                                <label for="mode-absolute" class="toggle-option">
                                    <i class="fas fa-list-check me-1"></i>
                                    Absolute
                                </label>
                            </div>
                        </div>
                        <small class="text-muted mt-1 d-block">
                            <strong>Proportionate:</strong> Redistribute quantity based on quarterly percentages.<br> 
                            <strong>Absolute:</strong> Select specific months for redistribution.
                        </small>
                        
                        <!-- Distribution Method Selection -->
                        <div class="distribution-method-container mt-3">
                            <div class="d-flex align-items-center gap-3">
                                <label class="form-label mb-0 fw-bold">
                                    <i class="fas fa-chart-pie me-2"></i>
                                    Distribution Method:
                                </label>
                                <div class="distribution-method-toggle">
                                    <input type="radio" id="method-quarterly" name="distribution-method" value="quarterly" checked>
                                    <label for="method-quarterly" class="toggle-option">
                                        <i class="fas fa-percentage me-1"></i>
                                        Quarterly Percentages
                                    </label>
                                    <input type="radio" id="method-equal" name="distribution-method" value="equal">
                                    <label for="method-equal" class="toggle-option">
                                        <i class="fas fa-balance-scale me-1"></i>
                                        Equal Distribution
                                    </label>
                                </div>
                            </div>
                            <small class="text-muted mt-1 d-block">
                                <strong>Quarterly Percentages:</strong> Distribute quantities based on Q1-Q4 percentages set above.<br>
                                <strong>Equal Distribution:</strong> Distribute quantities equally among target months.
                            </small>
                        </div>
                    </div>
                </div>
            </div>


        </div>
        </div>

        <!-- Tables Section -->
        <div class="row mt-4">
            <!-- Monthly Table -->
            <div class="col-12">
                <div class="table-header-container">
                    <h3 class="table-title">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Monthly Values
                    </h3>
                </div>
                
                <div class="coal-table-wrapper">
                    <table id="coal-table" class="table table-hover text-center align-middle CoalLinkageAdvance-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Allocated Quantity</th>
                                <th>Allocated Rakes</th>
                                <th>Actual Quantity <i class="bi bi-pencil-square ms-1"></i></th>
                                <th>Actual Rakes</th>
                                <th>Actual / Allocated</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Apr</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>May</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>Jun</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>Jul</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>Aug</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>Sep</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>Oct</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>Nov</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>Dec</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>Jan</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>Feb</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                            <tr><td>Mar</td><td></td><td></td><td contenteditable="true" class="actual-quantity"></td><td></td><td></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Quarterly Table -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="table-header-container">
                    <h3 class="table-title">
                        <i class="fas fa-chart-pie me-2"></i>
                        Quarterly Values
                    </h3>
                </div>
                
                <div class="coal-table-wrapper">
                    <table id="quarterly-table" class="table table-hover text-center align-middle CoalLinkageAdvance-table">
                    <thead>
                        <tr>
                            <th>Quarter</th>
                            <th>Allocated Quantity</th>
                            <th>Allocated Rakes</th>
                            <th>Actual Quantity</th>
                            <th>Actual Rakes</th>
                            <th>Actual / Allocated</th>
                        </tr>
                        </thead>
                        <tbody>
                            <tr><td id="q1-label">Q1-Apr-Jun 25%</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td id="q2-label">Q2-Jul-Sep 22%</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td id="q3-label">Q3-Oct-Dec 25%</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td id="q4-label">Q4-Jan-Mar 28%</td><td></td><td></td><td></td><td></td><td></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Per Day Values Table -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="table-header-container">
                    <h3 class="table-title">
                        <i class="fas fa-calendar-day me-2"></i>
                        Per Day Values
                    </h3>
                </div>
                <div class="coal-table-wrapper">
                    <table id="per-day-table" class="table table-bordered table-hover table-striped text-center align-middle table-sm CoalLinkageAdvance-table">
                    <thead class="table-gradient">
                        <tr>
                            <th>Month</th>
                            <th>Allocated Quantity</th>
                            <th>Allocated Rakes</th>
                            <th>Actual Quantity</th>
                            <th>Actual Rakes</th>
                            <th>Actual / Allocated</th>
                        </tr>
                        </thead>
                        <tbody>
                            <tr><td>Apr</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>May</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Jun</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Jul</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Aug</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Sep</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Oct</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Nov</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Dec</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Jan</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Feb</td><td></td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Mar</td><td></td><td></td><td></td><td></td><td></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Summary Table -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="table-header-container">
                    <h3 class="table-title">
                        <i class="fas fa-chart-bar me-2"></i>
                        Summary
                    </h3>
                </div>
                
                <div class="coal-table-wrapper">
                    <table id="summary-table" class="table table-hover text-center align-middle CoalLinkageAdvance-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Allocated</th>
                            <th>Actual</th>
                            <th>Difference</th>
                            <th>%age Achievement</th>
                        </tr>
                        </thead>
                        <tbody>
                            <tr><td>Total Quantity</td><td></td><td></td><td></td><td></td></tr>
                            <tr><td>Total Rakes</td><td></td><td></td><td></td><td></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Icons for Formula and Export -->
<div class="floating-icons">
    <!-- Formula Icon -->
    <button class="floating-icon" onclick="toggleFormulaSidebar()" title="View Formula & Calculation Logic">
        <span class="fx-icon">fx</span>
    </button>
    
    <!-- Export Icon with Dropdown -->
    <div class="floating-icon" id="exportBtn" onclick="toggleExportMenu()" title="Export Options">
        <i class="fas fa-download"></i>
        <div class="export-dropdown" id="exportDropdown">
            <button onclick="exportToJPG(); closeExportMenu(); event.stopPropagation();" title="Export as JPG">
                <i class="fas fa-image"></i>
            </button>
            <button onclick="generatePDF(); closeExportMenu(); event.stopPropagation();" title="Export as PDF">
                <i class="fas fa-file-pdf"></i>
            </button>
        </div>
    </div>
</div>

<!-- Formula Sidebar -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeFormulaSidebar()"></div>
<div class="formula-sidebar" id="formulaSidebar">
    <div class="sidebar-header">
        <h3 class="sidebar-title">
            <span class="fx-icon me-2">fx</span>
            Calculation Formula & Logic
        </h3>
        <button class="close-sidebar" onclick="closeFormulaSidebar()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="sidebar-content">
        <div class="alert alert-info">
            <h6><i class="fas fa-lightbulb me-2"></i>Advanced Redistribution Logic</h6>
            <p class="mb-0">When actual quantity in any month is changed (+/-), then remaining ACQ considering quantity in previous and current month, is redistributed proportionally among the remaining next months based on the respective quarterly percentages.</p>
        </div>

        <h5><i class="fas fa-cogs me-2"></i>Example Calculation:</h5>
        <div class="example-box p-3 rounded">
            <p><strong>Initial Setup:</strong></p>
            <ul>
                <li>ACQ = 70,00,000 MT</li>
                <li>Q1 (25%) = 17,50,000 MT</li>
                <li>Q2 (22%) = 15,40,000 MT</li>
                <li>Q3 (25%) = 17,50,000 MT</li>
                <li>Q4 (28%) = 19,60,000 MT</li>
            </ul>

            <p><strong>If Q1 = 0 MT:</strong></p>
            <p>The ACQ of 17,50,000 from Q1 will be redistributed proportionally amongst Q2, Q3 & Q4.</p>
            
            <p><strong>Remaining Total ACQ:</strong></p>
            <p>15,40,000 + 17,50,000 + 19,60,000 = 52,50,000</p>

            <h6>Proportional Distribution:</h6>
            
            <div class="mb-3">
                <strong>For Q2 (July, August, September):</strong>
                <ul>
                    <li>Percentage = 15,40,000 / 52,50,000  0.2924 (29.24%)</li>
                    <li>Additional ACQ = 17,50,000  0.2924  5,10,667</li>
                    <li>Each month gets: 5,10,667 / 3  1,70,222 additional</li>
                </ul>
            </div>

            <div class="mb-3">
                <strong>For Q3 (October, November, December):</strong>
                <ul>
                    <li>Percentage = 17,50,000 / 52,50,000  0.3333 (33.33%)</li>
                    <li>Additional ACQ = 17,50,000  0.3333  5,83,333</li>
                    <li>Each month gets: 5,83,333 / 3  1,94,444 additional</li>
                </ul>
            </div>

            <div class="mb-3">
                <strong>For Q4 (January, February, March):</strong>
                <ul>
                    <li>Percentage = 19,60,000 / 52,50,000  0.3733 (37.33%)</li>
                    <li>Additional ACQ = 17,50,000  0.3733  6,52,000</li>
                    <li>Each month gets: 6,52,000 / 3  2,17,333 additional</li>
                </ul>
            </div>
        </div>

        <div class="alert alert-success mt-3">
            <h6><i class="fas fa-check-circle me-2"></i>Key Features</h6>
            <ul class="mb-0">
                <li>Real-time calculation updates</li>
                <li>Editable actual quantity values</li>
                <li>Automatic percentage calculations</li>
                <li>Professional PDF/JPG export</li>
            </ul>
        </div>
    </div>
</div>

<!--- HTML for inputs ends here-->        

    <!-- Professional Features JavaScript -->
    <script>
        // Back Button Functionality
        function goBackToCalculators() {
            // Try to go back to parent window if opened from main app
            if (window.opener && !window.opener.closed) {
                try {
                    // If opened from main app, switch focus back and close this tab
                    window.opener.focus();
                    // Call function to show calculators page in parent window
                    if (typeof window.opener.showCalculatorsPage === 'function') {
                        window.opener.showCalculatorsPage();
                    }
                    window.close();
                } catch (e) {
                    // If cross-origin or other security issues, fallback to alert
                    alert('Please use the browser back button or close this tab to return to the main application.');
                }
            } else {
                // If no parent window, try to navigate to main app
                try {
                    window.location.href = 'index.html#calculators';
                } catch (e) {
                    alert('Please use the browser back button to return to the main application.');
                }
            }
        }

        // Floating Icons Functionality
        function toggleFloatingIcons() {
            const icons = document.querySelector('.floating-icons');
            const dropdown = document.getElementById('floating-dropdown');
            const overlay = document.getElementById('floating-overlay');
            
            if (dropdown.style.display === 'none' || !dropdown.style.display) {
                dropdown.style.display = 'block';
                overlay.style.display = 'block';
                setTimeout(() => {
                    dropdown.style.opacity = '1';
                    dropdown.style.transform = 'translateY(0)';
                    overlay.style.opacity = '1';
                }, 10);
            } else {
                dropdown.style.opacity = '0';
                dropdown.style.transform = 'translateY(20px)';
                overlay.style.opacity = '0';
                setTimeout(() => {
                    dropdown.style.display = 'none';
                    overlay.style.display = 'none';
                }, 300);
            }
        }

        function closeFloatingDropdown() {
            const dropdown = document.getElementById('floating-dropdown');
            const overlay = document.getElementById('floating-overlay');
            
            dropdown.style.opacity = '0';
            dropdown.style.transform = 'translateY(20px)';
            overlay.style.opacity = '0';
            setTimeout(() => {
                dropdown.style.display = 'none';
                overlay.style.display = 'none';
            }, 300);
        }

        // Formula Sidebar Functionality
        function toggleFormulaSidebar() {
            const sidebar = document.getElementById('formulaSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
                overlay.style.display = 'none';
            } else {
                sidebar.classList.add('show');
                overlay.style.display = 'block';
            }
        }

        function closeFormulaSidebar() {
            const sidebar = document.getElementById('formulaSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('show');
            overlay.style.display = 'none';
        }

        // Export Menu Functionality
        function toggleExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
            } else {
                dropdown.classList.add('show');
            }
        }

        function closeExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.remove('show');
        }

        // Close export menu and formula sidebar when clicking outside
        document.addEventListener('click', function(event) {
            const exportBtn = event.target.closest('#exportBtn');
            const exportDropdown = document.getElementById('exportDropdown');
            const formulaSidebar = document.getElementById('formulaSidebar');
            const formulaBtn = event.target.closest('[onclick*="toggleFormulaSidebar"]');
            
            // Close export menu if clicking outside
            if (!exportBtn && exportDropdown && exportDropdown.classList.contains('show')) {
                exportDropdown.classList.remove('show');
            }
            
            // Close formula sidebar if clicking outside
            if (!formulaBtn && formulaSidebar && formulaSidebar.classList.contains('show') && !formulaSidebar.contains(event.target)) {
                closeFormulaSidebar();
            }
        });

        // Ensure sticky columns work properly
        document.addEventListener('DOMContentLoaded', function() {
            // Force sticky positioning for first columns with high z-index
            function applyStickyColumnsInitial() {
                // Check if dark theme is active
                const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
                
                // Target tables within scroll wrappers specifically
                const scrollWrappers = document.querySelectorAll('.table-scroll-wrapper');
                scrollWrappers.forEach(wrapper => {
                    const table = wrapper.querySelector('.CoalLinkageAdvance-table');
                    if (table) {
                        const firstCells = table.querySelectorAll('th:first-child, td:first-child');
                        firstCells.forEach(cell => {
                            // Enhanced mobile sticky positioning
                            cell.style.setProperty('position', 'sticky', 'important');
                            cell.style.setProperty('left', '0', 'important');
                            
                            // Only apply colors for dark theme, let CSS handle light theme
                            if (isDarkTheme) {
                                if (cell.tagName === 'TH') {
                                    cell.style.setProperty('z-index', '1001', 'important');
                                } else {
                                    cell.style.setProperty('z-index', '999', 'important');
                                }
                            } else {
                                // For light theme, just ensure z-index is set, let CSS handle colors
                                if (cell.tagName === 'TH') {
                                    cell.style.setProperty('z-index', '1001', 'important');
                                } else {
                                    cell.style.setProperty('z-index', '999', 'important');
                                }
                                // Remove any inline color styling to let CSS take over
                                cell.style.removeProperty('background');
                                cell.style.removeProperty('background-color');
                                cell.style.removeProperty('color');
                            }
                            
                            // Additional properties to ensure sticky works on mobile
                            cell.style.setProperty('isolation', 'isolate', 'important');
                            cell.style.setProperty('white-space', 'normal', 'important');
                            cell.style.setProperty('font-weight', 'bolder', 'important');
                            cell.style.setProperty('word-wrap', 'break-word', 'important');
                            
                            // Mobile-specific width
                            if (window.innerWidth <= 768) {
                                cell.style.setProperty('min-width', '120px', 'important');
                                cell.style.setProperty('width', '120px', 'important');
                                cell.style.setProperty('max-width', '120px', 'important');
                            } else {
                                cell.style.setProperty('min-width', '200px', 'important');
                                cell.style.setProperty('width', '200px', 'important');
                                cell.style.setProperty('max-width', '200px', 'important');
                            }
                        });
                    }
                });
                
                // Also apply to any direct tables (fallback)
                const tables = document.querySelectorAll('.CoalLinkageAdvance-table');
                tables.forEach(table => {
                    const firstCells = table.querySelectorAll('th:first-child, td:first-child');
                    firstCells.forEach(cell => {
                        cell.style.setProperty('position', 'sticky', 'important');
                        cell.style.setProperty('left', '0', 'important');
                        
                        // Only apply colors for dark theme, let CSS handle light theme
                        if (isDarkTheme) {
                            if (cell.tagName === 'TH') {
                                cell.style.setProperty('z-index', '1001', 'important');
                            } else {
                                cell.style.setProperty('z-index', '999', 'important');
                            }
                        } else {
                            // For light theme, just ensure z-index is set, let CSS handle colors
                            if (cell.tagName === 'TH') {
                                cell.style.setProperty('z-index', '1001', 'important');
                            } else {
                                cell.style.setProperty('z-index', '999', 'important');
                            }
                            // Remove any inline color styling to let CSS take over
                            cell.style.removeProperty('background');
                            cell.style.removeProperty('background-color');
                            cell.style.removeProperty('color');
                        }
                        
                        // Additional properties to ensure sticky works on mobile
                        cell.style.setProperty('isolation', 'isolate', 'important');
                        cell.style.setProperty('white-space', 'normal', 'important');
                        cell.style.setProperty('font-weight', 'bolder', 'important');
                        cell.style.setProperty('word-wrap', 'break-word', 'important');
                    });
                });
            }
            
            // Apply initial sticky columns
            applyStickyColumnsInitial();
            
            // Apply sticky columns after any table updates
            function applyStickyColumns() {
                applyStickyColumnsInitial();
            }
            
            // Re-apply after any DOM changes and window resize
            window.applyStickyColumns = applyStickyColumns;
            
            // Re-apply on window resize to handle orientation changes
            window.addEventListener('resize', function() {
                setTimeout(applyStickyColumnsInitial, 100);
            });
            
            // Re-apply after a short delay to ensure all elements are loaded
            setTimeout(applyStickyColumnsInitial, 500);
        });

        // Mobile sticky column fix - Force table layout for mobile devices
        if (window.innerWidth <= 768) {
            document.addEventListener('DOMContentLoaded', function() {
                function forceMobileStickyColumns() {
                    // Force table-responsive containers to allow sticky positioning
                    const tableResponsive = document.querySelectorAll('.table-responsive');
                    tableResponsive.forEach(container => {
                        container.style.setProperty('position', 'relative', 'important');
                        container.style.setProperty('overflow-x', 'auto', 'important');
                        container.style.setProperty('contain', 'none', 'important');
                        container.style.setProperty('transform', 'none', 'important');
                        container.style.setProperty('will-change', 'scroll-position', 'important');
                    });
                    
                    // Force table layout for sticky columns
                    const tables = document.querySelectorAll('.CoalLinkageAdvance-table');
                    tables.forEach(table => {
                        table.style.setProperty('table-layout', 'fixed', 'important');
                        table.style.setProperty('border-collapse', 'separate', 'important');
                        table.style.setProperty('border-spacing', '0', 'important');
                        table.style.setProperty('min-width', '600px', 'important');
                        table.style.setProperty('position', 'relative', 'important');
                        
                        // Force first column sticky - let CSS handle colors
                        const firstCells = table.querySelectorAll('th:first-child, td:first-child');
                        firstCells.forEach(cell => {
                            cell.style.setProperty('position', 'sticky', 'important');
                            cell.style.setProperty('left', '0px', 'important');
                            cell.style.setProperty('z-index', cell.tagName === 'TH' ? '1002' : '1001', 'important');
                            cell.style.setProperty('box-shadow', '2px 0 4px rgba(0,0,0,0.1)', 'important');
                            cell.style.setProperty('border-right', '1px solid #ddd', 'important');
                            cell.style.setProperty('width', '100px', 'important');
                            cell.style.setProperty('min-width', '100px', 'important');
                            cell.style.setProperty('max-width', '100px', 'important');
                            
                            // Remove color styling to let CSS take over
                            cell.style.removeProperty('background');
                            cell.style.removeProperty('background-color');
                            cell.style.removeProperty('color');
                        });
                    });
                }
                
                // Apply immediately and on resize
                forceMobileStickyColumns();
                window.addEventListener('resize', forceMobileStickyColumns);
                setTimeout(forceMobileStickyColumns, 1000);
            });
        }

        // Export Functions
        function exportToPDF() {
            closeFloatingDropdown();
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            // Add title
            pdf.setFontSize(16);
            pdf.setFont(undefined, 'bold');
            pdf.text('Coal Linkage Distribution - Results', 20, 20);
            
            // Get all input values
            const inputs = document.querySelectorAll('input[type="number"]');
            let yPosition = 40;
            
            pdf.setFontSize(12);
            pdf.setFont(undefined, 'normal');
            
            inputs.forEach(input => {
                if (input.value && input.value !== '0') {
                    const label = input.closest('.input-group').querySelector('span').textContent;
                    pdf.text(`${label}: ${input.value}`, 20, yPosition);
                    yPosition += 8;
                }
            });
            
            // Get calculation results
            const resultsTable = document.querySelector('table');
            if (resultsTable) {
                yPosition += 10;
                pdf.setFont(undefined, 'bold');
                pdf.text('Calculation Results:', 20, yPosition);
                yPosition += 10;
                
                // Use autoTable for better table formatting
                const tableData = [];
                const rows = resultsTable.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 0) {
                        const rowData = [];
                        cells.forEach(cell => {
                            rowData.push(cell.textContent.trim());
                        });
                        tableData.push(rowData);
                    }
                });
                
                if (tableData.length > 0) {
                    pdf.autoTable({
                        head: [['Parameter', 'Value', 'Details']],
                        body: tableData,
                        startY: yPosition,
                        theme: 'grid',
                        headStyles: { fillColor: [52, 144, 220] },
                        styles: { fontSize: 10 }
                    });
                }
            }
            
            // Save the PDF
            pdf.save('coal-linkage-advanced-results.pdf');
        }

        function exportToJPG() {
            closeExportMenu();
            
            // Create a professional report container
            const reportContainer = document.createElement('div');
            reportContainer.style.cssText = `
                width: 794px;
                padding: 30px;
                background: white;
                font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                position: fixed;
                top: -10000px;
                left: -10000px;
                box-sizing: border-box;
            `;
            
            // Get input values
            const acqValue = document.getElementById("acq-input").value || "0";
            const rakeValue = document.getElementById("rake-quantity-input").value || "0";
            
            // Create report HTML
            reportContainer.innerHTML = `
                <div style="text-align: center; margin-bottom: 5px; border-bottom: 3px solid #343a40; padding-bottom: 5px;">
                    <h1 style="color: #343a40; font-size: 22px; margin: 0; font-weight: bold;">ACQ Distribution Report</h1>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 3px; background: #f8f9fa; padding: 3px; border-radius: 8px; border-left: 4px solid #28a745;">
                    <div style="font-size: 13px; font-weight: 600; color: #495057;">
                        <span style="color: #343a40;">Total ACQ:</span> ${formatNumber(parseFloat(acqValue))} MT
                    </div>
                    <div style="font-size: 13px; font-weight: 600; color: #495057;">
                        <span style="color: #343a40;">Total Rake Quantity:</span> ${formatNumber(parseFloat(rakeValue))}
                    </div>
                </div>
                
                ${createTableHTML('Monthly Allocation', 'coal-table')}
                ${createTableHTML('Quarterly Summary', 'quarterly-table')}
                ${createTableHTML('Per Day Analysis', 'per-day-table')}
                ${createTableHTML('Summary', 'summary-table')}
                
                <div style="text-align: right; margin-top: 5px; font-size: 10px; color: #6c757d;">
                    Generated: ${new Date().toLocaleDateString('en-IN')}
                </div>
            `;
            
            document.body.appendChild(reportContainer);
            
            // Generate high-quality image
            html2canvas(reportContainer, {
                scale: 3,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: 794,
                height: 1123,
                logging: false,
                allowTaint: false,
                foreignObjectRendering: false
            }).then(canvas => {
                document.body.removeChild(reportContainer);
                
                // Create download link
                const link = document.createElement('a');
                link.download = `ACQ-Distribution-Report-${new Date().toISOString().split('T')[0]}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 1.0);
                link.click();
            }).catch(error => {
                document.body.removeChild(reportContainer);
                console.error('Error generating JPG:', error);
                alert('Error generating JPG report. Please try again.');
            });
        }
        
        // Helper function to create professional table HTML
        function createTableHTML(title, tableId) {
            const table = document.getElementById(tableId);
            if (!table) return '';
            
            const rows = Array.from(table.rows);
            if (rows.length === 0) return '';
            
            let tableHTML = `
                <div style="margin-bottom: 5px;">
                    <h3 style="color: #343a40; font-size: 14px; margin-bottom: 4px; font-weight: 600; border-bottom: 2px solid #dee2e6; padding-bottom: 4px;">
                        <i class="fas fa-table" style="margin-right: 6px; color: #28a745;"></i>${title}
                    </h3>
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid #dee2e6; border-radius: 6px; overflow: hidden; font-size: 11px; table-layout: fixed;">
            `;
            
            // Add header with fixed column widths
            if (rows[0]) {
                tableHTML += '<thead style="background: linear-gradient(135deg, #343a40, #495057);">';
                tableHTML += '<tr>';
                Array.from(rows[0].cells).forEach((cell, index) => {
                    const width = index === 0 ? '20%' : '16%';
                    tableHTML += `<th style="padding: 4px 6px; color: white; font-weight: 600; text-align: center; border-right: 1px solid #6c757d; width: ${width};">${cell.textContent.trim()}</th>`;
                });
                tableHTML += '</tr></thead>';
            }
            
            // Add body rows with consistent widths
            tableHTML += '<tbody>';
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const isQuarterRow = row.cells[0] && row.cells[0].textContent.trim().includes('Q');
                const rowStyle = isQuarterRow ? 
                    'background: #f8f9fa; font-weight: 600; color: #495057;' : 
                    i % 2 === 0 ? 'background: #ffffff;' : 'background: #f8f9fa;';
                
                tableHTML += `<tr style="${rowStyle}">`;
                Array.from(row.cells).forEach((cell, index) => {
                    const alignment = index === 0 ? 'left' : 'center';
                    const fontWeight = index === 0 || isQuarterRow ? '600' : '400';
                    const width = index === 0 ? '20%' : '16%';
                    tableHTML += `<td style="padding: 4px 5px; border-right: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6; text-align: ${alignment}; font-weight: ${fontWeight}; width: ${width}; max-width: ${width}; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">${cell.textContent.trim()}</td>`;
                });
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody></table></div>';
            
            return tableHTML;
        }

        // Initialize page and all functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Coal Linkage Distribution - Professional loaded');
            
            // Initialize all calculator functionality
            initializeCalculator();
            
            // Initialize redistribution functionality
            initializeRedistribution();
            
            // Initialize additional functions
            const acqInput = document.getElementById("acq-input");
            const rakeInput = document.getElementById("rake-quantity-input");
            
            // Note: blur event listeners for validation are added below with calculations
            // to avoid conflicts with multiple listeners
            
            // enforceACQLimit(); // Disabled to prevent duplicate input listeners
            initializeQuarterValidation();
        });

        // Main calculator initialization function
        function initializeCalculator() {
            // Get all required elements
            const acqInput = document.getElementById("acq-input");
            const rakeInput = document.getElementById("rake-quantity-input");
            const table = document.getElementById("coal-table");
            const quarterlyTable = document.getElementById("quarterly-table");
            const perDayTable = document.getElementById("per-day-table");
            const copyButton = document.getElementById("copy-cells-btn");

            // Initialize variables
            let acq = 0;
            let rakeQuantity = 0;

            // Utility function for numeric input restriction
            function restrictNumericInput(input) {
                // Prevent non-numeric and negative input on keydown
                input.addEventListener('keydown', function (event) {
                    const allowedKeys = [
                        "Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab", "Home", "End"
                    ];
                    if (allowedKeys.includes(event.key)) return;

                    // Allow only one dot
                    if (event.key === "." && this.value.includes(".")) {
                        event.preventDefault();
                        return;
                    }
                    // Prevent minus, plus, 'e', and any non-digit except dot
                    if (
                        event.key === '-' || event.key === '+' || event.key === 'e' ||
                        (!/^\d$/.test(event.key) && event.key !== ".")
                    ) {
                        event.preventDefault();
                    }
                });

                // Prevent pasting non-numeric or negative values
                input.addEventListener('paste', function (event) {
                    const paste = (event.clipboardData || window.clipboardData).getData('text');
                    if (!/^\d*\.?\d*$/.test(paste)) {
                        event.preventDefault();
                    }
                });

                // On blur, clear if not a valid non-negative number
                input.addEventListener('blur', function () {
                    const value = parseFloat(this.value.trim());
                    if (isNaN(value) || value < 0) {
                        this.value = "";
                    }
                });
            }

            // Apply to all inputs except those with data-allow-text="true"
            function applyUniversalNumericRestriction() {
                document.querySelectorAll('input:not([data-allow-text="true"])').forEach(input => {
                    restrictNumericInput(input);
                });
            }

            // Apply initial restrictions
            applyUniversalNumericRestriction();

            // Prevent Enter key from submitting any form
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                    }
                });
            });

            // Prevent minus sign from being entered
            acqInput.addEventListener('keydown', function(event) {
                if (event.key === '-' || event.key === 'Minus'|| event.key === '+' || event.key === 'Plus') {
                    event.preventDefault();
                }
            });
            
            rakeInput.addEventListener('keydown', function(event) {
                if (event.key === '-' || event.key === 'Minus'|| event.key === '+' || event.key === 'Plus') {
                    event.preventDefault();
                }
            });

            // Main calculator functions
            function calculateQuarterlyAllocations() {
                const acqValue = parseFloat(acqInput.value) || 0;
                const rakeCapacity = parseFloat(rakeInput.value) || 0; // Quantity per rake (MT)
                
                if (acqValue === 0) return;

                const rows = Array.from(table.rows).slice(1);
                
                // Get quarterly percentages
                const quarterPercentages = [
                    parseFloat(document.getElementById('quarter-1')?.value) || 0,
                    parseFloat(document.getElementById('quarter-2')?.value) || 0,
                    parseFloat(document.getElementById('quarter-3')?.value) || 0,
                    parseFloat(document.getElementById('quarter-4')?.value) || 0
                ];

                console.log('Quarterly percentages:', quarterPercentages);

                // Calculate allocated quantity for each month based on quarterly percentages
                rows.forEach((row, index) => {
                    const quarterIndex = Math.floor(index / 3); // 0-3 for Q1-Q4
                    const quarterPercentage = quarterPercentages[quarterIndex];
                    const quarterlyAllocation = (quarterPercentage / 100) * acqValue;
                    const monthlyAllocation = quarterlyAllocation / 3; // Divide quarter allocation among 3 months
                    const monthlyRakes = rakeCapacity > 0 ? (monthlyAllocation / rakeCapacity) : 0; // Number of rakes needed

                    console.log(`Month ${index} (Q${quarterIndex + 1}): ${quarterPercentage}% -> ${monthlyAllocation.toFixed(2)} MT`);

                    row.cells[1].textContent = formatNumber(monthlyAllocation);
                    row.cells[2].textContent = monthlyRakes.toFixed(2);
                });

                updateQuarterlyTable();
                updatePerDayValues();
                updateSummaryTable();
                
                // Ensure sticky columns are maintained after table updates
                if (window.applyStickyColumns) {
                    window.applyStickyColumns();
                }
            }

            // FIXED Copy button functionality
            copyButton.addEventListener("click", function() {
                console.log("Copy button clicked"); // Debug log
                const rows = Array.from(table.rows).slice(1);
                
                rows.forEach(row => {
                    const allocatedQuantity = row.cells[1].textContent;
                    const allocatedRakes = row.cells[2].textContent;
                    
                    // Copy values to actual columns
                    row.cells[3].textContent = allocatedQuantity;
                    row.cells[4].textContent = allocatedRakes;
                });

                // Update all dependent calculations
                updateQuarterlyTable();
                updatePercentages();
                updatePerDayValues();
                updateSummaryTable();
                
                console.log("Copy operation completed"); // Debug log
            });

            // Input event listeners
            acqInput.addEventListener("blur", function(event) {
                validateInput(event); // Add validation
                calculateQuarterlyAllocations();
                updatePercentages();
            });

            rakeInput.addEventListener("blur", function(event) {
                validateInput(event); // Add validation
                calculateQuarterlyAllocations();
                updatePercentages();
            });

            // Add event listeners for quarterly percentage inputs
            const quarterInputs = ['quarter-1', 'quarter-2', 'quarter-3', 'quarter-4'];
            quarterInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener("input", function() {
                        updateQuarterlyLabels();
                    });
                    input.addEventListener("blur", function() {
                        calculateQuarterlyAllocations();
                        updatePercentages();
                        updateSummaryTable();
                    });
                }
            });

        } // End of initializeCalculator function

        // Helper function to format numbers with 2 decimal places and Indian locale
        function formatNumber(number, decimals = 2) {
            const fixedNumber = parseFloat(number).toFixed(decimals);
            const parts = fixedNumber.split('.');
            const integerPart = parts[0];
            const decimalPart = parts[1];
            
            // Apply Indian numbering system
            let formattedInteger = '';
            const length = integerPart.length;
            
            if (length <= 3) {
                formattedInteger = integerPart;
            } else {
                // First 3 digits from right
                formattedInteger = integerPart.slice(-3);
                let remaining = integerPart.slice(0, -3);
                
                // Add commas every 2 digits for the remaining part
                while (remaining.length > 0) {
                    if (remaining.length <= 2) {
                        formattedInteger = remaining + ',' + formattedInteger;
                        break;
                    } else {
                        formattedInteger = remaining.slice(-2) + ',' + formattedInteger;
                        remaining = remaining.slice(0, -2);
                    }
                }
            }
            
            return decimals > 0 ? formattedInteger + '.' + decimalPart : formattedInteger;
        }

        // Global update functions - accessible from anywhere
        function updateQuarterlyTable() {
            const table = document.getElementById("coal-table");
            const quarterlyTable = document.getElementById("quarterly-table");
            
            if (!table || !quarterlyTable) return;
            
            const rows = Array.from(table.rows).slice(1);
            const quarterlyRows = Array.from(quarterlyTable.rows).slice(1);

            // Update quarterly labels with real-time percentages
            updateQuarterlyLabels();

            for (let i = 0; i < 4; i++) {
                let allocatedQty = 0;
                let allocatedRakes = 0;
                let actualQty = 0;
                let actualRakes = 0;

                for (let j = i * 3; j < (i + 1) * 3; j++) {
                    if (j < rows.length) {
                        allocatedQty += parseFloat(rows[j].cells[1].textContent.replace(/,/g, '')) || 0;
                        allocatedRakes += parseFloat(rows[j].cells[2].textContent.replace(/,/g, '')) || 0;
                        actualQty += parseFloat(rows[j].cells[3].textContent.replace(/,/g, '')) || 0;
                        actualRakes += parseFloat(rows[j].cells[4].textContent.replace(/,/g, '')) || 0;
                    }
                }

                if (quarterlyRows[i]) {
                    quarterlyRows[i].cells[1].textContent = formatNumber(allocatedQty, 0);
                    quarterlyRows[i].cells[2].textContent = allocatedRakes.toFixed(2);
                    quarterlyRows[i].cells[3].textContent = formatNumber(actualQty, 0);
                    quarterlyRows[i].cells[4].textContent = actualRakes.toFixed(2);
                    
                    // Calculate percentage
                    const percentage = allocatedQty > 0 ? (actualQty / allocatedQty) * 100 : 0;
                    quarterlyRows[i].cells[5].textContent = `${percentage.toFixed(2)}%`;
                }
            }
            
            // Ensure sticky columns are maintained after table updates
            if (window.applyStickyColumns) {
                window.applyStickyColumns();
            }
        }

        function updateQuarterlyLabels() {
            const quarterLabels = ['q1-label', 'q2-label', 'q3-label', 'q4-label'];
            const quarterNames = ['Q1 (Apr-Jun)', 'Q2 (Jul-Sep)', 'Q3 (Oct-Dec)', 'Q4 (Jan-Mar)'];
            const quarterInputs = ['quarter-1', 'quarter-2', 'quarter-3', 'quarter-4'];

            quarterLabels.forEach((labelId, index) => {
                const labelElement = document.getElementById(labelId);
                const inputElement = document.getElementById(quarterInputs[index]);
                
                if (labelElement && inputElement) {
                    const percentage = parseFloat(inputElement.value) || 0;
                    labelElement.textContent = `${quarterNames[index]} ${percentage}%`;
                }
            });
        }

        function updateSummaryTable() {
            const table = document.getElementById("coal-table");
            const summaryTable = document.getElementById("summary-table");
            
            if (!table || !summaryTable) return;
            
            const rows = Array.from(table.rows).slice(1);
            const summaryRows = Array.from(summaryTable.rows).slice(1);

            let totalAllocatedQty = 0;
            let totalAllocatedRakes = 0;
            let totalActualQty = 0;
            let totalActualRakes = 0;

            // Calculate totals from monthly table
            rows.forEach(row => {
                totalAllocatedQty += parseFloat(row.cells[1].textContent.replace(/,/g, '')) || 0;
                totalAllocatedRakes += parseFloat(row.cells[2].textContent.replace(/,/g, '')) || 0;
                totalActualQty += parseFloat(row.cells[3].textContent.replace(/,/g, '')) || 0;
                totalActualRakes += parseFloat(row.cells[4].textContent.replace(/,/g, '')) || 0;
            });

            // Update Total Quantity row
            if (summaryRows[0]) {
                summaryRows[0].cells[1].textContent = formatNumber(totalAllocatedQty, 0);
                summaryRows[0].cells[2].textContent = formatNumber(totalActualQty, 0);
                summaryRows[0].cells[3].textContent = formatNumber(totalActualQty - totalAllocatedQty, 0);
                
                const qtyPercentage = totalAllocatedQty > 0 ? (totalActualQty / totalAllocatedQty) * 100 : 0;
                summaryRows[0].cells[4].textContent = `${qtyPercentage.toFixed(2)}%`;
            }

            // Update Total Rakes row
            if (summaryRows[1]) {
                summaryRows[1].cells[1].textContent = formatNumber(totalAllocatedRakes, 0);
                summaryRows[1].cells[2].textContent = formatNumber(totalActualRakes, 0);
                summaryRows[1].cells[3].textContent = formatNumber(totalActualRakes - totalAllocatedRakes, 0);
                
                const rakesPercentage = totalAllocatedRakes > 0 ? (totalActualRakes / totalAllocatedRakes) * 100 : 0;
                summaryRows[1].cells[4].textContent = `${rakesPercentage.toFixed(2)}%`;
            }
            
            // Ensure sticky columns are maintained after table updates
            if (window.applyStickyColumns) {
                window.applyStickyColumns();
            }
        }

        function updatePerDayValues() {
            const acqInput = document.getElementById("acq-input");
            const rakeInput = document.getElementById("rake-quantity-input");
            const table = document.getElementById("coal-table");
            const perDayTable = document.getElementById("per-day-table");
            
            if (!table || !perDayTable) return;
            
            const acqValue = parseFloat(acqInput?.value) || 0;
            const rakeValue = parseFloat(rakeInput?.value) || 0;
            const perDayRows = Array.from(perDayTable.rows).slice(1);
            const monthlyRows = Array.from(table.rows).slice(1);

            const daysInMonth = [30, 31, 30, 31, 31, 30, 31, 30, 31, 31, 28, 31];

            perDayRows.forEach((row, index) => {
                if (index < monthlyRows.length && index < daysInMonth.length) {
                    const allocatedQty = parseFloat(monthlyRows[index].cells[1].textContent.replace(/,/g, '')) || 0;
                    const allocatedRakes = parseFloat(monthlyRows[index].cells[2].textContent.replace(/,/g, '')) || 0;
                    const actualQty = parseFloat(monthlyRows[index].cells[3].textContent.replace(/,/g, '')) || 0;
                    const actualRakes = parseFloat(monthlyRows[index].cells[4].textContent.replace(/,/g, '')) || 0;
                    
                    const days = daysInMonth[index];
                    
                    row.cells[1].textContent = (allocatedQty / days).toFixed(2);
                    row.cells[2].textContent = (allocatedRakes / days).toFixed(2);
                    row.cells[3].textContent = actualQty > 0 ? (actualQty / days).toFixed(2) : '0.00';
                    row.cells[4].textContent = actualRakes > 0 ? (actualRakes / days).toFixed(2) : '0.00';
                    
                    // Calculate percentage
                    const percentage = allocatedQty > 0 ? (actualQty / allocatedQty) * 100 : 0;
                    row.cells[5].textContent = `${percentage.toFixed(2)}%`;
                }
            });
        }

        function updatePercentages() {
            const table = document.getElementById("coal-table");
            if (!table) return;
            
            const rows = Array.from(table.rows).slice(1);
            rows.forEach(row => {
                const allocatedQty = parseFloat(row.cells[1].textContent.replace(/,/g, '')) || 0;
                const actualQty = parseFloat(row.cells[3].textContent.replace(/,/g, '')) || 0;
                const percentage = allocatedQty > 0 ? (actualQty / allocatedQty) * 100 : 0;
                row.cells[5].textContent = `${percentage.toFixed(2)}%`;
            });
            
            // Update summary table when percentages change
            updateSummaryTable();
        }

        // Initialize redistribution functionality
        function initializeRedistribution() {
            const table = document.getElementById('coal-table'); // Correct table ID
            const acqInput = document.getElementById('acq-input');
            const rakeInput = document.getElementById('rake-quantity-input');
            
            if (!table || !acqInput || !rakeInput) {
                console.error('Required elements not found for redistribution');
                return;
            }
            
            console.log('Initializing redistribution functionality');

            // Global variables for debouncing and preventing conflicts
            let inputTimeout = null;
            let isProcessingInput = false;
            let lastTabTime = 0;
            let isTabPressed = false;

            // Function to select all text in a cell
            function selectAllTextInCell(cell) {
                try {
                    const range = document.createRange();
                    range.selectNodeContents(cell);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                } catch (error) {
                    console.log('Text selection error:', error);
                }
            }

            // Function to calculate actual rakes when actual quantity is entered
            function updateActualRakesForRow(actualQuantityCell) {
                const rakeCapacity = parseFloat(rakeInput.value) || 0;
                if (rakeCapacity === 0) return;

                const row = actualQuantityCell.closest('tr');
                const cellContent = actualQuantityCell.textContent.trim();
                
                // Handle empty cells
                if (cellContent === '') {
                    row.cells[4].textContent = '0.00'; // Actual rakes
                    row.cells[5].textContent = '0.00%'; // Percentage
                    return;
                }
                
                const actualQuantity = parseFloat(actualQuantityCell.textContent.replace(/,/g, '')) || 0;
                const actualRakes = actualQuantity / rakeCapacity;
                
                // Update the actual rakes cell (column 4)
                row.cells[4].textContent = actualRakes.toFixed(2);
                
                // Update percentage (column 5) - Actual/Allocated
                const allocatedQuantity = parseFloat(row.cells[1].textContent.replace(/,/g, '')) || 0;
                const percentage = allocatedQuantity > 0 ? (actualQuantity / allocatedQuantity) * 100 : 0;
                row.cells[5].textContent = `${percentage.toFixed(2)}%`;
            }

            // Function to get quarter for a month (0-based month index)
            function getQuarterForMonth(monthIndex) {
                // April(0), May(1), June(2) = Q1
                // July(3), August(4), September(5) = Q2  
                // October(6), November(7), December(8) = Q3
                // January(9), February(10), March(11) = Q4
                return Math.floor(monthIndex / 3);
            }

            // Function to get quarterly percentage for a month
            function getQuarterlyPercentage(monthIndex) {
                const quarterIndex = getQuarterForMonth(monthIndex);
                const quarterInputs = [
                    document.getElementById('quarter-1'),
                    document.getElementById('quarter-2'), 
                    document.getElementById('quarter-3'),
                    document.getElementById('quarter-4')
                ];
                
                const value = parseFloat(quarterInputs[quarterIndex]?.value) || 0;
                console.log(`Month ${monthIndex} is in quarter ${quarterIndex + 1}, percentage: ${value}%`);
                return value;
            }

            // Function to redistribute actual quantities among remaining months
            function redistributeActualQuantities(changedCell) {
                console.log('Redistributing quantities...');
                const acq = parseFloat(acqInput.value) || 0;
                if (acq === 0) {
                    console.log('ACQ is 0, no redistribution');
                    return;
                }

                const table = document.getElementById('coal-table');
                const rows = Array.from(table.rows).slice(1); // Skip header
                
                // Find the changed row index
                let changedRowIndex = -1;
                rows.forEach((row, index) => {
                    if (row.cells[3] === changedCell) {
                        changedRowIndex = index;
                    }
                });

                if (changedRowIndex === -1) return;

                // Parse and format the new value from the changed cell
                let changedValue = parseFloat(changedCell.textContent.replace(/,/g, '')) || 0;
                console.log('Changed month index:', changedRowIndex, 'Changed value:', changedValue);
                
                // Validate if the new value exceeds ACQ
                if (changedValue > acq) {
                    showErrorMessage(`Actual quantity cannot exceed ACQ (${formatNumber(acq)} MT). Please enter a valid value.`);
                    changedCell.textContent = '0';
                    changedValue = 0;
                }

                // Update the changed cell with proper formatting
                changedCell.textContent = formatNumber(changedValue);
                
                // If this cell is currently being edited (has focus), set cursor to end
                if (document.activeElement === changedCell || changedCell.hasAttribute('data-in-input')) {
                    setCursorToEnd(changedCell);
                }
                
                updateActualRakesForRow(changedCell);

                // Store the original allocated quantities before redistribution
                const originalAllocatedQuantities = [];
                for (let i = 0; i < rows.length; i++) {
                    originalAllocatedQuantities[i] = parseFloat(rows[i].cells[1].textContent.replace(/,/g, '')) || 0;
                }

                // Calculate how much quantity was freed up from changed months
                // by comparing current actual quantities with their allocated quantities
                let freedQuantity = 0;
                for (let i = 0; i <= changedRowIndex; i++) {
                    const allocatedQty = originalAllocatedQuantities[i];
                    const actualQty = parseFloat(rows[i].cells[3].textContent.replace(/,/g, '')) || 0;
                    const difference = allocatedQty - actualQty; // Positive if quantity is freed up
                    if (difference > 0) {
                        freedQuantity += difference;
                    }
                    console.log(`Month ${i} - Allocated: ${allocatedQty}, Actual: ${actualQty}, Freed: ${Math.max(0, difference)}`);
                }

                console.log('Total freed quantity to redistribute:', freedQuantity);

                if (freedQuantity <= 0) {
                    console.log('No quantity freed up for redistribution');
                    // Update all dependent calculations
                    updateQuarterlyTable();
                    updatePercentages();
                    updatePerDayValues();
                    updateSummaryTable();
                    return;
                }

                // Find subsequent months that should receive redistributed quantity
                // (only months after the changed month)
                const subsequentMonths = [];
                let totalQuarterlyPercent = 0;
                
                for (let i = changedRowIndex + 1; i < rows.length; i++) {
                    const quarterlyPercent = getQuarterlyPercentage(i);
                    if (quarterlyPercent > 0) {
                        subsequentMonths.push({
                            row: rows[i],
                            index: i,
                            quarterlyPercent: quarterlyPercent
                        });
                        totalQuarterlyPercent += quarterlyPercent;
                        console.log(`Subsequent month ${i} available for redistribution with ${quarterlyPercent}%`);
                    }
                }

                console.log('Subsequent months to redistribute:', subsequentMonths.length);
                console.log('Total quarterly percent for redistribution:', totalQuarterlyPercent);

                // Get the selected distribution method
                const distributionMethod = getDistributionMethod();
                console.log('Distribution method:', distributionMethod);

                // Redistribute freed quantity based on selected method
                if (subsequentMonths.length > 0) {
                    if (distributionMethod === 'quarterly' && totalQuarterlyPercent > 0) {
                        // Quarterly percentage-based distribution
                        console.log('Using quarterly percentage distribution');
                        subsequentMonths.forEach(monthData => {
                            const proportionalShare = (monthData.quarterlyPercent / totalQuarterlyPercent) * freedQuantity;
                            const currentActual = parseFloat(monthData.row.cells[3].textContent.replace(/,/g, '')) || 0;
                            const newActual = currentActual + proportionalShare;
                            console.log(`Month ${monthData.index} gets proportional share:`, proportionalShare);
                            
                            // Update the actual quantity cell (column 3)
                            monthData.row.cells[3].textContent = formatNumber(Math.max(0, newActual));
                            
                            // If this is the currently active cell, set cursor to end
                            if (document.activeElement === monthData.row.cells[3] || monthData.row.cells[3].hasAttribute('data-in-input')) {
                                setCursorToEnd(monthData.row.cells[3]);
                            }
                            
                            // Update actual rakes and percentage for this row
                            updateActualRakesForRow(monthData.row.cells[3]);
                        });
                    } else {
                        // Equal distribution (either method=equal or no quarterly percentages available)
                        console.log('Using equal distribution');
                        const equalShare = freedQuantity / subsequentMonths.length;
                        subsequentMonths.forEach(monthData => {
                            const currentActual = parseFloat(monthData.row.cells[3].textContent.replace(/,/g, '')) || 0;
                            const newActual = currentActual + equalShare;
                            console.log(`Month ${monthData.index} gets equal share:`, equalShare);
                            
                            monthData.row.cells[3].textContent = formatNumber(Math.max(0, newActual));
                            
                            // If this is the currently active cell, set cursor to end
                            if (document.activeElement === monthData.row.cells[3] || monthData.row.cells[3].hasAttribute('data-in-input')) {
                                setCursorToEnd(monthData.row.cells[3]);
                            }
                            
                            updateActualRakesForRow(monthData.row.cells[3]);
                        });
                    }
                }
                
                // Update all dependent calculations
                updateQuarterlyTable();
                updatePercentages();
                updatePerDayValues();
                updateSummaryTable();
                
                console.log('Redistribution completed');
            }

            // Function to set cursor to the end of a contenteditable element
            function setCursorToEnd(element) {
                setTimeout(() => {
                    try {
                        const range = document.createRange();
                        const selection = window.getSelection();
                        
                        if (element.firstChild) {
                            range.setStart(element.firstChild, element.firstChild.textContent.length);
                            range.setEnd(element.firstChild, element.firstChild.textContent.length);
                        } else {
                            range.selectNodeContents(element);
                            range.collapse(false);
                        }
                        
                        selection.removeAllRanges();
                        selection.addRange(range);
                    } catch (error) {
                        console.warn("Could not set cursor position:", error);
                    }
                }, 0);
            }

            // Listen for changes in actual quantity cells - only on actual typing/input
            table.addEventListener("input", function(event) {
                if (event.target.classList.contains("actual-quantity")) {
                    console.log("INPUT EVENT TRIGGERED - Actual quantity:", event.target.textContent);
                    
                    // Set processing flag to block tab navigation
                    isProcessingInput = true;
                    
                    // Clear any existing timeout
                    if (inputTimeout) {
                        clearTimeout(inputTimeout);
                    }
                    
                    // Store the fact that we're in an input event
                    event.target.setAttribute('data-in-input', 'true');
                    
                    // Store cursor position before cleaning
                    const selection = window.getSelection();
                    let cursorPosition = 0;
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        cursorPosition = range.startOffset;
                    }
                    
                    // Validate and clean input - only allow numbers and one decimal point
                    let originalValue = event.target.textContent;
                    let cleanedValue = originalValue.replace(/[^0-9.]/g, '');
                    
                    // Allow only one decimal point
                    const decimalCount = (cleanedValue.match(/\./g) || []).length;
                    if (decimalCount > 1) {
                        // Remove extra decimal points, keep only the first one
                        const firstDecimalIndex = cleanedValue.indexOf('.');
                        cleanedValue = cleanedValue.substring(0, firstDecimalIndex + 1) + cleanedValue.substring(firstDecimalIndex + 1).replace(/\./g, '');
                    }
                    
                    // Update the cell content only if it was actually modified
                    if (cleanedValue !== originalValue) {
                        event.target.textContent = cleanedValue;
                        
                        // Restore cursor position, but don't go beyond the cleaned content length
                        const newCursorPosition = Math.min(cursorPosition, cleanedValue.length);
                        
                        // Set cursor position with debouncing
                        inputTimeout = setTimeout(() => {
                            try {
                                const range = document.createRange();
                                const selection = window.getSelection();
                                
                                if (event.target.firstChild) {
                                    range.setStart(event.target.firstChild, newCursorPosition);
                                    range.setEnd(event.target.firstChild, newCursorPosition);
                                } else {
                                    range.selectNodeContents(event.target);
                                    range.collapse(false);
                                }
                                
                                selection.removeAllRanges();
                                selection.addRange(range);
                            } catch (error) {
                                console.warn("Could not set cursor position:", error);
                            }
                            // Clear processing flag after cursor positioning
                            isProcessingInput = false;
                        }, 50); // Increased delay for better debouncing
                    }
                    
                    // Update rakes immediately while typing
                    updateActualRakesForRow(event.target);
                    
                    // Update quarterly and per day tables to reflect changes (but don't redistribute on every keystroke)
                    updateQuarterlyTable();
                    updatePerDayValues();
                    updateSummaryTable();
                    
                    // Remove the input flag after a short delay
                    setTimeout(() => {
                        event.target.removeAttribute('data-in-input');
                        // Ensure processing flag is cleared even if cursor positioning fails
                        if (isProcessingInput) {
                            isProcessingInput = false;
                        }
                    }, 100);
                }
            });

            // Handle keyboard events - Numeric validation, Tab navigation, and Enter
            table.addEventListener("keydown", function(event) {
                if (event.target.classList.contains("actual-quantity")) {
                    // Handle Tab navigation (both forward and backward)
                    if (event.key === "Tab") {
                        event.preventDefault();
                        
                        // Prevent key repeat issues with long press
                        const currentTime = Date.now();
                        if (event.repeat || (currentTime - lastTabTime < 150)) {
                            console.log("Tab ignored - too fast or repeat");
                            return;
                        }
                        lastTabTime = currentTime;
                        
                        // Clear any pending input timeouts to prevent interference
                        if (inputTimeout) {
                            clearTimeout(inputTimeout);
                            inputTimeout = null;
                        }
                        
                        // Block tab navigation if input is being processed
                        if (isProcessingInput) {
                            console.log("Tab blocked - input processing in progress");
                            return;
                        }
                        
                        const cells = Array.from(table.querySelectorAll('.actual-quantity'));
                        const currentIndex = cells.indexOf(event.target);
                        
                        if (event.shiftKey) {
                            // Shift+Tab: Move backward, stop at first cell
                            if (currentIndex > 0) {
                                const prevCell = cells[currentIndex - 1];
                                prevCell.focus();
                                selectAllTextInCell(prevCell);
                            }
                        } else {
                            // Tab: Move forward, stop at last cell
                            if (currentIndex >= 0 && currentIndex < cells.length - 1) {
                                const nextCell = cells[currentIndex + 1];
                                nextCell.focus();
                                selectAllTextInCell(nextCell);
                            }
                        }
                        return;
                    }
                    
                    // Handle Enter key
                    if (event.key === "Enter") {
                        event.preventDefault();
                        event.target.blur(); // This will trigger the blur event for redistribution
                        return;
                    }
                    
                    // Handle numeric validation
                    const allowedKeys = [
                        "Backspace", "Delete", "ArrowLeft", "ArrowRight", "Home", "End", "Escape"
                    ];
                    
                    // Allow navigation and control keys
                    if (allowedKeys.includes(event.key)) {
                        return; // Allow these keys
                    }
                    
                    // Allow numbers
                    if (/^[0-9]$/.test(event.key)) {
                        return; // Allow numbers
                    }
                    
                    // Allow decimal point only if there isn't one already
                    if (event.key === "." || event.key === ",") {
                        const currentText = event.target.textContent;
                        if (!currentText.includes(".")) {
                            return; // Allow first decimal point
                        }
                    }
                    
                    // Block all other keys
                    event.preventDefault();
                }
            });

            // Handle key release to reset tab state
            table.addEventListener("keyup", function(event) {
                if (event.key === "Tab") {
                    isTabPressed = false;
                }
            });

            // Prevent paste of non-numeric content
            table.addEventListener("paste", function(event) {
                if (event.target.classList.contains("actual-quantity")) {
                    event.preventDefault();
                    
                    // Get pasted text
                    const pastedText = (event.clipboardData || window.clipboardData).getData('text');
                    
                    // Clean the pasted text to only allow numbers and one decimal
                    let cleanText = pastedText.replace(/[^0-9.]/g, '');
                    
                    // Allow only one decimal point
                    const decimalCount = (cleanText.match(/\./g) || []).length;
                    if (decimalCount > 1) {
                        const firstDecimalIndex = cleanText.indexOf('.');
                        cleanText = cleanText.substring(0, firstDecimalIndex + 1) + cleanText.substring(firstDecimalIndex + 1).replace(/\./g, '');
                    }
                    
                    // Insert the cleaned text
                    if (cleanText) {
                        event.target.textContent = cleanText;
                        updateActualRakesForRow(event.target);
                        
                        // Place cursor at the end
                        const range = document.createRange();
                        const selection = window.getSelection();
                        range.selectNodeContents(event.target);
                        range.collapse(false);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }
            });

            // Only trigger redistribution on blur if there was actual content change
            let originalValue = '';
            table.addEventListener("focus", function(event) {
                if (event.target.classList.contains("actual-quantity")) {
                    // Store original value when focusing
                    originalValue = event.target.textContent.trim();
                    console.log("Focus - Original value:", originalValue);
                    
                    // Select all text when clicking on a cell
                    setTimeout(() => {
                        selectAllTextInCell(event.target);
                    }, 50);
                }
            }, true);

            table.addEventListener("blur", function(event) {
                if (event.target.classList.contains("actual-quantity")) {
                    console.log("BLUR EVENT TRIGGERED for cell:", event.target);
                    const currentValue = event.target.textContent.trim();
                    console.log("Original value:", originalValue, "Current value:", currentValue);
                    
                    // Only redistribute if the value actually changed
                    if (currentValue !== originalValue) {
                        console.log("BLUR EVENT - Value changed from", originalValue, "to", currentValue);
                        
                        if (currentValue !== '') {
                            // Check redistribution mode and handle accordingly
                            const mode = getRedistributionMode();
                            if (mode === 'proportionate') {
                                // Use original working function for proportionate mode
                                redistributeActualQuantities(event.target);
                            } else if (mode === 'absolute') {
                                // For absolute mode, get row index and show modal
                                const table = document.getElementById("coal-table");
                                const rows = Array.from(table.querySelector("tbody").querySelectorAll("tr"));
                                const changedRowIndex = rows.findIndex(row => row.contains(event.target));
                                
                                // Calculate the difference (just for display in modal)
                                const currentActual = parseFloat(currentValue.replace(/,/g, '')) || 0;
                                const originalActual = parseFloat(originalValue.replace(/,/g, '')) || 0;
                                const difference = currentActual - originalActual;
                                
                                showMonthSelectionModal(changedRowIndex, difference);
                            }
                        } else {
                            // If cell is empty, just update rakes and percentages for this cell
                            updateActualRakesForRow(event.target);
                            updateQuarterlyTable();
                            updatePercentages();
                            updatePerDayValues();
                            updateSummaryTable();
                        }
                    } else {
                        console.log("BLUR EVENT - No value change, no redistribution");
                    }
                }
            }, true);
            
            console.log('Redistribution event listeners attached to coal-table');
        }

        // Additional calculator functions
        function validateInput(event) {
            console.log('validateInput called for:', event.target.id, 'value:', event.target.value);
            const input = event.target;
            const value = input.value.trim();
            const resultContainer = document.getElementById('input-error-badge');

            // Badge warning HTMLs
            const badgeMissing = `
                <span class="badge rounded-pill bg-danger text-white">
                  <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                  Please enter a value.
                </span>
            `;
            const badgeNegative = `
                <span class="badge rounded-pill bg-danger text-white">
                  <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                  Please enter a valid non-negative value.
                </span>
            `;

            // Check for missing or negative input
            if (value === "") {
                console.log('Empty value detected, calling showErrorMessage');
                showErrorMessage('Please enter a value for all required fields.', 'success');
                return;
            }
            if (!isNaN(value) && parseFloat(value) < 0) {
                console.log('Negative value detected, calling showErrorMessage');
                showErrorMessage('Please enter a valid non-negative value.', 'success');
                return;
            }

            // Hide all messages if input is valid (but only if no other inputs have errors)
            console.log('Input is valid, checking if we can hide error messages');
            hideErrorMessage();
        }

        // ACQ enforcement for actual quantity cells
        function enforceACQLimit() {
            const acqInput = document.getElementById("acq-input");
            
            document.querySelectorAll('.actual-quantity').forEach((cell, index, cells) => {
                cell.addEventListener('input', () => {
                    const acq = parseInt(acqInput.value, 10);
                    let total = 0;

                    // Calculate the sum of the current cell and all preceding cells
                    for (let i = 0; i <= index; i++) {
                        const value = parseInt(cells[i].innerText, 10);
                        if (!isNaN(value)) {
                            total += value;
                        }
                    }

                    const currentValue = parseInt(cell.innerText, 10);

                    // If the sum exceeds ACQ, reset the current cell
                    if (total > acq) {
                        const previousTotal = total - currentValue;
                        const maxAllowed = acq - previousTotal;
                        cell.innerText = Math.max(0, maxAllowed);
                    }
                });
            });
        }

        // Quarter percentage validation
        function initializeQuarterValidation() {
            const quarterPercentages = [0.25, 0.22, 0.25, 0.28];
            const quarterInputs = document.querySelectorAll('.quarter-input');
            const errorMessage = document.getElementById('error-message');
            const quarterLabels = [
                document.getElementById('q1-label'),
                document.getElementById('q2-label'),
                document.getElementById('q3-label'),
                document.getElementById('q4-label'),
            ];

            function validateAndUpdatePercentages() {
                let totalPercentage = 0;

                quarterInputs.forEach((input, index) => {
                    const value = parseFloat(input.value);
                    if (!isNaN(value)) {
                        totalPercentage += value;
                        quarterPercentages[index] = value / 100;

                        if (quarterLabels[index]) {
                            quarterLabels[index].textContent = `Q${index + 1} (${["Apr-Jun", "Jul-Sep", "Oct-Dec", "Jan-Mar"][index]}) ${value}%`;
                        }
                    }
                });

                const badgePercentageExceed = `
                    <span class="badge rounded-pill bg-danger text-white">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                        The total percentage cannot exceed 100%.
                    </span>
                `;

                const badgePercentageLess = `
                    <span class="badge rounded-pill bg-danger text-white">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                        The total percentage cannot be less than 100%.
                    </span>
                `;

                if (totalPercentage > 100) {
                    showErrorMessage('The total quarterly percentage cannot exceed 100%. Please adjust the quarterly percentages.', 'error');
                    // Hide the old error badge
                    if (errorMessage) {
                        errorMessage.style.display = 'none';
                        errorMessage.innerHTML = '';
                    }
                } else if (totalPercentage < 100) {
                    showErrorMessage('The total quarterly percentage must equal 100%. Please adjust the quarterly percentages.', 'warning');
                    // Hide the old error badge
                    if (errorMessage) {
                        errorMessage.style.display = 'none';
                        errorMessage.innerHTML = '';
                    }
                } else {
                    hideErrorMessage();
                    if (errorMessage) {
                        errorMessage.style.display = 'none';
                        errorMessage.innerHTML = '';
                    }
                }
                
                // Update tables when quarter percentages change
                updateQuarterlyTable();
                updatePerDayValues();
            }

            // Add event listeners to quarter inputs
            quarterInputs.forEach(input => {
                input.addEventListener('input', validateAndUpdatePercentages);
                input.addEventListener('blur', function(event) {
                    validateInput(event); // Add validation for quarterly inputs too
                });
            });
        }

        // PDF Export functionality
        function generatePDF() {
            closeExportMenu();
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('portrait', 'mm', 'a4');
            
            // Get input values
            const acqValue = document.getElementById("acq-input").value || "0";
            const rakeValue = document.getElementById("rake-quantity-input").value || "0";
            
            // Set page margins
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            
            // Add professional header
            doc.setFillColor(245, 245, 245);
            doc.rect(0, 0, pageWidth, 25, 'F');
            
            doc.setTextColor(64, 64, 64);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('ACQ Distribution Report', pageWidth/2, 15, { align: 'center' });
            
            // Add summary information box
            doc.setTextColor(0, 0, 0);
            doc.setFillColor(248, 249, 250);
            doc.rect(margin, 30, pageWidth - 2*margin, 18, 'F');
            doc.setDrawColor(40, 167, 69);
            doc.setLineWidth(2);
            doc.line(margin, 30, margin, 48);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(52, 58, 64);
            doc.text('Inputs:', margin + 3, 38);
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.setTextColor(73, 80, 87);
            doc.text(`Total ACQ: ${formatNumber(parseFloat(acqValue))} MT`, margin + 3, 43);
            doc.text(`Total Rake Quantity: ${formatNumber(parseFloat(rakeValue))}`, pageWidth/2 + 5, 43);
            
            let currentY = 55;
            
            // Generate Monthly Table
            currentY = addCompactTable(doc, 'Monthly Allocation & Distribution', 'coal-table', currentY, pageWidth, margin);
            
            // Generate Quarterly Table
            currentY = addCompactTable(doc, 'Quarterly Summary', 'quarterly-table', currentY, pageWidth, margin);
            
            // Generate Per Day Table
            currentY = addCompactTable(doc, 'Per Day Analysis', 'per-day-table', currentY, pageWidth, margin);
            
            // Generate Summary Table
            currentY = addCompactTable(doc, 'Summary', 'summary-table', currentY, pageWidth, margin);
            
            // Add footer with generation date on right side
            doc.setFontSize(8);
            doc.setTextColor(108, 117, 125);
            doc.text(`Generated: ${new Date().toLocaleDateString('en-IN')}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
            
            // Save the PDF
            doc.save(`ACQ-Distribution-Report-${new Date().toISOString().split('T')[0]}.pdf`);
        }
        
        // Helper function to add compact tables to PDF for single page layout
        function addCompactTable(doc, title, tableId, startY, pageWidth, margin) {
            const table = document.getElementById(tableId);
            if (!table) return startY;
            
            const rows = Array.from(table.rows);
            if (rows.length === 0) return startY;
            
            // Add table title
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(52, 58, 64);
            doc.text(title, margin, startY);
            
            // Add decorative line under title
            doc.setDrawColor(222, 226, 230);
            doc.setLineWidth(0.5);
            doc.line(margin, startY + 1, pageWidth - margin, startY + 1);
            
            startY += 6;
            
            // Prepare table data
            const headers = [];
            const data = [];
            
            // Extract headers
            if (rows[0]) {
                Array.from(rows[0].cells).forEach(cell => {
                    headers.push(cell.textContent.trim());
                });
            }
            
            // Extract data rows
            for (let i = 1; i < rows.length; i++) {
                const row = [];
                Array.from(rows[i].cells).forEach(cell => {
                    row.push(cell.textContent.trim());
                });
                data.push(row);
            }
            
            // Calculate column widths based on table type
            const tableWidth = pageWidth - 2 * margin;
            let columnStyles = {};
            
            if (tableId === 'summary-table') {
                // Summary table - 5 columns, consistent widths
                const colWidths = [
                    tableWidth * 0.20,  // Parameter name (20%)
                    tableWidth * 0.20,  // Allocated (20%)
                    tableWidth * 0.20,  // Actual (20%)
                    tableWidth * 0.20,  // Difference (20%)
                    tableWidth * 0.20   // %age Achievement (20%)
                ];
                
                columnStyles = {
                    0: { halign: 'left', fontStyle: 'bold', cellWidth: colWidths[0] },
                    1: { halign: 'center', cellWidth: colWidths[1] },
                    2: { halign: 'center', cellWidth: colWidths[2] },
                    3: { halign: 'center', cellWidth: colWidths[3] },
                    4: { halign: 'center', cellWidth: colWidths[4] }
                };
            } else {
                // Monthly, Quarterly, Per Day tables - 6 columns, consistent widths
                const colWidths = [
                    tableWidth * 0.20,  // Month/Quarter name (20%)
                    tableWidth * 0.16,  // Allocated Qty (16%)
                    tableWidth * 0.16,  // Allocated Rakes (16%)
                    tableWidth * 0.16,  // Actual Qty (16%)
                    tableWidth * 0.16,  // Actual Rakes (16%)
                    tableWidth * 0.16   // Percentage (16%)
                ];
                
                columnStyles = {
                    0: { halign: 'left', fontStyle: 'bold', cellWidth: colWidths[0] },
                    1: { halign: 'center', cellWidth: colWidths[1] },
                    2: { halign: 'center', cellWidth: colWidths[2] },
                    3: { halign: 'center', cellWidth: colWidths[3] },
                    4: { halign: 'center', cellWidth: colWidths[4] },
                    5: { halign: 'center', cellWidth: colWidths[5] }
                };
            }
            
            // Create the compact table
            doc.autoTable({
                head: [headers],
                body: data,
                startY: startY,
                theme: 'grid',
                headStyles: {
                    fillColor: [245, 245, 245],
                    textColor: [64, 64, 64],
                    fontStyle: 'bold',
                    fontSize: 8,
                    halign: 'center',
                    valign: 'middle',
                    cellPadding: 1
                },
                bodyStyles: {
                    fontSize: 7,
                    halign: 'center',
                    valign: 'middle',
                    cellPadding: 1
                },
                columnStyles: columnStyles,
                alternateRowStyles: {
                    fillColor: [248, 249, 250]
                },
                margin: { left: margin, right: margin },
                tableWidth: tableWidth,
                styles: {
                    lineColor: [222, 226, 230],
                    lineWidth: 0.1,
                    cellPadding: 1
                },
                didParseCell: function(data) {
                    // Highlight quarterly rows
                    if (data.row.raw[0] && (
                        data.row.raw[0].includes("Q1") ||
                        data.row.raw[0].includes("Q2") ||
                        data.row.raw[0].includes("Q3") ||
                        data.row.raw[0].includes("Q4")
                    )) {
                        data.cell.styles.fillColor = [233, 236, 239];
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [52, 58, 64];
                    }
                }
            });
            
            return doc.lastAutoTable.finalY + 8;
        }

        // =============================================================================
        // THEME TOGGLE FUNCTIONALITY
        // =============================================================================

        function toggleTheme() {
            const body = document.body;
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            const currentTheme = body.getAttribute('data-theme') || html.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.setAttribute('data-theme', 'light');
                html.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-moon theme-icon';
                localStorage.setItem('coalLinkageAdvanceTheme', 'light');
                
                // Animate the icon
                themeIcon.style.transform = 'rotate(360deg) scale(1.1)';
                setTimeout(() => {
                    themeIcon.style.transform = 'rotate(0deg) scale(1)';
                }, 300);
            } else {
                body.setAttribute('data-theme', 'dark');
                html.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-sun theme-icon';
                localStorage.setItem('coalLinkageAdvanceTheme', 'dark');
                
                // Animate the icon
                themeIcon.style.transform = 'rotate(-360deg) scale(1.1)';
                setTimeout(() => {
                    themeIcon.style.transform = 'rotate(0deg) scale(1)';
                }, 300);
            }
            
            // Refresh first column styling after theme change
            refreshFirstColumnStyling();
        }

        // Function to refresh first column styling after theme changes
        function refreshFirstColumnStyling() {
            const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
            const firstCells = document.querySelectorAll('.CoalLinkageAdvance-table th:first-child, .CoalLinkageAdvance-table td:first-child');
            
            firstCells.forEach(cell => {
                // Remove any inline styling to let CSS take over
                cell.style.removeProperty('background');
                cell.style.removeProperty('background-color');
                cell.style.removeProperty('color');
                cell.style.removeProperty('box-shadow');
                cell.style.removeProperty('border-right');
                
                // Only keep essential positioning styles
                cell.style.setProperty('position', 'sticky', 'important');
                cell.style.setProperty('left', '0', 'important');
                
                if (cell.tagName === 'TH') {
                    cell.style.setProperty('z-index', '1001', 'important');
                } else {
                    cell.style.setProperty('z-index', '999', 'important');
                }
            });
        }

        // Initialize theme from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('coalLinkageAdvanceTheme');
            const themeIcon = document.getElementById('theme-icon');
            
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                document.documentElement.setAttribute('data-theme', savedTheme);
                themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun theme-icon' : 'fas fa-moon theme-icon';
            }
        });

        // =============================================================================
        // RAINBOW ANIMATION TOGGLE FUNCTIONALITY
        // =============================================================================
        
        function toggleRainbowAnimation() {
            const body = document.body;
            const rainbowButton = document.querySelector('.rainbow-toggle');
            const rainbowIcon = document.getElementById('rainbow-icon');
            
            // Toggle the no-rainbow class on body
            if (body.classList.contains('no-rainbow')) {
                body.classList.remove('no-rainbow');
                rainbowButton.classList.remove('disabled');
                rainbowButton.title = 'Disable Rainbow Animation';
                localStorage.setItem('coalLinkageRainbowEnabled', 'true');
                
                // Animate the icon
                rainbowIcon.style.transform = 'rotate(360deg) scale(1.2)';
                setTimeout(() => {
                    rainbowIcon.style.transform = 'rotate(0deg) scale(1)';
                }, 400);
            } else {
                body.classList.add('no-rainbow');
                rainbowButton.classList.add('disabled');
                rainbowButton.title = 'Enable Rainbow Animation';
                localStorage.setItem('coalLinkageRainbowEnabled', 'false');
                
                // Animate the icon
                rainbowIcon.style.transform = 'rotate(-360deg) scale(0.8)';
                setTimeout(() => {
                    rainbowIcon.style.transform = 'rotate(0deg) scale(1)';
                }, 400);
            }
        }

        // Initialize rainbow animation state from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const rainbowEnabled = localStorage.getItem('coalLinkageRainbowEnabled');
            const body = document.body;
            const rainbowButton = document.querySelector('.rainbow-toggle');
            
            if (rainbowEnabled === 'false') {
                body.classList.add('no-rainbow');
                rainbowButton.classList.add('disabled');
                rainbowButton.title = 'Enable Rainbow Animation';
            } else {
                rainbowButton.title = 'Disable Rainbow Animation';
            }
        });

        // Function to clear all actual quantities
        function clearActualQuantities() {
            console.log('Clearing all actual quantities due to mode/method change');
            const table = document.getElementById('coal-table');
            if (table) {
                const rows = table.querySelector('tbody').querySelectorAll('tr');
                rows.forEach(row => {
                    // Clear actual quantity (column 3)
                    row.cells[3].textContent = '0';
                    // Clear actual rakes (column 4)
                    row.cells[4].textContent = '0.00';
                });
                
                // Update all dependent calculations
                updateQuarterlyTable();
                updatePercentages();
                updatePerDayValues();
                updateSummaryTable();
                
                console.log('Actual quantities cleared and tables updated');
            }
        }

        // Add event listeners for redistribution mode and distribution method changes
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for redistribution mode changes
            const redistributionModeRadios = document.querySelectorAll('input[name="redistribution-mode"]');
            redistributionModeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('Redistribution mode changed to:', this.value);
                    clearActualQuantities();
                });
            });

            // Listen for distribution method changes
            const distributionMethodRadios = document.querySelectorAll('input[name="distribution-method"]');
            distributionMethodRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('Distribution method changed to:', this.value);
                    clearActualQuantities();
                });
            });
        });

        // Global variables for redistribution mode
        let currentChangedRow = -1;
        let currentDifference = 0;
        const monthNames = ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'];

        // Get current redistribution mode
        function getRedistributionMode() {
            const modeRadio = document.querySelector('input[name="redistribution-mode"]:checked');
            return modeRadio ? modeRadio.value : 'proportionate';
        }

        // Get current distribution method
        function getDistributionMethod() {
            const methodRadio = document.querySelector('input[name="distribution-method"]:checked');
            return methodRadio ? methodRadio.value : 'quarterly';
        }

        // Function to display error messages above the Annual Coal Quantity input
        function showErrorMessage(message, type = 'error') {
            console.log('showErrorMessage called with:', message, 'type:', type);
            const errorContainer = document.getElementById('input-error-badge');
            console.log('Error container found:', errorContainer);
            
            if (errorContainer) {
                errorContainer.style.display = 'block';
                
                // Determine alert class and icon
                let alertClass, typeLabel, iconClass;
                switch(type) {
                    case 'success':
                        alertClass = 'alert-success';
                        typeLabel = 'Info';
                        iconClass = 'fas fa-info-circle';
                        break;
                    case 'warning':
                        alertClass = 'alert-warning';
                        typeLabel = 'Warning';
                        iconClass = 'fas fa-exclamation-triangle';
                        break;
                    default: // error
                        alertClass = 'alert-danger';
                        typeLabel = 'Error';
                        iconClass = 'fas fa-exclamation-triangle';
                }
                
                errorContainer.className = `alert ${alertClass} mb-2`;
                errorContainer.innerHTML = `
                    <i class="${iconClass} me-2"></i>
                    <strong>${typeLabel}:</strong> ${message}
                    <button type="button" class="btn-close ms-auto" onclick="hideErrorMessage()"></button>
                `;
                
                console.log('Error message set, container class:', errorContainer.className);
                
                // Auto-hide after 5 seconds for warnings and success, keep errors until manually closed
                if (type === 'warning' || type === 'success') {
                    setTimeout(() => {
                        hideErrorMessage();
                    }, 5000);
                }
            } else {
                console.log('Error container not found!');
            }
        }

        // Function to hide error messages (but only if no current errors exist)
        function hideErrorMessage() {
            console.log('hideErrorMessage called');
            // Don't hide if there are current validation errors
            const acqInput = document.getElementById('acq-input');
            const rakeInput = document.getElementById('rake-quantity-input');
            
            let hasErrors = false;
            if (acqInput && acqInput.value.trim() === '') hasErrors = true;
            if (rakeInput && rakeInput.value.trim() === '') hasErrors = true;
            
            // Check quarterly inputs too
            const quarterInputs = ['quarter-1', 'quarter-2', 'quarter-3', 'quarter-4'];
            quarterInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input && input.value.trim() === '') hasErrors = true;
            });
            
            if (!hasErrors) {
                console.log('No errors detected, hiding message');
                const errorContainer = document.getElementById('input-error-badge');
                if (errorContainer) {
                    errorContainer.style.display = 'none';
                    errorContainer.innerHTML = '';
                    errorContainer.className = '';
                }
            } else {
                console.log('Errors still exist, keeping message visible');
            }
        }

        // Show month selection modal for absolute mode
        function showMonthSelectionModal(changedRowIndex, difference) {
            currentChangedRow = changedRowIndex;
            currentDifference = difference;
            
            const modal = document.getElementById('month-selection-modal');
            const changedMonthName = document.getElementById('changed-month-name');
            const differenceAmount = document.getElementById('difference-amount');
            const checkboxGroup = document.getElementById('month-checkbox-group');
            
            // Calculate the total surplus from all months up to and including the changed month
            const table = document.getElementById("coal-table");
            const rows = table.querySelector("tbody").querySelectorAll("tr");
            let totalSurplus = 0;
            
            for (let i = 0; i <= changedRowIndex; i++) {
                const allocatedQty = parseFloat(rows[i].cells[1].textContent.replace(/,/g, '')) || 0; // Column 1: Allocated
                const actualQty = parseFloat(rows[i].cells[3].textContent.replace(/,/g, '')) || 0;     // Column 3: Actual
                const monthSurplus = allocatedQty - actualQty;
                totalSurplus += monthSurplus;
            }
            
            // Set modal content
            changedMonthName.textContent = monthNames[changedRowIndex];
            differenceAmount.textContent = formatNumber(Math.max(0, totalSurplus));
            
            // Clear and populate month checkboxes (only for months after the changed month)
            checkboxGroup.innerHTML = '';
            
            for (let i = changedRowIndex + 1; i < 12; i++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `month-${i}`;
                checkbox.value = i;
                
                const label = document.createElement('label');
                label.htmlFor = `month-${i}`;
                label.textContent = monthNames[i];
                
                monthDiv.appendChild(checkbox);
                monthDiv.appendChild(label);
                
                // Add click handler for the div
                monthDiv.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                    }
                    monthDiv.classList.toggle('selected', checkbox.checked);
                });
                
                // Add change handler for checkbox
                checkbox.addEventListener('change', function() {
                    monthDiv.classList.toggle('selected', this.checked);
                });
                
                checkboxGroup.appendChild(monthDiv);
            }
            
            // Show modal
            modal.style.display = 'flex';
        }

        // Close month selection modal
        function closeMonthSelectionModal() {
            const modal = document.getElementById('month-selection-modal');
            modal.style.display = 'none';
            currentChangedRow = -1;
            currentDifference = 0;
        }

        // Redistribute in absolute mode
        function redistributeAbsoluteMode() {
            const selectedMonths = [];
            const checkboxes = document.querySelectorAll('#month-checkbox-group input[type="checkbox"]:checked');
            
            checkboxes.forEach(checkbox => {
                selectedMonths.push(parseInt(checkbox.value));
            });
            
            console.log('Selected months for redistribution:', selectedMonths);
            
            if (selectedMonths.length === 0) {
                showErrorMessage('Please select at least one month for redistribution.');
                return;
            }
            
            const table = document.getElementById("coal-table");
            const rows = table.querySelector("tbody").querySelectorAll("tr");
            
            // Calculate the surplus/deficit from ONLY the currently changed month
            // This prevents accumulation from previously redistributed months
            const allocatedQty = parseFloat(rows[currentChangedRow].cells[1].textContent.replace(/,/g, '')) || 0; // Column 1: Allocated
            const actualQty = parseFloat(rows[currentChangedRow].cells[3].textContent.replace(/,/g, '')) || 0;     // Column 3: Actual
            const totalSurplus = allocatedQty - actualQty; // Surplus if positive, deficit if negative
            
            console.log(`Changed month ${currentChangedRow} (${monthNames[currentChangedRow]}): Allocated ${allocatedQty}, Actual ${actualQty}, Surplus ${totalSurplus}`);
            console.log('Number of selected months:', selectedMonths.length);
            
            if (totalSurplus <= 0) {
                showErrorMessage('No surplus quantity available for redistribution from this month.');
                return;
            }
            
            // If only one month selected, give all surplus to that month
            if (selectedMonths.length === 1) {
                const selectedRowIndex = selectedMonths[0];
                const currentActual = parseFloat(rows[selectedRowIndex].cells[3].textContent.replace(/,/g, '')) || 0;
                const newActual = currentActual + totalSurplus;
                
                console.log(`Single month ${monthNames[selectedRowIndex]}: ${currentActual} + ${totalSurplus} = ${newActual}`);
                
                rows[selectedRowIndex].cells[3].textContent = formatNumber(newActual);
                
                // Update actual rakes for this row
                const rakeCapacity = parseFloat(document.getElementById('rake-quantity-input')?.value) || 0;
                if (rakeCapacity > 0) {
                    const actualRakes = newActual / rakeCapacity;
                    rows[selectedRowIndex].cells[4].textContent = formatNumber(actualRakes.toFixed(2));
                }
            } else {
                // Multiple months selected - distribute based on selected distribution method
                const distributionMethod = getDistributionMethod();
                console.log('Multiple months selected, distribution method:', distributionMethod);
                
                if (distributionMethod === 'quarterly') {
                    // Quarterly percentage-based distribution
                    console.log('Using quarterly percentage distribution for absolute mode...');
                    
                    // Get quarterly percentages for selected months
                    const selectedMonthsData = selectedMonths.map(monthIndex => {
                        const quarterIndex = Math.floor(monthIndex / 3);
                        const quarterPercentages = [
                            parseFloat(document.getElementById('quarter-1')?.value) || 0,
                            parseFloat(document.getElementById('quarter-2')?.value) || 0,
                            parseFloat(document.getElementById('quarter-3')?.value) || 0,
                            parseFloat(document.getElementById('quarter-4')?.value) || 0
                        ];
                        const monthlyPercentage = quarterPercentages[quarterIndex] / 3; // Monthly percentage
                        
                        console.log(`Month ${monthNames[monthIndex]} (Q${quarterIndex + 1}): ${monthlyPercentage}% monthly`);
                        
                        return {
                            index: monthIndex,
                            monthlyPercentage: monthlyPercentage
                        };
                    });
                    
                    // Calculate total percentage of selected months
                    const totalSelectedPercentage = selectedMonthsData.reduce((sum, month) => sum + month.monthlyPercentage, 0);
                    console.log('Total selected percentage:', totalSelectedPercentage);
                    
                    if (totalSelectedPercentage > 0) {
                        // Distribute surplus proportionally among selected months
                        console.log('Distributing proportionally...');
                        selectedMonthsData.forEach(monthData => {
                            const proportionalShare = (monthData.monthlyPercentage / totalSelectedPercentage) * totalSurplus;
                            const currentActual = parseFloat(rows[monthData.index].cells[3].textContent.replace(/,/g, '')) || 0;
                            const newActual = currentActual + proportionalShare;
                            
                            console.log(`Month ${monthNames[monthData.index]}: ${currentActual} + ${proportionalShare} = ${newActual}`);
                            
                            rows[monthData.index].cells[3].textContent = formatNumber(newActual);
                            
                            // Update actual rakes for this row
                            const rakeCapacity = parseFloat(document.getElementById('rake-quantity-input')?.value) || 0;
                            if (rakeCapacity > 0) {
                                const actualRakes = newActual / rakeCapacity;
                                rows[monthData.index].cells[4].textContent = formatNumber(actualRakes.toFixed(2));
                            }
                        });
                    } else {
                        // If no quarterly percentages available, fall back to equal distribution
                        console.log('No quarterly percentages available, falling back to equal distribution...');
                        const equalShare = totalSurplus / selectedMonths.length;
                        selectedMonths.forEach(monthIndex => {
                            const currentActual = parseFloat(rows[monthIndex].cells[3].textContent.replace(/,/g, '')) || 0;
                            const newActual = currentActual + equalShare;
                            
                            console.log(`Month ${monthNames[monthIndex]}: ${currentActual} + ${equalShare} = ${newActual}`);
                            
                            rows[monthIndex].cells[3].textContent = formatNumber(newActual);
                            
                            // Update actual rakes for this row
                            const rakeCapacity = parseFloat(document.getElementById('rake-quantity-input')?.value) || 0;
                            if (rakeCapacity > 0) {
                                const actualRakes = newActual / rakeCapacity;
                                rows[monthIndex].cells[4].textContent = formatNumber(actualRakes.toFixed(2));
                            }
                        });
                    }
                } else {
                    // Equal distribution method
                    console.log('Using equal distribution for absolute mode...');
                    const equalShare = totalSurplus / selectedMonths.length;
                    selectedMonths.forEach(monthIndex => {
                        const currentActual = parseFloat(rows[monthIndex].cells[3].textContent.replace(/,/g, '')) || 0;
                        const newActual = currentActual + equalShare;
                        
                        console.log(`Month ${monthNames[monthIndex]}: ${currentActual} + ${equalShare} = ${newActual}`);
                        
                        rows[monthIndex].cells[3].textContent = formatNumber(newActual);
                        
                        // Update actual rakes for this row
                        const rakeCapacity = parseFloat(document.getElementById('rake-quantity-input')?.value) || 0;
                        if (rakeCapacity > 0) {
                            const actualRakes = newActual / rakeCapacity;
                            rows[monthIndex].cells[4].textContent = formatNumber(actualRakes.toFixed(2));
                        }
                    });
                }
            }
            
            updateQuarterlyTable();
            updateSummaryTable();
            updatePerDayValues();
            updatePercentages();
            
            // Ensure sticky columns are maintained after table updates
            if (window.applyStickyColumns) {
                window.applyStickyColumns();
            }
            
            // Close modal
            closeMonthSelectionModal();
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('month-selection-modal');
            if (event.target === modal) {
                closeMonthSelectionModal();
            }
        });

    </script>
    
    <!-- Month Selection Modal for Absolute Mode -->
    <div id="month-selection-modal" class="month-selection-modal">
        <div class="month-selection-content">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-check me-2"></i>
                    Select Months for Redistribution
                </h5>
                <button type="button" class="btn-close" onclick="closeMonthSelectionModal()"></button>
            </div>
            
            <div class="mb-3">
                <p class="text-muted mb-2">
                    <strong>Last Changed Month:</strong> <span id="changed-month-name"></span><br>
                    <strong>Surplus to Redistribute:</strong> <span id="difference-amount"></span> MT<br>
                    <small><em>Surplus = Total Allocated - Total Actual (up to changed month)</em></small>
                </p>
            </div>
            
            <div class="month-checkbox-group" id="month-checkbox-group">
                <!-- Month checkboxes will be populated dynamically -->
            </div>
            
            <div class="d-flex justify-content-end gap-2 mt-3">
                <button type="button" class="btn btn-secondary" onclick="closeMonthSelectionModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-professional-green" onclick="redistributeAbsoluteMode()">
                    <i class="fas fa-check me-2"></i>
                    Redistribute
                </button>
            </div>
        </div>
    </div>
</body>
</html>
