<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional GCV Analysis Suite</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- MathJax for formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>

    <style>
        /* Professional Gradient Background */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px 0;
            margin: 0;
        }

        /* Back Button */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            color: white;
        }

        /* Main Container */
        .calculator-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .calculator-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .calculator-title {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .calculator-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            margin-bottom: 0;
        }

        /* Calculator Tabs */
        .calculator-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .calculator-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 12px 24px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: 500;
        }

        .calculator-tab.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .calculator-tab:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
        }

        /* Calculator Content */
        .calculator-content {
            display: none;
        }

        .calculator-content.active {
            display: block;
        }

        /* Section Styling */
        .section-title {
            color: white;
            font-size: 1.4rem;
            font-weight: 600;
            margin: 25px 0 20px 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .input-label {
            color: white;
            font-weight: 500;
            width: 200px;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .input-group {
            display: flex;
            flex: 1;
            gap: 10px;
            max-width: 300px;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            padding: 12px 15px;
            font-size: 14px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
            color: white;
            outline: none;
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Results Display */
        .results-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .result-badge {
            display: inline-block;
            background: rgba(0, 123, 255, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin: 5px 5px 5px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .result-badge.success {
            background: rgba(40, 167, 69, 0.8);
        }

        .result-badge.warning {
            background: rgba(255, 193, 7, 0.8);
            color: #212529;
        }

        .result-badge.danger {
            background: rgba(220, 53, 69, 0.8);
        }

        /* Action Buttons */
        .action-buttons {
            text-align: center;
            margin: 20px 0;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 14px;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            color: white;
        }

        .action-btn.primary {
            background: rgba(0, 123, 255, 0.8);
        }

        .action-btn.primary:hover {
            background: rgba(0, 123, 255, 0.9);
        }

        .action-btn.danger {
            background: rgba(220, 53, 69, 0.8);
        }

        .action-btn.danger:hover {
            background: rgba(220, 53, 69, 0.9);
        }

        /* Floating Action Buttons */
        .floating-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }

        .floating-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .floating-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            color: white;
        }

        /* Storage Counter */
        .storage-counter {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .storage-counter:empty {
            display: none;
        }

        /* Error/Info Messages */
        .error-message {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 10px;
            color: #ff6b6b;
            padding: 12px 15px;
            margin-bottom: 15px;
            display: none;
            backdrop-filter: blur(10px);
        }

        .instruction-message {
            background: rgba(0, 123, 255, 0.1);
            border: 1px solid rgba(0, 123, 255, 0.3);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.9);
            padding: 12px 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        /* Formula Sidebar */
        .formula-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1500;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }

        .formula-sidebar.active {
            right: 0;
        }

        .formula-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .formula-title {
            color: #333;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #333;
        }

        .formula-item {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .formula-expression {
            color: #333;
            font-size: 14px;
            line-height: 1.6;
        }

        .formula-fallback {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
            font-style: italic;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .calculator-container {
                padding: 20px;
                margin: 10px;
            }
            
            .calculator-title {
                font-size: 1.8rem;
            }

            .calculator-tabs {
                flex-direction: column;
                align-items: center;
            }

            .calculator-tab {
                width: 100%;
                max-width: 300px;
                text-align: center;
            }

            .input-row {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .input-label {
                width: 100%;
                text-align: left;
                margin-bottom: 5px;
            }

            .input-group {
                max-width: none;
            }

            .floating-actions {
                bottom: 20px;
                right: 20px;
            }

            .floating-btn {
                width: 50px;
                height: 50px;
                font-size: 16px;
            }

            .formula-sidebar {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- Back Button -->
    <button class="back-button" onclick="window.history.back()" title="Back to Dashboard">
        <i class="fas fa-arrow-left"></i>
    </button>

    <!-- Main Container -->
    <div class="container">
        <div class="calculator-container">
            <!-- Header -->
            <div class="calculator-header">
                <h1 class="calculator-title">
                    <i class="fas fa-flask me-3"></i>GCV Analysis Suite
                </h1>
                <p class="calculator-subtitle">Professional Coal Quality Analysis Tools</p>
            </div>

            <!-- Calculator Tabs -->
            <div class="calculator-tabs">
                <div class="calculator-tab active" onclick="switchCalculator('calc1')">
                    <i class="fas fa-calculator me-2"></i>GCV/Ash/Moisture Calculator
                </div>
                <div class="calculator-tab" onclick="switchCalculator('calc2')">
                    <i class="fas fa-exchange-alt me-2"></i>GCV Conversion Calculator
                </div>
            </div>

            <!-- Calculator 1: GCV/Ash/Moisture Calculator -->
            <div id="calc1" class="calculator-content active">
                <div class="instruction-message">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Instructions:</strong> Enter any two values to calculate the third. All calculations are based on standard coal analysis formulas.
                </div>

                <div class="error-message" id="error1">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorText1"></span>
                </div>

                <div class="input-section">
                    <h3 class="section-title">
                        <i class="fas fa-edit me-2"></i>Input Parameters
                    </h3>
                    
                    <div class="input-row">
                        <label class="input-label">GCV (ADB) [kcal/kg]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="gcvInput" 
                                   placeholder="Enter GCV value" step="0.01" 
                                   oninput="calculateFromInputs()">
                        </div>
                    </div>

                    <div class="input-row">
                        <label class="input-label">Ash Content [%]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ashInput" 
                                   placeholder="Enter Ash percentage" step="0.01" min="0" max="100"
                                   oninput="calculateFromInputs()">
                        </div>
                    </div>

                    <div class="input-row">
                        <label class="input-label">Moisture Content [%]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="moistureInput" 
                                   placeholder="Enter Moisture percentage" step="0.01" min="0" max="100"
                                   oninput="calculateFromInputs()">
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="action-btn primary" onclick="calculateFromInputs()">
                        <i class="fas fa-calculator me-2"></i>Calculate
                    </button>
                    <button class="action-btn" onclick="clearCalculator1()">
                        <i class="fas fa-refresh me-2"></i>Clear All
                    </button>
                    <button class="action-btn" onclick="saveCalculation('calc1')">
                        <i class="fas fa-save me-2"></i>Save Result
                    </button>
                </div>

                <div class="results-container" id="results1" style="display: none;">
                    <h3 class="section-title">
                        <i class="fas fa-chart-line me-2"></i>Calculation Results
                    </h3>
                    <div id="resultDisplay1"></div>
                </div>
            </div>

            <!-- Calculator 2: GCV Conversion Calculator -->
            <div id="calc2" class="calculator-content">
                <div class="instruction-message">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Instructions:</strong> Enter any three values to calculate the fourth. Choose between GCV ARB to Equilibrated conversion or vice versa.
                </div>

                <div class="error-message" id="error2">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorText2"></span>
                </div>

                <div class="input-section">
                    <h3 class="section-title">
                        <i class="fas fa-edit me-2"></i>Input Parameters
                    </h3>
                    
                    <div class="input-row">
                        <label class="input-label">GCV ARB [kcal/kg]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="gcvArbInput" 
                                   placeholder="Enter GCV ARB value" step="0.01" 
                                   oninput="calculateConversion()">
                        </div>
                    </div>

                    <div class="input-row">
                        <label class="input-label">GCV Equilibrated [kcal/kg]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="gcvEqInput" 
                                   placeholder="Enter GCV Equilibrated value" step="0.01" 
                                   oninput="calculateConversion()">
                        </div>
                    </div>

                    <div class="input-row">
                        <label class="input-label">Moisture ARB [%]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="moistureArbInput" 
                                   placeholder="Enter Moisture ARB" step="0.01" min="0" max="100"
                                   oninput="calculateConversion()">
                        </div>
                    </div>

                    <div class="input-row">
                        <label class="input-label">Moisture Equilibrated [%]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="moistureEqInput" 
                                   placeholder="Enter Moisture Equilibrated" step="0.01" min="0" max="100"
                                   oninput="calculateConversion()">
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="action-btn primary" onclick="calculateConversion()">
                        <i class="fas fa-exchange-alt me-2"></i>Convert
                    </button>
                    <button class="action-btn" onclick="clearCalculator2()">
                        <i class="fas fa-refresh me-2"></i>Clear All
                    </button>
                    <button class="action-btn" onclick="saveCalculation('calc2')">
                        <i class="fas fa-save me-2"></i>Save Result
                    </button>
                </div>

                <div class="results-container" id="results2" style="display: none;">
                    <h3 class="section-title">
                        <i class="fas fa-chart-line me-2"></i>Conversion Results
                    </h3>
                    <div id="resultDisplay2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-actions">
        <button class="floating-btn" onclick="toggleFormulaSidebar()" title="View Formulas">
            <i class="fas fa-flask"></i>
        </button>
        <button class="floating-btn" onclick="exportToPDF()" title="Export to PDF">
            <i class="fas fa-file-pdf"></i>
        </button>
        <button class="floating-btn" onclick="exportToJPG()" title="Export to JPG">
            <i class="fas fa-image"></i>
        </button>
        <button class="floating-btn" onclick="toggleStorageManager()" title="Manage Saved Data">
            <i class="fas fa-database"></i>
            <div class="storage-counter" id="storageCounter"></div>
        </button>
    </div>

    <!-- Formula Sidebar -->
    <div class="formula-sidebar" id="formulaSidebar">
        <div class="formula-header">
            <h3 class="formula-title">Coal Analysis Formulas</h3>
            <button class="close-btn" onclick="toggleFormulaSidebar()">×</button>
        </div>
        
        <div class="formula-item">
            <h5 style="color: #333; margin-bottom: 10px;">GCV/Ash/Moisture Relationships</h5>
            <div class="formula-expression" id="formula1">
                <p><strong>Approximate Dulong Formula:</strong></p>
                <p>GCV = 8100 - 138 × Ash% - 138 × Moisture%</p>
                
                <p><strong>Modified Dulong Formula:</strong></p>
                <p>GCV = 8080 - 140 × Ash% - 120 × Moisture%</p>
                
                <p><strong>Indian Coal Formula:</strong></p>
                <p>GCV = 8900 - 142 × Ash% - 65 × Moisture%</p>
            </div>
            <div class="formula-fallback">
                Note: These are empirical formulas for estimation. Actual values may vary based on coal composition.
            </div>
        </div>

        <div class="formula-item">
            <h5 style="color: #333; margin-bottom: 10px;">GCV Conversion Formulas</h5>
            <div class="formula-expression" id="formula2">
                <p><strong>ARB to Equilibrated:</strong></p>
                <p>GCV(Eq) = GCV(ARB) × (100 - M(Eq)) / (100 - M(ARB))</p>
                
                <p><strong>Equilibrated to ARB:</strong></p>
                <p>GCV(ARB) = GCV(Eq) × (100 - M(ARB)) / (100 - M(Eq))</p>
                
                <p>Where:</p>
                <p>• M(ARB) = Moisture content As Received Basis</p>
                <p>• M(Eq) = Moisture content Equilibrated</p>
                <p>• GCV = Gross Calorific Value</p>
            </div>
            <div class="formula-fallback">
                Standard ASTM/ISO conversion methods for coal quality analysis.
            </div>
        </div>
    </div>

    <!-- Storage Manager Modal -->
    <div class="modal fade" id="storageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 15px;">
                <div class="modal-header" style="border-bottom: 1px solid rgba(0, 0, 0, 0.1);">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="fas fa-database me-2"></i>Saved Calculations Manager
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                    <div id="savedCalculationsList"></div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(0, 0, 0, 0.1);">
                    <button type="button" class="btn btn-danger" onclick="clearAllSavedData()">
                        <i class="fas fa-trash-alt me-2"></i>Clear All
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>


document.addEventListener('DOMContentLoaded', function () {
  function restrictNumericInput(input) {
    // Prevent non-numeric and negative input on keydown
    input.addEventListener('keydown', function (event) {
      const allowedKeys = [
        "Backspace", "Delete", "ArrowLeft", "ArrowRight", "Tab", "Home", "End"
      ];
      if (allowedKeys.includes(event.key)) return;

      // Allow only one dot
      if (event.key === "." && this.value.includes(".")) {
        event.preventDefault();
        return;
      }
      // Prevent minus, plus, 'e', and any non-digit except dot
      if (
        event.key === '-' || event.key === '+' || event.key === 'e' ||
        (!/^\d$/.test(event.key) && event.key !== ".")
      ) {
        event.preventDefault();
      }
    });

    // Prevent pasting non-numeric or negative values
    input.addEventListener('paste', function (event) {
      const paste = (event.clipboardData || window.clipboardData).getData('text');
      if (!/^\d*\.?\d*$/.test(paste)) {
        event.preventDefault();
      }
    });

    // On blur, clear if not a valid non-negative number
    input.addEventListener('blur', function () {
      const value = parseFloat(this.value.trim());
      if (isNaN(value) || value < 0) {
        this.value = "";
      }
    });
  }

  // Apply to all inputs except those with data-allow-text="true"
  function applyUniversalNumericRestriction() {
    document.querySelectorAll('input:not([data-allow-text="true"])').forEach(input => {
      restrictNumericInput(input);
    });
  }

  // Initial application
  applyUniversalNumericRestriction();

  // If you dynamically add inputs, call applyUniversalNumericRestriction() again after adding them.
});












document.addEventListener('DOMContentLoaded', function () {
    // Prevent Enter key from submitting any form
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
            }
        });
    });
});





// JavaScript to calculate GCV, Ash, Moisture
document.addEventListener('DOMContentLoaded', function () {
    const gamInputs = [
        document.getElementById("gcv-gam"),
        document.getElementById("ash-gam"),
        document.getElementById("moisture-gam")
    ];
    gamInputs.forEach(input => {
        input.addEventListener('input', calculateGCVAshMoisture);
    });
});
// Initialize an array to store parameter values for GCV, Ash, Moisture calculations
const gamParameterValues = [];

// Function to calculate GCV, Ash, or Moisture
function calculateGCVAshMoisture() {
    const gcv = parseFloat($("#gcv-gam").val());
    const ash = parseFloat($("#ash-gam").val());
    const moisture = parseFloat($("#moisture-gam").val());
    const resultshow3 = document.getElementById('resultshow3');
    const badgeError = `
      <div class="d-flex flex-wrap gap-1">
        <span class="badge rounded-pill bg-danger text-white">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          Please enter valid non-negative inputs.
        </span>
      </div>
    `;
    const badgeTwoInputs = `
      <div class="d-flex flex-wrap gap-1">
        <span class="badge rounded-pill" style="color:#222;background:#ffe066;">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          Enter any 2 inputs.
        </span>
      </div>
    `;
    // Error for negative input
    if (gcv < 0 || ash < 0 || moisture < 0) {
        resultshow3.style.display = 'block';
        resultshow3.innerHTML = badgeError;
        return;
    }
    // Error if not exactly 2 inputs are filled
    const values = [gcv, ash, moisture];
    const filledCount = values.filter(v => !isNaN(v)).length;
    if (filledCount !== 2) {
        resultshow3.style.display = 'block';
        resultshow3.innerHTML = badgeTwoInputs;
        return;
    }
    // Prepare result badge HTML
    resultshow3.style.display = 'block';
    resultshow3.innerHTML = `
      <div class="d-flex flex-wrap gap-1">
        <span class="badge rounded-pill bg-secondary">
          <span id="calculated-parameter-result"></span>
        </span>
      </div>
    `;
    // Calculate and display results
    if (isNaN(gcv) && !isNaN(ash) && !isNaN(moisture)) {
        const calculatedGCV = ((154 * (100 - (moisture + (1.1 * ash)))) - (108 * moisture)) / 1.8;
        $("#calculated-parameter-result").text("GCV: " + calculatedGCV.toFixed(2) + " kcal/kg");
    } else if (!isNaN(gcv) && isNaN(ash) && !isNaN(moisture)) {
        const calculatedAsh = ((100 - (((gcv * 1.8) + (108 * moisture)) / 154)) - moisture) / 1.1;
        if (calculatedAsh < 0) {
            $("#calculated-parameter-result").html(
                `Ash: ${calculatedAsh.toFixed(2)} % <i class="bi bi-exclamation-triangle-fill text-danger"></i> <span class="text-danger">Ash cannot be negative!</span>`
            );
        } else {
            $("#calculated-parameter-result").text("Ash: " + calculatedAsh.toFixed(2) + " %");
        }
    } else if (!isNaN(gcv) && !isNaN(ash) && isNaN(moisture)) {
        const calculatedMoisture = (15400 - (169.4 * ash) - (1.8 * gcv)) / 262;
        if (calculatedMoisture < 0) {
            $("#calculated-parameter-result").html(
                `Moisture: ${calculatedMoisture.toFixed(2)} % <i class="bi bi-exclamation-triangle-fill text-danger"></i> <span class="text-danger">Moisture cannot be negative!</span>`
            );
        } else {
            $("#calculated-parameter-result").text("Moisture: " + calculatedMoisture.toFixed(2) + " %");
        }
    }
}


function storeGCVAshMoistureParameters() {
    let gcv = parseFloat(document.getElementById("gcv-gam").value);
    let ash = parseFloat(document.getElementById("ash-gam").value);
    let moisture = parseFloat(document.getElementById("moisture-gam").value);

    // Count how many are missing
    let missingCount = [
        isNaN(gcv),
        isNaN(ash),
        isNaN(moisture)
    ].filter(Boolean).length;

    if (missingCount > 1) {
        alert("Please enter any 2 inputs.");
        return;
    }

    // Calculate the missing parameter
    if (isNaN(gcv) && !isNaN(ash) && !isNaN(moisture)) {
        // GCV = [{154 x (100 - (Moisture + (1.1 x Ash)))} - {108 x Moisture}] / 1.8
        gcv = ((154 * (100 - (moisture + (1.1 * ash)))) - (108 * moisture)) / 1.8;
    } else if (!isNaN(gcv) && isNaN(ash) && !isNaN(moisture)) {
        // Ash = [{100 - (((GCV x 1.8) + (108 x Moisture)) / 154)} - Moisture] / 1.1
        ash = ((100 - (((gcv * 1.8) + (108 * moisture)) / 154)) - moisture) / 1.1;
    } else if (!isNaN(gcv) && !isNaN(ash) && isNaN(moisture)) {
        // Moisture = [15400 - {169.4 x Ash} - {1.8 x GCV}] / 262
        moisture = (15400 - (169.4 * ash) - (1.8 * gcv)) / 262;
    }

    const parameterValueObj = {
        "GCV (kcal/kg)": isNaN(gcv) ? "" : gcv.toFixed(2),
        "Ash (%)": isNaN(ash) ? "" : ash.toFixed(2),
        "Moisture (%)": isNaN(moisture) ? "" : moisture.toFixed(2)
    };
    gamParameterValues.push(parameterValueObj);
    updateRowCountBadgeGam();
}


// Function to update the row count badge for GCV, Ash, Moisture calculations
function updateRowCountBadgeGam() {
    $("#rowCountBadgeGam").text(gamParameterValues.length);
}

// Function to clear the array for GCV, Ash, Moisture calculations
function clearGamParameterValues() {
    // Ask for confirmation before clearing
    const confirmation = confirm("Do you really want to clear the calculations?");
            if (confirmation) {gamParameterValues.splice(0, gamParameterValues.length); // Clear the array
    updateRowCountBadgeGam(); // Update the row count badge
}}

// Function to generate a PDF with all stored parameter values for GCV, Ash, Moisture calculations
function generatePDFWithStoredValuesGam() {
    // Prevent the default behavior of the button
    event.preventDefault();

    if (gamParameterValues.length === 0) {
        alert("No parameter values are stored.");
        return;
    }

    // Create a new jsPDF instance
    let doc = new jsPDF("p", "mm", [210, 297]);
    doc.setFontSize(16);
    doc.text("GCV, Ash, Moisture", 15, 25);

    // Create content for the PDF with a table containing all stored parameter values
    const tableData = [];
    const parameterNames = Object.keys(gamParameterValues[0]);

    // Add the parameter names as the first row
    tableData.push(["Sr. No.", ...parameterNames]);

    // Add the parameter values as rows
    gamParameterValues.forEach((valueObj, index) => {
        const rowData = [`(${index + 1})`];
        parameterNames.forEach(parameter => {
            rowData.push(valueObj[parameter]);
        });
        tableData.push(rowData);
    });

    // Add the table to the PDF
    doc.autoTable({
        startY: 30,
        head: tableData.slice(0, 1),
        body: tableData.slice(1),
        theme: "grid",
        tableWidth: "auto",
        margin: { top: 15 },
        columnStyles: {
            0: { halign: "left" },
            1: { halign: "center" },
            2: { halign: "center" },
            3: { halign: "center" }
        }        
    });

    // Save the PDF
    doc.save("GAM.pdf");
}

document.addEventListener('DOMContentLoaded', function () {
    const parameterInputs = [
        document.getElementById("gcv-arb"),
        document.getElementById("gcv-eq"),
        document.getElementById("total-moisture"),
        document.getElementById("eq-moisture")
    ];
    parameterInputs.forEach(input => {
        input.addEventListener('input', calculateParameter);
    });
});
      
// Initialize an array to store parameter values
const parameterValues = [];

// Function to calculate a parameter based on the given values
function calculateParameter() {
    const gcvArb = parseFloat($("#gcv-arb").val());
    const gcvEq = parseFloat($("#gcv-eq").val());
    const totalMoisture = parseFloat($("#total-moisture").val());
    const eqMoisture = parseFloat($("#eq-moisture").val());
    const resultshow4 = document.getElementById('resultshow4');

    // Error badge templates
    const badgeError = `
      <div class="d-flex flex-wrap gap-1">
        <span class="badge rounded-pill  bg-danger text-white">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          Please enter valid non-negative inputs.
        </span>
      </div>
    `;
    const badgeMoisture = `
      <div class="d-flex flex-wrap gap-1">
        <span class="badge rounded-pill bg-danger text-white">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          Total Moisture cannot be less than Eq Moisture!
        </span>
      </div>
    `;
    const badgeGcv = `
      <div class="d-flex flex-wrap gap-1">
        <span class="badge rounded-pill bg-danger text-white">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          GCV Eq cannot be less than GCV ARB!
        </span>
      </div>
    `;
    const badgeThreeInputs = `
      <div class="d-flex flex-wrap gap-1">
        <span class="badge rounded-pill" style="color:#222;background:#ffe066;">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          Enter any 3 inputs.
        </span>
      </div>
    `;

    // Error for negative input
    if (
        gcvArb < 0 ||
        gcvEq < 0 ||
        totalMoisture < 0 ||
        eqMoisture < 0
    ) {
        resultshow4.style.display = 'block';
        resultshow4.innerHTML = badgeError;
        return;
    }

    // TM cannot be less than Eq. Moisture
    if (!isNaN(totalMoisture) && !isNaN(eqMoisture) && totalMoisture < eqMoisture) {
        resultshow4.style.display = 'block';
        resultshow4.innerHTML = badgeMoisture;
        return;
    }
    // GCV Eq cannot be less than GCV ARB
    if (!isNaN(gcvEq) && !isNaN(gcvArb) && gcvEq < gcvArb) {
        resultshow4.style.display = 'block';
        resultshow4.innerHTML = badgeGcv;
        return;
    }

    // Count filled inputs
    const values = [gcvArb, gcvEq, totalMoisture, eqMoisture];
    const filledCount = values.filter(v => !isNaN(v)).length;
    if (filledCount !== 3) {
        resultshow4.style.display = 'block';
        resultshow4.innerHTML = badgeThreeInputs;
        return;
    }

    // Prepare result badge HTML
    resultshow4.style.display = 'block';
    resultshow4.innerHTML = `
      <div class="d-flex flex-wrap gap-1">
        <span class="badge rounded-pill bg-info">
          <span id="calculated-parameter-ARB-Eq-result"></span>
        </span>
      </div>
    `;

    // Calculate and display results
    if (isNaN(gcvArb) && !isNaN(gcvEq) && !isNaN(totalMoisture) && !isNaN(eqMoisture)) {
        // Calculate GCV ARB
        const calculatedGcvArb = (gcvEq * (100 - totalMoisture)) / (100 - eqMoisture);
        $("#calculated-parameter-ARB-Eq-result").text(`GCV ARB: ${calculatedGcvArb.toFixed(2)} kcal/kg`);
    } else if (!isNaN(gcvArb) && isNaN(gcvEq) && !isNaN(totalMoisture) && !isNaN(eqMoisture)) {
        // Calculate GCV EQ
        const calculatedGcvEq = (gcvArb * (100 - eqMoisture)) / (100 - totalMoisture);
        $("#calculated-parameter-ARB-Eq-result").text(`GCV EQ: ${calculatedGcvEq.toFixed(2)} kcal/kg`);
    } else if (!isNaN(gcvArb) && !isNaN(gcvEq) && isNaN(totalMoisture) && !isNaN(eqMoisture)) {
        // Calculate Total Moisture
        const calculatedTotalMoisture = 100 - ((gcvArb / gcvEq) * (100 - eqMoisture));
        $("#calculated-parameter-ARB-Eq-result").text(`Total Moisture: ${calculatedTotalMoisture.toFixed(2)} %`);
    } else if (!isNaN(gcvArb) && !isNaN(gcvEq) && !isNaN(totalMoisture) && isNaN(eqMoisture)) {
        // Calculate EQ Moisture
        const calculatedEqMoisture = 100 - ((gcvEq / gcvArb) * (100 - totalMoisture));
        $("#calculated-parameter-ARB-Eq-result").text(`EQ Moisture: ${calculatedEqMoisture.toFixed(2)} %`);
    }
}
// Function to store parameter values in an array
function storeParameterValues() {
    const gcvArb = parseFloat(document.getElementById("gcv-arb").value);
    const gcvEq = parseFloat(document.getElementById("gcv-eq").value);
    const totalMoisture = parseFloat(document.getElementById("total-moisture").value);
    const eqMoisture = parseFloat(document.getElementById("eq-moisture").value);

    // Count how many are missing
    let missingCount = [
        isNaN(gcvArb),
        isNaN(gcvEq),
        isNaN(totalMoisture),
        isNaN(eqMoisture)
    ].filter(Boolean).length;

    if (missingCount > 1) {
        alert("Please enter any 3 inputs.");
        return;
    }

    let calculatedGcvArb = gcvArb;
    let calculatedGcvEq = gcvEq;
    let calculatedTotalMoisture = totalMoisture;
    let calculatedEqMoisture = eqMoisture;

    // Calculate the missing parameter
    if (isNaN(gcvArb) && !isNaN(gcvEq) && !isNaN(totalMoisture) && !isNaN(eqMoisture)) {
        calculatedGcvArb = (gcvEq * (100 - totalMoisture)) / (100 - eqMoisture);
    } else if (!isNaN(gcvArb) && isNaN(gcvEq) && !isNaN(totalMoisture) && !isNaN(eqMoisture)) {
        calculatedGcvEq = (gcvArb * (100 - eqMoisture)) / (100 - totalMoisture);
    } else if (!isNaN(gcvArb) && !isNaN(gcvEq) && isNaN(totalMoisture) && !isNaN(eqMoisture)) {
        calculatedTotalMoisture = 100 - ((gcvArb / gcvEq) * (100 - eqMoisture));
    } else if (!isNaN(gcvArb) && !isNaN(gcvEq) && !isNaN(totalMoisture) && isNaN(eqMoisture)) {
        calculatedEqMoisture = 100 - ((gcvEq / gcvArb) * (100 - totalMoisture));
    }

    const parameterValueObj = {
        "GCV ARB (kcal/kg)": isNaN(calculatedGcvArb) ? "" : calculatedGcvArb.toFixed(2),
        "GCV EQ (kcal/kg)": isNaN(calculatedGcvEq) ? "" : calculatedGcvEq.toFixed(2),
        "Total Moisture (%)": isNaN(calculatedTotalMoisture) ? "" : calculatedTotalMoisture.toFixed(2),
        "EQ Moisture (%)": isNaN(calculatedEqMoisture) ? "" : calculatedEqMoisture.toFixed(2)
    };

    parameterValues.push(parameterValueObj);
    updateRowCountBadge();
}

// Professional GCV Analysis Suite - JavaScript
// Global Variables
let currentCalculator = 'calc1';
let calculationHistory = {
    calc1: [],
    calc2: []
};

// Tab Switching
function switchCalculator(calc) {
    // Hide all calculator contents
    document.querySelectorAll('.calculator-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active from all tabs
    document.querySelectorAll('.calculator-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected calculator
    document.getElementById(calc).classList.add('active');
    
    // Set active tab
    event.target.closest('.calculator-tab').classList.add('active');
    
    currentCalculator = calc;
}

// Error Display Functions
function showError(calcNumber, message) {
    const errorDiv = document.getElementById(`error${calcNumber}`);
    const errorText = document.getElementById(`errorText${calcNumber}`);
    errorText.textContent = message;
    errorDiv.style.display = 'block';
}

function hideError(calcNumber) {
    document.getElementById(`error${calcNumber}`).style.display = 'none';
}

// Calculator 1: GCV/Ash/Moisture Calculator
function calculateFromInputs() {
    hideError(1);
    
    const gcv = parseFloat(document.getElementById('gcvInput').value) || null;
    const ash = parseFloat(document.getElementById('ashInput').value) || null;
    const moisture = parseFloat(document.getElementById('moistureInput').value) || null;
    
    // Count filled inputs
    const inputs = [gcv, ash, moisture];
    const filledCount = inputs.filter(v => v !== null && !isNaN(v)).length;
    
    if (filledCount < 2) {
        showError(1, "Please enter exactly 2 values to calculate the third.");
        document.getElementById('results1').style.display = 'none';
        return;
    }
    
    if (filledCount > 2) {
        showError(1, "Please enter only 2 values. Clear one input to calculate the third.");
        document.getElementById('results1').style.display = 'none';
        return;
    }
    
    // Validation
    if (ash !== null && (ash < 0 || ash > 100)) {
        showError(1, "Ash content must be between 0 and 100%");
        return;
    }
    
    if (moisture !== null && (moisture < 0 || moisture > 100)) {
        showError(1, "Moisture content must be between 0 and 100%");
        return;
    }
    
    if (gcv !== null && gcv < 0) {
        showError(1, "GCV cannot be negative");
        return;
    }
    
    let result = {};
    let calculatedValue = null;
    let calculatedParam = '';
    
    // Calculate missing parameter
    if (gcv === null && ash !== null && moisture !== null) {
        // Calculate GCV using modified Dulong formula
        calculatedValue = 8080 - (140 * ash) - (120 * moisture);
        calculatedParam = 'GCV';
        result = {
            gcv: calculatedValue,
            ash: ash,
            moisture: moisture,
            calculated: 'GCV'
        };
        document.getElementById('gcvInput').value = calculatedValue.toFixed(2);
    } else if (ash === null && gcv !== null && moisture !== null) {
        // Calculate Ash
        calculatedValue = (8080 - gcv - (120 * moisture)) / 140;
        calculatedParam = 'Ash';
        result = {
            gcv: gcv,
            ash: calculatedValue,
            moisture: moisture,
            calculated: 'Ash'
        };
        document.getElementById('ashInput').value = calculatedValue.toFixed(2);
    } else if (moisture === null && gcv !== null && ash !== null) {
        // Calculate Moisture
        calculatedValue = (8080 - gcv - (140 * ash)) / 120;
        calculatedParam = 'Moisture';
        result = {
            gcv: gcv,
            ash: ash,
            moisture: calculatedValue,
            calculated: 'Moisture'
        };
        document.getElementById('moistureInput').value = calculatedValue.toFixed(2);
    }
    
    // Check if calculated values are reasonable
    if (calculatedValue < 0) {
        showError(1, `Calculated ${calculatedParam} is negative (${calculatedValue.toFixed(2)}). Please check your input values.`);
        return;
    }
    
    if (calculatedParam === 'Ash' && calculatedValue > 100) {
        showError(1, `Calculated Ash content exceeds 100% (${calculatedValue.toFixed(2)}%). Please check your input values.`);
        return;
    }
    
    if (calculatedParam === 'Moisture' && calculatedValue > 100) {
        showError(1, `Calculated Moisture content exceeds 100% (${calculatedValue.toFixed(2)}%). Please check your input values.`);
        return;
    }
    
    displayResults1(result);
}

function displayResults1(result) {
    const resultDiv = document.getElementById('resultDisplay1');
    const resultsContainer = document.getElementById('results1');
    
    let statusClass = 'success';
    let statusIcon = 'fas fa-check-circle';
    let statusText = 'Calculation Complete';
    
    // Determine quality assessment
    if (result.gcv < 3000) {
        statusClass = 'danger';
        statusIcon = 'fas fa-exclamation-triangle';
        statusText = 'Low Quality Coal';
    } else if (result.gcv < 4500) {
        statusClass = 'warning';
        statusIcon = 'fas fa-exclamation-circle';
        statusText = 'Medium Quality Coal';
    }
    
    resultDiv.innerHTML = `
        <div class="result-badge ${statusClass}" style="font-size: 16px; margin-bottom: 15px;">
            <i class="${statusIcon} me-2"></i>${statusText}
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="result-badge ${result.calculated === 'GCV' ? 'success' : ''}">
                    <i class="fas fa-fire me-2"></i>
                    GCV: ${result.gcv.toFixed(2)} kcal/kg
                    ${result.calculated === 'GCV' ? ' <i class="fas fa-star ms-1" title="Calculated"></i>' : ''}
                </div>
            </div>
            <div class="col-md-4">
                <div class="result-badge ${result.calculated === 'Ash' ? 'success' : ''}">
                    <i class="fas fa-mountain me-2"></i>
                    Ash: ${result.ash.toFixed(2)}%
                    ${result.calculated === 'Ash' ? ' <i class="fas fa-star ms-1" title="Calculated"></i>' : ''}
                </div>
            </div>
            <div class="col-md-4">
                <div class="result-badge ${result.calculated === 'Moisture' ? 'success' : ''}">
                    <i class="fas fa-tint me-2"></i>
                    Moisture: ${result.moisture.toFixed(2)}%
                    ${result.calculated === 'Moisture' ? ' <i class="fas fa-star ms-1" title="Calculated"></i>' : ''}
                </div>
            </div>
        </div>
        <div class="mt-3">
            <small style="color: rgba(255, 255, 255, 0.7);">
                <i class="fas fa-info-circle me-1"></i>
                Formula used: Modified Dulong Formula (GCV = 8080 - 140×Ash% - 120×Moisture%)
            </small>
        </div>
    `;
    
    resultsContainer.style.display = 'block';
}

// Calculator 2: GCV Conversion Calculator
function calculateConversion() {
    hideError(2);
    
    const gcvArb = parseFloat(document.getElementById('gcvArbInput').value) || null;
    const gcvEq = parseFloat(document.getElementById('gcvEqInput').value) || null;
    const moistureArb = parseFloat(document.getElementById('moistureArbInput').value) || null;
    const moistureEq = parseFloat(document.getElementById('moistureEqInput').value) || null;
    
    // Count filled inputs
    const inputs = [gcvArb, gcvEq, moistureArb, moistureEq];
    const filledCount = inputs.filter(v => v !== null && !isNaN(v)).length;
    
    if (filledCount < 3) {
        showError(2, "Please enter exactly 3 values to calculate the fourth.");
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    if (filledCount > 3) {
        showError(2, "Please enter only 3 values. Clear one input to calculate the fourth.");
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    // Validation
    if (moistureArb !== null && (moistureArb < 0 || moistureArb > 100)) {
        showError(2, "Moisture ARB must be between 0 and 100%");
        return;
    }
    
    if (moistureEq !== null && (moistureEq < 0 || moistureEq > 100)) {
        showError(2, "Moisture Equilibrated must be between 0 and 100%");
        return;
    }
    
    if (gcvArb !== null && gcvArb < 0) {
        showError(2, "GCV ARB cannot be negative");
        return;
    }
    
    if (gcvEq !== null && gcvEq < 0) {
        showError(2, "GCV Equilibrated cannot be negative");
        return;
    }
    
    // Additional validation: Total Moisture should be >= Equilibrated Moisture
    if (moistureArb !== null && moistureEq !== null && moistureArb < moistureEq) {
        showError(2, "Moisture ARB cannot be less than Moisture Equilibrated");
        return;
    }
    
    let result = {};
    let calculatedValue = null;
    let calculatedParam = '';
    
    // Calculate missing parameter
    if (gcvArb === null && gcvEq !== null && moistureArb !== null && moistureEq !== null) {
        // Calculate GCV ARB
        calculatedValue = (gcvEq * (100 - moistureArb)) / (100 - moistureEq);
        calculatedParam = 'GCV ARB';
        result = {
            gcvArb: calculatedValue,
            gcvEq: gcvEq,
            moistureArb: moistureArb,
            moistureEq: moistureEq,
            calculated: 'GCV ARB'
        };
        document.getElementById('gcvArbInput').value = calculatedValue.toFixed(2);
    } else if (gcvEq === null && gcvArb !== null && moistureArb !== null && moistureEq !== null) {
        // Calculate GCV Equilibrated
        calculatedValue = (gcvArb * (100 - moistureEq)) / (100 - moistureArb);
        calculatedParam = 'GCV Equilibrated';
        result = {
            gcvArb: gcvArb,
            gcvEq: calculatedValue,
            moistureArb: moistureArb,
            moistureEq: moistureEq,
            calculated: 'GCV Equilibrated'
        };
        document.getElementById('gcvEqInput').value = calculatedValue.toFixed(2);
    } else if (moistureArb === null && gcvArb !== null && gcvEq !== null && moistureEq !== null) {
        // Calculate Moisture ARB
        calculatedValue = 100 - ((gcvArb / gcvEq) * (100 - moistureEq));
        calculatedParam = 'Moisture ARB';
        result = {
            gcvArb: gcvArb,
            gcvEq: gcvEq,
            moistureArb: calculatedValue,
            moistureEq: moistureEq,
            calculated: 'Moisture ARB'
        };
        document.getElementById('moistureArbInput').value = calculatedValue.toFixed(2);
    } else if (moistureEq === null && gcvArb !== null && gcvEq !== null && moistureArb !== null) {
        // Calculate Moisture Equilibrated
        calculatedValue = 100 - ((gcvEq / gcvArb) * (100 - moistureArb));
        calculatedParam = 'Moisture Equilibrated';
        result = {
            gcvArb: gcvArb,
            gcvEq: gcvEq,
            moistureArb: moistureArb,
            moistureEq: calculatedValue,
            calculated: 'Moisture Equilibrated'
        };
        document.getElementById('moistureEqInput').value = calculatedValue.toFixed(2);
    }
    
    // Check if calculated values are reasonable
    if (calculatedValue < 0) {
        showError(2, `Calculated ${calculatedParam} is negative (${calculatedValue.toFixed(2)}). Please check your input values.`);
        return;
    }
    
    if ((calculatedParam.includes('Moisture')) && calculatedValue > 100) {
        showError(2, `Calculated ${calculatedParam} exceeds 100% (${calculatedValue.toFixed(2)}%). Please check your input values.`);
        return;
    }
    
    displayResults2(result);
}

function displayResults2(result) {
    const resultDiv = document.getElementById('resultDisplay2');
    const resultsContainer = document.getElementById('results2');
    
    let statusClass = 'success';
    let statusIcon = 'fas fa-check-circle';
    let statusText = 'Conversion Complete';
    
    // Calculate conversion factor
    const conversionFactor = result.gcvArb / result.gcvEq;
    
    resultDiv.innerHTML = `
        <div class="result-badge ${statusClass}" style="font-size: 16px; margin-bottom: 15px;">
            <i class="${statusIcon} me-2"></i>${statusText}
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="result-badge ${result.calculated === 'GCV ARB' ? 'success' : ''}">
                    <i class="fas fa-fire me-2"></i>
                    GCV ARB: ${result.gcvArb.toFixed(2)} kcal/kg
                    ${result.calculated === 'GCV ARB' ? ' <i class="fas fa-star ms-1" title="Calculated"></i>' : ''}
                </div>
            </div>
            <div class="col-md-6">
                <div class="result-badge ${result.calculated === 'GCV Equilibrated' ? 'success' : ''}">
                    <i class="fas fa-balance-scale me-2"></i>
                    GCV Eq: ${result.gcvEq.toFixed(2)} kcal/kg
                    ${result.calculated === 'GCV Equilibrated' ? ' <i class="fas fa-star ms-1" title="Calculated"></i>' : ''}
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-6">
                <div class="result-badge ${result.calculated === 'Moisture ARB' ? 'success' : ''}">
                    <i class="fas fa-tint me-2"></i>
                    Moisture ARB: ${result.moistureArb.toFixed(2)}%
                    ${result.calculated === 'Moisture ARB' ? ' <i class="fas fa-star ms-1" title="Calculated"></i>' : ''}
                </div>
            </div>
            <div class="col-md-6">
                <div class="result-badge ${result.calculated === 'Moisture Equilibrated' ? 'success' : ''}">
                    <i class="fas fa-tint me-2"></i>
                    Moisture Eq: ${result.moistureEq.toFixed(2)}%
                    ${result.calculated === 'Moisture Equilibrated' ? ' <i class="fas fa-star ms-1" title="Calculated"></i>' : ''}
                </div>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12">
                <div class="result-badge" style="background: rgba(0, 123, 255, 0.8);">
                    <i class="fas fa-calculator me-2"></i>
                    Conversion Factor: ${conversionFactor.toFixed(4)}
                </div>
            </div>
        </div>
        <div class="mt-3">
            <small style="color: rgba(255, 255, 255, 0.7);">
                <i class="fas fa-info-circle me-1"></i>
                Formula: GCV(Eq) = GCV(ARB) × (100 - M(Eq)) / (100 - M(ARB))
            </small>
        </div>
    `;
    
    resultsContainer.style.display = 'block';
}

// Clear Functions
function clearCalculator1() {
    document.getElementById('gcvInput').value = '';
    document.getElementById('ashInput').value = '';
    document.getElementById('moistureInput').value = '';
    document.getElementById('results1').style.display = 'none';
    hideError(1);
}

function clearCalculator2() {
    document.getElementById('gcvArbInput').value = '';
    document.getElementById('gcvEqInput').value = '';
    document.getElementById('moistureArbInput').value = '';
    document.getElementById('moistureEqInput').value = '';
    document.getElementById('results2').style.display = 'none';
    hideError(2);
}

// Save Calculation Function
function saveCalculation(calcType) {
    let data = {};
    let isValid = false;
    
    if (calcType === 'calc1') {
        const gcv = parseFloat(document.getElementById('gcvInput').value);
        const ash = parseFloat(document.getElementById('ashInput').value);
        const moisture = parseFloat(document.getElementById('moistureInput').value);
        
        if (!isNaN(gcv) && !isNaN(ash) && !isNaN(moisture)) {
            data = {
                type: 'GCV/Ash/Moisture',
                gcv: gcv.toFixed(2),
                ash: ash.toFixed(2),
                moisture: moisture.toFixed(2),
                timestamp: new Date().toLocaleString()
            };
            isValid = true;
        }
    } else if (calcType === 'calc2') {
        const gcvArb = parseFloat(document.getElementById('gcvArbInput').value);
        const gcvEq = parseFloat(document.getElementById('gcvEqInput').value);
        const moistureArb = parseFloat(document.getElementById('moistureArbInput').value);
        const moistureEq = parseFloat(document.getElementById('moistureEqInput').value);
        
        if (!isNaN(gcvArb) && !isNaN(gcvEq) && !isNaN(moistureArb) && !isNaN(moistureEq)) {
            data = {
                type: 'GCV Conversion',
                gcvArb: gcvArb.toFixed(2),
                gcvEq: gcvEq.toFixed(2),
                moistureArb: moistureArb.toFixed(2),
                moistureEq: moistureEq.toFixed(2),
                conversionFactor: (gcvArb / gcvEq).toFixed(4),
                timestamp: new Date().toLocaleString()
            };
            isValid = true;
        }
    }
    
    if (isValid) {
        calculationHistory[calcType].push(data);
        updateStorageCounter();
        
        // Show success message
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-2"></i>Saved!';
        btn.style.background = 'rgba(40, 167, 69, 0.8)';
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = '';
        }, 2000);
        
        // Save to localStorage
        localStorage.setItem('gcvAnalysisSuite', JSON.stringify(calculationHistory));
    } else {
        alert('Please complete a calculation before saving.');
    }
}

// Storage Management
function updateStorageCounter() {
    const totalCount = calculationHistory.calc1.length + calculationHistory.calc2.length;
    const counter = document.getElementById('storageCounter');
    if (totalCount > 0) {
        counter.textContent = totalCount;
        counter.style.display = 'flex';
    } else {
        counter.style.display = 'none';
    }
}

function toggleStorageManager() {
    loadSavedCalculations();
    const modal = new bootstrap.Modal(document.getElementById('storageModal'));
    modal.show();
}

function loadSavedCalculations() {
    const saved = localStorage.getItem('gcvAnalysisSuite');
    if (saved) {
        calculationHistory = JSON.parse(saved);
        updateStorageCounter();
    }
    
    const listDiv = document.getElementById('savedCalculationsList');
    listDiv.innerHTML = '';
    
    if (calculationHistory.calc1.length === 0 && calculationHistory.calc2.length === 0) {
        listDiv.innerHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">No saved calculations found.</p>';
        return;
    }
    
    // Display GCV/Ash/Moisture calculations
    if (calculationHistory.calc1.length > 0) {
        listDiv.innerHTML += '<h6 style="color: #333; margin-bottom: 15px;">GCV/Ash/Moisture Calculations:</h6>';
        calculationHistory.calc1.forEach((calc, index) => {
            listDiv.innerHTML += `
                <div class="card mb-2" style="border: 1px solid rgba(0,0,0,0.1);">
                    <div class="card-body" style="padding: 10px;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <small style="color: #666;">${calc.timestamp}</small><br>
                                <strong>GCV:</strong> ${calc.gcv} kcal/kg | 
                                <strong>Ash:</strong> ${calc.ash}% | 
                                <strong>Moisture:</strong> ${calc.moisture}%
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeCalculation('calc1', ${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    // Display GCV Conversion calculations
    if (calculationHistory.calc2.length > 0) {
        listDiv.innerHTML += '<h6 style="color: #333; margin: 20px 0 15px 0;">GCV Conversion Calculations:</h6>';
        calculationHistory.calc2.forEach((calc, index) => {
            listDiv.innerHTML += `
                <div class="card mb-2" style="border: 1px solid rgba(0,0,0,0.1);">
                    <div class="card-body" style="padding: 10px;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <small style="color: #666;">${calc.timestamp}</small><br>
                                <strong>GCV ARB:</strong> ${calc.gcvArb} | <strong>GCV Eq:</strong> ${calc.gcvEq}<br>
                                <strong>M ARB:</strong> ${calc.moistureArb}% | <strong>M Eq:</strong> ${calc.moistureEq}%<br>
                                <strong>Factor:</strong> ${calc.conversionFactor}
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeCalculation('calc2', ${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
    }
}

function removeCalculation(calcType, index) {
    calculationHistory[calcType].splice(index, 1);
    localStorage.setItem('gcvAnalysisSuite', JSON.stringify(calculationHistory));
    updateStorageCounter();
    loadSavedCalculations();
}

function clearAllSavedData() {
    if (confirm('Are you sure you want to clear all saved calculations?')) {
        calculationHistory = { calc1: [], calc2: [] };
        localStorage.removeItem('gcvAnalysisSuite');
        updateStorageCounter();
        loadSavedCalculations();
    }
}

// Formula Sidebar
function toggleFormulaSidebar() {
    const sidebar = document.getElementById('formulaSidebar');
    sidebar.classList.toggle('active');
}

// Click outside to close sidebar
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('formulaSidebar');
    const formulaBtn = event.target.closest('[onclick="toggleFormulaSidebar()"]');
    
    if (!sidebar.contains(event.target) && !formulaBtn && sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
    }
});

// Export Functions
async function exportToPDF() {
    const { jsPDF } = window.jspdf;
    
    try {
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 20;
        
        // Header
        pdf.setFontSize(20);
        pdf.setTextColor(41, 128, 185);
        pdf.text('GCV Analysis Suite - Professional Report', margin, 30);
        
        pdf.setFontSize(12);
        pdf.setTextColor(100, 100, 100);
        pdf.text(`Generated: ${new Date().toLocaleString()}`, margin, 40);
        
        let yPos = 60;
        
        // Current Calculator Results
        if (currentCalculator === 'calc1') {
            const results1 = document.getElementById('results1');
            if (results1.style.display !== 'none') {
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.text('GCV/Ash/Moisture Calculator Results:', margin, yPos);
                yPos += 10;
                
                const gcv = document.getElementById('gcvInput').value;
                const ash = document.getElementById('ashInput').value;
                const moisture = document.getElementById('moistureInput').value;
                
                pdf.setFontSize(11);
                pdf.text(`GCV (ADB): ${gcv} kcal/kg`, margin + 5, yPos);
                pdf.text(`Ash Content: ${ash}%`, margin + 5, yPos + 8);
                pdf.text(`Moisture Content: ${moisture}%`, margin + 5, yPos + 16);
                
                yPos += 35;
            }
        } else {
            const results2 = document.getElementById('results2');
            if (results2.style.display !== 'none') {
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                pdf.text('GCV Conversion Calculator Results:', margin, yPos);
                yPos += 10;
                
                const gcvArb = document.getElementById('gcvArbInput').value;
                const gcvEq = document.getElementById('gcvEqInput').value;
                const moistureArb = document.getElementById('moistureArbInput').value;
                const moistureEq = document.getElementById('moistureEqInput').value;
                
                pdf.setFontSize(11);
                pdf.text(`GCV ARB: ${gcvArb} kcal/kg`, margin + 5, yPos);
                pdf.text(`GCV Equilibrated: ${gcvEq} kcal/kg`, margin + 5, yPos + 8);
                pdf.text(`Moisture ARB: ${moistureArb}%`, margin + 5, yPos + 16);
                pdf.text(`Moisture Equilibrated: ${moistureEq}%`, margin + 5, yPos + 24);
                
                yPos += 40;
            }
        }
        
        // Add calculation history if available
        const totalSaved = calculationHistory.calc1.length + calculationHistory.calc2.length;
        if (totalSaved > 0 && yPos < 200) {
            pdf.setFontSize(14);
            pdf.setTextColor(0, 0, 0);
            pdf.text('Saved Calculations History:', margin, yPos);
            yPos += 15;
            
            // Add table for saved calculations
            const tableData = [];
            
            calculationHistory.calc1.forEach(calc => {
                tableData.push([
                    calc.type,
                    `${calc.gcv} kcal/kg`,
                    `${calc.ash}%`,
                    `${calc.moisture}%`,
                    calc.timestamp
                ]);
            });
            
            calculationHistory.calc2.forEach(calc => {
                tableData.push([
                    calc.type,
                    `ARB: ${calc.gcvArb}\nEq: ${calc.gcvEq}`,
                    `ARB: ${calc.moistureArb}%\nEq: ${calc.moistureEq}%`,
                    `Factor: ${calc.conversionFactor}`,
                    calc.timestamp
                ]);
            });
            
            if (tableData.length > 0) {
                pdf.autoTable({
                    startY: yPos,
                    head: [['Type', 'GCV', 'Parameter 1', 'Parameter 2', 'Timestamp']],
                    body: tableData,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [41, 128, 185] },
                    margin: { left: margin, right: margin }
                });
            }
        }
        
        // Footer
        const totalPages = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            pdf.setPage(i);
            pdf.setFontSize(8);
            pdf.setTextColor(150, 150, 150);
            pdf.text(`Page ${i} of ${totalPages}`, pageWidth - margin - 20, pageHeight - 10);
            pdf.text('Professional GCV Analysis Suite', margin, pageHeight - 10);
        }
        
        pdf.save(`GCV_Analysis_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        
        // Show success feedback
        const btn = event.target.closest('.floating-btn');
        const originalBg = btn.style.background;
        btn.style.background = 'rgba(40, 167, 69, 0.8)';
        btn.innerHTML = '<i class="fas fa-check"></i>';
        
        setTimeout(() => {
            btn.style.background = originalBg;
            btn.innerHTML = '<i class="fas fa-file-pdf"></i>';
        }, 2000);
        
    } catch (error) {
        console.error('PDF export error:', error);
        alert('Error generating PDF. Please try again.');
    }
}

async function exportToJPG() {
    try {
        const container = document.querySelector('.calculator-container');
        
        const canvas = await html2canvas(container, {
            backgroundColor: null,
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        const link = document.createElement('a');
        link.download = `GCV_Analysis_${new Date().toISOString().split('T')[0]}.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
        
        // Show success feedback
        const btn = event.target.closest('.floating-btn');
        const originalBg = btn.style.background;
        btn.style.background = 'rgba(40, 167, 69, 0.8)';
        btn.innerHTML = '<i class="fas fa-check"></i>';
        
        setTimeout(() => {
            btn.style.background = originalBg;
            btn.innerHTML = '<i class="fas fa-image"></i>';
        }, 2000);
        
    } catch (error) {
        console.error('JPG export error:', error);
        alert('Error generating image. Please try again.');
    }
}

// Initialize Application
document.addEventListener('DOMContentLoaded', function() {
    // Load saved data
    const saved = localStorage.getItem('gcvAnalysisSuite');
    if (saved) {
        calculationHistory = JSON.parse(saved);
        updateStorageCounter();
    }
    
    // Add input validation
    const numericInputs = document.querySelectorAll('input[type="number"]');
    numericInputs.forEach(input => {
        input.addEventListener('keydown', function(e) {
            // Allow: backspace, delete, tab, escape, enter
            if ([46, 8, 9, 27, 13].indexOf(e.keyCode) !== -1 ||
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) ||
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true) ||
                // Allow: home, end, left, right
                (e.keyCode >= 35 && e.keyCode <= 39)) {
                return;
            }
            // Ensure that it is a number and stop the keypress
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });
        
        input.addEventListener('paste', function(e) {
            setTimeout(() => {
                const value = parseFloat(this.value);
                if (isNaN(value) || value < 0) {
                    this.value = '';
                }
            }, 1);
        });
    });
    
    console.log('Professional GCV Analysis Suite initialized successfully!');
});

    </script>
</body>
</html>
