<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional GCV Analysis Suite</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        /* Glassmorphism Container */
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin: 20px auto;
            max-width: 1200px;
        }

        .page-title {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: default;
        }

        .page-title:hover {
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.1);
            transform: scale(1.02);
        }

        .page-title i {
            display: inline-block;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Back Button */
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            font-weight: 500;
            z-index: 1000; /* High z-index to appear above other elements */
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        /* Calculator Tabs */
        .calculator-tabs {
            display: flex;
            margin-bottom: 30px;
            gap: 10px;
            justify-content: center;
        }

        .calculator-tab {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .calculator-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .calculator-tab:hover::before {
            left: 100%;
        }

        .calculator-tab.active {
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid transparent;
            background-image: linear-gradient(rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.2)), 
                              linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
            background-origin: border-box;
            background-clip: padding-box, border-box;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .calculator-tab:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
        }

        /* Calculator Content */
        .calculator-content {
            display: none;
        }

        .calculator-content.active {
            display: block;
        }

        /* Calculated Result Badge Styles */
        .result-badge {
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            color: white;
            min-width: 300px;
        }
        
        .result-badge.success {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.3), rgba(25, 135, 84, 0.2));
            border-color: rgba(40, 167, 69, 0.4);
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .result-badge.success:hover {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.4), rgba(25, 135, 84, 0.3));
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(40, 167, 69, 0.2);
        }

        /* Section Styling */
        .section-title {
            color: white;
            font-size: 1.4rem;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.2);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(220, 53, 69, 0.3);
            display: none;
        }

        /* Input Styling */
        .input-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .input-row {
            margin-bottom: 20px;
        }

        .input-label {
            color: white;
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            padding: 12px 15px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .form-control:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
            color: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #28a745, #20c997);
            border-color: #28a745;
        }

        .action-btn.clear {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border-color: #df6975;
            color: white;
        }

        .action-btn.save {
            background: linear-gradient(135deg, #28a745, #20c997);
            border-color: #52bc6b;
            color: white;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .action-btn.primary:hover {
            background: linear-gradient(135deg, #218838, #1ea775);
        }

        .action-btn.clear:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .action-btn.save:hover {
            background: linear-gradient(135deg, #218838, #1ea775);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        /* Results Section */
        .results-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .results-container.success {
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .result-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .floating-btn {
            position: fixed;
            right: 30px;
            bottom: 120px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .floating-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .floating-btn:nth-child(1) { bottom: 220px; }
        .floating-btn:nth-child(2) { bottom: 150px; }
        .floating-btn:nth-child(3) { bottom: 80px; }

        .storage-counter {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .export-dropdown {
            position: fixed;
            right: 85px;
            bottom: 80px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transform: scale(0);
            opacity: 0;
            transform-origin: bottom right;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            min-width: 150px;
        }

        .export-dropdown.active {
            transform: scale(1);
            opacity: 1;
        }

        .export-btn {
            display: block;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: left;
        }

        .export-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            transform: translateY(-2px);
        }

        .export-btn:last-child {
            margin-bottom: 0;
        }

        .formula-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1050;
        }

        .formula-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .formula-card-header h5 {
            margin: 0;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
        }

        .close-btn {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(220, 53, 69, 0.4);
        }

        .formula-card-body {
            padding: 20px;
        }

        .formula-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .formula-section h6 {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .formula-section ol {
            margin: 0;
            color: rgba(255, 255, 255, 0.8);
        }

        .formula-section li {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.5;
        }

        .analysis-table-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
            margin: 30px auto;
            max-width: 1200px;
        }

        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
        }

        .analysis-table th,
        .analysis-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }

        .analysis-table th {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }

        .analysis-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Animation Keyframes */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Animation Classes */
        .animate-fadeInUp {
            animation: fadeInUp 0.8s ease-out forwards;
        }

        .animate-fadeInDown {
            animation: fadeInDown 0.8s ease-out forwards;
        }

        .animate-fadeInLeft {
            animation: fadeInLeft 0.8s ease-out forwards;
        }

        .animate-fadeInRight {
            animation: fadeInRight 0.8s ease-out forwards;
        }

        .animate-scaleIn {
            animation: scaleIn 0.8s ease-out forwards;
        }

        .animate-bounceIn {
            animation: bounceIn 1s ease-out forwards;
        }

        /* Initial hidden state for animated elements */
        .animate-on-load {
            opacity: 0;
        }

        /* Staggered animation delays */
        .animate-delay-1 {
            animation-delay: 0.1s;
        }

        .animate-delay-2 {
            animation-delay: 0.2s;
        }

        .animate-delay-3 {
            animation-delay: 0.3s;
        }

        .animate-delay-4 {
            animation-delay: 0.4s;
        }

        .animate-delay-5 {
            animation-delay: 0.5s;
        }

        .animate-delay-6 {
            animation-delay: 0.6s;
        }

        /* Night Mode Toggle Switch */
        .night-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 50px;
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .night-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .toggle-switch.active::before {
            transform: translateX(26px);
        }

        .toggle-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 500;
        }

        .toggle-icon {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        /* Night Mode Styles */
        body.night-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        body.night-mode .glass-container {
            background: rgba(30, 30, 60, 0.3);
            border: 1px solid rgba(100, 100, 150, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        body.night-mode .page-title {
            color: #e8e8f0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
        }

        body.night-mode .calculator-tab {
            background: rgba(40, 40, 80, 0.4);
            border: 1px solid rgba(100, 100, 150, 0.3);
            color: #d0d0d8;
        }

        body.night-mode .calculator-tab.active {
            background: linear-gradient(135deg, rgba(30, 120, 180, 0.4), rgba(40, 80, 160, 0.3));
            color: #ffffff;
        }

        body.night-mode .input-section {
            background: rgba(25, 25, 50, 0.4);
        }

        body.night-mode .form-control {
            background: rgba(40, 40, 80, 0.3);
            border: 1px solid rgba(80, 80, 120, 0.4);
            color: #e0e0e8;
        }

        body.night-mode .form-control:focus {
            background: rgba(50, 50, 90, 0.4);
            border-color: rgba(100, 150, 200, 0.6);
            box-shadow: 0 0 15px rgba(100, 150, 200, 0.2);
        }

        body.night-mode .form-control::placeholder {
            color: rgba(180, 180, 200, 0.6);
        }

        body.night-mode .input-label {
            color: #d0d0d8;
        }

        body.night-mode .section-title {
            color: #e0e0e8;
        }

        body.night-mode .results-container {
            background: rgba(25, 25, 50, 0.4);
        }

        body.night-mode .result-item {
            background: rgba(40, 40, 80, 0.3);
            color: #e0e0e8;
        }

        body.night-mode .result-badge {
            background: linear-gradient(135deg, rgba(60, 60, 100, 0.4), rgba(40, 40, 80, 0.3));
            color: #ffffff;
        }

        body.night-mode .action-btn {
            background: rgba(50, 50, 90, 0.3);
            color: #e0e0e8;
            border: 1px solid rgba(80, 80, 120, 0.4);
        }

        body.night-mode .action-btn:hover {
            background: rgba(60, 60, 110, 0.4);
        }

        body.night-mode .floating-btn {
            background: rgba(40, 40, 80, 0.4);
            color: #e0e0e8;
        }

        body.night-mode .export-dropdown {
            background: rgba(30, 30, 60, 0.5);
            border: 1px solid rgba(80, 80, 120, 0.4);
        }

        body.night-mode .export-btn {
            background: rgba(50, 50, 90, 0.3);
            border: 1px solid rgba(80, 80, 120, 0.3);
            color: #d0d0d8;
        }

        body.night-mode .export-btn:hover {
            background: rgba(60, 60, 110, 0.4);
            color: #ffffff;
        }

        body.night-mode .formula-card {
            background: rgba(30, 30, 60, 0.4);
            border: 1px solid rgba(80, 80, 120, 0.4);
        }

        body.night-mode .formula-card-header h5 {
            color: #e0e0e8;
        }

        body.night-mode .formula-section {
            background: rgba(40, 40, 80, 0.3);
            border: 1px solid rgba(80, 80, 120, 0.3);
        }

        body.night-mode .formula-section h6 {
            color: #d0d0d8;
        }

        body.night-mode .formula-section li {
            color: #c0c0c8;
        }

        body.night-mode .analysis-table-container {
            background: rgba(30, 30, 60, 0.4);
            border: 1px solid rgba(80, 80, 120, 0.4);
        }

        body.night-mode .analysis-table {
            background: rgba(40, 40, 80, 0.3);
        }

        body.night-mode .analysis-table th,
        body.night-mode .analysis-table td {
            color: #e0e0e8;
            border-bottom: 1px solid rgba(80, 80, 120, 0.4);
        }

        body.night-mode .analysis-table th {
            background: rgba(50, 50, 90, 0.4);
        }

        body.night-mode .analysis-table tbody tr:hover {
            background: rgba(60, 60, 110, 0.3);
        }

        body.night-mode .back-button {
            background: rgba(40, 40, 80, 0.4);
            color: #e0e0e8;
        }

        body.night-mode .back-button:hover {
            background: rgba(60, 60, 110, 0.5);
        }

        body.night-mode .night-mode-toggle {
            background: rgba(40, 40, 80, 0.4);
            border: 1px solid rgba(80, 80, 120, 0.4);
        }

        body.night-mode .night-mode-toggle:hover {
            background: rgba(50, 50, 90, 0.5);
        }

        @media (max-width: 768px) {
            * {
                box-sizing: border-box;
            }
            
            body {
                padding: 0;
                margin: 0;
                overflow-x: hidden;
                width: 100vw;
            }
            
            .container-fluid {
                padding: 0;
                margin: 0;
                width: 100%;
                max-width: 100vw;
                overflow-x: hidden;
            }
            
            .glass-container {
                margin: 10px;
                padding: 15px;
                border-radius: 15px;
                width: calc(100vw - 20px);
                max-width: none;
                box-sizing: border-box;
                overflow-x: hidden;
            }
            
            .page-title {
                font-size: 1.8rem;
                margin-bottom: 20px;
                text-align: center;
                padding: 0 10px;
            }
            
            .calculator-tabs {
                flex-direction: column;
                gap: 8px;
                margin-bottom: 20px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .calculator-tab {
                padding: 12px 20px;
                font-size: 14px;
                text-align: center;
                border-radius: 10px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                word-wrap: break-word;
            }
            
            .calculator-content {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
            }
            
            .back-button {
                top: 15px;
                left: 15px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .input-section {
                padding: 20px 15px;
                border-radius: 12px;
                margin-bottom: 15px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
            }
            
            .section-title {
                font-size: 1.2rem;
                margin-bottom: 15px;
                word-wrap: break-word;
            }
            
            .input-row {
                margin-bottom: 15px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .input-group {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .input-label {
                font-size: 14px;
                margin-bottom: 6px;
                word-wrap: break-word;
            }
            
            .form-control {
                padding: 12px;
                font-size: 16px;
                border-radius: 8px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                margin: 0;
                overflow: hidden;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .action-btn {
                width: 100%;
                padding: 14px 20px;
                font-size: 16px;
                border-radius: 8px;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .results-container {
                padding: 20px 15px;
                border-radius: 12px;
                margin-top: 15px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
            }
            
            .result-badge {
                min-width: auto;
                width: 100%;
                font-size: 14px;
                padding: 10px 15px;
                border-radius: 10px;
                box-sizing: border-box;
            }
            
            .floating-btn {
                width: 50px;
                height: 50px;
                right: 20px;
                font-size: 1rem;
            }
            
            .floating-btn:nth-child(1) { bottom: 190px; }
            .floating-btn:nth-child(2) { bottom: 125px; }
            .floating-btn:nth-child(3) { bottom: 60px; }
            
            .export-dropdown {
                right: 75px;
                bottom: 60px;
                min-width: 130px;
                padding: 12px;
            }
            
            .export-btn {
                padding: 10px 12px;
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .formula-card {
                width: 95vw;
                max-width: none;
                margin: 0;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                max-height: 85vh;
                border-radius: 15px;
            }
            
            .formula-card-header {
                padding: 15px;
            }
            
            .formula-card-header h5 {
                font-size: 1.1rem;
            }
            
            .formula-card-body {
                padding: 15px;
            }
            
            .formula-section {
                margin-bottom: 20px;
                padding: 12px;
                border-radius: 10px;
            }
            
            .formula-section h6 {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            
            .formula-section li {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .analysis-table-container {
                width: 95vw;
                max-width: none;
                padding: 15px;
                margin: 0;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                max-height: 80vh;
                border-radius: 15px;
            }
            
            .analysis-table {
                font-size: 12px;
                width: 100%;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .analysis-table thead,
            .analysis-table tbody,
            .analysis-table th,
            .analysis-table td,
            .analysis-table tr {
                display: block;
            }
            
            .analysis-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .analysis-table tr {
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 10px;
                margin-bottom: 10px;
                padding: 10px;
                background: rgba(255, 255, 255, 0.05);
            }
            
            .analysis-table td {
                border: none;
                padding: 5px 0;
                text-align: left;
                position: relative;
                padding-left: 40%;
            }
            
            .analysis-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 35%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: rgba(255, 255, 255, 0.8);
            }
            
            .error-message {
                font-size: 14px;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 15px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow-wrap: break-word;
                word-wrap: break-word;
            }
            
            .night-mode-toggle {
                position: fixed;
                top: 10px;
                right: 5px;
                padding: 4px 6px;
                border-radius: 20px;
                transform: scale(0.75);
                z-index: 1001;
                max-width: calc(100vw - 15px);
                box-sizing: border-box;
            }
            
            .toggle-switch {
                width: 30px;
                height: 16px;
            }
            
            .toggle-switch::before {
                width: 12px;
                height: 12px;
                top: 2px;
                left: 2px;
            }
            
            .toggle-switch.active::before {
                transform: translateX(14px);
            }
            
            .toggle-label {
                font-size: 10px;
                display: none;
            }
            
            .toggle-icon {
                font-size: 11px;
            }
            
            .page-title {
                margin-top: 50px !important;
                font-size: 1.8rem !important;
                padding-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Night Mode Toggle -->
    <div class="night-mode-toggle animate-on-load animate-fadeInRight">
        <i class="fas fa-sun toggle-icon" id="dayIcon"></i>
        <div class="toggle-switch" id="nightModeSwitch" onclick="toggleNightMode()"></div>
        <i class="fas fa-moon toggle-icon" id="nightIcon"></i>
        <span class="toggle-label" id="toggleLabel">Day Mode</span>
    </div>

    <button class="back-button animate-on-load animate-fadeInLeft" onclick="goBack()" title="Back to Dashboard">
        <i class="fas fa-arrow-left"></i>
    </button>

    <div class="container-fluid">
        <div class="glass-container animate-on-load animate-scaleIn animate-delay-1">
            <h1 class="page-title animate-on-load animate-fadeInDown animate-delay-2">
                <i class="fas fa-flask me-3"></i>
                GCV Analysis Suite
            </h1>

            <!-- Calculator Tabs -->
            <div class="calculator-tabs animate-on-load animate-fadeInUp animate-delay-3">
                <div class="calculator-tab active" onclick="switchCalculator('calc1')">
                    <i class="fas fa-calculator me-2"></i>GCV/Ash/Moisture Calculator
                </div>
                <div class="calculator-tab" onclick="switchCalculator('calc2')">
                    <i class="fas fa-exchange-alt me-2"></i>GCV Conversion Calculator
                </div>
            </div>

            <!-- Calculator 1: GCV/Ash/Moisture Calculator -->
            <div id="calc1" class="calculator-content active animate-on-load animate-fadeInUp animate-delay-4">
                <div class="error-message" id="error1">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorText1"></span>
                </div>

                <!-- Calculated Result Display for Calculator 1 -->
                <div class="results-container" id="calcResult1" style="display: none; margin-bottom: 20px;">
                    <h5 class="section-title" style="font-size: 1.1rem; margin-bottom: 15px;">
                        <i class="fas fa-calculator me-2"></i>Calculated Parameter
                    </h5>
                    <div id="calcResultDisplay1"></div>
                </div>

                <div class="input-section animate-on-load animate-fadeInUp animate-delay-5">
                    <h3 class="section-title">
                        <i class="fas fa-edit me-2"></i>Input Parameters
                    </h3>
                    
                    <div class="input-row">
                        <label class="input-label">GCV [kcal/kg]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="gcvInput" 
                                   placeholder="Enter GCV value" step="0.01" 
                                   oninput="debouncedCalculateFromInputs()">
                        </div>
                    </div>

                    <div class="input-row">
                        <label class="input-label">Ash Content [%]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="ashInput" 
                                   placeholder="Enter ash content" step="0.01" min="0" max="100"
                                   oninput="debouncedCalculateFromInputs()">
                        </div>
                    </div>

                    <div class="input-row">
                        <label class="input-label">Moisture Content [%]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="moistureInput" 
                                   placeholder="Enter moisture content" step="0.01" min="0" max="100"
                                   oninput="debouncedCalculateFromInputs()">
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn clear" onclick="clearCalculator1()">
                            <i class="fas fa-eraser me-2"></i>Clear
                        </button>
                        <button class="action-btn save" onclick="saveCalculation('calc1')">
                            <i class="fas fa-save me-2"></i>Save Result
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calculator 2: GCV Conversion Calculator -->
            <div id="calc2" class="calculator-content animate-on-load animate-fadeInUp animate-delay-4">
                <div class="error-message" id="error2">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorText2"></span>
                </div>

                <!-- Calculated Result Display for Calculator 2 -->
                <div class="results-container" id="calcResult2" style="display: none; margin-bottom: 20px;">
                    <h5 class="section-title" style="font-size: 1.1rem; margin-bottom: 15px;">
                        <i class="fas fa-calculator me-2"></i>Calculated Parameter
                    </h5>
                    <div id="calcResultDisplay2"></div>
                </div>

                <div class="input-section">
                    <h3 class="section-title">
                        <i class="fas fa-edit me-2"></i>Input Parameters
                    </h3>
                
                    <div class="input-row">
                        <label class="input-label">GCV Equilibrated [kcal/kg]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="gcvEqInput" 
                                   placeholder="Enter GCV Equilibrated value" step="0.01" 
                                   oninput="debouncedCalculateConversion()">
                        </div>
                    </div>

                    <div class="input-row">
                        <label class="input-label">Total Moisture [%]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="moistureArbInput" 
                                   placeholder="Enter Total Moisture" step="0.01" min="0" max="100"
                                   oninput="debouncedCalculateConversion()">
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <label class="input-label">Inherent Moisture [%]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="moistureEqInput" 
                                   placeholder="Enter Inherent Moisture" step="0.01" min="0" max="100"
                                   oninput="debouncedCalculateConversion()">
                        </div>
                    </div>                    
                        
                    <div class="input-row">
                        <label class="input-label">GCV ARB [kcal/kg]:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="gcvArbInput" 
                                   placeholder="Enter GCV ARB value" step="0.01" 
                                   oninput="debouncedCalculateConversion()">
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="action-btn clear" onclick="clearCalculator2()">
                            <i class="fas fa-eraser me-2"></i>Clear
                        </button>
                        <button class="action-btn save" onclick="saveCalculation('calc2')">
                            <i class="fas fa-save me-2"></i>Save Result
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-buttons">
        <button class="floating-btn animate-on-load animate-bounceIn animate-delay-6" onclick="toggleFormulaCard()" title="View Formulas">
            f<sub>x</sub>
        </button>
        <button class="floating-btn animate-on-load animate-bounceIn animate-delay-5" onclick="viewStoredCalculations()" title="View Analysis Results">
            <i class="fas fa-database"></i>
            <span class="storage-counter" id="storageCounter">0</span>
        </button>
        <button class="floating-btn animate-on-load animate-bounceIn animate-delay-4" onclick="toggleExportOptions()" title="Export Options">
            <i class="fas fa-download"></i>
        </button>
    </div>

    <!-- Export Dropdown -->
    <div class="export-dropdown" id="exportDropdown">
        <button class="export-btn" onclick="exportToPDF()">
            <i class="fas fa-file-pdf text-danger"></i>
            Export as PDF
        </button>
        <button class="export-btn" onclick="exportToJPG()">
            <i class="fas fa-image text-primary"></i>
            Export as JPG
        </button>
    </div>

    <!-- Formula Card -->
    <div class="formula-card" id="formulaCard" style="display: none;">
        <div class="formula-card-header">
            <h5><i class="fas fa-calculator me-2"></i>Coal Analysis Formulas</h5>
            <button class="close-btn" onclick="toggleFormulaCard()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="formula-card-body">
            <div class="formula-section">
                <h6><i class="fas fa-fire me-2"></i>GCV/Ash/Moisture Calculator</h6>
                <ol>
                    <li><strong>GCV:</strong> [{154 × (100 - (Moisture + (1.1 × Ash)))} - {108 × Moisture}] / 1.8</li>
                    <li><strong>Ash:</strong> [{100 - (((GCV × 1.8) + (108 × Moisture)) / 154)} - Moisture] / 1.1</li>
                    <li><strong>Moisture:</strong> [15400 - {169.4 × Ash} - {1.8 × GCV}] / 262</li>
                </ol>
            </div>
            <div class="formula-section">
                <h6><i class="fas fa-exchange-alt me-2"></i>GCV Conversion Calculator</h6>
                <ol>
                    <li><strong>GCV ARB:</strong> [GCV Eq × {100 - TM}] / [100 - IM]</li>
                    <li><strong>GCV Eq:</strong> [GCV ARB × {100 - IM}] / [100 - TM]</li>
                    <li><strong>Total Moisture (TM):</strong> 100 - [{GCV ARB / GCV Eq} × {100 - IM}]</li>
                    <li><strong>Inherent Moisture (IM):</strong> 100 - [{GCV Eq / GCV ARB} × {100 - TM}]</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
// Professional GCV Analysis Suite - JavaScript
// Back Button Functionality
function goBack() {
    // Try to go back to parent window if opened from main app
    if (window.opener && !window.opener.closed) {
        try {
            // If opened from main app, switch focus back and close this tab
            window.opener.focus();
            // Call function to show calculators page in parent window
            if (typeof window.opener.showCalculatorsPage === 'function') {
                window.opener.showCalculatorsPage();
            }
            window.close();
        } catch (e) {
            // If cross-origin or other security issues, fallback to alert
            alert('Please use the browser back button or close this tab to return to the main application.');
        }
    } else {
        // If no parent window, try to navigate to main app
        try {
            window.location.href = 'index.html#calculators';
        } catch (e) {
            alert('Please use the browser back button to return to the main application.');
        }
    }
}

// Global Variables
let currentCalculator = 'calc1';
let calculationHistory = {
    calc1: [],
    calc2: []
};

// Night Mode Variables
let isNightMode = false;

// Night Mode Functions
function toggleNightMode() {
    isNightMode = !isNightMode;
    const body = document.body;
    const toggleSwitch = document.getElementById('nightModeSwitch');
    const toggleLabel = document.getElementById('toggleLabel');
    const dayIcon = document.getElementById('dayIcon');
    const nightIcon = document.getElementById('nightIcon');
    
    if (isNightMode) {
        body.classList.add('night-mode');
        toggleSwitch.classList.add('active');
        toggleLabel.textContent = 'Night Mode';
        dayIcon.style.opacity = '0.5';
        nightIcon.style.opacity = '1';
        // Save preference to localStorage
        localStorage.setItem('nightMode', 'true');
    } else {
        body.classList.remove('night-mode');
        toggleSwitch.classList.remove('active');
        toggleLabel.textContent = 'Day Mode';
        dayIcon.style.opacity = '1';
        nightIcon.style.opacity = '0.5';
        // Save preference to localStorage
        localStorage.setItem('nightMode', 'false');
    }
}

// Load night mode preference on page load
function loadNightModePreference() {
    const savedMode = localStorage.getItem('nightMode');
    if (savedMode === 'true') {
        // Set night mode without animation on page load
        isNightMode = false; // Set to false first so toggle will work
        toggleNightMode();
    } else {
        // Ensure day mode icons are properly set
        const dayIcon = document.getElementById('dayIcon');
        const nightIcon = document.getElementById('nightIcon');
        if (dayIcon && nightIcon) {
            dayIcon.style.opacity = '1';
            nightIcon.style.opacity = '0.5';
        }
    }
}

// Debounced input handlers to prevent cursor jumping
let inputTimeout1, inputTimeout2;

function debouncedCalculateFromInputs() {
    clearTimeout(inputTimeout1);
    inputTimeout1 = setTimeout(() => {
        calculateFromInputs();
    }, 300); // 300ms delay to allow for complete decimal input
}

function debouncedCalculateConversion() {
    clearTimeout(inputTimeout2);
    inputTimeout2 = setTimeout(() => {
        calculateConversion();
    }, 300); // 300ms delay to allow for complete decimal input
}

// Input event handler that preserves cursor position
function handleNumberInput(inputElement, calculationFunction) {
    const cursorPosition = inputElement.selectionStart;
    const value = inputElement.value;
    
    // Store cursor position
    setTimeout(() => {
        inputElement.setSelectionRange(cursorPosition, cursorPosition);
    }, 0);
    
    // Call the appropriate calculation function with debouncing
    calculationFunction();
}

// Tab Switching
function switchCalculator(calc) {
    // Hide all calculator contents
    document.querySelectorAll('.calculator-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Remove active from all tabs
    document.querySelectorAll('.calculator-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected calculator
    const targetCalc = document.getElementById(calc);
    if (targetCalc) {
        targetCalc.classList.add('active');
    }
    
    // Set active tab
    if (event && event.target) {
        event.target.closest('.calculator-tab').classList.add('active');
    }
    
    currentCalculator = calc;
}

// Error Display Functions
function showError(calcNumber, message) {
    const errorDiv = document.getElementById(`error${calcNumber}`);
    const errorText = document.getElementById(`errorText${calcNumber}`);
    errorText.textContent = message;
    errorDiv.style.display = 'block';
}

function hideError(calcNumber) {
    document.getElementById(`error${calcNumber}`).style.display = 'none';
}

// Calculator 1: GCV/Ash/Moisture Calculator
function calculateFromInputs() {
    hideError(1);
    
    const gcv = parseFloat(document.getElementById('gcvInput').value) || null;
    const ash = parseFloat(document.getElementById('ashInput').value) || null;
    const moisture = parseFloat(document.getElementById('moistureInput').value) || null;
    
    // Count filled inputs
    const inputs = [gcv, ash, moisture];
    const filledCount = inputs.filter(v => v !== null && !isNaN(v)).length;
    
    if (filledCount === 0) {
        document.getElementById('calcResult1').style.display = 'none';
        return;
    }
    
    if (filledCount === 1) {
        showError(1, "Please enter at least 2 values to calculate the third.");
        document.getElementById('calcResult1').style.display = 'none';
        return;
    }
    
    if (filledCount === 3) {
        showError(1, "All values are entered. Please clear one input to calculate it.");
        document.getElementById('calcResult1').style.display = 'none';
        return;
    }
    
    // Validation
    if (ash !== null && (ash < 0 || ash > 100)) {
        showError(1, "Ash content must be between 0 and 100%");
        return;
    }
    
    if (moisture !== null && (moisture < 0 || moisture > 100)) {
        showError(1, "Moisture content must be between 0 and 100%");
        return;
    }
    
    if (gcv !== null && gcv < 0) {
        showError(1, "GCV cannot be negative");
        return;
    }
    
    let result = {};
    let calculatedValue = null;
    let calculatedParam = '';
    
    // Calculate missing parameter
    if (gcv === null && ash !== null && moisture !== null) {
        // Calculate GCV using correct formula
        // GCV = [{154 × (100 - (Moisture + (1.1 × Ash)))} - {108 × Moisture}] / 1.8
        calculatedValue = ((154 * (100 - (moisture + (1.1 * ash)))) - (108 * moisture)) / 1.8;
        calculatedParam = 'GCV';
        
        if (calculatedValue < 0) {
            showError(1, `Calculated ${calculatedParam} cannot be negative (${calculatedValue.toFixed(2)}). Please check your input values.`);
            document.getElementById('calcResult1').style.display = 'none';
            document.getElementById('results1').style.display = 'none';
            return;
        }
        
        result = {
            gcv: calculatedValue,
            ash: ash,
            moisture: moisture,
            calculated: 'GCV'
        };
    } else if (ash === null && gcv !== null && moisture !== null) {
        // Calculate Ash using correct formula
        // Ash = [{100 - (((GCV × 1.8) + (108 × Moisture)) / 154)} - Moisture] / 1.1
        calculatedValue = ((100 - (((gcv * 1.8) + (108 * moisture)) / 154)) - moisture) / 1.1;
        calculatedParam = 'Ash';
        
        if (calculatedValue < 0) {
            showError(1, `Calculated ${calculatedParam} cannot be negative (${calculatedValue.toFixed(2)}). Please check your input values.`);
            document.getElementById('calcResult1').style.display = 'none';
            document.getElementById('results1').style.display = 'none';
            return;
        }
        
        if (calculatedValue > 100) {
            showError(1, `Calculated Ash content exceeds 100% (${calculatedValue.toFixed(2)}%). Please check your input values.`);
            document.getElementById('calcResult1').style.display = 'none';
            document.getElementById('results1').style.display = 'none';
            return;
        }
        
        result = {
            gcv: gcv,
            ash: calculatedValue,
            moisture: moisture,
            calculated: 'Ash'
        };
    } else if (moisture === null && gcv !== null && ash !== null) {
        // Calculate Moisture using correct formula
        // Moisture = [15400 - {169.4 × Ash} - {1.8 × GCV}] / 262
        calculatedValue = (15400 - (169.4 * ash) - (1.8 * gcv)) / 262;
        calculatedParam = 'Moisture';
        
        if (calculatedValue < 0) {
            showError(1, `Calculated ${calculatedParam} cannot be negative (${calculatedValue.toFixed(2)}). Please check your input values.`);
            document.getElementById('calcResult1').style.display = 'none';
            document.getElementById('results1').style.display = 'none';
            return;
        }
        
        if (calculatedValue > 100) {
            showError(1, `Calculated Moisture content exceeds 100% (${calculatedValue.toFixed(2)}%). Please check your input values.`);
            document.getElementById('calcResult1').style.display = 'none';
            document.getElementById('results1').style.display = 'none';
            return;
        }
        
        result = {
            gcv: gcv,
            ash: ash,
            moisture: calculatedValue,
            calculated: 'Moisture'
        };
    }
    
    // Display calculated parameter in badge above inputs
    displayCalculatedParameter1(result);
}

function displayCalculatedParameter1(result) {
    const calcResultDiv = document.getElementById('calcResultDisplay1');
    const calcResultContainer = document.getElementById('calcResult1');
    
    let icon = '';
    let unit = '';
    
    if (result.calculated === 'GCV') {
        icon = 'fas fa-fire';
        unit = 'kcal/kg';
    } else if (result.calculated === 'Ash') {
        icon = 'fas fa-mountain';
        unit = '%';
    } else if (result.calculated === 'Moisture') {
        icon = 'fas fa-tint';
        unit = '%';
    }
    
    calcResultDiv.innerHTML = `
        <div class="result-badge success" style="font-size: 16px;">
            <i class="${icon} me-2"></i>
            ${result.calculated}: ${result[result.calculated.toLowerCase()].toFixed(2)} ${unit}
        </div>
    `;
    
    calcResultContainer.style.display = 'block';
}

// Calculator 2: GCV Conversion Calculator
function calculateConversion() {
    hideError(2);
    
    const gcvArb = parseFloat(document.getElementById('gcvArbInput').value) || null;
    const gcvEq = parseFloat(document.getElementById('gcvEqInput').value) || null;
    const moistureArb = parseFloat(document.getElementById('moistureArbInput').value) || null;
    const moistureEq = parseFloat(document.getElementById('moistureEqInput').value) || null;
    
    // Count filled inputs
    const inputs = [gcvArb, gcvEq, moistureArb, moistureEq];
    const filledCount = inputs.filter(v => v !== null && !isNaN(v)).length;
    
    if (filledCount === 0) {
        document.getElementById('calcResult2').style.display = 'none';
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    if (filledCount < 3) {
        showError(2, "Please enter at least 3 values to calculate the fourth.");
        document.getElementById('calcResult2').style.display = 'none';
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    if (filledCount === 4) {
        showError(2, "All values are entered. Please clear one input to calculate it.");
        document.getElementById('calcResult2').style.display = 'none';
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    // Validation
    if (moistureArb !== null && (moistureArb < 0 || moistureArb > 100)) {
        showError(2, "Total Moisture must be between 0 and 100%");
        document.getElementById('calcResult2').style.display = 'none';
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    if (moistureEq !== null && (moistureEq < 0 || moistureEq > 100)) {
        showError(2, "Inherent Moisture must be between 0 and 100%");
        document.getElementById('calcResult2').style.display = 'none';
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    if (gcvArb !== null && gcvArb < 0) {
        showError(2, "GCV ARB cannot be negative");
        document.getElementById('calcResult2').style.display = 'none';
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    if (gcvEq !== null && gcvEq < 0) {
        showError(2, "GCV Equilibrated cannot be negative");
        document.getElementById('calcResult2').style.display = 'none';
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    // Additional validation: Total Moisture should be >= Inherent Moisture
    if (moistureArb !== null && moistureEq !== null && moistureArb < moistureEq) {
        showError(2, "Total Moisture cannot be less than Inherent Moisture");
        document.getElementById('calcResult2').style.display = 'none';
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    // Additional validation: GCV ARB should be <= GCV Equilibrated
    if (gcvArb !== null && gcvEq !== null && gcvArb > gcvEq) {
        showError(2, "GCV ARB cannot be more than GCV Equilibrated");
        document.getElementById('calcResult2').style.display = 'none';
        document.getElementById('results2').style.display = 'none';
        return;
    }
    
    let result = {};
    let calculatedValue = null;
    
    // Calculate missing parameter
    if (gcvArb === null && gcvEq !== null && moistureArb !== null && moistureEq !== null) {
        // Calculate GCV ARB
        calculatedValue = (gcvEq * (100 - moistureArb)) / (100 - moistureEq);
        
        if (calculatedValue < 0) {
            showError(2, `Calculated GCV ARB cannot be negative (${calculatedValue.toFixed(2)}). Please check your input values.`);
            document.getElementById('calcResult2').style.display = 'none';
            document.getElementById('results2').style.display = 'none';
            return;
        }
        
        // Additional validation: GCV ARB should be <= GCV Equilibrated
        if (calculatedValue > gcvEq) {
            showError(2, `Calculated GCV ARB (${calculatedValue.toFixed(2)}) cannot be more than GCV Equilibrated (${gcvEq}). Please check your input values.`);
            document.getElementById('calcResult2').style.display = 'none';
            document.getElementById('results2').style.display = 'none';
            return;
        }
        
        result = {
            gcvArb: calculatedValue,
            gcvEq: gcvEq,
            moistureArb: moistureArb,
            moistureEq: moistureEq,
            calculated: 'GCV ARB'
        };
    } else if (gcvEq === null && gcvArb !== null && moistureArb !== null && moistureEq !== null) {
        // Calculate GCV Equilibrated
        calculatedValue = (gcvArb * (100 - moistureEq)) / (100 - moistureArb);
        
        if (calculatedValue < 0) {
            showError(2, `Calculated GCV Equilibrated cannot be negative (${calculatedValue.toFixed(2)}). Please check your input values.`);
            document.getElementById('calcResult2').style.display = 'none';
            document.getElementById('results2').style.display = 'none';
            return;
        }
        
        // Additional validation: GCV ARB should be <= GCV Equilibrated
        if (gcvArb > calculatedValue) {
            showError(2, `Calculated GCV Equilibrated (${calculatedValue.toFixed(2)}) cannot be less than GCV ARB (${gcvArb}). Please check your input values.`);
            document.getElementById('calcResult2').style.display = 'none';
            document.getElementById('results2').style.display = 'none';
            return;
        }
        
        result = {
            gcvArb: gcvArb,
            gcvEq: calculatedValue,
            moistureArb: moistureArb,
            moistureEq: moistureEq,
            calculated: 'GCV Equilibrated'
        };
    } else if (moistureArb === null && gcvArb !== null && gcvEq !== null && moistureEq !== null) {
        // Calculate Moisture ARB (Total Moisture)
        calculatedValue = 100 - ((gcvArb / gcvEq) * (100 - moistureEq));
        
        if (calculatedValue < 0) {
            showError(2, `Calculated Total Moisture cannot be negative (${calculatedValue.toFixed(2)}). Please check your input values.`);
            document.getElementById('calcResult2').style.display = 'none';
            document.getElementById('results2').style.display = 'none';
            return;
        }
        
        if (calculatedValue > 100) {
            showError(2, `Calculated Total Moisture exceeds 100% (${calculatedValue.toFixed(2)}%). Please check your input values.`);
            document.getElementById('calcResult2').style.display = 'none';
            document.getElementById('results2').style.display = 'none';
            return;
        }
        
        if (calculatedValue < moistureEq) {
            showError(2, `Calculated Total Moisture (${calculatedValue.toFixed(2)}%) cannot be less than Inherent Moisture (${moistureEq}%). Please check your input values.`);
            document.getElementById('calcResult2').style.display = 'none';
            document.getElementById('results2').style.display = 'none';
            return;
        }
        
        result = {
            gcvArb: gcvArb,
            gcvEq: gcvEq,
            moistureArb: calculatedValue,
            moistureEq: moistureEq,
            calculated: 'Total Moisture'
        };
    } else if (moistureEq === null && gcvArb !== null && gcvEq !== null && moistureArb !== null) {
        // Calculate Inherent Moisture
        calculatedValue = 100 - ((gcvEq / gcvArb) * (100 - moistureArb));
        
        if (calculatedValue < 0) {
            showError(2, `Calculated Inherent Moisture cannot be negative (${calculatedValue.toFixed(2)}). Please check your input values.`);
            document.getElementById('calcResult2').style.display = 'none';
            document.getElementById('results2').style.display = 'none';
            return;
        }
        
        if (calculatedValue > 100) {
            showError(2, `Calculated Inherent Moisture exceeds 100% (${calculatedValue.toFixed(2)}%). Please check your input values.`);
            document.getElementById('calcResult2').style.display = 'none';
            document.getElementById('results2').style.display = 'none';
            return;
        }
        
        if (calculatedValue > moistureArb) {
            showError(2, `Calculated Inherent Moisture (${calculatedValue.toFixed(2)}%) cannot be more than Total Moisture (${moistureArb}%). Please check your input values.`);
            document.getElementById('calcResult2').style.display = 'none';
            document.getElementById('results2').style.display = 'none';
            return;
        }
        
        result = {
            gcvArb: gcvArb,
            gcvEq: gcvEq,
            moistureArb: moistureArb,
            moistureEq: calculatedValue,
            calculated: 'Inherent Moisture'
        };
    }
    
    // Display calculated parameter in badge above inputs
    displayCalculatedParameter2(result);
}

function displayCalculatedParameter2(result) {
    const calcResultDiv = document.getElementById('calcResultDisplay2');
    const calcResultContainer = document.getElementById('calcResult2');
    
    let icon = '';
    let unit = '';
    let displayValue = 0;
    
    if (result.calculated === 'GCV ARB') {
        icon = 'fas fa-fire';
        unit = 'kcal/kg';
        displayValue = result.gcvArb;
    } else if (result.calculated === 'GCV Equilibrated') {
        icon = 'fas fa-balance-scale';
        unit = 'kcal/kg';
        displayValue = result.gcvEq;
    } else if (result.calculated === 'Total Moisture') {
        icon = 'fas fa-tint';
        unit = '%';
        displayValue = result.moistureArb;
    } else if (result.calculated === 'Inherent Moisture') {
        icon = 'fas fa-tint';
        unit = '%';
        displayValue = result.moistureEq;
    }
    
    calcResultDiv.innerHTML = `
        <div class="result-badge success" style="font-size: 16px;">
            <i class="${icon} me-2"></i>
            ${result.calculated}: ${displayValue.toFixed(2)} ${unit}
        </div>
    `;
    
    calcResultContainer.style.display = 'block';
}

// Clear Functions
function clearCalculator1() {
    document.getElementById('gcvInput').value = '';
    document.getElementById('ashInput').value = '';
    document.getElementById('moistureInput').value = '';
    document.getElementById('calcResult1').style.display = 'none';
    hideError(1);
}

function clearCalculator2() {
    document.getElementById('gcvArbInput').value = '';
    document.getElementById('gcvEqInput').value = '';
    document.getElementById('moistureArbInput').value = '';
    document.getElementById('moistureEqInput').value = '';
    document.getElementById('calcResult2').style.display = 'none';
    hideError(2);
}

// Save Functions
function saveCalculation(calcType) {
    let resultData = {};
    let calculationName = '';
    
    if (calcType === 'calc1') {
        // Get data from Calculator 1
        const resultDiv = document.getElementById('calcResult1');
        if (resultDiv.style.display === 'none') {
            alert('No calculation result to save. Please perform a calculation first.');
            return;
        }
        
        const gcvInput = parseFloat(document.getElementById('gcvInput').value) || null;
        const ashInput = parseFloat(document.getElementById('ashInput').value) || null;
        const moistureInput = parseFloat(document.getElementById('moistureInput').value) || null;
        
        // Determine which value was calculated and get the calculated values
        let calculatedField = '';
        let gcvValue, ashValue, moistureValue;
        
        if (gcvInput === null) {
            calculatedField = 'GCV';
            // Calculate GCV from the other two values
            gcvValue = ((154 * (100 - (moistureInput + (1.1 * ashInput)))) - (108 * moistureInput)) / 1.8;
            ashValue = ashInput;
            moistureValue = moistureInput;
        } else if (ashInput === null) {
            calculatedField = 'Ash';
            // Calculate Ash from the other two values
            gcvValue = gcvInput;
            ashValue = ((100 - (((gcvInput * 1.8) + (108 * moistureInput)) / 154)) - moistureInput) / 1.1;
            moistureValue = moistureInput;
        } else if (moistureInput === null) {
            calculatedField = 'Moisture';
            // Calculate Moisture from the other two values
            gcvValue = gcvInput;
            ashValue = ashInput;
            moistureValue = (15400 - (169.4 * ashInput) - (1.8 * gcvInput)) / 262;
        }
        
        resultData = {
            type: 'GCV/Ash/Moisture Calculator',
            gcv: gcvValue.toFixed(2),
            ash: ashValue.toFixed(2),
            moisture: moistureValue.toFixed(2),
            calculatedField: calculatedField,
            timestamp: new Date().toLocaleString()
        };
        calculationName = `GCV/Ash/Moisture - ${calculatedField} Calculated`;
        
    } else if (calcType === 'calc2') {
        // Get data from Calculator 2
        const resultDiv = document.getElementById('calcResult2');
        if (resultDiv.style.display === 'none') {
            alert('No calculation result to save. Please perform a calculation first.');
            return;
        }
        
        const gcvArbInput = parseFloat(document.getElementById('gcvArbInput').value) || null;
        const gcvEqInput = parseFloat(document.getElementById('gcvEqInput').value) || null;
        const moistureArbInput = parseFloat(document.getElementById('moistureArbInput').value) || null;
        const moistureEqInput = parseFloat(document.getElementById('moistureEqInput').value) || null;
        
        let calculatedField = '';
        let gcvArbValue, gcvEqValue, moistureArbValue, moistureEqValue;
        
        if (gcvArbInput === null) {
            calculatedField = 'GCV ARB';
            gcvArbValue = (gcvEqInput * (100 - moistureArbInput)) / (100 - moistureEqInput);
            gcvEqValue = gcvEqInput;
            moistureArbValue = moistureArbInput;
            moistureEqValue = moistureEqInput;
        } else if (gcvEqInput === null) {
            calculatedField = 'GCV Equilibrated';
            gcvArbValue = gcvArbInput;
            gcvEqValue = (gcvArbInput * (100 - moistureEqInput)) / (100 - moistureArbInput);
            moistureArbValue = moistureArbInput;
            moistureEqValue = moistureEqInput;
        } else if (moistureArbInput === null) {
            calculatedField = 'Total Moisture';
            gcvArbValue = gcvArbInput;
            gcvEqValue = gcvEqInput;
            moistureArbValue = 100 - ((gcvArbInput / gcvEqInput) * (100 - moistureEqInput));
            moistureEqValue = moistureEqInput;
        } else if (moistureEqInput === null) {
            calculatedField = 'Inherent Moisture';
            gcvArbValue = gcvArbInput;
            gcvEqValue = gcvEqInput;
            moistureArbValue = moistureArbInput;
            moistureEqValue = 100 - ((gcvEqInput / gcvArbInput) * (100 - moistureArbInput));
        }
        
        resultData = {
            type: 'GCV Conversion Calculator',
            gcvArb: gcvArbValue.toFixed(2),
            gcvEq: gcvEqValue.toFixed(2),
            moistureArb: moistureArbValue.toFixed(2),
            moistureEq: moistureEqValue.toFixed(2),
            calculatedField: calculatedField,
            timestamp: new Date().toLocaleString()
        };
        calculationName = `GCV Conversion - ${calculatedField} Calculated`;
    }
    
    // Save to localStorage
    let savedCalculations = JSON.parse(localStorage.getItem('coalCalculations') || '[]');
    resultData.id = Date.now(); // Simple ID
    resultData.name = calculationName;
    savedCalculations.push(resultData);
    localStorage.setItem('coalCalculations', JSON.stringify(savedCalculations));
    
    // Update counter
    updateStorageCounter();
    
    // Show success message
    alert(`✅ Calculation saved successfully!\n\nSaved: ${calculationName}\nTotal saved calculations: ${savedCalculations.length}`);
}

function updateStorageCounter() {
    const savedCalculations = JSON.parse(localStorage.getItem('coalCalculations') || '[]');
    const counter = document.getElementById('storageCounter');
    if (counter) {
        counter.textContent = savedCalculations.length;
        counter.style.display = savedCalculations.length > 0 ? 'flex' : 'none';
    }
}

function viewStoredCalculations() {
    const savedCalculations = JSON.parse(localStorage.getItem('coalCalculations') || '[]');
    
    if (savedCalculations.length === 0) {
        alert('No saved calculations found.\n\nUse the "Save Result" button after performing calculations to store them.');
        return;
    }
    
    // Create modal table view
    const tableContainer = document.createElement('div');
    tableContainer.className = 'analysis-table-container';
    tableContainer.style.position = 'fixed';
    tableContainer.style.top = '50%';
    tableContainer.style.left = '50%';
    tableContainer.style.transform = 'translate(-50%, -50%)';
    tableContainer.style.zIndex = '1050';
    tableContainer.style.maxWidth = '95vw';
    tableContainer.style.maxHeight = '90vh';
    tableContainer.style.overflow = 'auto';
    
    let tableHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h4 style="color: rgba(255, 255, 255, 0.9); margin: 0;">
                <i class="fas fa-chart-bar me-2"></i>Analysis Results (${savedCalculations.length})
            </h4>
            <div>
                <button class="action-btn" onclick="clearAllCalculations()" style="margin-right: 10px; background: rgba(220, 53, 69, 0.2); border-color: rgba(220, 53, 69, 0.3);">
                    <i class="fas fa-trash me-2"></i>Clear All
                </button>
                <button class="close-btn" onclick="closeAnalysisTable()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <table class="analysis-table">
            <thead>
                <tr>
                    <th style="text-align: center;">S.No</th>
                    <th>Calculator Type</th>
                    <th style="text-align: center;">GCV<br><small>(kcal/kg)</small></th>
                    <th style="text-align: center;">Ash<br><small>(%)</small></th>
                    <th style="text-align: center;">Moisture<br><small>(%)</small></th>
                    <th>Calculated Field</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    savedCalculations.reverse().forEach((calc, index) => {
        const serialNo = index + 1;
        
        if (calc.type === 'GCV/Ash/Moisture Calculator') {
            tableHTML += `
                <tr>
                    <td data-label="S.No" style="text-align: center; font-weight: 600;">${serialNo}</td>
                    <td data-label="Type"><i class="fas fa-calculator me-2 text-info"></i>GCV/Ash/Moisture</td>
                    <td data-label="GCV" style="text-align: center; font-weight: 600;">${calc.gcv}</td>
                    <td data-label="Ash" style="text-align: center; font-weight: 600;">${calc.ash}</td>
                    <td data-label="Moisture" style="text-align: center; font-weight: 600;">${calc.moisture}</td>
                    <td data-label="Calculated" style="color: #28a745; font-weight: 600;"><i class="fas fa-star me-1"></i>${calc.calculatedField}</td>
                </tr>
            `;
        } else if (calc.type === 'GCV Conversion Calculator') {
            tableHTML += `
                <tr>
                    <td data-label="S.No" style="text-align: center; font-weight: 600;">${serialNo}</td>
                    <td data-label="Type"><i class="fas fa-exchange-alt me-2 text-warning"></i>GCV Conversion</td>
                    <td data-label="GCV" style="text-align: center; font-weight: 600;">ARB: ${calc.gcvArb}<br>Eq: ${calc.gcvEq}</td>
                    <td data-label="Ash" style="text-align: center; color: rgba(255, 255, 255, 0.5);">N/A</td>
                    <td data-label="Moisture" style="text-align: center; font-weight: 600;">TM: ${calc.moistureArb}<br>IM: ${calc.moistureEq}</td>
                    <td data-label="Calculated" style="color: #17a2b8; font-weight: 600;"><i class="fas fa-star me-1"></i>${calc.calculatedField}</td>
                </tr>
            `;
        }
    });
    
    tableHTML += `
            </tbody>
        </table>
        <div style="margin-top: 20px; text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 14px;">
            <i class="fas fa-info-circle me-2"></i>Click "Clear All" to remove all stored calculations
        </div>
    `;
    
    tableContainer.innerHTML = tableHTML;
    tableContainer.id = 'analysisTableContainer';
    
    // Add backdrop
    const backdrop = document.createElement('div');
    backdrop.style.position = 'fixed';
    backdrop.style.top = '0';
    backdrop.style.left = '0';
    backdrop.style.width = '100%';
    backdrop.style.height = '100%';
    backdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    backdrop.style.zIndex = '1040';
    backdrop.id = 'analysisTableBackdrop';
    backdrop.onclick = closeAnalysisTable;
    
    document.body.appendChild(backdrop);
    document.body.appendChild(tableContainer);
}

function closeAnalysisTable() {
    const container = document.getElementById('analysisTableContainer');
    const backdrop = document.getElementById('analysisTableBackdrop');
    if (container) container.remove();
    if (backdrop) backdrop.remove();
}

function clearAllCalculations() {
    if (confirm('Are you sure you want to clear all saved calculations?\n\nThis action cannot be undone.')) {
        localStorage.removeItem('coalCalculations');
        updateStorageCounter();
        closeAnalysisTable();
        alert('✅ All calculations have been cleared successfully!');
    }
}

// Initialize storage counter on page load and trigger animations
document.addEventListener('DOMContentLoaded', function() {
    updateStorageCounter();
    
    // Load night mode preference
    loadNightModePreference();
    
    // Trigger entrance animations
    const animatedElements = document.querySelectorAll('.animate-on-load');
    
    // Add a slight delay to ensure smooth rendering
    setTimeout(() => {
        animatedElements.forEach(element => {
            element.style.opacity = '1';
            
            // Add the appropriate animation class based on existing classes
            if (element.classList.contains('animate-fadeInUp')) {
                element.style.animation = element.style.animation || 'fadeInUp 0.8s ease-out forwards';
            } else if (element.classList.contains('animate-fadeInDown')) {
                element.style.animation = element.style.animation || 'fadeInDown 0.8s ease-out forwards';
            } else if (element.classList.contains('animate-fadeInLeft')) {
                element.style.animation = element.style.animation || 'fadeInLeft 0.8s ease-out forwards';
            } else if (element.classList.contains('animate-fadeInRight')) {
                element.style.animation = element.style.animation || 'fadeInRight 0.8s ease-out forwards';
            } else if (element.classList.contains('animate-scaleIn')) {
                element.style.animation = element.style.animation || 'scaleIn 0.8s ease-out forwards';
            } else if (element.classList.contains('animate-bounceIn')) {
                element.style.animation = element.style.animation || 'bounceIn 1s ease-out forwards';
            }
        });
    }, 100);
    
    // Add a welcome effect to the page title
    setTimeout(() => {
        const pageTitle = document.querySelector('.page-title');
        if (pageTitle) {
            pageTitle.style.transform = 'scale(1.02)';
            setTimeout(() => {
                pageTitle.style.transform = 'scale(1)';
            }, 200);
        }
    }, 1200);
});

function toggleFormulaCard() {
    const formulaCard = document.getElementById('formulaCard');
    formulaCard.style.display = formulaCard.style.display === 'none' ? 'block' : 'none';
}

function toggleExportOptions() {
    const dropdown = document.getElementById('exportDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}

// Close export dropdown when clicking outside
document.addEventListener('click', function(event) {
    const exportDropdown = document.getElementById('exportDropdown');
    const exportBtn = event.target.closest('.floating-btn[onclick*="toggleExportOptions"]');
    
    if (exportDropdown && !exportBtn && !exportDropdown.contains(event.target)) {
        exportDropdown.classList.remove('active');
    }
});

// Export Functions with table data
function exportToPDF() {
    const savedCalculations = JSON.parse(localStorage.getItem('coalCalculations') || '[]');
    
    if (savedCalculations.length === 0) {
        alert('No saved calculations to export.\n\nPlease save some calculations first.');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // Add title
    doc.setFontSize(18);
    doc.setTextColor(40, 40, 40);
    doc.text('Coal Analysis Results', 20, 20);
    
    // Add subtitle
    doc.setFontSize(12);
    doc.setTextColor(80, 80, 80);
    doc.text(`Total Records: ${savedCalculations.length} | Generated: ${new Date().toLocaleString()}`, 20, 30);
    
    // Prepare table data
    const tableColumns = ['S.No', 'Calculator Type', 'GCV (kcal/kg)', 'Ash (%)', 'Moisture (%)', 'Calculated Field'];
    const tableRows = [];
    
    savedCalculations.reverse().forEach((calc, index) => {
        if (calc.type === 'GCV/Ash/Moisture Calculator') {
            tableRows.push([
                index + 1,
                'GCV/Ash/Moisture',
                calc.gcv,
                calc.ash,
                calc.moisture,
                calc.calculatedField
            ]);
        } else {
            tableRows.push([
                index + 1,
                'GCV Conversion',
                `ARB: ${calc.gcvArb}\nEq: ${calc.gcvEq}`,
                'N/A',
                `TM: ${calc.moistureArb}\nIM: ${calc.moistureEq}`,
                calc.calculatedField
            ]);
        }
    });
    
    // Add table
    doc.autoTable({
        head: [tableColumns],
        body: tableRows,
        startY: 40,
        styles: {
            fontSize: 10,
            cellPadding: 3
        },
        headStyles: {
            fillColor: [41, 128, 185],
            textColor: 255,
            fontStyle: 'bold'
        },
        alternateRowStyles: {
            fillColor: [245, 245, 245]
        }
    });
    
    // Save the PDF
    doc.save(`Coal_Analysis_Results_${new Date().toISOString().split('T')[0]}.pdf`);
    
    // Close export dropdown
    document.getElementById('exportDropdown').classList.remove('active');
    
    alert('✅ PDF exported successfully!');
}

function exportToJPG() {
    const savedCalculations = JSON.parse(localStorage.getItem('coalCalculations') || '[]');
    
    if (savedCalculations.length === 0) {
        alert('No saved calculations to export.\n\nPlease save some calculations first.');
        return;
    }

    // Create a canvas to render the table
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size for A4 portrait mode (same as PDF)
    canvas.width = 2480; // A4 width at 300 DPI
    canvas.height = 3508; // A4 height at 300 DPI
    
    // Fill background
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Add title
    ctx.fillStyle = '#2c3e50';
    ctx.font = 'bold 48px Arial';
    ctx.fillText('Coal Analysis Results', 100, 150);
    
    // Add subtitle
    ctx.fillStyle = '#7f8c8d';
    ctx.font = '32px Arial';
    ctx.fillText(`Total Records: ${savedCalculations.length} | Generated: ${new Date().toLocaleString()}`, 100, 200);
    
    // Table styling (adjusted for portrait A4 - full width, no timestamp)
    const startY = 300;
    const rowHeight = 100; // Increased for larger fonts
    const availableWidth = canvas.width - 200; // Full width minus margins
    const colWidths = [120, 420, 480, 200, 480, 380]; // 6 columns, no timestamp
    const tableWidth = availableWidth; // Use full available width
    
    // Scale column widths to fit exactly
    const totalCols = colWidths.reduce((a, b) => a + b, 0);
    const scaleFactor = availableWidth / totalCols;
    colWidths.forEach((width, i) => colWidths[i] = Math.floor(width * scaleFactor));
    
    // Updated table headers without timestamp
    const headers = ['S.No', 'Calculator Type', 'GCV (kcal/kg)', 'Ash (%)', 'Moisture (%)', 'Calculated Field'];
    
    // Draw header
    ctx.fillStyle = '#3498db';
    ctx.fillRect(100, startY, tableWidth, rowHeight);
    
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 32px Arial'; // Larger font for headers
    
    let xPos = 100;
    headers.forEach((header, i) => {
        // Center text in column
        const textWidth = ctx.measureText(header).width;
        const centerX = xPos + (colWidths[i] - textWidth) / 2;
        ctx.fillText(header, centerX, startY + 60);
        xPos += colWidths[i];
    });
    
    // Draw rows
    ctx.fillStyle = '#2c3e50';
    ctx.font = '28px Arial'; // Larger font for data rows
    
    savedCalculations.reverse().forEach((calc, index) => {
        const yPos = startY + (index + 1) * rowHeight;
        
        // Alternate row colors
        ctx.fillStyle = index % 2 === 0 ? '#f8f9fa' : '#ffffff';
        ctx.fillRect(100, yPos, tableWidth, rowHeight);
        
        ctx.fillStyle = '#2c3e50';
        
        let xPos = 100;
        let rowData = []; // Changed from const to let
        
        if (calc.type === 'GCV/Ash/Moisture Calculator') {
            rowData = [
                index + 1,
                'GCV/Ash/Moisture',
                calc.gcv,
                calc.ash,
                calc.moisture,
                calc.calculatedField
            ];
        } else {
            rowData = [
                index + 1,
                'GCV Conversion',
                `ARB:${calc.gcvArb} Eq:${calc.gcvEq}`,
                'N/A',
                `TM:${calc.moistureArb} IM:${calc.moistureEq}`,
                calc.calculatedField
            ];
        }
        
        rowData.forEach((data, i) => {
            // Handle text rendering with larger fonts
            const text = String(data);
            const maxWidth = colWidths[i] - 20;
            
            if (ctx.measureText(text).width > maxWidth) {
                // Handle long text with wrapping
                const words = text.split(' ');
                let line = '';
                let lineY = yPos + 35;
                const lineHeight = 30;
                
                for (let n = 0; n < words.length; n++) {
                    let testLine = line + words[n] + ' ';
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && n > 0) {
                        // Center text in column
                        const textWidth = ctx.measureText(line).width;
                        const centerX = xPos + (colWidths[i] - textWidth) / 2;
                        ctx.fillText(line, centerX, lineY);
                        line = words[n] + ' ';
                        lineY += lineHeight;
                        if (lineY > yPos + rowHeight - 15) break;
                    } else {
                        line = testLine;
                    }
                }
                if (lineY <= yPos + rowHeight - 15) {
                    const textWidth = ctx.measureText(line).width;
                    const centerX = xPos + (colWidths[i] - textWidth) / 2;
                    ctx.fillText(line, centerX, lineY);
                }
            } else {
                // Check if it's multi-line content
                if (text.includes('ARB:') && text.includes('Eq:')) {
                    const parts = text.split(' ');
                    const centerX1 = xPos + (colWidths[i] - ctx.measureText(parts[0]).width) / 2;
                    const centerX2 = xPos + (colWidths[i] - ctx.measureText(parts[1]).width) / 2;
                    ctx.fillText(parts[0], centerX1, yPos + 40);
                    ctx.fillText(parts[1], centerX2, yPos + 75);
                } else if (text.includes('TM:') && text.includes('IM:')) {
                    const parts = text.split(' ');
                    const centerX1 = xPos + (colWidths[i] - ctx.measureText(parts[0]).width) / 2;
                    const centerX2 = xPos + (colWidths[i] - ctx.measureText(parts[1]).width) / 2;
                    ctx.fillText(parts[0], centerX1, yPos + 40);
                    ctx.fillText(parts[1], centerX2, yPos + 75);
                } else {
                    // Center single line text
                    const textWidth = ctx.measureText(text).width;
                    const centerX = xPos + (colWidths[i] - textWidth) / 2;
                    ctx.fillText(text, centerX, yPos + 60);
                }
            }
            
            xPos += colWidths[i];
        });
    });
    
    // Convert canvas to JPG and download
    canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Coal_Analysis_Results_${new Date().toISOString().split('T')[0]}.jpg`;
        a.click();
        URL.revokeObjectURL(url);
        
        // Close export dropdown
        document.getElementById('exportDropdown').classList.remove('active');
        
        alert('✅ JPG exported successfully!');
    }, 'image/jpeg', 0.95);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Professional GCV Analysis Suite initialized successfully!');
});

    </script>
</body>
</html>
